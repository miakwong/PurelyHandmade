<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Payment - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

  <div class="container my-5" style="background-color: #f8f9fa; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <h2 class="mb-4 text-center">Payment</h2>
    <div class="row">
      <div class="col-md-6">
        <h4>Order Summary</h4>
        <table class="table table-striped">
          <tbody id="summary-items"></tbody>
          <tfoot>
            <tr>
              <td><strong>Subtotal:</strong></td>
              <td class="text-end">$<span id="summary-subtotal"></span></td>
            </tr>
            <tr>
              <td><strong>Shipping:</strong></td>
              <td class="text-end">$<span id="summary-shipping"></span></td>
            </tr>
            <tr>
              <td><strong>Total:</strong></td>
              <td class="text-end">$<span id="summary-total"></span></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="col-md-6">
        <h4>Payment Details</h4>
        <form id="payment-form" novalidate>
          <input type="text" id="cardNumber" class="form-control mb-3" placeholder="Card Number" required>
          <input type="text" id="cardExpiry" class="form-control mb-3" placeholder="Expiry Date (MM/YY)" required>
          <input type="text" id="cardCVV" class="form-control mb-3" placeholder="CVV" required>
          <button type="submit" class="btn btn-success w-100">Pay Now</button>
        </form>
        <div class="text-center my-3">-- OR --</div>
        <button id="paypal-button" class="btn btn-outline-primary w-100">Pay with PayPal</button>
      </div>
    </div>
  </div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder" class="mt-5"></div>

  <script>
    fetch('../../assets/layout/navbar.html').then(r => r.text()).then(html => document.getElementById('navbar-placeholder').innerHTML = html);
    fetch('../../assets/layout/footer.html').then(r => r.text()).then(html => document.getElementById('footer-placeholder').innerHTML = html);

    // Display order summary based on cart and shipping info
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const shippingInfo = JSON.parse(localStorage.getItem('shippingInfo') || '{}');
    let subtotal = 0;
    cart.forEach(item => { subtotal += item.price * item.qty; });
    subtotal = parseFloat(subtotal.toFixed(2));
    // Determine shipping cost based on method
    let shippingCost = 0;
    if (shippingInfo.method === 'express') {
      shippingCost = 15.00;
    } else {
      shippingCost = 5.00;
    }
    const total = parseFloat((subtotal + shippingCost).toFixed(2));
    // Populate summary table
    document.getElementById('summary-subtotal').textContent = subtotal.toFixed(2);
    document.getElementById('summary-shipping').textContent = shippingCost.toFixed(2);
    document.getElementById('summary-total').textContent = total.toFixed(2);
    const summaryItems = document.getElementById('summary-items');
    summaryItems.innerHTML = '';
    cart.forEach(item => {
      const itemTotal = (item.price * item.qty).toFixed(2);
      summaryItems.innerHTML += `<tr><td>${item.name} (x${item.qty})</td><td class="text-end">$${itemTotal}</td></tr>`;
    });

    // Function to finalize order and save it
    function placeOrder(paymentMethod) {
      const orderId = 'ORD' + Date.now();  // simple unique ID
      // Calculate estimated delivery date (2 days for express, 5 days for standard)
      const estDate = new Date();
      estDate.setDate(estDate.getDate() + (shippingInfo.method === 'express' ? 2 : 5));
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      const estimatedDelivery = estDate.toLocaleDateString(undefined, options);
      // Create order object
      const order = {
        id: orderId,
        items: cart,
        shipping: shippingInfo,
        subtotal: subtotal,
        shippingCost: shippingCost,
        total: total,
        paymentMethod: paymentMethod,
        orderDate: new Date().toISOString(),
        estimatedDelivery: estimatedDelivery
      };
      // Save order to localStorage (for confirmation page and order history)
      localStorage.setItem('lastOrder', JSON.stringify(order));
      const orderHistory = JSON.parse(localStorage.getItem('orders') || '[]');
      orderHistory.push(order);
      localStorage.setItem('orders', JSON.stringify(orderHistory));
      // Clear the cart now that the order is placed
      localStorage.setItem('cart', '[]');
      // Redirect to confirmation page
      window.location.href = 'order_confirm.html';
    }

    // Handle credit card form submission
    document.getElementById('payment-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      // Get and validate card details
      const cardNumInput = document.getElementById('cardNumber');
      const expiryInput = document.getElementById('cardExpiry');
      const cvvInput = document.getElementById('cardCVV');
      const cardNumber = cardNumInput.value.trim();
      const cardExpiry = expiryInput.value.trim();
      const cardCVV = cvvInput.value.trim();
      // Validate card number (allowing spaces/dashes)
      const digits = cardNumber.replace(/\D/g, '');
      if (digits.length !== 16) {
        alert('Please enter a valid 16-digit card number.');
        return;
      }
      // Validate expiry (format MM/YY)
      if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(cardExpiry)) {
        alert('Please enter a valid expiry date in MM/YY format.');
        return;
      }
      // Validate CVV (3 digits)
      if (!/^\d{3}$/.test(cardCVV)) {
        alert('Please enter a valid 3-digit CVV.');
        return;
      }
      // All good â€“ place the order with Credit Card as payment method
      placeOrder('Credit Card');
    });

    // Handle PayPal payment (simulated immediate success)
    document.getElementById('paypal-button').addEventListener('click', function() {
      // In a real application, redirect to PayPal. Here we directly place the order.
      placeOrder('PayPal');
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>