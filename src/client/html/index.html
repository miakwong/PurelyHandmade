<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purely Homemade - Handcrafted with Love</title>
  
  <!-- Add alert拦截器，在页面最早期执行 -->
  <script src="/src/client/js/no-alerts.js"></script>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/src/client/css/index.css">
  <link rel="stylesheet" href="/src/client/css/navbar.css">
  <link rel="stylesheet" href="/src/client/css/global.css">
  <link rel="stylesheet" href="/src/client/css/toast.css">

  <!-- Data Services -->
  <script src="/src/client/js/data-service.js"></script>
  <script src="/src/client/js/api-data-loader.js" defer></script>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Hero Section -->
<section class="hero-section">
  <div class="hero-content">
    <h1 class="hero-title">Handcrafted with Love</h1>
    <p class="hero-subtitle">Discover unique, artisan-made products that bring warmth and character to your home</p>
    <a href="/src/client/views/designer/designers.html" class="btn btn-light btn-lg">Explore Our Collections</a>
  </div>
</section>

<!-- Featured Categories -->
<section class="container mb-5">
  <h2 class="text-center mb-4">Shop by Category</h2>
  <div class="row justify-content-center" id="category-cards-container">
    <!-- Categories will be loaded dynamically -->
    <div class="col-12 text-center py-4" id="categories-loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading categories...</p>
    </div>
  </div>
  <div class="text-center mt-4">
    <a href="/src/client/views/product/category-list.html" class="btn btn-outline-primary">View All Categories</a>
  </div>
</section>

<!-- New Arrivals -->
<section class="container mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>New Arrivals</h2>
    <a href="/src/client/views/new-arrivals.html" class="btn btn-outline-primary">View All</a>
  </div>
  <div class="row justify-content-center" id="new-arrivals-container">
    <!-- Products will be loaded dynamically -->
  </div>
</section>

<!-- Featured Designers -->
<section class="featured-designers-section">
  <div class="container">
    <div class="section-header text-center mb-4">
      <h2>Meet Our Featured Artisans</h2>
      <p class="text-muted">Discover the talented featured designers behind our unique products</p>
      <div class="mt-3">
        <a href="/src/client/views/designer/designers.html" class="btn btn-outline-primary">View All Artisans</a>
      </div>
    </div>
    <div class="row justify-content-center" id="designers-container">
      <!-- Designer cards will be dynamically loaded here -->
      <div class="col-12 text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading our talented artisans...</p>
      </div>
    </div>
  </div>
</section>

<!-- Best Sellers -->
<section class="container mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Best Sellers</h2>
    <a href="/src/client/views/product/product-list.html" class="btn btn-outline-primary">View All</a>
  </div>
  <div class="row justify-content-center" id="best-sellers-container">
    <!-- Products will be loaded dynamically -->
  </div>
</section>

<!-- Subscribe Section -->
<section class="subscribe-section">
  <div class="container">
    <h2>Stay Updated</h2>
    <p>Subscribe to our newsletter for exclusive offers and updates on new products</p>
    <div class="subscribe-form">
      <form class="d-flex">
        <input type="email" class="form-control me-2" placeholder="Your email address">
        <button type="submit" class="btn btn-light">Subscribe</button>
      </form>
    </div>
  </div>
</section>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast Container for notifications -->
<div class="modern-toast-container" id="toast-container"></div>

<!-- Bootstrap JS and jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Data Service scripts - Must load before init-data.js -->
<script src="/src/client/js/data-service.js"></script>
<script src="/src/client/js/api-data-loader.js"></script>

<!-- 初始化数据脚本 -->
<script src="/src/client/js/init-data.js"></script>

<!-- Navbar Handler -->
<script src="/src/client/js/navbar-handler.js"></script>

<script>
  // 确保数据初始化
  document.addEventListener('DOMContentLoaded', function() {
    console.log('index.html: DOM content loaded');
    console.log('DataService exists:', typeof DataService !== 'undefined');
    console.log('window.loadProducts exists:', typeof window.loadProducts === 'function');
    console.log('window.loadCategories exists:', typeof window.loadCategories === 'function');
    console.log('window.loadDesigners exists:', typeof window.loadDesigners === 'function');
    
    // Verify all containers exist in the DOM
    console.log('Checking containers:');
    console.log('- category-cards-container exists:', !!document.getElementById('category-cards-container'));
    console.log('- new-arrivals-container exists:', !!document.getElementById('new-arrivals-container'));
    console.log('- best-sellers-container exists:', !!document.getElementById('best-sellers-container'));
    console.log('- designers-container exists:', !!document.getElementById('designers-container'));
    
    // Wait a short delay to ensure all scripts are fully loaded
    setTimeout(() => {
      console.log('Executing main initialization with delay');
      console.log('DataService exists after delay:', typeof DataService !== 'undefined');
      console.log('window.loadProducts exists after delay:', typeof window.loadProducts === 'function');
      console.log('window.loadCategories exists after delay:', typeof window.loadCategories === 'function');
      console.log('window.loadDesigners exists after delay:', typeof window.loadDesigners === 'function');
      
      if (typeof window.initializeData === 'function') {
        window.initializeData();
      }

      // 加载分类
      loadFeaturedCategories();

      // 加载新品
      loadNewArrivals();
      
      // 加载畅销品
      loadBestSellers();
      
      // 再次尝试更新身份验证状态和购物车数量，以确保状态正确
      setTimeout(() => {
        console.log("Document fully loaded, updating auth state again");
        if (typeof window.updateAuthButton === 'function') {
          window.updateAuthButton();
        }
        
        if (typeof window.updateCartCount === 'function') {
          window.updateCartCount();
        }
      }, 500);
    }, 300);  
  });
  
  // 加载精选分类
  function loadFeaturedCategories() {
    console.log('Calling loadFeaturedCategories()');
    
    // Get a direct reference to the container element
    const categoriesContainer = document.getElementById('category-cards-container');
    if (!categoriesContainer) {
      console.error('category-cards-container element not found in DOM');
      return;
    }
    
    // Check if the API function exists
    if (typeof window.loadCategories !== 'function') {
      console.error('window.loadCategories is not defined!');
      return;
    }
    
    // Pass the container ID directly - ensure it's a string
    console.log('Calling window.loadCategories with container ID:', 'category-cards-container');
    window.loadCategories('category-cards-container', {
      limit: 6,
      featured: true
    });
    console.log('loadCategories() called with container ID: category-cards-container');
  }
  
  // 加载新品
  function loadNewArrivals() {
    console.log('Calling loadNewArrivals()');
    
    // Get a direct reference to the container element
    const newArrivalsContainer = document.getElementById('new-arrivals-container');
    if (!newArrivalsContainer) {
      console.error('new-arrivals-container element not found in DOM');
      return;
    }
    
    // Check if the API function exists
    if (typeof window.loadProducts !== 'function') {
      console.error('window.loadProducts is not defined!');
      return;
    }
    
    // Pass the container ID directly - ensure it's a string
    console.log('Calling window.loadProducts with container ID:', 'new-arrivals-container');
    window.loadProducts('new-arrivals-container', {
      limit: 4,
      newArrivals: true
    });
    console.log('loadProducts() called with container ID: new-arrivals-container');
  }
  
  // 加载畅销品
  function loadBestSellers() {
    console.log('Calling loadBestSellers()');
    console.log('window.loadProducts exists:', typeof window.loadProducts === 'function');
    
    // Get a direct reference to the container element
    const bestSellersContainer = document.getElementById('best-sellers-container');
    if (!bestSellersContainer) {
      console.error('best-sellers-container element not found in DOM');
      return;
    }
    
    if (typeof window.loadProducts !== 'function') {
      console.error('window.loadProducts is not defined yet!');
      // Try again after a small delay
      setTimeout(() => {
        console.log('Retrying loadBestSellers after delay');
        if (typeof window.loadProducts === 'function') {
          // Pass the DOM element directly to avoid ID resolution issues
          window.loadProducts('best-sellers-container', {
            limit: 4,
            featured: true
          });
        } else {
          console.error('window.loadProducts is still not defined after delay');
          // Fallback: Use the container element directly
          bestSellersContainer.innerHTML = `
            <div class="col-12 text-center py-4">
              <p class="text-danger">Error loading best sellers: API function not available</p>
            </div>
          `;
        }
      }, 500);
      return;
    }
    
    // Pass the container ID directly - FIX: ensure it's passed as a string 'best-sellers-container'
    console.log('Calling window.loadProducts with container ID:', 'best-sellers-container');
    window.loadProducts('best-sellers-container', {
      limit: 4,
      featured: true
    });
    console.log('loadProducts() called with container ID: best-sellers-container');
  }
  
  // 添加到购物车
  async function addToCart(productId, quantity) {
    try {
      // Get product details from the API
      const result = await DataService.getProductById(productId);
      
      if (!result || !result.success) {
        console.error(`Failed to get product with ID ${productId}`);
        showToast('Product not found', 'error');
        return;
      }
      
      const product = result.product;
      
      // Add product to cart using DataService
      DataService.addToCart(product, quantity);
      
      // Update cart count in navbar
      updateCartCount();
      
      // Show success message
      showToast(`${product.name} added to cart!`);
    } catch (error) {
      console.error('Error adding product to cart:', error);
      showToast('Failed to add product to cart', 'error');
    }
  }
  
  // 显示提示消息
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `modern-toast ${type}`;
    
    toast.innerHTML = `
      <div class="toast-content">
        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'}"></i>
        <div class="message">${message}</div>
      </div>
      <button class="close-btn"><i class="bi bi-x"></i></button>
    `;
    
    toastContainer.appendChild(toast);
    
    // 添加关闭按钮功能
    const closeBtn = toast.querySelector('.close-btn');
    closeBtn.addEventListener('click', function() {
      toast.classList.add('hide');
      setTimeout(() => {
        toast.remove();
      }, 300);
    });
    
    // 3秒后自动消失
    setTimeout(() => {
      toast.classList.add('hide');
      setTimeout(() => {
        toast.remove();
      }, 300);
    }, 3000);
  }
  
  // 更新购物车计数
  function updateCartCount() {
    const badge = document.querySelector('#cart-badge');
    
    if (!badge) return;
    
    // Get cart count using DataService
    const count = DataService.getCartItemCount();
    
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = 'block';
    } else {
      badge.style.display = 'none';
    }
  }
</script>

<script src="/src/client/js/index.js"></script>
</body>
</html>
