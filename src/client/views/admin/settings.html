<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Website Settings - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  <style>
    .settings-card {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      border: 1px solid #eaeaea;
    }
    .settings-header {
      background-color: #f8f9fa;
      padding: 15px;
      border-bottom: 1px solid #eaeaea;
    }
    .settings-body {
      padding: 20px;
    }
  </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">
              <i class="bi bi-box me-2"></i>
              Products
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="categories.html">
              <i class="bi bi-tags me-2"></i>
              Categories
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="designers.html">
              <i class="bi bi-palette me-2"></i>
              Designers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="orders.html">
              <i class="bi bi-cart-check me-2"></i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="users.html">
              <i class="bi bi-people me-2"></i>
              Users
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="comments.html">
              <i class="bi bi-chat-dots me-2"></i>
              Reviews
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-graph-up me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-gear me-2 text-primary"></i>Website Settings</h1>
        <div>
          <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
            <i class="bi bi-person me-2"></i>Back to Profile
          </a>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-header">
          <h5 class="mb-0">General Settings</h5>
        </div>
        <div class="settings-body">
          <form id="settings-form">
            <div class="mb-3">
              <label for="site-name" class="form-label">Site Name</label>
              <input type="text" class="form-control" id="site-name" placeholder="Enter site name">
            </div>
            <div class="mb-3">
              <label for="contact-email" class="form-label">Contact Email</label>
              <input type="email" class="form-control" id="contact-email" placeholder="Enter contact email">
            </div>
            <div class="mb-3">
              <label for="phone-number" class="form-label">Phone Number</label>
              <input type="text" class="form-control" id="phone-number" placeholder="Enter phone number">
            </div>
            <div class="mb-3">
              <label for="address" class="form-label">Address</label>
              <textarea class="form-control" id="address" rows="3" placeholder="Enter address"></textarea>
            </div>
            <div class="mb-3">
              <label for="facebook-link" class="form-label">Facebook Link</label>
              <input type="url" class="form-control" id="facebook-link" placeholder="Enter Facebook URL">
            </div>
            <div class="mb-3">
              <label for="twitter-link" class="form-label">Twitter Link</label>
              <input type="url" class="form-control" id="twitter-link" placeholder="Enter Twitter URL">
            </div>
            <div class="mb-3">
              <label for="instagram-link" class="form-label">Instagram Link</label>
              <input type="url" class="form-control" id="instagram-link" placeholder="Enter Instagram URL">
            </div>
            <div class="d-flex justify-content-end">
              <button type="button" class="btn btn-secondary me-2" onclick="resetSettings()">Reset</button>
              <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>
</div>

<div id="footer-placeholder"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  /**
   * API Service for Purely Handmade
   */
  const ApiService = {
    // 基础API URL
    baseUrl: '/api',
    
    // 处理API响应
    handleResponse: async function(response) {
      const contentType = response.headers.get('content-type');
      const isJson = contentType && contentType.includes('application/json');
      
      // 如果状态码不在2xx范围内，抛出错误
      if (!response.ok) {
        let errorData;
        
        try {
          errorData = isJson ? await response.json() : await response.text();
        } catch (error) {
          errorData = 'Failed to parse error response';
        }
        
        const error = new Error(
          isJson && errorData.error 
            ? errorData.error 
            : 'API request failed'
        );
        
        error.status = response.status;
        error.statusText = response.statusText;
        error.data = errorData;
        
        throw error;
      }
      
      // 解析成功响应
      return isJson ? response.json() : response.text();
    },
    
    // 发送请求
    request: async function(url, options = {}) {
      const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
      
      // 默认选项
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        credentials: 'same-origin',
      };
      
      // 添加授权令牌
      const token = localStorage.getItem('authToken') || localStorage.getItem('token');
      if (token) {
        defaultOptions.headers['Authorization'] = `Bearer ${token}`;
      }
      
      // 合并选项
      const fetchOptions = {
        ...defaultOptions,
        ...options,
        headers: {
          ...defaultOptions.headers,
          ...options.headers,
        },
      };
      
      try {
        const response = await fetch(fullUrl, fetchOptions);
        return await this.handleResponse(response);
      } catch (error) {
        console.error('API request failed:', error);
        throw error;
      }
    },
    
    // GET请求
    get: function(url, params = {}) {
      // 构建查询字符串
      const queryParams = new URLSearchParams();
      Object.keys(params).forEach(key => {
        if (params[key] !== undefined && params[key] !== null) {
          queryParams.append(key, params[key]);
        }
      });
      
      const queryString = queryParams.toString();
      const fullUrl = queryString ? `${url}?${queryString}` : url;
      
      return this.request(fullUrl, { method: 'GET' });
    },
    
    // POST请求
    post: function(url, data = {}) {
      return this.request(url, {
        method: 'POST',
        body: JSON.stringify(data),
      });
    },
    
    // PUT请求
    put: function(url, data = {}) {
      return this.request(url, {
        method: 'PUT',
        body: JSON.stringify(data),
      });
    },
    
    // DELETE请求
    delete: function(url) {
      return this.request(url, { method: 'DELETE' });
    }
  };

  /**
   * Admin API Service
   */
  const AdminApiService = {
    // 获取设置
    getSettings: function(group = null) {
      let url = '/settings';
      if (group) {
        url += `?group=${encodeURIComponent(group)}`;
      }
      return ApiService.get(url);
    },
    
    // 更新设置
    updateSettings: function(settingsData) {
      return ApiService.put('/settings/update', settingsData);
    },
    
    // 删除设置
    deleteSettings: function(key, group = 'general') {
      return ApiService.delete(`/settings?key=${encodeURIComponent(key)}&group=${encodeURIComponent(group)}`);
    }
  };

  function getLocalSettings() {
    const settings = JSON.parse(localStorage.getItem('settings') || '{}');
    return {
      general: {
        site_name: { value: settings.siteName || '' },
        contact_email: { value: settings.contactEmail || '' },
        phone_number: { value: settings.phoneNumber || '' },
        address: { value: settings.address || '' },
        facebook_link: { value: settings.facebookLink || '' },
        twitter_link: { value: settings.twitterLink || '' },
        instagram_link: { value: settings.instagramLink || '' }
      }
    };
  }

  function saveToLocalStorageOnly(settingsData) {
    const settings = {
      siteName: settingsData.general.site_name || '',
      contactEmail: settingsData.general.contact_email || '',
      phoneNumber: settingsData.general.phone_number || '',
      address: settingsData.general.address || '',
      facebookLink: settingsData.general.facebook_link || '',
      twitterLink: settingsData.general.twitter_link || '',
      instagramLink: settingsData.general.instagram_link || ''
    };
    
    localStorage.setItem('settings', JSON.stringify(settings));
    return settings;
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Load navbar and footer
    loadNavbar();
    loadFooter();
    
    // 检查管理员权限
    checkAdminPermissions();
  });

  function checkAdminPermissions() {
    // 检查用户是否为管理员
    const token = localStorage.getItem('authToken');
    console.log('🔐 检查管理员权限 - Token:', token ? '存在' : '不存在');
    
    if (!token) {
      // 未登录，重定向到登录页面
      console.log('❌ 未找到认证令牌，重定向到登录页面');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      return;
    }
    
    // 调用API验证用户权限
    console.log('📡 发送API请求: /auth/profile');
    ApiService.get('/auth/profile')
      .then(response => {
        console.log('✅ 收到profile响应:', response);
        if (!response.success || !response.data.isAdmin) {
          // 不是管理员，重定向到首页
          console.log('❌ 用户不是管理员，isAdmin =', response.data?.isAdmin);
          showToast('You do not have permission to access this area', 'danger');
          setTimeout(() => {
            window.location.href = '/src/client/views/index.html';
          }, 2000);
        } else {
          // 加载设置数据
          console.log('✅ 用户是管理员，加载设置数据');
          loadSettings();
        }
      })
      .catch(error => {
        console.error('❌ 检查管理员权限出错:', error);
        // 验证失败，重定向到登录页面
        showToast('Authentication error. Please login again.', 'danger');
        setTimeout(() => {
          window.location.href = '/src/client/views/auth/login.html?redirect=admin';
        }, 2000);
      });
  }

  function loadSettings() {
    // 显示加载中状态
    showToast('Loading settings...', 'info');
    
    // 从API获取设置
    AdminApiService.getSettings()
      .then(response => {
        if (response.success && response.data) {
          const settings = response.data;
          
          // 获取通用设置组
          const generalSettings = settings.general || {};
          
          document.getElementById('site-name').value = getSettingValue(generalSettings, 'site_name', '');
          document.getElementById('contact-email').value = getSettingValue(generalSettings, 'contact_email', '');
          document.getElementById('phone-number').value = getSettingValue(generalSettings, 'phone_number', '');
          document.getElementById('address').value = getSettingValue(generalSettings, 'address', '');
          document.getElementById('facebook-link').value = getSettingValue(generalSettings, 'facebook_link', '');
          document.getElementById('twitter-link').value = getSettingValue(generalSettings, 'twitter_link', '');
          document.getElementById('instagram-link').value = getSettingValue(generalSettings, 'instagram_link', '');
          
          showToast('Settings loaded successfully', 'success');
        } else {
          // 如果API请求失败，从localStorage加载
          loadSettingsFromLocalStorage();
          showToast('Failed to load settings from API, using local data', 'warning');
        }
      })
      .catch(error => {
        console.error('Error loading settings:', error);
        // 如果API请求失败，从localStorage加载
        loadSettingsFromLocalStorage();
        showToast('Error loading settings from API, using local data', 'warning');
      });
  }
  
  // 辅助函数 - 从设置对象中获取值
  function getSettingValue(settingsGroup, key, defaultValue = '') {
    if (!settingsGroup || !settingsGroup[key]) {
      return defaultValue;
    }
    
    // 处理不同的API响应格式
    if (typeof settingsGroup[key] === 'object' && settingsGroup[key].value !== undefined) {
      return settingsGroup[key].value;
    }
    
    return settingsGroup[key];
  }

  function loadSettingsFromLocalStorage() {
    const settings = JSON.parse(localStorage.getItem('settings') || '{}');
    document.getElementById('site-name').value = settings.siteName || '';
    document.getElementById('contact-email').value = settings.contactEmail || '';
    document.getElementById('phone-number').value = settings.phoneNumber || '';
    document.getElementById('address').value = settings.address || '';
    document.getElementById('facebook-link').value = settings.facebookLink || '';
    document.getElementById('twitter-link').value = settings.twitterLink || '';
    document.getElementById('instagram-link').value = settings.instagramLink || '';
  }

  function saveSettings() {
    // 显示保存中状态
    showToast('Saving settings...', 'info');
    
    // 获取表单值
    const settingsData = {
      general: {
        site_name: document.getElementById('site-name').value.trim(),
        contact_email: document.getElementById('contact-email').value.trim(),
        phone_number: document.getElementById('phone-number').value.trim(),
        address: document.getElementById('address').value.trim(),
        facebook_link: document.getElementById('facebook-link').value.trim(),
        twitter_link: document.getElementById('twitter-link').value.trim(),
        instagram_link: document.getElementById('instagram-link').value.trim()
      }
    };
    
    // 保存到API
    AdminApiService.updateSettings(settingsData)
      .then(response => {
        if (response.success) {
          showToast('Settings saved successfully', 'success');
          
          // 同时保存到localStorage作为备份
          const localSettings = {
            siteName: settingsData.general.site_name,
            contactEmail: settingsData.general.contact_email,
            phoneNumber: settingsData.general.phone_number,
            address: settingsData.general.address,
            facebookLink: settingsData.general.facebook_link,
            twitterLink: settingsData.general.twitter_link,
            instagramLink: settingsData.general.instagram_link
          };
          localStorage.setItem('settings', JSON.stringify(localSettings));
        } else {
          showToast('Failed to save settings: ' + (response.message || 'Unknown error'), 'error');
        }
      })
      .catch(error => {
        console.error('Error saving settings:', error);
        showToast('Error saving settings: ' + (error.message || 'Unknown error'), 'error');
      });
  }

  function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to their default values?')) {
      // 显示重置中状态
      showToast('Resetting settings...', 'info');
      
      // 准备空设置
      const emptySettings = {
        general: {
          site_name: '',
          contact_email: '',
          phone_number: '',
          address: '',
          facebook_link: '',
          twitter_link: '',
          instagram_link: ''
        }
      };
      
      // 更新到API
      AdminApiService.updateSettings(emptySettings)
        .then(response => {
          if (response.success) {
            // 同时清除本地存储
            localStorage.removeItem('settings');
            
            // 重新加载表单
            document.getElementById('site-name').value = '';
            document.getElementById('contact-email').value = '';
            document.getElementById('phone-number').value = '';
            document.getElementById('address').value = '';
            document.getElementById('facebook-link').value = '';
            document.getElementById('twitter-link').value = '';
            document.getElementById('instagram-link').value = '';
            
            showToast('Settings reset to default', 'success');
          } else {
            showToast('Failed to reset settings: ' + (response.message || 'Unknown error'), 'error');
          }
        })
        .catch(error => {
          console.error('Error resetting settings:', error);
          showToast('Error resetting settings: ' + (error.message || 'Unknown error'), 'error');
        });
    }
  }
  
  function showToast(message, type = 'success') {
    // 简单的toast实现，仅用于展示
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 300);
    }, 3000);
  }
</script>
</body>
</html> 