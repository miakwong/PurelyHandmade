<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Category Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Style for action buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Admin button styles */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
    
    /* Style for category featured badge */
    .badge-success {
      background-color: #5a8c70;
      color: white;
    }
    
    .category-management-card {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .category-table th {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
    }
    
    .category-table tbody tr:hover {
      background-color: rgba(134, 118, 102, 0.05);
    }
    
    .empty-state-icon {
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-size: 2.5rem;
      color: #ccc;
      background-color: #f8f9fa;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .product-image-small {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #eaeaea;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-tags me-2 text-primary"></i>Category Management</h1>
    <div>
      <a href="dashboard.html" class="btn btn-outline-secondary me-2">
        <i class="bi bi-speedometer2 me-2"></i>Dashboard
      </a>
      <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
        <i class="bi bi-person me-2"></i>Back to Profile
      </a>
    </div>
  </div>

  <div class="card mb-4 category-management-card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col">
          <h5 class="mb-0">Category Management</h5>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="resetCategoryForm()">
            <i class="bi bi-plus-circle me-2"></i>Add Category
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover category-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>Description</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="category-table-body">
            <!-- Category data will be loaded here -->
          </tbody>
        </table>
        <div id="no-categories-message" class="d-none text-center py-5">
          <div class="empty-state-icon mx-auto mb-3">
            <i class="bi bi-folder-x"></i>
          </div>
          <p class="text-muted mb-3">No categories found</p>
          <button class="btn btn-primary" onclick="resetCategoryForm()">
            Add Your First Category
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id">
          
          <div class="admin-form-group">
            <label for="category-name" class="admin-form-label">Category Name<span class="text-danger">*</span></label>
            <input type="text" class="admin-form-control" id="category-name" required placeholder="Enter category name">
            <div class="form-text">A clear, concise name for your product category</div>
          </div>
          
          <div class="admin-form-group">
            <label for="category-description" class="admin-form-label">Description</label>
            <textarea class="admin-form-control" id="category-description" rows="3" placeholder="Briefly describe what types of products belong in this category"></textarea>
            <div class="form-text">Optional: Describe the types of products that will be included</div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Category Image</label>
            <div class="d-flex align-items-start mb-2">
              <div class="product-preview me-3" style="width: 120px; height: 120px;">
                <img id="category-img-preview" src="../../../img/profile.png" alt="Category preview">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="admin-form-control mb-2" id="category-image-file" accept="image/*">
                <div class="form-text mb-2">Recommended size: 400Ã—400px</div>
                <div class="d-grid">
                  <button type="button" class="admin-btn admin-btn-warning" onclick="resetCategoryImage()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Image
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="category-featured">
              <label class="form-check-label" for="category-featured">
                Featured Category
              </label>
              <div class="form-text">Featured categories will be highlighted on the homepage</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveCategory()">
          <i class="bi bi-check2 me-1"></i>Save Category
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load nav and footer
    loadNavbar();
    loadFooter();
    
    // Load categories data
    loadCategories();
    
    // Set up image preview
    document.getElementById('category-image-file').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('category-img-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Check user permissions
    checkAdminPermissions();
  });
  
  // Category management functions
  function loadCategories() {
    // Get categories from localStorage
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const tableBody = document.getElementById('category-table-body');
    const noCategories = document.getElementById('no-categories-message');
    
    if (!tableBody) {
      console.error('category-table-body element not found! DOM may not be fully loaded.');
      return; // Exit the function early if tableBody doesn't exist
    }
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    // Get products to count items in each category
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    
    if (categories.length === 0) {
      // No categories found, show empty state message
      tableBody.parentElement.classList.add('d-none');
      noCategories.classList.remove('d-none');
    } else {
      // Show table and hide empty state
      tableBody.parentElement.classList.remove('d-none');
      noCategories.classList.add('d-none');
      
      // Add category rows
      categories.forEach(category => {
        const productCount = products.filter(product => product.categoryId === category.id).length;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="product-image-small">
              <img src="${category.image || '../../../img/profile.png'}" 
                   alt="${category.name}" 
                   style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          </td>
          <td>
            <div class="d-flex flex-column">
              <div class="fw-medium">${category.name || 'Unnamed Category'}</div>
              ${category.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
            </div>
          </td>
          <td class="text-truncate" style="max-width: 250px;">
            ${category.description ? category.description : '<span class="text-muted fst-italic">No description</span>'}
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editCategory(${category.id})" data-bs-toggle="tooltip" title="Edit Category">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteCategory(${category.id})" data-bs-toggle="tooltip" title="Delete Category">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Initialize tooltips
      const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltips.map(tooltip => new bootstrap.Tooltip(tooltip));
    }
  }

  function resetCategoryForm() {
    // Reset form to default values
    document.getElementById('category-form').reset();
    document.getElementById('categoryModalLabel').textContent = 'Add Category';
    document.getElementById('category-id').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
  }
  
  function resetCategoryImage() {
    // Reset the image to default placeholder
    document.getElementById('category-image-file').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
  }

  function editCategory(categoryId) {
    // Get category data
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const category = categories.find(c => c.id === categoryId);
    
    if (category) {
      // Populate form with category data
      document.getElementById('categoryModalLabel').textContent = 'Edit Category';
      document.getElementById('category-id').value = category.id;
      document.getElementById('category-name').value = category.name || '';
      document.getElementById('category-description').value = category.description || '';
      document.getElementById('category-featured').checked = category.featured || false;
      
      // Reset file input
      document.getElementById('category-image-file').value = '';
      
      // Update image preview
      const imgPreview = document.getElementById('category-img-preview');
      if (category.image) {
        imgPreview.src = category.image;
      } else {
        imgPreview.src = '../../../img/profile.png';
      }
      
      // Show the modal
      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    } else {
      showToast('Category not found', 'danger');
    }
  }

  function saveCategory() {
    // Get form values
    const categoryId = document.getElementById('category-id').value;
    const name = document.getElementById('category-name').value.trim();
    const description = document.getElementById('category-description').value.trim();
    const featured = document.getElementById('category-featured').checked;
    
    if (!name) {
      showToast('Category name is required', 'danger');
      return;
    }
    
    // Process image if one is selected
    const imageFile = document.getElementById('category-image-file').files[0];
    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        saveCategoryData(categoryId, name, description, featured, e.target.result);
      };
      reader.readAsDataURL(imageFile);
    } else {
      // If editing and no new image is selected, keep the existing one
      if (categoryId) {
        const categories = JSON.parse(localStorage.getItem('categories') || '[]');
        const category = categories.find(c => c.id === categoryId);
        saveCategoryData(categoryId, name, description, featured, category ? category.image : null);
      } else {
        saveCategoryData(categoryId, name, description, featured, null);
      }
    }
  }
  
  function saveCategoryData(categoryId, name, description, featured, image) {
    // Get existing categories
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // Create slug from name
    const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    
    if (categoryId) {
      // Update existing category
      const index = categories.findIndex(c => c.id === categoryId);
      if (index !== -1) {
        categories[index] = {
          ...categories[index],
          name,
          slug,
          description,
          featured,
          image: image || categories[index].image
        };
        showToast('Category updated successfully', 'success');
      }
    } else {
      // Create new category
      categories.push({
        id: Date.now().toString(),
        name,
        slug,
        description,
        featured,
        image
      });
      showToast('Category created successfully', 'success');
    }
    
    // Save to localStorage
    localStorage.setItem('categories', JSON.stringify(categories));
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
    
    // Reload categories
    loadCategories();
  }

  function deleteCategory(categoryId) {
    // Get categories
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // Check if category exists
    const category = categories.find(c => c.id === categoryId);
    if (!category) {
      showToast('Category not found', 'danger');
      return;
    }
    
    // Get products
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    
    // Check if any products use this category
    const productsWithCategory = products.filter(p => p.categoryId === categoryId);
    
    if (productsWithCategory.length > 0) {
      if (!confirm(`This category is used by ${productsWithCategory.length} product(s). Deleting it will remove the category association from these products. Do you want to continue?`)) {
        return;
      }
      
      // Update products to remove category
      productsWithCategory.forEach(product => {
        product.categoryId = null;
      });
      
      // Save updated products
      localStorage.setItem('products', JSON.stringify(products));
    } else {
      if (!confirm('Are you sure you want to delete this category?')) {
        return;
      }
    }
    
    // Remove category
    const updatedCategories = categories.filter(c => c.id !== categoryId);
    localStorage.setItem('categories', JSON.stringify(updatedCategories));
    
    showToast('Category deleted successfully', 'success');
    
    // Reload categories
    loadCategories();
  }
  
  function checkAdminPermissions() {
    // Check if user is logged in and is admin
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || currentUser.role !== 'admin') {
      // Redirect to login if not admin
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      alert('You must be logged in as an administrator to access this page.');
    }
  }
  
  // Helper function to show toast notifications
  function showToast(message, type = 'primary') {
    const toastContainer = document.querySelector('.toast-container');
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      toastElement.remove();
    });
  }
</script>
</body>
</html> 