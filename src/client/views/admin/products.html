<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Style for action buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Admin button styles */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
    
    /* Style for badges */
    .badge-success {
      background-color: #5a8c70;
      color: white;
    }
    
    .badge-warning {
      background-color: #e6a23c;
      color: white;
    }
    
    .badge-danger {
      background-color: #d9534f;
      color: white;
    }
    
    .product-management-card {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .product-table th {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
    }
    
    .product-table tbody tr:hover {
      background-color: rgba(134, 118, 102, 0.05);
    }
    
    .empty-state-icon {
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-size: 2.5rem;
      color: #ccc;
      background-color: #f8f9fa;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .product-image-small {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #eaeaea;
    }
    
    .product-gallery-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .product-gallery-item {
      position: relative;
      width: 100px;
      height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .product-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-gallery-item .remove-image {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .product-price {
      font-weight: bold;
      color: #5a8c70;
    }
    
    /* Filter section styles */
    .filter-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    
    /* Review styles */
    .review-item .card-footer {
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .review-item {
      transition: all 0.2s ease-in-out;
    }
    
    .review-item:hover {
      border-color: #ddd;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .review-avatar img {
      object-fit: cover;
      border: 1px solid #eee;
    }
    
    .review-content {
      white-space: pre-line;
      line-height: 1.5;
    }
    
    .review-date {
      font-size: 0.85rem;
    }
    
    .review-badge-pending {
      background-color: #ffc107;
      color: #212529;
    }
    
    .review-badge-approved {
      background-color: #5a8c70;
      color: white;
    }
    
    .review-badge-rejected {
      background-color: #dc3545;
      color: white;
    }
    
    .review-stats {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .review-stats-item {
      display: inline-flex;
      align-items: center;
      font-size: 0.85rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="products.html">
              <i class="bi bi-box me-2"></i>
              Products
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="categories.html">
              <i class="bi bi-tags me-2"></i>
              Categories
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="designers.html">
              <i class="bi bi-palette me-2"></i>
              Designers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="orders.html">
              <i class="bi bi-cart-check me-2"></i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="users.html">
              <i class="bi bi-people me-2"></i>
              Users
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="comments.html">
              <i class="bi bi-chat-dots me-2"></i>
              Reviews
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-graph-up me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-box-seam me-2 text-primary"></i>Product Management</h1>
        <div>
      <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
        <i class="bi bi-person me-2"></i>Back to Profile
      </a>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="filter-category" class="form-label">Category</label>
        <select class="form-select" id="filter-category">
          <option value="">All Categories</option>
          <!-- Categories will be loaded here -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-designer" class="form-label">Designer</label>
        <select class="form-select" id="filter-designer">
          <option value="">All Designers</option>
          <!-- Designers will be loaded here -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-status" class="form-label">Status</label>
        <select class="form-select" id="filter-status">
          <option value="">All Status</option>
          <option value="in-stock">In Stock</option>
          <option value="low-stock">Low Stock</option>
          <option value="out-of-stock">Out of Stock</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-search" class="form-label">Search</label>
        <input type="text" class="form-control" id="filter-search" placeholder="Search products...">
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-secondary me-2" onclick="resetFilters()">
          <i class="bi bi-x-circle me-2"></i>Clear Filters
        </button>
        <button class="btn btn-primary" onclick="applyFilters()">
          <i class="bi bi-funnel me-2"></i>Apply Filters
        </button>
      </div>
    </div>
  </div>

  <div class="card mb-4 product-management-card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col">
          <h5 class="mb-0">Product Management</h5>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="resetProductForm()">
            <i class="bi bi-plus-circle me-2"></i>Add Product
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover product-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Product</th>
              <th>Price</th>
              <th>Status</th>
              <th>Category</th>
              <th>Designer</th>
              <th>Reviews</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="product-table-body">
            <!-- Product data will be loaded here -->
          </tbody>
        </table>
        <div id="no-products-message" class="d-none text-center py-5">
          <div class="empty-state-icon mx-auto mb-3">
            <i class="bi bi-box"></i>
          </div>
          <p class="text-muted mb-3">No products found</p>
          <button class="btn btn-primary" onclick="resetProductForm()">
            Add Your First Product
          </button>
        </div>
      </div>
    </div>
      </div>
    </main>
  </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="product-form">
          <input type="hidden" id="product-id">
          
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-group">
                <label for="product-name" class="admin-form-label">Product Name<span class="text-danger">*</span></label>
                <input type="text" class="admin-form-control" id="product-name" required placeholder="Enter product name">
                <div class="form-text">A clear, descriptive name for your product</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="admin-form-group">
                <label for="product-sku" class="admin-form-label">SKU</label>
                <input type="text" class="admin-form-control" id="product-sku" placeholder="Enter SKU code">
                <div class="form-text">Stock Keeping Unit (optional)</div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-price" class="admin-form-label">Price<span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="admin-form-control" id="product-price" required min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-stock" class="admin-form-label">Stock Quantity<span class="text-danger">*</span></label>
                <input type="number" class="admin-form-control" id="product-stock" required min="0" placeholder="Enter stock quantity">
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-category" class="admin-form-label">Category</label>
                <select class="admin-form-control" id="product-category">
                  <option value="">-- Select Category --</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-designer" class="admin-form-label">Designer</label>
                <select class="admin-form-control" id="product-designer">
                  <option value="">-- Select Designer --</option>
                  <!-- Designers will be loaded here -->
                </select>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label for="product-description" class="admin-form-label">Description<span class="text-danger">*</span></label>
            <textarea class="admin-form-control" id="product-description" rows="4" required placeholder="Describe your product in detail..."></textarea>
            <div class="form-text">Provide a detailed description of your product</div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Main Product Image<span class="text-danger">*</span></label>
            <div class="d-flex align-items-start mb-2">
              <div class="product-preview me-3" style="width: 120px; height: 120px;">
                <img id="product-img-preview" src="/src/client/img/profile.png" alt="Product preview">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="admin-form-control mb-2" id="product-image-file" accept="image/*">
                <div class="form-text mb-2">Recommended size: 800×800px</div>
                <div class="d-grid">
                  <button type="button" class="admin-btn admin-btn-warning" onclick="resetProductImage()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Image
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Additional Images</label>
            <input type="file" class="admin-form-control mb-2" id="product-gallery-file" accept="image/*" multiple>
            <div class="form-text mb-2">Add up to 5 additional images (optional)</div>
            
            <div id="product-gallery-preview" class="product-gallery-container">
              <!-- Gallery images will be previewed here -->
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4">
              <div class="admin-form-group">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="product-featured">
                  <label class="form-check-label" for="product-featured">
                    Featured Product
                  </label>
                  <div class="form-text">Featured products will be highlighted on the homepage</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="admin-form-group">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="product-onsale">
                  <label class="form-check-label" for="product-onsale">
                    On Sale
                  </label>
                  <div class="form-text">Products on sale will be displayed with discount badge</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="admin-form-group">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="product-active" checked>
                  <label class="form-check-label" for="product-active">
                    Active Product
                  </label>
                  <div class="form-text">Inactive products won't be displayed on the store</div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveProduct()">
          <i class="bi bi-check2 me-1"></i>Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Review Management Modal after the product modal -->
<div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewsModalLabel">Product Reviews</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0" id="review-product-name">Reviews for Product</h6>
          <div class="d-flex align-items-center">
            <div id="review-stats" class="me-3">
              <!-- Review stats will be loaded here -->
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshReviews()">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
          </div>
        </div>
        
        <div id="reviews-container">
          <!-- Reviews will be loaded here -->
          <div id="no-reviews-message" class="text-center py-4">
            <div class="empty-state-icon mx-auto mb-3">
              <i class="bi bi-chat-square"></i>
            </div>
            <p class="text-muted mb-0">No reviews found for this product</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add review item template (hidden) -->
<template id="review-item-template">
  <div class="review-item card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="d-flex align-items-center">
          <div class="review-avatar me-2">
            <img src="/src/client/img/profile.png" alt="User" class="rounded-circle" width="40" height="40">
          </div>
          <div>
            <div class="fw-medium review-author">Customer Name</div>
            <div class="text-muted small review-date">Date</div>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <div class="review-rating me-3">
            <i class="bi bi-star-fill text-warning"></i>
            <span class="ms-1 rating-value">5</span>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item approve-review" href="#"><i class="bi bi-check-circle me-2"></i>Approve</a></li>
              <li><a class="dropdown-item reject-review" href="#"><i class="bi bi-x-circle me-2"></i>Reject</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item delete-review" href="#"><i class="bi bi-trash me-2"></i>Delete</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="review-content">
        Content of the review...
      </div>
    </div>
    <div class="card-footer bg-light py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="review-status">
          <span class="badge"></span>
        </div>
        <div class="review-actions">
          <button class="btn btn-sm btn-outline-primary me-1 reply-review">
            <i class="bi bi-reply me-1"></i>Reply
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

    </main>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 直接在页面中内联定义关键服务，避免加载问题 -->
<script>
/**
 * API Service for Purely Handmade
 * 提供统一的API访问层，处理所有与服务器的通信
 */
const ApiService = {
  // 基础API URL
  baseUrl: '/api',
  
  // 获取授权令牌
  getAuthToken: function() {
    const token = localStorage.getItem('authToken');
    // 移除日志，避免频繁输出
    return token;
  },
  
  // 获取带有授权信息的请求头
  getAuthHeaders: function() {
    const token = this.getAuthToken();
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    };
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      // 移除日志，避免频繁输出
    }
    
    return headers;
  },
  
  // 处理API响应
  handleResponse: async function(response) {
    const contentType = response.headers.get('content-type');
    const isJson = contentType && contentType.includes('application/json');
    
    // 如果状态码不在2xx范围内，抛出错误
    if (!response.ok) {
      let errorData;
      
      try {
        errorData = isJson ? await response.json() : await response.text();
      } catch (error) {
        errorData = 'Failed to parse error response';
      }
      
      const error = new Error(
        isJson && errorData.error 
          ? errorData.error 
          : 'API request failed'
      );
      
      error.status = response.status;
      error.statusText = response.statusText;
      error.data = errorData;
      
      throw error;
    }
    
    // 解析成功响应
    return isJson ? response.json() : response.text();
  },
  
  // 发送请求
  request: async function(url, options = {}) {
    const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
    
    // 默认选项
    const defaultOptions = {
      headers: this.getAuthHeaders(),
      credentials: 'same-origin',
    };
    
    // 合并选项
    const fetchOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...options.headers,
      },
    };
    
    try {
      const response = await fetch(fullUrl, fetchOptions);
      return await this.handleResponse(response);
    } catch (error) {
      console.error('API request failed:', error);
      throw error;
    }
  },
  
  // GET请求
  get: function(url, params = {}) {
    // 构建查询字符串
    const queryParams = new URLSearchParams();
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        queryParams.append(key, params[key]);
      }
    });
    
    const queryString = queryParams.toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    
    return this.request(fullUrl, { method: 'GET' });
  },
  
  // POST请求
  post: function(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  
  // PUT请求
  put: function(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
  
  // DELETE请求
  delete: function(url) {
    return this.request(url, { method: 'DELETE' });
  }
};

/**
 * Admin API Service for Purely Handmade
 * 提供管理员API访问层，处理与服务器的管理功能通信
 */
const AdminApiService = {
  // 获取所有用户
  getAllUsers: function() {
    return ApiService.get('/auth/profile?all=1');
  },
  
  // 获取所有产品
  getAllProducts: function() {
    return ApiService.get('/products');
  },
  
  // 添加新产品
  addProduct: function(productData) {
    return ApiService.post('/products/create', productData);
  },
  
  // 更新产品
  updateProduct: function(productId, productData) {
    return ApiService.put(`/products/update`, { id: productId, ...productData });
  },
  
  // 删除产品
  deleteProduct: function(productId) {
    return ApiService.delete(`/products?id=${productId}`);
  },
  
  // 获取所有类别
  getAllCategories: function() {
    return ApiService.get('/categories');
  },
  
  // 添加新类别
  addCategory: function(categoryData) {
    return ApiService.post('/categories/create', categoryData);
  },
  
  // 更新类别
  updateCategory: function(categoryId, categoryData) {
    return ApiService.put(`/categories/update`, { id: categoryId, ...categoryData });
  },
  
  // 删除类别
  deleteCategory: function(categoryId) {
    return ApiService.delete(`/categories?id=${categoryId}`);
  },
  
  // 获取所有设计师
  getAllDesigners: function() {
    return ApiService.get('/designers');
  },
  
  // 获取所有订单
  getAllOrders: function() {
    return ApiService.get('/orders');
  },
  
  // 获取所有评论
  getAllReviews: function() {
    return ApiService.get('/reviews');
  }
};
</script>

<script src="/src/client/js/data-service.js"></script>
<script src="/src/client/js/ui-helpers.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  // Store gallery images for the current product
  let productGalleryImages = [];
  // Current filters
  let currentFilters = {
    category: '',
    designer: '',
    status: '',
    search: ''
  };
  
  // Store current product for reviews
  let currentReviewProductId = null;
  
  // 全局加载状态标记
  let isLoading = false;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Load nav and footer
    if (typeof UIHelpers !== 'undefined') {
      UIHelpers.loadNavbar();
      UIHelpers.loadFooter();
    } else {
    loadNavbar();
    loadFooter();
    }
    
    // Check user permissions
    checkAdminPermissions();
    
    // Set up search filter event
    document.getElementById('filter-search').addEventListener('keyup', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  });
  
  // Initialize product management functionality
  function initProductManagement() {
    // 显示全局加载状态
    showPageLoadingState();
    
    // 并行加载所有数据
    Promise.all([
      loadProducts(),
      loadCategoriesForDropdown(),
      loadDesignersForDropdown()
    ])
    .then(() => {
      // 隐藏全局加载状态
      hidePageLoadingState();
    })
    .catch(error => {
      console.error('初始化失败:', error);
      showErrorMessage('加载数据时出错，请刷新页面或稍后再试。');
      hidePageLoadingState();
    });
    
    // Set up image preview for main product image
    document.getElementById('product-image-file').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('product-img-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Set up gallery image preview
    document.getElementById('product-gallery-file').addEventListener('change', function(event) {
      const files = event.target.files;
      if (files && files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          if (productGalleryImages.length >= 5) {
            showToast('Maximum of 5 gallery images allowed', 'warning');
            break;
          }
          
          const file = files[i];
          const reader = new FileReader();
          reader.onload = function(e) {
            productGalleryImages.push(e.target.result);
            updateGalleryPreview();
          };
          reader.readAsDataURL(file);
        }
      }
    });
  }
  
  // 显示页面全局加载状态
  function showPageLoadingState() {
    isLoading = true;
    
    // 创建一个加载蒙层
    if (!document.getElementById('global-loading')) {
      const loadingEl = document.createElement('div');
      loadingEl.id = 'global-loading';
      loadingEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
      loadingEl.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-primary fw-bold">正在加载数据...</p>
        </div>
      `;
      document.body.appendChild(loadingEl);
    } else {
      document.getElementById('global-loading').style.display = 'flex';
    }
  }
  
  // 隐藏页面全局加载状态
  function hidePageLoadingState() {
    isLoading = false;
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
    }
  }
  
  // 显示错误消息
  function showErrorMessage(message) {
    const main = document.querySelector('main');
    if (main) {
      const alertEl = document.createElement('div');
      alertEl.className = 'alert alert-danger alert-dismissible fade show my-3';
      alertEl.role = 'alert';
      alertEl.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // 插入到页面顶部
      if (main.firstChild) {
        main.insertBefore(alertEl, main.firstChild);
      } else {
        main.appendChild(alertEl);
      }
    } else {
      // 如果找不到main元素，使用toast
      showToast(message, 'danger');
    }
  }
  
  // Product management functions
  async function loadProducts() {
    const tableBody = document.getElementById('product-table-body');
    const noProducts = document.getElementById('no-products-message');
    
    if (!tableBody) {
      console.error('product-table-body element not found! DOM may not be fully loaded.');
      return; // Exit the function early if tableBody doesn't exist
    }
    
    // 显示加载状态
    tableBody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading products...</p>
        </td>
      </tr>
    `;
    
    try {
      // 从API获取产品数据
      const result = await AdminApiService.getAllProducts();
      if (!result.success) {
        throw new Error(result.message || 'Failed to load products');
      }
      
      // 正确处理API返回结构
      let products = [];
      if (result.data) {
        if (Array.isArray(result.data)) {
          products = result.data;
        } else if (result.data.products && Array.isArray(result.data.products)) {
          products = result.data.products;
        } else {
          console.error('API返回的products格式不正确:', result.data);
        }
      }
      
      // 应用过滤器（如果有产品）
      if (products.length > 0) {
        products = filterProducts(products);
      }
      
      // 清空现有行
      tableBody.innerHTML = '';
    
      if (products.length === 0) {
        // 没有产品，显示空状态消息
        tableBody.parentElement.classList.add('d-none');
        noProducts.classList.remove('d-none');
      } else {
        // 显示表格，隐藏空状态
        tableBody.parentElement.classList.remove('d-none');
        noProducts.classList.add('d-none');
      
        // 获取类别和设计师数据-使用缓存避免重复请求
        let categories = window.adminCachedCategories || [];
        let designers = window.adminCachedDesigners || [];
        
        if (!categories.length) {
          const catResult = await AdminApiService.getAllCategories();
          categories = Array.isArray(catResult.data) ? catResult.data : [];
          window.adminCachedCategories = categories;
        }
        
        if (!designers.length) {
          const designerResult = await AdminApiService.getAllDesigners();
          designers = Array.isArray(designerResult.data) ? designerResult.data : [];
          window.adminCachedDesigners = designers;
        }
        
        // 添加产品行
        products.forEach(product => {
          // 查找类别和设计师名称
          const category = categories.find(c => c.id == product.categoryId);
          const designer = designers.find(d => d.id == product.designerId);
          
          // 确定库存状态徽章
          let stockBadge;
          if (product.stock <= 0) {
            stockBadge = '<span class="badge badge-danger">Out of Stock</span>';
          } else if (product.stock <= 5) {
            stockBadge = '<span class="badge badge-warning">Low Stock</span>';
          } else {
            stockBadge = '<span class="badge badge-success">In Stock</span>';
          }
          
          const row = document.createElement('tr');
          row.setAttribute('data-product-id', product.id);
          row.innerHTML = `
            <td>
              <div class="product-image-small">
                <img src="${product.image || '/src/client/img/profile.png'}" 
                     alt="${product.name}" 
                     style="width: 100%; height: 100%; object-fit: cover;">
              </div>
            </td>
            <td>
              <div class="d-flex flex-column">
                <div class="fw-medium">${product.name || 'Unnamed Product'}</div>
                <small class="text-muted">${product.sku || 'No SKU'}</small>
                ${product.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
                ${!product.active ? '<span class="badge bg-secondary mt-1">Inactive</span>' : ''}
              </div>
            </td>
            <td class="product-price">$${parseFloat(product.price).toFixed(2)}</td>
            <td>${stockBadge}</td>
            <td>${category ? category.name : '<span class="text-muted">Uncategorized</span>'}</td>
            <td>${designer ? designer.name : '<span class="text-muted">No Designer</span>'}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary" onclick="viewProductReviews('${product.id}')">
                <i class="bi bi-chat-left-text me-1"></i>
                  <span class="review-count">${product.reviewCount || 0}</span>
              </button>
            </td>
            <td class="text-center">
              <div class="action-buttons">
                <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editProduct('${product.id}')" data-bs-toggle="tooltip" title="Edit Product">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteProduct('${product.id}')" data-bs-toggle="tooltip" title="Delete Product">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // 初始化提示工具
        const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltips.map(tooltip => new bootstrap.Tooltip(tooltip));
      }
    } catch (error) {
      console.error('加载产品时出错:', error);
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center py-4">
            <div class="alert alert-danger mb-0">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              加载产品数据时出错，请刷新页面或稍后再试。
            </div>
          </td>
        </tr>
      `;
    }
  }

  function filterProducts(products) {
    if (!Array.isArray(products)) {
      console.error('filterProducts: 参数不是数组', products);
      return [];
    }
    
    return products.filter(product => {
      // Apply category filter
      if (currentFilters.category && product.categoryId != currentFilters.category) {
        return false;
      }
      
      // Apply designer filter
      if (currentFilters.designer && product.designerId != currentFilters.designer) {
        return false;
      }
      
      // Apply status filter
      if (currentFilters.status) {
        if (currentFilters.status === 'out-of-stock' && product.stock > 0) {
          return false;
        } else if (currentFilters.status === 'low-stock' && (product.stock <= 0 || product.stock > 5)) {
          return false;
        } else if (currentFilters.status === 'in-stock' && product.stock <= 5) {
          return false;
        }
      }
      
      // Apply search filter
      if (currentFilters.search) {
        const searchTerm = currentFilters.search.toLowerCase();
        return (
          product.name.toLowerCase().includes(searchTerm) ||
          (product.description && product.description.toLowerCase().includes(searchTerm)) ||
          (product.sku && product.sku.toLowerCase().includes(searchTerm))
        );
      }
      
      return true;
    });
  }

  function applyFilters() {
    currentFilters = {
      category: document.getElementById('filter-category').value,
      designer: document.getElementById('filter-designer').value,
      status: document.getElementById('filter-status').value,
      search: document.getElementById('filter-search').value.trim()
    };
    
    loadProducts();
  }

  function resetFilters() {
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-designer').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-search').value = '';
    
    currentFilters = {
      category: '',
      designer: '',
      status: '',
      search: ''
    };
    
    loadProducts();
  }

  async function loadCategoriesForDropdown() {
    const categoryDropdown = document.getElementById('product-category');
    const filterDropdown = document.getElementById('filter-category');
    
    try {
      const result = await AdminApiService.getAllCategories();
      
      // 正确处理API返回结构
      let categories = [];
      if (result.data) {
        if (Array.isArray(result.data)) {
          categories = result.data;
        } else if (result.data.categories && Array.isArray(result.data.categories)) {
          categories = result.data.categories;
        } else {
          console.error('API返回的categories格式不正确:', result.data);
        }
      }
      
      // 缓存类别数据
      window.adminCachedCategories = categories;
      
      // 填充产品表单下拉菜单
      if (categoryDropdown) {
        // 保留第一个选项并添加类别
        const defaultOption = categoryDropdown.options[0];
        categoryDropdown.innerHTML = '';
        categoryDropdown.appendChild(defaultOption);
        
        if (categories.length > 0) {
          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categoryDropdown.appendChild(option);
          });
        }
      }
      
      // 填充筛选下拉菜单
      if (filterDropdown) {
        // 保留第一个选项并添加类别
        const defaultOption = filterDropdown.options[0];
        filterDropdown.innerHTML = '';
        filterDropdown.appendChild(defaultOption);
        
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          filterDropdown.appendChild(option);
        });
      }
    } catch (error) {
      console.error('加载类别时出错:', error);
      showToast('加载类别数据时出错，某些功能可能不可用', 'warning');
    }
  }

  async function loadDesignersForDropdown() {
    const designerDropdown = document.getElementById('product-designer');
    const filterDropdown = document.getElementById('filter-designer');
    
    try {
      const result = await AdminApiService.getAllDesigners();
      
      // 正确处理API返回结构
      let designers = [];
      if (result.data) {
        if (Array.isArray(result.data)) {
          designers = result.data;
        } else if (result.data.designers && Array.isArray(result.data.designers)) {
          designers = result.data.designers;
        } else {
          console.error('API返回的designers格式不正确:', result.data);
        }
      }
      
      // 缓存设计师数据
      window.adminCachedDesigners = designers;
      
      // 填充产品表单下拉菜单
      if (designerDropdown) {
        // 保留第一个选项并添加设计师
        const defaultOption = designerDropdown.options[0];
        designerDropdown.innerHTML = '';
        designerDropdown.appendChild(defaultOption);
        
        if (designers.length > 0) {
          designers.forEach(designer => {
            const option = document.createElement('option');
            option.value = designer.id;
            option.textContent = designer.name;
            designerDropdown.appendChild(option);
          });
        }
      }
      
      // 填充筛选下拉菜单
      if (filterDropdown) {
        // 保留第一个选项并添加设计师
        const defaultOption = filterDropdown.options[0];
        filterDropdown.innerHTML = '';
        filterDropdown.appendChild(defaultOption);
        
        designers.forEach(designer => {
          const option = document.createElement('option');
          option.value = designer.id;
          option.textContent = designer.name;
          filterDropdown.appendChild(option);
        });
      }
    } catch (error) {
      console.error('加载设计师时出错:', error);
      showToast('加载设计师数据时出错，某些功能可能不可用', 'warning');
    }
  }

  function resetProductForm() {
    // 重置表单为默认值
    document.getElementById('product-form').reset();
    document.getElementById('productModalLabel').textContent = 'Add Product';
    document.getElementById('product-id').value = '';
    document.getElementById('product-img-preview').src = '/src/client/img/profile.png';
    
    // 清除画廊图片
    productGalleryImages = [];
    updateGalleryPreview();
    
    // 设置默认活动状态
    document.getElementById('product-active').checked = true;
    
    // 显示模态窗口
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }
  
  function resetProductImage() {
    // 将图像重置为默认占位符
    document.getElementById('product-image-file').value = '';
    document.getElementById('product-img-preview').src = '/src/client/img/profile.png';
  }
  
  function updateGalleryPreview() {
    const galleryContainer = document.getElementById('product-gallery-preview');
    galleryContainer.innerHTML = '';
    
    if (productGalleryImages.length === 0) {
      return;
    }
    
    productGalleryImages.forEach((imageSrc, index) => {
      const galleryItem = document.createElement('div');
      galleryItem.className = 'product-gallery-item';
      galleryItem.innerHTML = `
        <img src="${imageSrc}" alt="Gallery image ${index + 1}">
        <div class="remove-image" onclick="removeGalleryImage(${index})">
          <i class="bi bi-x-circle"></i>
        </div>
      `;
      galleryContainer.appendChild(galleryItem);
    });
  }
  
  function removeGalleryImage(index) {
    productGalleryImages.splice(index, 1);
    updateGalleryPreview();
  }

  async function editProduct(productId) {
    showToast('正在加载产品数据...', 'info');
    
    try {
      // 获取产品数据
      const result = await AdminApiService.getAllProducts();
      
      // 正确处理API返回结构
      let products = [];
      if (result.data) {
        if (Array.isArray(result.data)) {
          products = result.data;
        } else if (result.data.products && Array.isArray(result.data.products)) {
          products = result.data.products;
        } else {
          console.error('API返回的products格式不正确:', result.data);
        }
      }
      
      // 查找指定ID的产品
      const productIdStr = String(productId);
      const product = products.find(p => String(p.id) === productIdStr);
      
      if (product) {
        console.log('找到产品:', product);
        // 用产品数据填充表单
        document.getElementById('productModalLabel').textContent = 'Edit Product';
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-sku').value = product.sku || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-stock').value = product.stock || '';
        document.getElementById('product-category').value = product.categoryId || '';
        document.getElementById('product-designer').value = product.designerId || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-featured').checked = product.featured || false;
        document.getElementById('product-onsale').checked = product.onSale || false;
        document.getElementById('product-active').checked = product.active !== false; // 如果未指定，则默认为true
        
        // 重置文件输入
        document.getElementById('product-image-file').value = '';
        document.getElementById('product-gallery-file').value = '';
        
        // 更新图像预览
        const imgPreview = document.getElementById('product-img-preview');
        if (product.image) {
          imgPreview.src = product.image;
        } else {
          imgPreview.src = '/src/client/img/profile.png';
        }
        
        // 加载图库图像
        productGalleryImages = product.gallery || [];
        updateGalleryPreview();
        
        // 显示模态窗口
        new bootstrap.Modal(document.getElementById('productModal')).show();
      } else {
        console.error('未找到ID为以下ID的产品:', productId);
        console.log('数据库中的产品ID:', products.map(p => p.id));
        showToast('未找到产品', 'danger');
      }
    } catch (error) {
      console.error('编辑产品时出错:', error);
      showToast('加载产品数据时出错', 'danger');
    }
  }

  async function saveProduct() {
    // 获取表单值
    const productId = document.getElementById('product-id').value;
    const name = document.getElementById('product-name').value.trim();
    const sku = document.getElementById('product-sku').value.trim();
    const price = parseFloat(document.getElementById('product-price').value);
    const stock = parseInt(document.getElementById('product-stock').value);
    const categoryId = document.getElementById('product-category').value;
    const designerId = document.getElementById('product-designer').value;
    const description = document.getElementById('product-description').value.trim();
    const featured = document.getElementById('product-featured').checked;
    const onSale = document.getElementById('product-onsale').checked;
    const active = document.getElementById('product-active').checked;
    
    // 验证
    if (!name) {
      showToast('产品名称是必填项', 'danger');
      return;
    }
    
    if (isNaN(price) || price < 0) {
      showToast('请输入有效的价格', 'danger');
      return;
    }
    
    if (isNaN(stock) || stock < 0) {
      showToast('请输入有效的库存数量', 'danger');
      return;
    }
    
    if (!description) {
      showToast('产品描述是必填项', 'danger');
      return;
    }
    
    // 处理主图像（如果已选择）
    const imageFile = document.getElementById('product-image-file').files[0];
    let imageData = null;
    
    // 如果选择了新图像，处理它
    if (imageFile) {
      try {
        imageData = await readFileAsDataURL(imageFile);
      } catch (error) {
        console.error('读取图像文件时出错:', error);
        showToast('处理图像时出错', 'danger');
        return;
      }
    }
    
    // 准备产品数据
    const productData = {
      name,
      sku,
      price,
      stock,
      categoryId: categoryId || null,
      designerId: designerId || null,
      description,
      featured,
      onSale,
      active,
      gallery: productGalleryImages
    };
    
    // 仅在有新图像时添加图像数据
    if (imageData) {
      productData.image = imageData;
    }
    
    try {
      showToast('正在保存产品...', 'info');
      
      let result;
      if (productId) {
        // 更新现有产品
        result = await AdminApiService.updateProduct(productId, productData);
      } else {
        // 创建新产品
        result = await AdminApiService.addProduct(productData);
      }
      
      if (result.success) {
        showToast(productId ? '产品更新成功' : '产品创建成功', 'success');
        
        // 关闭模态窗口
        try {
          const modalElement = document.getElementById('productModal');
          const modalInstance = bootstrap.Modal.getInstance(modalElement);
          if (modalInstance) {
            modalInstance.hide();
          } else {
            console.warn('未找到模态实例，创建新实例以隐藏');
            new bootstrap.Modal(modalElement).hide();
          }
        } catch (error) {
          console.error('关闭模态窗口时出错:', error);
        }
        
        // 刷新产品列表
        loadProducts();
      } else {
        showToast(`操作失败: ${result.message || '未知错误'}`, 'danger');
      }
    } catch (error) {
      console.error('保存产品时出错:', error);
      showToast('保存产品时出错', 'danger');
    }
  }
  
  // 将文件读取为数据URL的辅助函数
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function deleteProduct(productId) {
    if (!confirm('确定要删除此产品吗？此操作无法撤消。')) {
      return;
    }
    
    try {
      showToast('正在删除产品...', 'info');
      
      // 通过API删除产品
      const result = await AdminApiService.deleteProduct(productId);
      
      if (result.success) {
        showToast('产品删除成功', 'success');
        // 重新加载产品
        loadProducts();
      } else {
        showToast(`删除失败: ${result.message || '未知错误'}`, 'danger');
      }
    } catch (error) {
      console.error('删除产品时出错:', error);
      showToast('删除产品时出错', 'danger');
    }
  }
  
  function checkAdminPermissions() {
    // 检查用户是否为管理员
    const token = localStorage.getItem('authToken');
    console.log('🔐 检查管理员权限 - Token:', token ? '存在' : '不存在');
    
    if (!token) {
      // 未登录，重定向到登录页面
      console.log('❌ 未找到认证令牌，重定向到登录页面');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      return;
    }
    
    // 调用API验证用户权限
    console.log('📡 发送API请求: /auth/profile');
    ApiService.get('/auth/profile')
      .then(response => {
        console.log('✅ 收到profile响应:', response);
        if (!response.success || !response.data.isAdmin) {
          // 不是管理员，重定向到首页
          console.log('❌ 用户不是管理员，isAdmin =', response.data?.isAdmin);
          showToast('You do not have permission to access this area', 'danger');
          setTimeout(() => {
            window.location.href = '/src/client/views/index.html';
          }, 2000);
        } else {
          // 初始化产品管理
          console.log('✅ 用户是管理员，初始化产品管理');
          initProductManagement();
        }
      })
      .catch(error => {
        console.error('❌ 检查管理员权限出错:', error);
        // 验证失败，重定向到登录页面
        showToast('Authentication error. Please login again.', 'danger');
        setTimeout(() => {
          window.location.href = '/src/client/views/auth/login.html?redirect=admin';
        }, 2000);
      });
  }
  
  // 查看产品评论
  async function viewProductReviews(productId) {
    // 设置当前评论的产品ID
    currentReviewProductId = productId;
    
    try {
      // 获取产品详情
      const productsResult = await AdminApiService.getAllProducts();
      
      // 正确处理API返回结构
      let products = [];
      if (productsResult.data) {
        if (Array.isArray(productsResult.data)) {
          products = productsResult.data;
        } else if (productsResult.data.products && Array.isArray(productsResult.data.products)) {
          products = productsResult.data.products;
        } else {
          console.error('API返回的products格式不正确:', productsResult.data);
        }
      }
      
      // 查找指定ID的产品
      const productIdStr = String(productId);
      const product = products.find(p => String(p.id) === productIdStr);
      
      if (!product) {
        console.error('未找到产品, ID:', productId);
        showToast('产品未找到', 'danger');
        return;
      }
      
      // 设置模态窗口中的产品名称
      document.getElementById('reviewsModalLabel').textContent = `Reviews for ${product.name}`;
      document.getElementById('review-product-name').textContent = product.name;
      
      // 显示加载状态
      const reviewsContainer = document.getElementById('reviews-container');
      reviewsContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading reviews...</p>
        </div>
      `;
      
      // 显示模态窗口
      new bootstrap.Modal(document.getElementById('reviewsModal')).show();
      
      // 加载评论
      loadProductReviews(productId);
    } catch (error) {
      console.error('查看产品评论时出错:', error);
      showToast('加载产品数据时出错', 'danger');
    }
  }
  
  // 加载产品评论
  async function loadProductReviews(productId) {
    const reviewsContainer = document.getElementById('reviews-container');
    const noReviewsMessage = document.getElementById('no-reviews-message');
    
    try {
      // 从API获取评论
      const result = await ApiService.get(`/api/reviews?productId=${productId}`);
      
      // 正确处理API返回结构
      let reviews = [];
      if (result.data) {
        if (Array.isArray(result.data)) {
          reviews = result.data;
        } else if (result.data.reviews && Array.isArray(result.data.reviews)) {
          reviews = result.data.reviews;
        } else {
          console.error('API返回的reviews格式不正确:', result.data);
        }
      }
      
      // 清除现有评论
      reviewsContainer.innerHTML = '';
      
      if (reviews.length === 0) {
        // 显示无评论消息
        reviewsContainer.appendChild(noReviewsMessage);
      } else {
        // 获取用户数据
        const usersResult = await AdminApiService.getAllUsers();
        
        // 正确处理API返回结构
        let users = [];
        if (usersResult.data) {
          if (Array.isArray(usersResult.data)) {
            users = usersResult.data;
          } else if (usersResult.data.users && Array.isArray(usersResult.data.users)) {
            users = usersResult.data.users;
          } else {
            console.error('API返回的users格式不正确:', usersResult.data);
          }
        }
        
        // 添加评论
        reviews.forEach(review => {
          // 查找用户
          const userIdStr = String(review.userId);
          const user = users.find(u => String(u.id) === userIdStr);
          
          // 从模板创建评论项
          const template = document.getElementById('review-item-template');
          const reviewItem = document.importNode(template.content, true).querySelector('.review-item');
          
          // 设置评论数据
          reviewItem.setAttribute('data-review-id', review.id);
          reviewItem.querySelector('.review-author').textContent = user 
              ? (user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()) 
              : 'Anonymous User';
          reviewItem.querySelector('.review-date').textContent = new Date(review.createdAt || review.date).toLocaleDateString();
          reviewItem.querySelector('.rating-value').textContent = review.rating;
          reviewItem.querySelector('.review-content').textContent = review.content || review.comment || 'No comment provided.';
          
          // 设置评论头像
          if (user && user.avatar) {
            reviewItem.querySelector('.review-avatar img').src = user.avatar;
          }
          
          // 根据评分设置评星
          const ratingElement = reviewItem.querySelector('.review-rating');
          ratingElement.innerHTML = '';
          for (let i = 1; i <= 5; i++) {
            const star = document.createElement('i');
            star.className = i <= review.rating ? 'bi bi-star-fill text-warning' : 'bi bi-star text-muted';
            ratingElement.appendChild(star);
          }
          
          // 设置评论状态徽章
          const badgeElement = reviewItem.querySelector('.review-status .badge');
          let statusClass = '';
          let statusText = '';
          
          switch (review.status) {
            case 'pending':
              statusClass = 'review-badge-pending';
              statusText = 'Pending';
              break;
            case 'approved':
              statusClass = 'review-badge-approved';
              statusText = 'Approved';
              break;
            case 'rejected':
              statusClass = 'review-badge-rejected';
              statusText = 'Rejected';
              break;
            default:
              statusClass = 'review-badge-pending';
              statusText = 'Pending';
          }
          
          badgeElement.className = `badge ${statusClass}`;
          badgeElement.textContent = statusText;
          
          // 设置操作处理程序
          reviewItem.querySelector('.approve-review').addEventListener('click', function(e) {
            e.preventDefault();
            updateReviewStatus(review.id, 'approved');
          });
          
          reviewItem.querySelector('.reject-review').addEventListener('click', function(e) {
            e.preventDefault();
            updateReviewStatus(review.id, 'rejected');
          });
          
          reviewItem.querySelector('.delete-review').addEventListener('click', function(e) {
            e.preventDefault();
            deleteReview(review.id);
          });
          
          reviewItem.querySelector('.reply-review').addEventListener('click', function(e) {
            e.preventDefault();
            replyToReview(review.id);
          });
          
          // 添加到容器
          reviewsContainer.appendChild(reviewItem);
        });
        
        // 更新评论统计
        updateReviewStats(reviews);
      }
    } catch (error) {
      console.error('加载评论时出错:', error);
      reviewsContainer.innerHTML = `
        <div class="alert alert-danger mb-0">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          加载评论时出错，请刷新或稍后再试。
        </div>
      `;
    }
  }
  
  // 更新评论统计
  function updateReviewStats(reviews) {
    const statsElement = document.getElementById('review-stats');
    
    // 按状态计数评论
    const total = reviews.length;
    const pending = reviews.filter(r => r.status === 'pending' || !r.status).length;
    const approved = reviews.filter(r => r.status === 'approved').length;
    const rejected = reviews.filter(r => r.status === 'rejected').length;
    
    // 计算平均评分
    let totalRating = 0;
    reviews.forEach(review => {
      totalRating += review.rating;
    });
    const averageRating = total > 0 ? (totalRating / total).toFixed(1) : '0.0';
    
    // 更新统计HTML
    statsElement.innerHTML = `
      <div class="review-stats">
        <div class="review-stats-item" title="Average Rating">
          <i class="bi bi-star-fill text-warning me-1"></i>
          ${averageRating}
        </div>
        <div class="review-stats-item" title="Total Reviews">
          <i class="bi bi-chat-left-text me-1"></i>
          ${total}
        </div>
        <div class="review-stats-item" title="Pending Reviews">
          <i class="bi bi-clock me-1"></i>
          ${pending}
        </div>
        <div class="review-stats-item" title="Approved Reviews">
          <i class="bi bi-check-circle me-1"></i>
          ${approved}
        </div>
      </div>
    `;
  }
  
  // 更新评论状态
  async function updateReviewStatus(reviewId, status) {
    try {
      showToast('正在更新评论状态...', 'info');
      
      // 通过API更新评论状态
      const result = await ApiService.put(`/api/reviews/${reviewId}/status`, {
        status: status
      });
      
      if (result.success) {
        showToast(`评论已${status === 'approved' ? '批准' : '拒绝'}`, 'success');
        
        // 重新加载评论
        loadProductReviews(currentReviewProductId);
      } else {
        showToast(`更新失败: ${result.message || '未知错误'}`, 'danger');
      }
    } catch (error) {
      console.error('更新评论状态时出错:', error);
      showToast('更新评论状态时出错', 'danger');
    }
  }
  
  // 删除评论
  async function deleteReview(reviewId) {
    if (!confirm('确定要删除此评论吗？此操作无法撤消。')) {
      return;
    }
    
    try {
      showToast('正在删除评论...', 'info');
    
      // 通过API删除评论
      const result = await ApiService.delete(`/api/reviews/${reviewId}`);
    
      if (result.success) {
        showToast('评论删除成功', 'success');
        
        // 重新加载评论
        loadProductReviews(currentReviewProductId);
      } else {
        showToast(`删除失败: ${result.message || '未知错误'}`, 'danger');
      }
    } catch (error) {
      console.error('删除评论时出错:', error);
      showToast('删除评论时出错', 'danger');
    }
  }
  
  // 回复评论
  async function replyToReview(reviewId) {
    // 获取评论
    try {
      const result = await ApiService.get(`/api/reviews/${reviewId}`);
      if (!result.success) {
        showToast('评论未找到', 'danger');
        return;
      }
    
      const review = result.data;
      
      // 提示回复
      const reply = prompt('输入您对此评论的回复:', review.adminReply || '');
    
    if (reply !== null) {
        showToast('正在保存回复...', 'info');
        
        // 通过API更新评论回复
        const updateResult = await ApiService.put(`/api/reviews/${reviewId}/reply`, {
          adminReply: reply
        });
        
        if (updateResult.success) {
          showToast('回复添加成功', 'success');
          
          // 重新加载评论
          loadProductReviews(currentReviewProductId);
        } else {
          showToast(`保存回复失败: ${updateResult.message || '未知错误'}`, 'danger');
        }
      }
    } catch (error) {
      console.error('回复评论时出错:', error);
      showToast('回复评论时出错', 'danger');
    }
  }
  
  // 刷新评论
  function refreshReviews() {
    if (currentReviewProductId) {
      loadProductReviews(currentReviewProductId);
    }
  }
  
  // 辅助函数：显示toast通知
  function showToast(message, type = 'primary') {
    // 检查UIHelpers是否可用
    if (typeof UIHelpers !== 'undefined' && typeof UIHelpers.showToast === 'function') {
      UIHelpers.showToast(message, type);
      return;
    }
    
    // 后备实现
    const toastContainer = document.querySelector('.toast-container');
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      toastElement.remove();
    });
  }
  
  // 基本的导航栏和页脚加载函数（如果UIHelpers不可用）
  function loadNavbar() {
    fetch('/src/client/assets/layout/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
      })
      .catch(error => {
        console.error('加载导航栏时出错:', error);
      });
  }
  
  function loadFooter() {
    fetch('/src/client/assets/layout/footer.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      })
      .catch(error => {
        console.error('加载页脚时出错:', error);
      });
  }
</script>
</body>
</html> 