<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Style for action buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Admin button styles */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
    
    /* Style for badges */
    .badge-success {
      background-color: #5a8c70;
      color: white;
    }
    
    .badge-warning {
      background-color: #e6a23c;
      color: white;
    }
    
    .badge-danger {
      background-color: #d9534f;
      color: white;
    }
    
    .product-management-card {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .product-table th {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #555;
    }
    
    .product-table tbody tr:hover {
      background-color: rgba(134, 118, 102, 0.05);
    }
    
    .empty-state-icon {
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-size: 2.5rem;
      color: #ccc;
      background-color: #f8f9fa;
      border: 1px solid #f0f0f0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .product-image-small {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #eaeaea;
    }
    
    .product-gallery-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    .product-gallery-item {
      position: relative;
      width: 100px;
      height: 100px;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .product-gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .product-gallery-item .remove-image {
      position: absolute;
      top: 2px;
      right: 2px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .product-price {
      font-weight: bold;
      color: #5a8c70;
    }
    
    /* Filter section styles */
    .filter-section {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    
    /* Review styles */
    .review-item .card-footer {
      border-top: 1px solid rgba(0,0,0,0.05);
    }
    
    .review-item {
      transition: all 0.2s ease-in-out;
    }
    
    .review-item:hover {
      border-color: #ddd;
      box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .review-avatar img {
      object-fit: cover;
      border: 1px solid #eee;
    }
    
    .review-content {
      white-space: pre-line;
      line-height: 1.5;
    }
    
    .review-date {
      font-size: 0.85rem;
    }
    
    .review-badge-pending {
      background-color: #ffc107;
      color: #212529;
    }
    
    .review-badge-approved {
      background-color: #5a8c70;
      color: white;
    }
    
    .review-badge-rejected {
      background-color: #dc3545;
      color: white;
    }
    
    .review-stats {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .review-stats-item {
      display: inline-flex;
      align-items: center;
      font-size: 0.85rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="products.html">
              <i class="bi bi-box me-2"></i>
              Products
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="categories.html">
              <i class="bi bi-tags me-2"></i>
              Categories
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="designers.html">
              <i class="bi bi-palette me-2"></i>
              Designers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="orders.html">
              <i class="bi bi-cart-check me-2"></i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="users.html">
              <i class="bi bi-people me-2"></i>
              Users
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="comments.html">
              <i class="bi bi-chat-dots me-2"></i>
              Reviews
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-graph-up me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-box-seam me-2 text-primary"></i>Product Management</h1>
        <div>
      <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
        <i class="bi bi-person me-2"></i>Back to Profile
      </a>
    </div>
  </div>

  <!-- Filter Section -->
  <div class="filter-section mb-4">
    <div class="row g-3">
      <div class="col-md-3">
        <label for="filter-category" class="form-label">Category</label>
        <select class="form-select" id="filter-category">
          <option value="">All Categories</option>
          <!-- Categories will be loaded here -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-designer" class="form-label">Designer</label>
        <select class="form-select" id="filter-designer">
          <option value="">All Designers</option>
          <!-- Designers will be loaded here -->
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-status" class="form-label">Status</label>
        <select class="form-select" id="filter-status">
          <option value="">All Status</option>
          <option value="in-stock">In Stock</option>
          <option value="low-stock">Low Stock</option>
          <option value="out-of-stock">Out of Stock</option>
        </select>
      </div>
      <div class="col-md-3">
        <label for="filter-search" class="form-label">Search</label>
        <input type="text" class="form-control" id="filter-search" placeholder="Search products...">
      </div>
    </div>
    <div class="row mt-3">
      <div class="col-12 d-flex justify-content-end">
        <button class="btn btn-secondary me-2" onclick="resetFilters()">
          <i class="bi bi-x-circle me-2"></i>Clear Filters
        </button>
        <button class="btn btn-primary" onclick="applyFilters()">
          <i class="bi bi-funnel me-2"></i>Apply Filters
        </button>
      </div>
    </div>
  </div>

  <div class="card mb-4 product-management-card">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col">
          <h5 class="mb-0">Product Management</h5>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" onclick="resetProductForm()">
            <i class="bi bi-plus-circle me-2"></i>Add Product
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover product-table">
          <thead>
            <tr>
              <th>Image</th>
              <th>Product</th>
              <th>Price</th>
              <th>Status</th>
              <th>Category</th>
              <th>Designer</th>
              <th>Reviews</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="product-table-body">
            <!-- Product data will be loaded here -->
          </tbody>
        </table>
        <div id="no-products-message" class="d-none text-center py-5">
          <div class="empty-state-icon mx-auto mb-3">
            <i class="bi bi-box"></i>
          </div>
          <p class="text-muted mb-3">No products found</p>
          <button class="btn btn-primary" onclick="resetProductForm()">
            Add Your First Product
          </button>
        </div>
      </div>
    </div>
      </div>
    </main>
  </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Add Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="product-form">
          <input type="hidden" id="product-id">
          
          <div class="row">
            <div class="col-md-8">
              <div class="admin-form-group">
                <label for="product-name" class="admin-form-label">Product Name<span class="text-danger">*</span></label>
                <input type="text" class="admin-form-control" id="product-name" required placeholder="Enter product name">
                <div class="form-text">A clear, descriptive name for your product</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="admin-form-group">
                <label for="product-sku" class="admin-form-label">SKU</label>
                <input type="text" class="admin-form-control" id="product-sku" placeholder="Enter SKU code">
                <div class="form-text">Stock Keeping Unit (optional)</div>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-price" class="admin-form-label">Price<span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input type="number" class="admin-form-control" id="product-price" required min="0" step="0.01" placeholder="0.00">
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-stock" class="admin-form-label">Stock Quantity<span class="text-danger">*</span></label>
                <input type="number" class="admin-form-control" id="product-stock" required min="0" placeholder="Enter stock quantity">
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-category" class="admin-form-label">Category</label>
                <select class="admin-form-control" id="product-category">
                  <option value="">-- Select Category --</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="admin-form-group">
                <label for="product-designer" class="admin-form-label">Designer</label>
                <select class="admin-form-control" id="product-designer">
                  <option value="">-- Select Designer --</option>
                  <!-- Designers will be loaded here -->
                </select>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label for="product-description" class="admin-form-label">Description<span class="text-danger">*</span></label>
            <textarea class="admin-form-control" id="product-description" rows="4" required placeholder="Describe your product in detail..."></textarea>
            <div class="form-text">Provide a detailed description of your product</div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Main Product Image<span class="text-danger">*</span></label>
            <div class="d-flex align-items-start mb-2">
              <div class="product-preview me-3" style="width: 120px; height: 120px;">
                <img id="product-img-preview" src="../../../img/profile.png" alt="Product preview">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="admin-form-control mb-2" id="product-image-file" accept="image/*">
                <div class="form-text mb-2">Recommended size: 800Ã—800px</div>
                <div class="d-grid">
                  <button type="button" class="admin-btn admin-btn-warning" onclick="resetProductImage()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Image
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Additional Images</label>
            <input type="file" class="admin-form-control mb-2" id="product-gallery-file" accept="image/*" multiple>
            <div class="form-text mb-2">Add up to 5 additional images (optional)</div>
            
            <div id="product-gallery-preview" class="product-gallery-container">
              <!-- Gallery images will be previewed here -->
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="admin-form-group">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="product-featured">
                  <label class="form-check-label" for="product-featured">
                    Featured Product
                  </label>
                  <div class="form-text">Featured products will be highlighted on the homepage</div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="admin-form-group">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="product-active" checked>
                  <label class="form-check-label" for="product-active">
                    Active Product
                  </label>
                  <div class="form-text">Inactive products won't be displayed on the store</div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveProduct()">
          <i class="bi bi-check2 me-1"></i>Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Review Management Modal after the product modal -->
<div class="modal fade" id="reviewsModal" tabindex="-1" aria-labelledby="reviewsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewsModalLabel">Product Reviews</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0" id="review-product-name">Reviews for Product</h6>
          <div class="d-flex align-items-center">
            <div id="review-stats" class="me-3">
              <!-- Review stats will be loaded here -->
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshReviews()">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
          </div>
        </div>
        
        <div id="reviews-container">
          <!-- Reviews will be loaded here -->
          <div id="no-reviews-message" class="text-center py-4">
            <div class="empty-state-icon mx-auto mb-3">
              <i class="bi bi-chat-square"></i>
            </div>
            <p class="text-muted mb-0">No reviews found for this product</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add review item template (hidden) -->
<template id="review-item-template">
  <div class="review-item card mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="d-flex align-items-center">
          <div class="review-avatar me-2">
            <img src="../../../img/profile.png" alt="User" class="rounded-circle" width="40" height="40">
          </div>
          <div>
            <div class="fw-medium review-author">Customer Name</div>
            <div class="text-muted small review-date">Date</div>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <div class="review-rating me-3">
            <i class="bi bi-star-fill text-warning"></i>
            <span class="ms-1 rating-value">5</span>
          </div>
          <div class="dropdown">
            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-three-dots-vertical"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item approve-review" href="#"><i class="bi bi-check-circle me-2"></i>Approve</a></li>
              <li><a class="dropdown-item reject-review" href="#"><i class="bi bi-x-circle me-2"></i>Reject</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item delete-review" href="#"><i class="bi bi-trash me-2"></i>Delete</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="review-content">
        Content of the review...
      </div>
    </div>
    <div class="card-footer bg-light py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="review-status">
          <span class="badge"></span>
        </div>
        <div class="review-actions">
          <button class="btn btn-sm btn-outline-primary me-1 reply-review">
            <i class="bi bi-reply me-1"></i>Reply
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

    </main>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ç›´æ¥åœ¨é¡µé¢ä¸­å†…è”å®šä¹‰å…³é”®æœåŠ¡ï¼Œé¿å…åŠ è½½é—®é¢˜ -->
<script>
/**
 * API Service for Purely Handmade
 * æä¾›ç»Ÿä¸€çš„APIè®¿é—®å±‚ï¼Œå¤„ç†æ‰€æœ‰ä¸æœåŠ¡å™¨çš„é€šä¿¡
 */
const ApiService = {
  // åŸºç¡€API URL
  baseUrl: '/api',
  
  // è·å–æˆæƒä»¤ç‰Œ
  getAuthToken: function() {
    const token = localStorage.getItem('authToken');
    console.log('Getting auth token:', token ? 'Token found' : 'No token');
    return token;
  },
  
  // è·å–å¸¦æœ‰æˆæƒä¿¡æ¯çš„è¯·æ±‚å¤´
  getAuthHeaders: function() {
    const token = this.getAuthToken();
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
    };
    
    if (token) {
      headers['Authorization'] = `Bearer ${token}`;
      console.log('Adding Authorization header');
    } else {
      console.log('No token for Authorization header');
    }
    
    return headers;
  },
  
  // å¤„ç†APIå“åº”
  handleResponse: async function(response) {
    const contentType = response.headers.get('content-type');
    const isJson = contentType && contentType.includes('application/json');
    
    // å¦‚æœçŠ¶æ€ç ä¸åœ¨2xxèŒƒå›´å†…ï¼ŒæŠ›å‡ºé”™è¯¯
    if (!response.ok) {
      let errorData;
      
      try {
        errorData = isJson ? await response.json() : await response.text();
      } catch (error) {
        errorData = 'Failed to parse error response';
      }
      
      const error = new Error(
        isJson && errorData.error 
          ? errorData.error 
          : 'API request failed'
      );
      
      error.status = response.status;
      error.statusText = response.statusText;
      error.data = errorData;
      
      throw error;
    }
    
    // è§£ææˆåŠŸå“åº”
    return isJson ? response.json() : response.text();
  },
  
  // å‘é€è¯·æ±‚
  request: async function(url, options = {}) {
    const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
    
    // é»˜è®¤é€‰é¡¹
    const defaultOptions = {
      headers: this.getAuthHeaders(),
      credentials: 'same-origin',
    };
    
    // åˆå¹¶é€‰é¡¹
    const fetchOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...options.headers,
      },
    };
    
    try {
      const response = await fetch(fullUrl, fetchOptions);
      return await this.handleResponse(response);
    } catch (error) {
      console.error('API request failed:', error);
      throw error;
    }
  },
  
  // GETè¯·æ±‚
  get: function(url, params = {}) {
    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    const queryParams = new URLSearchParams();
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        queryParams.append(key, params[key]);
      }
    });
    
    const queryString = queryParams.toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    
    return this.request(fullUrl, { method: 'GET' });
  },
  
  // POSTè¯·æ±‚
  post: function(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  
  // PUTè¯·æ±‚
  put: function(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
  
  // DELETEè¯·æ±‚
  delete: function(url) {
    return this.request(url, { method: 'DELETE' });
  }
};

/**
 * Admin API Service for Purely Handmade
 * æä¾›ç®¡ç†å‘˜APIè®¿é—®å±‚ï¼Œå¤„ç†ä¸æœåŠ¡å™¨çš„ç®¡ç†åŠŸèƒ½é€šä¿¡
 */
const AdminApiService = {
  // è·å–æ‰€æœ‰ç”¨æˆ·
  getAllUsers: function() {
    return ApiService.get('/auth/profile?all=1');
  },
  
  // è·å–æ‰€æœ‰äº§å“
  getAllProducts: function() {
    return ApiService.get('/products');
  },
  
  // æ·»åŠ æ–°äº§å“
  addProduct: function(productData) {
    return ApiService.post('/products/create', productData);
  },
  
  // æ›´æ–°äº§å“
  updateProduct: function(productId, productData) {
    return ApiService.put(`/products/update`, { id: productId, ...productData });
  },
  
  // åˆ é™¤äº§å“
  deleteProduct: function(productId) {
    return ApiService.delete(`/products?id=${productId}`);
  },
  
  // è·å–æ‰€æœ‰ç±»åˆ«
  getAllCategories: function() {
    return ApiService.get('/categories');
  },
  
  // æ·»åŠ æ–°ç±»åˆ«
  addCategory: function(categoryData) {
    return ApiService.post('/categories/create', categoryData);
  },
  
  // æ›´æ–°ç±»åˆ«
  updateCategory: function(categoryId, categoryData) {
    return ApiService.put(`/categories/update`, { id: categoryId, ...categoryData });
  },
  
  // åˆ é™¤ç±»åˆ«
  deleteCategory: function(categoryId) {
    return ApiService.delete(`/categories?id=${categoryId}`);
  },
  
  // è·å–æ‰€æœ‰è®¾è®¡å¸ˆ
  getAllDesigners: function() {
    return ApiService.get('/designers');
  },
  
  // è·å–æ‰€æœ‰è®¢å•
  getAllOrders: function() {
    return ApiService.get('/orders');
  },
  
  // è·å–æ‰€æœ‰è¯„è®º
  getAllReviews: function() {
    return ApiService.get('/reviews');
  }
};
</script>

<script src="/src/client/js/data-service.js"></script>
<script src="/src/client/js/ui-helpers.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  // Store gallery images for the current product
  let productGalleryImages = [];
  // Current filters
  let currentFilters = {
    category: '',
    designer: '',
    status: '',
    search: ''
  };
  
  // Store current product for reviews
  let currentReviewProductId = null;
  
  // å…¨å±€åŠ è½½çŠ¶æ€æ ‡è®°
  let isLoading = false;
  
  document.addEventListener('DOMContentLoaded', function() {
    // Load nav and footer
    if (typeof UIHelpers !== 'undefined') {
      UIHelpers.loadNavbar();
      UIHelpers.loadFooter();
    } else {
    loadNavbar();
    loadFooter();
    }
    
    // Check user permissions
    checkAdminPermissions();
    
    // Set up search filter event
    document.getElementById('filter-search').addEventListener('keyup', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
  });
  
  // Initialize product management functionality
  function initProductManagement() {
    // æ˜¾ç¤ºå…¨å±€åŠ è½½çŠ¶æ€
    showPageLoadingState();
    
    // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
    Promise.all([
      loadProducts(),
      loadCategoriesForDropdown(),
      loadDesignersForDropdown()
    ])
    .then(() => {
      // éšè—å…¨å±€åŠ è½½çŠ¶æ€
      hidePageLoadingState();
    })
    .catch(error => {
      console.error('åˆå§‹åŒ–å¤±è´¥:', error);
      showErrorMessage('åŠ è½½æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–ç¨åå†è¯•ã€‚');
      hidePageLoadingState();
    });
    
    // Set up image preview for main product image
    document.getElementById('product-image-file').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('product-img-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Set up gallery image preview
    document.getElementById('product-gallery-file').addEventListener('change', function(event) {
      const files = event.target.files;
      if (files && files.length > 0) {
        for (let i = 0; i < files.length; i++) {
          if (productGalleryImages.length >= 5) {
            showToast('Maximum of 5 gallery images allowed', 'warning');
            break;
          }
          
          const file = files[i];
          const reader = new FileReader();
          reader.onload = function(e) {
            productGalleryImages.push(e.target.result);
            updateGalleryPreview();
          };
          reader.readAsDataURL(file);
        }
      }
    });
  }
  
  // æ˜¾ç¤ºé¡µé¢å…¨å±€åŠ è½½çŠ¶æ€
  function showPageLoadingState() {
    isLoading = true;
    
    // åˆ›å»ºä¸€ä¸ªåŠ è½½è’™å±‚
    if (!document.getElementById('global-loading')) {
      const loadingEl = document.createElement('div');
      loadingEl.id = 'global-loading';
      loadingEl.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;';
      loadingEl.innerHTML = `
        <div class="text-center">
          <div class="spinner-border text-primary" role="status" style="width:3rem;height:3rem;">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-primary fw-bold">æ­£åœ¨åŠ è½½æ•°æ®...</p>
        </div>
      `;
      document.body.appendChild(loadingEl);
    } else {
      document.getElementById('global-loading').style.display = 'flex';
    }
  }
  
  // éšè—é¡µé¢å…¨å±€åŠ è½½çŠ¶æ€
  function hidePageLoadingState() {
    isLoading = false;
    const loadingEl = document.getElementById('global-loading');
    if (loadingEl) {
      loadingEl.style.display = 'none';
    }
  }
  
  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
  function showErrorMessage(message) {
    const main = document.querySelector('main');
    if (main) {
      const alertEl = document.createElement('div');
      alertEl.className = 'alert alert-danger alert-dismissible fade show my-3';
      alertEl.role = 'alert';
      alertEl.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
      if (main.firstChild) {
        main.insertBefore(alertEl, main.firstChild);
      } else {
        main.appendChild(alertEl);
      }
    } else {
      // å¦‚æœæ‰¾ä¸åˆ°mainå…ƒç´ ï¼Œä½¿ç”¨toast
      showToast(message, 'danger');
    }
  }
  
  // Product management functions
  async function loadProducts() {
    const tableBody = document.getElementById('product-table-body');
    const noProducts = document.getElementById('no-products-message');
    
    if (!tableBody) {
      console.error('product-table-body element not found! DOM may not be fully loaded.');
      return; // Exit the function early if tableBody doesn't exist
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    tableBody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading products...</p>
        </td>
      </tr>
    `;
    
    try {
      // ä»APIè·å–äº§å“æ•°æ®
      const result = await AdminApiService.getAllProducts();
      let products = result.data || [];
      
      // åº”ç”¨è¿‡æ»¤å™¨
      products = filterProducts(products);
      
      // æ¸…ç©ºç°æœ‰è¡Œ
    tableBody.innerHTML = '';
    
    if (products.length === 0) {
        // æ²¡æœ‰äº§å“ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æ¶ˆæ¯
      tableBody.parentElement.classList.add('d-none');
      noProducts.classList.remove('d-none');
    } else {
        // æ˜¾ç¤ºè¡¨æ ¼ï¼Œéšè—ç©ºçŠ¶æ€
      tableBody.parentElement.classList.remove('d-none');
      noProducts.classList.add('d-none');
      
        // è·å–ç±»åˆ«å’Œè®¾è®¡å¸ˆæ•°æ®-ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤è¯·æ±‚
        let categories = window.adminCachedCategories || [];
        let designers = window.adminCachedDesigners || [];
        
        if (!categories.length) {
          const catResult = await AdminApiService.getAllCategories();
          categories = catResult.data || [];
          window.adminCachedCategories = categories;
        }
        
        if (!designers.length) {
          const designerResult = await AdminApiService.getAllDesigners();
          designers = designerResult.data || [];
          window.adminCachedDesigners = designers;
        }
        
        // æ·»åŠ äº§å“è¡Œ
      products.forEach(product => {
          // æŸ¥æ‰¾ç±»åˆ«å’Œè®¾è®¡å¸ˆåç§°
          const category = categories.find(c => c.id == product.categoryId);
          const designer = designers.find(d => d.id == product.designerId);
          
          // ç¡®å®šåº“å­˜çŠ¶æ€å¾½ç« 
        let stockBadge;
        if (product.stock <= 0) {
          stockBadge = '<span class="badge badge-danger">Out of Stock</span>';
        } else if (product.stock <= 5) {
          stockBadge = '<span class="badge badge-warning">Low Stock</span>';
        } else {
          stockBadge = '<span class="badge badge-success">In Stock</span>';
        }
        
        const row = document.createElement('tr');
        row.setAttribute('data-product-id', product.id);
        row.innerHTML = `
          <td>
            <div class="product-image-small">
              <img src="${product.image || '../../../img/profile.png'}" 
                   alt="${product.name}" 
                   style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          </td>
          <td>
            <div class="d-flex flex-column">
              <div class="fw-medium">${product.name || 'Unnamed Product'}</div>
              <small class="text-muted">${product.sku || 'No SKU'}</small>
              ${product.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
              ${!product.active ? '<span class="badge bg-secondary mt-1">Inactive</span>' : ''}
            </div>
          </td>
          <td class="product-price">$${parseFloat(product.price).toFixed(2)}</td>
          <td>${stockBadge}</td>
          <td>${category ? category.name : '<span class="text-muted">Uncategorized</span>'}</td>
          <td>${designer ? designer.name : '<span class="text-muted">No Designer</span>'}</td>
          <td>
            <button class="btn btn-sm btn-outline-secondary" onclick="viewProductReviews('${product.id}')">
              <i class="bi bi-chat-left-text me-1"></i>
                <span class="review-count">${product.reviewCount || 0}</span>
            </button>
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editProduct('${product.id}')" data-bs-toggle="tooltip" title="Edit Product">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteProduct('${product.id}')" data-bs-toggle="tooltip" title="Delete Product">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
        // åˆå§‹åŒ–æç¤ºå·¥å…·
      const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltips.map(tooltip => new bootstrap.Tooltip(tooltip));
      }
    } catch (error) {
      console.error('åŠ è½½äº§å“æ—¶å‡ºé”™:', error);
      tableBody.innerHTML = `
        <tr>
          <td colspan="8" class="text-center py-4">
            <div class="alert alert-danger mb-0">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              åŠ è½½äº§å“æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–ç¨åå†è¯•ã€‚
            </div>
          </td>
        </tr>
      `;
    }
  }

  function filterProducts(products) {
    return products.filter(product => {
      // Apply category filter
      if (currentFilters.category && product.categoryId != currentFilters.category) {
        return false;
      }
      
      // Apply designer filter
      if (currentFilters.designer && product.designerId != currentFilters.designer) {
        return false;
      }
      
      // Apply status filter
      if (currentFilters.status) {
        if (currentFilters.status === 'out-of-stock' && product.stock > 0) {
          return false;
        } else if (currentFilters.status === 'low-stock' && (product.stock <= 0 || product.stock > 5)) {
          return false;
        } else if (currentFilters.status === 'in-stock' && product.stock <= 5) {
          return false;
        }
      }
      
      // Apply search filter
      if (currentFilters.search) {
        const searchTerm = currentFilters.search.toLowerCase();
        return (
          product.name.toLowerCase().includes(searchTerm) ||
          (product.description && product.description.toLowerCase().includes(searchTerm)) ||
          (product.sku && product.sku.toLowerCase().includes(searchTerm))
        );
      }
      
      return true;
    });
  }

  function applyFilters() {
    currentFilters = {
      category: document.getElementById('filter-category').value,
      designer: document.getElementById('filter-designer').value,
      status: document.getElementById('filter-status').value,
      search: document.getElementById('filter-search').value.trim()
    };
    
    loadProducts();
  }

  function resetFilters() {
    document.getElementById('filter-category').value = '';
    document.getElementById('filter-designer').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-search').value = '';
    
    currentFilters = {
      category: '',
      designer: '',
      status: '',
      search: ''
    };
    
    loadProducts();
  }

  async function loadCategoriesForDropdown() {
    const categoryDropdown = document.getElementById('product-category');
    const filterDropdown = document.getElementById('filter-category');
    
    try {
      const result = await AdminApiService.getAllCategories();
      const categories = result.data || [];
      
      // ç¼“å­˜ç±»åˆ«æ•°æ®
      window.adminCachedCategories = categories;
      
      // å¡«å……äº§å“è¡¨å•ä¸‹æ‹‰èœå•
    if (categoryDropdown) {
        // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹å¹¶æ·»åŠ ç±»åˆ«
      const defaultOption = categoryDropdown.options[0];
      categoryDropdown.innerHTML = '';
      categoryDropdown.appendChild(defaultOption);
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        categoryDropdown.appendChild(option);
      });
    }
    
      // å¡«å……ç­›é€‰ä¸‹æ‹‰èœå•
    if (filterDropdown) {
        // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹å¹¶æ·»åŠ ç±»åˆ«
      const defaultOption = filterDropdown.options[0];
      filterDropdown.innerHTML = '';
      filterDropdown.appendChild(defaultOption);
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        filterDropdown.appendChild(option);
      });
      }
    } catch (error) {
      console.error('åŠ è½½ç±»åˆ«æ—¶å‡ºé”™:', error);
      showToast('åŠ è½½ç±»åˆ«æ•°æ®æ—¶å‡ºé”™ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨', 'warning');
    }
  }

  async function loadDesignersForDropdown() {
    const designerDropdown = document.getElementById('product-designer');
    const filterDropdown = document.getElementById('filter-designer');
    
    try {
      const result = await AdminApiService.getAllDesigners();
      const designers = result.data || [];
      
      // ç¼“å­˜è®¾è®¡å¸ˆæ•°æ®
      window.adminCachedDesigners = designers;
      
      // å¡«å……äº§å“è¡¨å•ä¸‹æ‹‰èœå•
    if (designerDropdown) {
        // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹å¹¶æ·»åŠ è®¾è®¡å¸ˆ
      const defaultOption = designerDropdown.options[0];
      designerDropdown.innerHTML = '';
      designerDropdown.appendChild(defaultOption);
      
      designers.forEach(designer => {
        const option = document.createElement('option');
        option.value = designer.id;
        option.textContent = designer.name;
        designerDropdown.appendChild(option);
      });
    }
    
      // å¡«å……ç­›é€‰ä¸‹æ‹‰èœå•
    if (filterDropdown) {
        // ä¿ç•™ç¬¬ä¸€ä¸ªé€‰é¡¹å¹¶æ·»åŠ è®¾è®¡å¸ˆ
      const defaultOption = filterDropdown.options[0];
      filterDropdown.innerHTML = '';
      filterDropdown.appendChild(defaultOption);
      
      designers.forEach(designer => {
        const option = document.createElement('option');
        option.value = designer.id;
        option.textContent = designer.name;
        filterDropdown.appendChild(option);
      });
      }
    } catch (error) {
      console.error('åŠ è½½è®¾è®¡å¸ˆæ—¶å‡ºé”™:', error);
      showToast('åŠ è½½è®¾è®¡å¸ˆæ•°æ®æ—¶å‡ºé”™ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ä¸å¯ç”¨', 'warning');
    }
  }

  function resetProductForm() {
    // é‡ç½®è¡¨å•ä¸ºé»˜è®¤å€¼
    document.getElementById('product-form').reset();
    document.getElementById('productModalLabel').textContent = 'Add Product';
    document.getElementById('product-id').value = '';
    document.getElementById('product-img-preview').src = '../../../img/profile.png';
    
    // æ¸…é™¤ç”»å»Šå›¾ç‰‡
    productGalleryImages = [];
    updateGalleryPreview();
    
    // è®¾ç½®é»˜è®¤æ´»åŠ¨çŠ¶æ€
    document.getElementById('product-active').checked = true;
    
    // æ˜¾ç¤ºæ¨¡æ€çª—å£
    new bootstrap.Modal(document.getElementById('productModal')).show();
  }
  
  function resetProductImage() {
    // å°†å›¾åƒé‡ç½®ä¸ºé»˜è®¤å ä½ç¬¦
    document.getElementById('product-image-file').value = '';
    document.getElementById('product-img-preview').src = '../../../img/profile.png';
  }
  
  function updateGalleryPreview() {
    const galleryContainer = document.getElementById('product-gallery-preview');
    galleryContainer.innerHTML = '';
    
    if (productGalleryImages.length === 0) {
      return;
    }
    
    productGalleryImages.forEach((imageSrc, index) => {
      const galleryItem = document.createElement('div');
      galleryItem.className = 'product-gallery-item';
      galleryItem.innerHTML = `
        <img src="${imageSrc}" alt="Gallery image ${index + 1}">
        <div class="remove-image" onclick="removeGalleryImage(${index})">
          <i class="bi bi-x-circle"></i>
        </div>
      `;
      galleryContainer.appendChild(galleryItem);
    });
  }
  
  function removeGalleryImage(index) {
    productGalleryImages.splice(index, 1);
    updateGalleryPreview();
  }

  async function editProduct(productId) {
    showToast('æ­£åœ¨åŠ è½½äº§å“æ•°æ®...', 'info');
    
    try {
      // è·å–äº§å“æ•°æ®
      const result = await AdminApiService.getAllProducts();
      const products = result.data || [];
      
      // æŸ¥æ‰¾æŒ‡å®šIDçš„äº§å“
    const productIdStr = String(productId);
    const product = products.find(p => String(p.id) === productIdStr);
    
    if (product) {
        console.log('æ‰¾åˆ°äº§å“:', product);
        // ç”¨äº§å“æ•°æ®å¡«å……è¡¨å•
      document.getElementById('productModalLabel').textContent = 'Edit Product';
      document.getElementById('product-id').value = product.id;
      document.getElementById('product-name').value = product.name || '';
      document.getElementById('product-sku').value = product.sku || '';
      document.getElementById('product-price').value = product.price || '';
      document.getElementById('product-stock').value = product.stock || '';
      document.getElementById('product-category').value = product.categoryId || '';
      document.getElementById('product-designer').value = product.designerId || '';
      document.getElementById('product-description').value = product.description || '';
      document.getElementById('product-featured').checked = product.featured || false;
        document.getElementById('product-active').checked = product.active !== false; // å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸ºtrue
      
        // é‡ç½®æ–‡ä»¶è¾“å…¥
      document.getElementById('product-image-file').value = '';
      document.getElementById('product-gallery-file').value = '';
      
        // æ›´æ–°å›¾åƒé¢„è§ˆ
      const imgPreview = document.getElementById('product-img-preview');
      if (product.image) {
        imgPreview.src = product.image;
      } else {
        imgPreview.src = '../../../img/profile.png';
      }
      
        // åŠ è½½å›¾åº“å›¾åƒ
      productGalleryImages = product.gallery || [];
      updateGalleryPreview();
      
        // æ˜¾ç¤ºæ¨¡æ€çª—å£
      new bootstrap.Modal(document.getElementById('productModal')).show();
    } else {
        console.error('æœªæ‰¾åˆ°IDä¸ºä»¥ä¸‹IDçš„äº§å“:', productId);
        console.log('æ•°æ®åº“ä¸­çš„äº§å“ID:', products.map(p => p.id));
        showToast('æœªæ‰¾åˆ°äº§å“', 'danger');
      }
    } catch (error) {
      console.error('ç¼–è¾‘äº§å“æ—¶å‡ºé”™:', error);
      showToast('åŠ è½½äº§å“æ•°æ®æ—¶å‡ºé”™', 'danger');
    }
  }

  async function saveProduct() {
    // è·å–è¡¨å•å€¼
    const productId = document.getElementById('product-id').value;
    const name = document.getElementById('product-name').value.trim();
    const sku = document.getElementById('product-sku').value.trim();
    const price = parseFloat(document.getElementById('product-price').value);
    const stock = parseInt(document.getElementById('product-stock').value);
    const categoryId = document.getElementById('product-category').value;
    const designerId = document.getElementById('product-designer').value;
    const description = document.getElementById('product-description').value.trim();
    const featured = document.getElementById('product-featured').checked;
    const active = document.getElementById('product-active').checked;
    
    // éªŒè¯
    if (!name) {
      showToast('äº§å“åç§°æ˜¯å¿…å¡«é¡¹', 'danger');
      return;
    }
    
    if (isNaN(price) || price < 0) {
      showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼', 'danger');
      return;
    }
    
    if (isNaN(stock) || stock < 0) {
      showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„åº“å­˜æ•°é‡', 'danger');
      return;
    }
    
    if (!description) {
      showToast('äº§å“æè¿°æ˜¯å¿…å¡«é¡¹', 'danger');
      return;
    }
    
    // å¤„ç†ä¸»å›¾åƒï¼ˆå¦‚æœå·²é€‰æ‹©ï¼‰
    const imageFile = document.getElementById('product-image-file').files[0];
    let imageData = null;
    
    // å¦‚æœé€‰æ‹©äº†æ–°å›¾åƒï¼Œå¤„ç†å®ƒ
    if (imageFile) {
      try {
        imageData = await readFileAsDataURL(imageFile);
      } catch (error) {
        console.error('è¯»å–å›¾åƒæ–‡ä»¶æ—¶å‡ºé”™:', error);
        showToast('å¤„ç†å›¾åƒæ—¶å‡ºé”™', 'danger');
        return;
      }
    }
    
    // å‡†å¤‡äº§å“æ•°æ®
    const productData = {
          name,
          sku,
          price,
          stock,
          categoryId: categoryId || null,
          designerId: designerId || null,
          description,
          featured,
          active,
      gallery: productGalleryImages
    };
    
    // ä»…åœ¨æœ‰æ–°å›¾åƒæ—¶æ·»åŠ å›¾åƒæ•°æ®
    if (imageData) {
      productData.image = imageData;
    }
    
    try {
      showToast('æ­£åœ¨ä¿å­˜äº§å“...', 'info');
      
      let result;
      if (productId) {
        // æ›´æ–°ç°æœ‰äº§å“
        result = await AdminApiService.updateProduct(productId, productData);
      } else {
        // åˆ›å»ºæ–°äº§å“
        result = await AdminApiService.addProduct(productData);
      }
      
      if (result.success) {
        showToast(productId ? 'äº§å“æ›´æ–°æˆåŠŸ' : 'äº§å“åˆ›å»ºæˆåŠŸ', 'success');
        
        // å…³é—­æ¨¡æ€çª—å£
    try {
      const modalElement = document.getElementById('productModal');
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      if (modalInstance) {
        modalInstance.hide();
      } else {
            console.warn('æœªæ‰¾åˆ°æ¨¡æ€å®ä¾‹ï¼Œåˆ›å»ºæ–°å®ä¾‹ä»¥éšè—');
        new bootstrap.Modal(modalElement).hide();
      }
    } catch (error) {
          console.error('å…³é—­æ¨¡æ€çª—å£æ—¶å‡ºé”™:', error);
    }
    
        // åˆ·æ–°äº§å“åˆ—è¡¨
    loadProducts();
      } else {
        showToast(`æ“ä½œå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
      }
    } catch (error) {
      console.error('ä¿å­˜äº§å“æ—¶å‡ºé”™:', error);
      showToast('ä¿å­˜äº§å“æ—¶å‡ºé”™', 'danger');
    }
  }
  
  // å°†æ–‡ä»¶è¯»å–ä¸ºæ•°æ®URLçš„è¾…åŠ©å‡½æ•°
  function readFileAsDataURL(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function deleteProduct(productId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤äº§å“å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤æ¶ˆã€‚')) {
      return;
    }
    
    try {
      showToast('æ­£åœ¨åˆ é™¤äº§å“...', 'info');
      
      // é€šè¿‡APIåˆ é™¤äº§å“
      const result = await AdminApiService.deleteProduct(productId);
      
      if (result.success) {
        showToast('äº§å“åˆ é™¤æˆåŠŸ', 'success');
        // é‡æ–°åŠ è½½äº§å“
    loadProducts();
      } else {
        showToast(`åˆ é™¤å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
      }
    } catch (error) {
      console.error('åˆ é™¤äº§å“æ—¶å‡ºé”™:', error);
      showToast('åˆ é™¤äº§å“æ—¶å‡ºé”™', 'danger');
    }
  }
  
  function checkAdminPermissions() {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
    const token = localStorage.getItem('authToken');
    console.log('ğŸ” æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - Token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
    
    if (!token) {
      // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      console.log('âŒ æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      return;
    }
    
    // è°ƒç”¨APIéªŒè¯ç”¨æˆ·æƒé™
    console.log('ğŸ“¡ å‘é€APIè¯·æ±‚: /auth/profile');
    ApiService.get('/auth/profile')
      .then(response => {
        console.log('âœ… æ”¶åˆ°profileå“åº”:', response);
        if (!response.success || !response.data.isAdmin) {
          // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
          console.log('âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼ŒisAdmin =', response.data?.isAdmin);
          showToast('You do not have permission to access this area', 'danger');
          setTimeout(() => {
            window.location.href = '/src/client/views/index.html';
          }, 2000);
        } else {
          // åˆå§‹åŒ–äº§å“ç®¡ç†
          console.log('âœ… ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼Œåˆå§‹åŒ–äº§å“ç®¡ç†');
          initProductManagement();
        }
      })
      .catch(error => {
        console.error('âŒ æ£€æŸ¥ç®¡ç†å‘˜æƒé™å‡ºé”™:', error);
        // éªŒè¯å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        showToast('Authentication error. Please login again.', 'danger');
        setTimeout(() => {
          window.location.href = '/src/client/views/auth/login.html?redirect=admin';
        }, 2000);
      });
  }
  
  // æŸ¥çœ‹äº§å“è¯„è®º
  async function viewProductReviews(productId) {
    // è®¾ç½®å½“å‰è¯„è®ºçš„äº§å“ID
    currentReviewProductId = productId;
    
    try {
      // è·å–äº§å“è¯¦æƒ…
      const productsResult = await AdminApiService.getAllProducts();
      const products = productsResult.data || [];
      
      // æŸ¥æ‰¾æŒ‡å®šIDçš„äº§å“
    const productIdStr = String(productId);
    const product = products.find(p => String(p.id) === productIdStr);
    
    if (!product) {
      console.error('æœªæ‰¾åˆ°äº§å“, ID:', productId);
      showToast('äº§å“æœªæ‰¾åˆ°', 'danger');
      return;
    }
    
      // è®¾ç½®æ¨¡æ€çª—å£ä¸­çš„äº§å“åç§°
    document.getElementById('reviewsModalLabel').textContent = `Reviews for ${product.name}`;
    document.getElementById('review-product-name').textContent = product.name;
    
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const reviewsContainer = document.getElementById('reviews-container');
      reviewsContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading reviews...</p>
        </div>
      `;
      
      // æ˜¾ç¤ºæ¨¡æ€çª—å£
    new bootstrap.Modal(document.getElementById('reviewsModal')).show();
      
      // åŠ è½½è¯„è®º
      loadProductReviews(productId);
    } catch (error) {
      console.error('æŸ¥çœ‹äº§å“è¯„è®ºæ—¶å‡ºé”™:', error);
      showToast('åŠ è½½äº§å“æ•°æ®æ—¶å‡ºé”™', 'danger');
    }
  }
  
  // åŠ è½½äº§å“è¯„è®º
  async function loadProductReviews(productId) {
    const reviewsContainer = document.getElementById('reviews-container');
    const noReviewsMessage = document.getElementById('no-reviews-message');
    
    try {
      // ä»APIè·å–è¯„è®º
      const result = await ApiService.get(`/api/reviews?productId=${productId}`);
      const reviews = result.data || [];
      
      // æ¸…é™¤ç°æœ‰è¯„è®º
    reviewsContainer.innerHTML = '';
    
      if (reviews.length === 0) {
        // æ˜¾ç¤ºæ— è¯„è®ºæ¶ˆæ¯
      reviewsContainer.appendChild(noReviewsMessage);
    } else {
        // è·å–ç”¨æˆ·æ•°æ®
        const usersResult = await AdminApiService.getAllUsers();
        const users = usersResult.data || [];
        
        // æ·»åŠ è¯„è®º
        reviews.forEach(review => {
          // æŸ¥æ‰¾ç”¨æˆ·
        const userIdStr = String(review.userId);
        const user = users.find(u => String(u.id) === userIdStr);
        
          // ä»æ¨¡æ¿åˆ›å»ºè¯„è®ºé¡¹
        const template = document.getElementById('review-item-template');
        const reviewItem = document.importNode(template.content, true).querySelector('.review-item');
        
          // è®¾ç½®è¯„è®ºæ•°æ®
        reviewItem.setAttribute('data-review-id', review.id);
        reviewItem.querySelector('.review-author').textContent = user 
            ? (user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim()) 
            : 'Anonymous User';
        reviewItem.querySelector('.review-date').textContent = new Date(review.createdAt || review.date).toLocaleDateString();
        reviewItem.querySelector('.rating-value').textContent = review.rating;
        reviewItem.querySelector('.review-content').textContent = review.content || review.comment || 'No comment provided.';
        
          // è®¾ç½®è¯„è®ºå¤´åƒ
        if (user && user.avatar) {
          reviewItem.querySelector('.review-avatar img').src = user.avatar;
        }
        
          // æ ¹æ®è¯„åˆ†è®¾ç½®è¯„æ˜Ÿ
        const ratingElement = reviewItem.querySelector('.review-rating');
        ratingElement.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('i');
          star.className = i <= review.rating ? 'bi bi-star-fill text-warning' : 'bi bi-star text-muted';
          ratingElement.appendChild(star);
        }
        
          // è®¾ç½®è¯„è®ºçŠ¶æ€å¾½ç« 
        const badgeElement = reviewItem.querySelector('.review-status .badge');
        let statusClass = '';
        let statusText = '';
        
        switch (review.status) {
          case 'pending':
            statusClass = 'review-badge-pending';
            statusText = 'Pending';
            break;
          case 'approved':
            statusClass = 'review-badge-approved';
            statusText = 'Approved';
            break;
          case 'rejected':
            statusClass = 'review-badge-rejected';
            statusText = 'Rejected';
            break;
          default:
            statusClass = 'review-badge-pending';
            statusText = 'Pending';
        }
        
        badgeElement.className = `badge ${statusClass}`;
        badgeElement.textContent = statusText;
        
          // è®¾ç½®æ“ä½œå¤„ç†ç¨‹åº
        reviewItem.querySelector('.approve-review').addEventListener('click', function(e) {
          e.preventDefault();
          updateReviewStatus(review.id, 'approved');
        });
        
        reviewItem.querySelector('.reject-review').addEventListener('click', function(e) {
          e.preventDefault();
          updateReviewStatus(review.id, 'rejected');
        });
        
        reviewItem.querySelector('.delete-review').addEventListener('click', function(e) {
          e.preventDefault();
          deleteReview(review.id);
        });
        
        reviewItem.querySelector('.reply-review').addEventListener('click', function(e) {
          e.preventDefault();
          replyToReview(review.id);
        });
        
          // æ·»åŠ åˆ°å®¹å™¨
        reviewsContainer.appendChild(reviewItem);
      });
      
        // æ›´æ–°è¯„è®ºç»Ÿè®¡
        updateReviewStats(reviews);
      }
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºæ—¶å‡ºé”™:', error);
      reviewsContainer.innerHTML = `
        <div class="alert alert-danger mb-0">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          åŠ è½½è¯„è®ºæ—¶å‡ºé”™ï¼Œè¯·åˆ·æ–°æˆ–ç¨åå†è¯•ã€‚
        </div>
      `;
    }
  }
  
  // æ›´æ–°è¯„è®ºç»Ÿè®¡
  function updateReviewStats(reviews) {
    const statsElement = document.getElementById('review-stats');
    
    // æŒ‰çŠ¶æ€è®¡æ•°è¯„è®º
    const total = reviews.length;
    const pending = reviews.filter(r => r.status === 'pending' || !r.status).length;
    const approved = reviews.filter(r => r.status === 'approved').length;
    const rejected = reviews.filter(r => r.status === 'rejected').length;
    
    // è®¡ç®—å¹³å‡è¯„åˆ†
    let totalRating = 0;
    reviews.forEach(review => {
      totalRating += review.rating;
    });
    const averageRating = total > 0 ? (totalRating / total).toFixed(1) : '0.0';
    
    // æ›´æ–°ç»Ÿè®¡HTML
    statsElement.innerHTML = `
      <div class="review-stats">
        <div class="review-stats-item" title="Average Rating">
          <i class="bi bi-star-fill text-warning me-1"></i>
          ${averageRating}
        </div>
        <div class="review-stats-item" title="Total Reviews">
          <i class="bi bi-chat-left-text me-1"></i>
          ${total}
        </div>
        <div class="review-stats-item" title="Pending Reviews">
          <i class="bi bi-clock me-1"></i>
          ${pending}
        </div>
        <div class="review-stats-item" title="Approved Reviews">
          <i class="bi bi-check-circle me-1"></i>
          ${approved}
        </div>
      </div>
    `;
  }
  
  // æ›´æ–°è¯„è®ºçŠ¶æ€
  async function updateReviewStatus(reviewId, status) {
    try {
      showToast('æ­£åœ¨æ›´æ–°è¯„è®ºçŠ¶æ€...', 'info');
      
      // é€šè¿‡APIæ›´æ–°è¯„è®ºçŠ¶æ€
      const result = await ApiService.put(`/api/reviews/${reviewId}/status`, {
        status: status
      });
      
      if (result.success) {
        showToast(`è¯„è®ºå·²${status === 'approved' ? 'æ‰¹å‡†' : 'æ‹’ç»'}`, 'success');
        
        // é‡æ–°åŠ è½½è¯„è®º
      loadProductReviews(currentReviewProductId);
    } else {
        showToast(`æ›´æ–°å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
      }
    } catch (error) {
      console.error('æ›´æ–°è¯„è®ºçŠ¶æ€æ—¶å‡ºé”™:', error);
      showToast('æ›´æ–°è¯„è®ºçŠ¶æ€æ—¶å‡ºé”™', 'danger');
    }
  }
  
  // åˆ é™¤è¯„è®º
  async function deleteReview(reviewId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤æ¶ˆã€‚')) {
      return;
    }
    
    try {
      showToast('æ­£åœ¨åˆ é™¤è¯„è®º...', 'info');
    
      // é€šè¿‡APIåˆ é™¤è¯„è®º
      const result = await ApiService.delete(`/api/reviews/${reviewId}`);
    
      if (result.success) {
        showToast('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
        
        // é‡æ–°åŠ è½½è¯„è®º
    loadProductReviews(currentReviewProductId);
    
        // æ›´æ–°äº§å“è¡Œä¸­çš„è¯„è®ºè®¡æ•°
        loadProducts();
      } else {
        showToast(`åˆ é™¤å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
      }
    } catch (error) {
      console.error('åˆ é™¤è¯„è®ºæ—¶å‡ºé”™:', error);
      showToast('åˆ é™¤è¯„è®ºæ—¶å‡ºé”™', 'danger');
    }
  }
  
  // å›å¤è¯„è®º
  async function replyToReview(reviewId) {
    // è·å–è¯„è®º
    try {
      const result = await ApiService.get(`/api/reviews/${reviewId}`);
      if (!result.success) {
        showToast('è¯„è®ºæœªæ‰¾åˆ°', 'danger');
      return;
    }
    
      const review = result.data;
      
      // æç¤ºå›å¤
      const reply = prompt('è¾“å…¥æ‚¨å¯¹æ­¤è¯„è®ºçš„å›å¤:', review.adminReply || '');
    
    if (reply !== null) {
        showToast('æ­£åœ¨ä¿å­˜å›å¤...', 'info');
        
        // é€šè¿‡APIæ›´æ–°è¯„è®ºå›å¤
        const updateResult = await ApiService.put(`/api/reviews/${reviewId}/reply`, {
          adminReply: reply
        });
        
        if (updateResult.success) {
          showToast('å›å¤æ·»åŠ æˆåŠŸ', 'success');
          
          // é‡æ–°åŠ è½½è¯„è®º
          loadProductReviews(currentReviewProductId);
        } else {
          showToast(`ä¿å­˜å›å¤å¤±è´¥: ${updateResult.message || 'æœªçŸ¥é”™è¯¯'}`, 'danger');
        }
      }
    } catch (error) {
      console.error('å›å¤è¯„è®ºæ—¶å‡ºé”™:', error);
      showToast('å›å¤è¯„è®ºæ—¶å‡ºé”™', 'danger');
    }
  }
  
  // åˆ·æ–°è¯„è®º
  function refreshReviews() {
    if (currentReviewProductId) {
      loadProductReviews(currentReviewProductId);
    }
  }
  
  // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºtoasté€šçŸ¥
  function showToast(message, type = 'primary') {
    // æ£€æŸ¥UIHelpersæ˜¯å¦å¯ç”¨
    if (typeof UIHelpers !== 'undefined' && typeof UIHelpers.showToast === 'function') {
      UIHelpers.showToast(message, type);
      return;
    }
    
    // åå¤‡å®ç°
    const toastContainer = document.querySelector('.toast-container');
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      toastElement.remove();
    });
  }
  
  // åŸºæœ¬çš„å¯¼èˆªæ å’Œé¡µè„šåŠ è½½å‡½æ•°ï¼ˆå¦‚æœUIHelpersä¸å¯ç”¨ï¼‰
  function loadNavbar() {
    fetch('/src/client/assets/layout/navbar.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('navbar-placeholder').innerHTML = html;
      })
      .catch(error => {
        console.error('åŠ è½½å¯¼èˆªæ æ—¶å‡ºé”™:', error);
      });
  }
  
  function loadFooter() {
    fetch('/src/client/assets/layout/footer.html')
      .then(response => response.text())
      .then(html => {
        document.getElementById('footer-placeholder').innerHTML = html;
      })
      .catch(error => {
        console.error('åŠ è½½é¡µè„šæ—¶å‡ºé”™:', error);
      });
  }
</script>
</body>
</html> 