<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  <style>
    /* Custom styles for order management */
    .order-id-column {
      min-width: 250px;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .order-id-text {
      cursor: pointer;
    }
    
    .order-id-text:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-receipt me-2 text-primary"></i>Order Management</h1>
    <div>
      <a href="dashboard.html" class="btn btn-outline-secondary me-2">
        <i class="bi bi-speedometer2 me-2"></i>Dashboard
      </a>
      <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
        <i class="bi bi-person me-2"></i>Back to Profile
      </a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Orders List</h5>
    </div>
    <div class="card-body">
      <!-- Add filter section -->
      <div class="filter-section mb-4 p-3 border rounded bg-light">
        <div class="row g-3">
          <div class="col-md-3">
            <label for="filter-id" class="form-label">Order ID</label>
            <input type="text" class="form-control" id="filter-id" placeholder="Filter by Order ID">
          </div>
          <div class="col-md-3">
            <label for="filter-user" class="form-label">Customer</label>
            <input type="text" class="form-control" id="filter-user" placeholder="Filter by customer name">
          </div>
          <div class="col-md-2">
            <label for="filter-status" class="form-label">Status</label>
            <select class="form-select" id="filter-status">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="col-md-2">
            <label for="filter-date" class="form-label">Date From</label>
            <input type="date" class="form-control" id="filter-date-from">
          </div>
          <div class="col-md-2">
            <label for="filter-date" class="form-label">Date To</label>
            <input type="date" class="form-control" id="filter-date-to">
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-secondary me-2" onclick="resetFilters()">
              <i class="bi bi-x-circle me-1"></i>Clear Filters
            </button>
            <button class="btn btn-primary" onclick="applyFilters()">
              <i class="bi bi-funnel me-1"></i>Apply Filters
            </button>
          </div>
        </div>
      </div>
      
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="order-id-column">Order ID</th>
            <th>User</th>
            <th>Status</th>
            <th>Total Amount</th>
            <th>Order Date</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody id="order-table-body">
          <!-- Orders data will be loaded here -->
        </tbody>
      </table>
      <div id="no-orders-message" class="text-center py-5 d-none">
        <p class="text-muted">No orders found</p>
      </div>
    </div>
  </div>
</div>

<div id="footer-placeholder"></div>

<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    loadNavbar();
    loadFooter();
    checkAdminPermissions();
    loadOrders();
  });

  function loadOrders() {
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    const tableBody = document.getElementById('order-table-body');
    const noOrdersMessage = document.getElementById('no-orders-message');

    const users = JSON.parse(localStorage.getItem('users') || '[]');
    
    console.log('Loading orders:', orders.length);
    tableBody.innerHTML = '';
    
    // Filter orders based on current filters
    const filteredOrders = filterOrders(orders, users);
    
    console.log('Filtered orders:', filteredOrders.length);

    if (filteredOrders.length === 0) {
      noOrdersMessage.classList.remove('d-none');
    } else {
      noOrdersMessage.classList.add('d-none');
      
      filteredOrders.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
      
      filteredOrders.forEach(order => {
        const user = users.find(u => u.id === order.userId) || { name: 'Unknown User' };
        const userName = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Unknown User';
        
        let statusBadgeClass = 'bg-secondary';
        switch(order.status) {
          case 'pending':
            statusBadgeClass = 'bg-warning text-dark';
            break;
          case 'processing':
            statusBadgeClass = 'bg-info text-dark';
            break;
          case 'shipped':
            statusBadgeClass = 'bg-primary';
            break;
          case 'delivered':
            statusBadgeClass = 'bg-success';
            break;
          case 'cancelled':
            statusBadgeClass = 'bg-danger';
            break;
        }
        
        const totalAmount = typeof order.totalAmount === 'number' ? 
          order.totalAmount.toFixed(2) : 
          order.totalAmount || 0;
          
        const orderDate = order.createdAt || order.date || '';
        const formattedDate = orderDate ? new Date(orderDate).toLocaleDateString() : 'Unknown date';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="order-id-column">
            <span class="order-id-text" title="${order.id}" onclick="copyToClipboard('${order.id}')">${order.id}</span>
          </td>
          <td>${userName}</td>
          <td><span class="badge ${statusBadgeClass}">${order.status || 'unknown'}</span></td>
          <td>$${totalAmount}</td>
          <td>${formattedDate}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-primary" onclick="viewOrderDetails('${order.id}')">
              <i class="bi bi-eye me-1"></i>View
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteOrder('${order.id}')">
              <i class="bi bi-trash me-1"></i>Delete
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
  }

  function viewOrderDetails(orderId) {
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    const order = orders.find(o => o.id === orderId);
    
    if (!order) {
      showToast('Order not found', 'danger');
      return;
    }
    
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const user = users.find(u => u.id === order.userId) || { name: 'Unknown User' };
    
    const modalHtml = `
      <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <h6>Order Information</h6>
                  <p><strong>Order ID:</strong> ${order.id}</p>
                  <p><strong>Date:</strong> ${new Date(order.createdAt || order.date).toLocaleString()}</p>
                  <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></p>
                  <p><strong>Payment Method:</strong> ${formatPaymentMethod(order.paymentMethod)}</p>
                  <p><strong>Payment Status:</strong> ${order.isPaid ? '<span class="text-success">Paid</span>' : '<span class="text-danger">Not Paid</span>'}</p>
                </div>
                <div class="col-md-6">
                  <h6>Customer Information</h6>
                  <p><strong>Name:</strong> ${user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Unknown'}</p>
                  <p><strong>Email:</strong> ${user.email || 'Not available'}</p>
                  <h6 class="mt-3">Shipping Address</h6>
                  ${formatShippingAddress(order.shippingAddress)}
                </div>
              </div>
              
              <h6>Order Items</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Price</th>
                      <th>Quantity</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${formatOrderItems(order.items)}
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                      <td>$${order.totalAmount?.toFixed(2) || '0.00'}</td>
                    </tr>
                    <tr>
                      <td colspan="3" class="text-end"><strong>Shipping Fee:</strong></td>
                      <td>$${order.shippingFee?.toFixed(2) || '0.00'}</td>
                    </tr>
                    <tr>
                      <td colspan="3" class="text-end"><strong>Total:</strong></td>
                      <td><strong>$${order.grandTotal?.toFixed(2) || '0.00'}</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div class="mt-4">
                <h6>Update Order Status</h6>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn ${order.status === 'pending' ? 'btn-warning' : 'btn-outline-warning'}" 
                          onclick="updateOrderStatus('${order.id}', 'pending')">
                    <i class="bi bi-hourglass me-1"></i>Pending
                  </button>
                  <button class="btn ${order.status === 'processing' ? 'btn-info' : 'btn-outline-info'}" 
                          onclick="updateOrderStatus('${order.id}', 'processing')">
                    <i class="bi bi-gear me-1"></i>Processing
                  </button>
                  <button class="btn ${order.status === 'shipped' ? 'btn-primary' : 'btn-outline-primary'}" 
                          onclick="updateOrderStatus('${order.id}', 'shipped')">
                    <i class="bi bi-truck me-1"></i>Shipped
                  </button>
                  <button class="btn ${order.status === 'delivered' ? 'btn-success' : 'btn-outline-success'}" 
                          onclick="updateOrderStatus('${order.id}', 'delivered')">
                    <i class="bi bi-check-circle me-1"></i>Delivered
                  </button>
                  <button class="btn ${order.status === 'cancelled' ? 'btn-danger' : 'btn-outline-danger'}" 
                          onclick="updateOrderStatus('${order.id}', 'cancelled')">
                    <i class="bi bi-x-circle me-1"></i>Cancelled
                  </button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);
    
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
    
    document.getElementById('orderDetailsModal').addEventListener('hidden.bs.modal', function() {
      document.body.removeChild(modalContainer);
    });
  }
  
  function getStatusColor(status) {
    switch(status) {
      case 'pending': return 'warning';
      case 'processing': return 'info';
      case 'shipped': return 'primary';
      case 'delivered': return 'success';
      case 'cancelled': return 'danger';
      default: return 'secondary';
    }
  }
  
  function formatPaymentMethod(method) {
    if (!method) return 'Unknown';
    
    const methods = {
      'creditCard': 'Credit Card',
      'alipay': 'Alipay',
      'wechatPay': 'WeChat Pay',
      'bankTransfer': 'Bank Transfer'
    };
    
    return methods[method] || method;
  }
  
  function formatShippingAddress(address) {
    if (!address) return '<p>No address information available</p>';
    
    return `
      <p>${address.fullName || ''}</p>
      <p>${address.streetAddress || ''} ${address.aptSuite || ''}</p>
      <p>${address.city || ''}, ${address.state || ''} ${address.zipCode || ''}</p>
      <p>${address.country || ''}</p>
      <p>Phone: ${address.phone || 'Not available'}</p>
    `;
  }
  
  function formatOrderItems(items) {
    if (!items || !items.length) return '<tr><td colspan="4" class="text-center">No items</td></tr>';
    
    return items.map(item => `
      <tr>
        <td>
          ${item.image ? `<img src="${item.image}" alt="${item.productName}" width="50" class="me-2">` : ''}
          ${item.productName || 'Unknown Product'}
        </td>
        <td>$${item.price?.toFixed(2) || '0.00'}</td>
        <td>${item.quantity || 0}</td>
        <td>$${item.subtotal?.toFixed(2) || '0.00'}</td>
      </tr>
    `).join('');
  }
  
  function updateOrderStatus(orderId, newStatus) {
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    const orderIndex = orders.findIndex(o => o.id === orderId);
    
    if (orderIndex === -1) {
      showToast('Order not found', 'danger');
      return;
    }
    
    // Update the order status
    orders[orderIndex].status = newStatus;
    orders[orderIndex].updatedAt = new Date().toISOString();
    
    // Save to localStorage
    localStorage.setItem('orders', JSON.stringify(orders));
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
    modal.hide();
    
    // Refresh the orders list
    loadOrders();
    
    // Show success message
    showToast(`Order status updated to ${newStatus}`, 'success');
  }

  function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
      let orders = JSON.parse(localStorage.getItem('orders') || '[]');
      orders = orders.filter(order => order.id !== orderId);
      localStorage.setItem('orders', JSON.stringify(orders));
      loadOrders();
      showToast('Order deleted successfully', 'success');
    }
  }

  function checkAdminPermissions() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    console.log('Checking admin permissions for user:', currentUser);
    if (!currentUser || (currentUser.role !== 'admin' && currentUser.isAdmin !== true)) {
      console.log('User is not admin, redirecting...');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      alert('You must be logged in as an administrator to access this page.');
    } else {
      console.log('Admin permissions verified successfully');
    }
  }
  
  // Current filter values
  let currentFilters = {
    id: '',
    user: '',
    status: '',
    dateFrom: '',
    dateTo: ''
  };
  
  // Apply filters to orders
  function filterOrders(orders, users) {
    if (!orders || !orders.length) return [];
    
    return orders.filter(order => {
      // Get user info for filtering
      const user = users.find(u => u.id === order.userId) || {};
      const userName = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || '';
      
      // Filter by Order ID
      if (currentFilters.id && !order.id.toLowerCase().includes(currentFilters.id.toLowerCase())) {
        return false;
      }
      
      // Filter by User
      if (currentFilters.user && !userName.toLowerCase().includes(currentFilters.user.toLowerCase())) {
        return false;
      }
      
      // Filter by Status
      if (currentFilters.status && order.status !== currentFilters.status) {
        return false;
      }
      
      // Filter by Date Range
      const orderDate = new Date(order.createdAt || order.date);
      
      // Check date from
      if (currentFilters.dateFrom) {
        const fromDate = new Date(currentFilters.dateFrom);
        fromDate.setHours(0, 0, 0, 0);
        if (orderDate < fromDate) {
          return false;
        }
      }
      
      // Check date to
      if (currentFilters.dateTo) {
        const toDate = new Date(currentFilters.dateTo);
        toDate.setHours(23, 59, 59, 999);
        if (orderDate > toDate) {
          return false;
        }
      }
      
      return true;
    });
  }
  
  // Apply filters when button is clicked
  function applyFilters() {
    currentFilters = {
      id: document.getElementById('filter-id').value.trim(),
      user: document.getElementById('filter-user').value.trim(),
      status: document.getElementById('filter-status').value,
      dateFrom: document.getElementById('filter-date-from').value,
      dateTo: document.getElementById('filter-date-to').value
    };
    
    loadOrders();
    
    // Show which filters are applied
    const appliedFilters = Object.entries(currentFilters)
      .filter(([_, value]) => value)
      .map(([key, _]) => key)
      .join(', ');
      
    if (appliedFilters) {
      showToast(`Filters applied: ${appliedFilters}`, 'info');
    }
  }
  
  // Reset all filters
  function resetFilters() {
    document.getElementById('filter-id').value = '';
    document.getElementById('filter-user').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    
    currentFilters = {
      id: '',
      user: '',
      status: '',
      dateFrom: '',
      dateTo: ''
    };
    
    loadOrders();
    showToast('Filters cleared', 'info');
  }
  
  function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      toastElement.remove();
    });
  }
  
  // Function to copy order ID to clipboard
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
      .then(() => {
        showToast('Order ID copied to clipboard', 'info');
      })
      .catch(err => {
        console.error('Could not copy text: ', err);
      });
  }
</script>
</body>
</html> 