<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  <style>
    /* Custom styles for order management */
    .order-id-column {
      min-width: 250px;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .order-id-text {
      cursor: pointer;
    }
    
    .order-id-text:hover {
      text-decoration: underline;
    }
    
    /* Management UI styles */
    .admin-card {
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
      border: none;
    }
    
    .admin-card .card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #eaecef;
      padding: 15px 20px;
    }
    
    .admin-card .card-body {
      padding: 20px;
    }
    
    .filter-section {
      background-color: #f8f9fa;
      border: 1px solid #eaecef !important;
      border-radius: 8px;
      margin-bottom: 20px;
      padding: 20px !important;
    }
    
    .filter-toggle {
      cursor: pointer;
      color: #6c757d;
    }
    
    .filter-toggle:hover {
      color: #495057;
    }
    
    .admin-table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .admin-table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
      border-top: none;
      border-bottom: 2px solid #dee2e6;
      padding: 12px 15px;
    }
    
    .admin-table td {
      padding: 12px 15px;
      vertical-align: middle;
    }
    
    .admin-table tbody tr:hover {
      background-color: #f1f3f5;
    }
    
    .action-buttons {
      white-space: nowrap;
    }
    
    .action-button {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      margin-right: 0.25rem;
    }
    
    .badge-status {
      padding: 0.5em 0.75em;
      font-weight: 500;
      letter-spacing: 0.3px;
    }
    
    @media (max-width: 768px) {
      .filter-section .row > div {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>

<div id="navbar-placeholder"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">
              <i class="bi bi-box me-2"></i>
              Products
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="categories.html">
              <i class="bi bi-tags me-2"></i>
              Categories
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="designers.html">
              <i class="bi bi-palette me-2"></i>
              Designers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="orders.html">
              <i class="bi bi-cart-check me-2"></i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="users.html">
              <i class="bi bi-people me-2"></i>
              Users
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="comments.html">
              <i class="bi bi-chat-dots me-2"></i>
              Reviews
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-graph-up me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-receipt me-2 text-primary"></i>Order Management</h1>
        <div>
          <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
            <i class="bi bi-person me-2"></i>Back to Profile
          </a>
        </div>
      </div>

      <div class="card admin-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Orders List</h5>
          <span class="filter-toggle" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="true">
            <i class="bi bi-funnel me-1"></i>Filters <i class="bi bi-chevron-up"></i>
          </span>
        </div>
        <div class="card-body">
          <!-- Add filter section -->
          <div class="collapse show" id="filterCollapse">
            <div class="filter-section mb-4">
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="filter-id" class="form-label">Order ID</label>
                  <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-hash"></i></span>
                    <input type="text" class="form-control" id="filter-id" placeholder="Filter by Order ID">
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="filter-user" class="form-label">Customer</label>
                  <div class="input-group">
                    <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
                    <input type="text" class="form-control" id="filter-user" placeholder="Filter by customer name">
                  </div>
                </div>
                <div class="col-md-2">
                  <label for="filter-status" class="form-label">Status</label>
                  <select class="form-select" id="filter-status">
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label for="filter-date-from" class="form-label">Date From</label>
                  <input type="date" class="form-control" id="filter-date-from">
                </div>
                <div class="col-md-2">
                  <label for="filter-date-to" class="form-label">Date To</label>
                  <input type="date" class="form-control" id="filter-date-to">
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12 d-flex justify-content-end">
                  <button class="btn btn-outline-secondary me-2" onclick="resetFilters()">
                    <i class="bi bi-x-circle me-1"></i>Clear
                  </button>
                  <button class="btn btn-primary" onclick="applyFilters()">
                    <i class="bi bi-search me-1"></i>Search
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table admin-table table-hover">
              <thead>
                <tr>
                  <th class="order-id-column">Order ID</th>
                  <th>User</th>
                  <th>Status</th>
                  <th>Total Amount</th>
                  <th>Order Date</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="order-table-body">
                <!-- Orders data will be loaded here -->
              </tbody>
            </table>
          </div>
          <div id="no-orders-message" class="text-center py-5 d-none">
            <div class="py-5">
              <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
              <p class="text-muted mt-3">No orders found</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<div id="footer-placeholder"></div>

<div class="toast-container position-fixed top-0 end-0 p-3"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ç›´æ¥åœ¨é¡µé¢ä¸­å†…è”å®šä¹‰å…³é”®æœåŠ¡ï¼Œé¿å…åŠ è½½é—®é¢˜ -->
<script>
/**
 * API Service for Purely Handmade
 * æä¾›ç»Ÿä¸€çš„APIè®¿é—®å±‚ï¼Œå¤„ç†æ‰€æœ‰ä¸æœåŠ¡å™¨çš„é€šä¿¡
 */
const ApiService = {
  // åŸºç¡€API URL
  baseUrl: '/api',
  
  // å¤„ç†APIå“åº”
  handleResponse: async function(response) {
    const contentType = response.headers.get('content-type');
    const isJson = contentType && contentType.includes('application/json');
    
    // å¦‚æœçŠ¶æ€ç ä¸åœ¨2xxèŒƒå›´å†…ï¼ŒæŠ›å‡ºé”™è¯¯
    if (!response.ok) {
      let errorData;
      
      try {
        errorData = isJson ? await response.json() : await response.text();
      } catch (error) {
        errorData = 'Failed to parse error response';
      }
      
      const error = new Error(
        isJson && errorData.error 
          ? errorData.error 
          : 'API request failed'
      );
      
      error.status = response.status;
      error.statusText = response.statusText;
      error.data = errorData;
      
      throw error;
    }
    
    // è§£ææˆåŠŸå“åº”
    return isJson ? response.json() : response.text();
  },
  
  // å‘é€è¯·æ±‚
  request: async function(url, options = {}) {
    const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
    
    // é»˜è®¤é€‰é¡¹
    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      credentials: 'same-origin',
    };
    
    // æ·»åŠ æˆæƒä»¤ç‰Œ
    const token = localStorage.getItem('authToken') || localStorage.getItem('token');
    if (token) {
      defaultOptions.headers['Authorization'] = `Bearer ${token}`;
    }
    
    // åˆå¹¶é€‰é¡¹
    const fetchOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...options.headers,
      },
    };
    
    try {
      const response = await fetch(fullUrl, fetchOptions);
      return await this.handleResponse(response);
    } catch (error) {
      console.error('API request failed:', error);
      throw error;
    }
  },
  
  // GETè¯·æ±‚
  get: function(url, params = {}) {
    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    const queryParams = new URLSearchParams();
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        queryParams.append(key, params[key]);
      }
    });
    
    const queryString = queryParams.toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    
    return this.request(fullUrl, { method: 'GET' });
  },
  
  // POSTè¯·æ±‚
  post: function(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  
  // PUTè¯·æ±‚
  put: function(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
  
  // DELETEè¯·æ±‚
  delete: function(url) {
    return this.request(url, { method: 'DELETE' });
  }
};

/**
 * Admin API Service for Purely Handmade
 * æä¾›ç®¡ç†å‘˜APIè®¿é—®å±‚ï¼Œå¤„ç†ä¸æœåŠ¡å™¨çš„ç®¡ç†åŠŸèƒ½é€šä¿¡
 */
const AdminApiService = {
  // è·å–æ‰€æœ‰ç”¨æˆ·
  getAllUsers: function() {
    return ApiService.get('/auth/profile?all=1');
  },
  
  // è·å–æ‰€æœ‰äº§å“
  getAllProducts: function() {
    return ApiService.get('/products');
  },
  
  // è·å–æ‰€æœ‰ç±»åˆ«
  getAllCategories: function() {
    return ApiService.get('/categories');
  },
  
  // è·å–æ‰€æœ‰è®¾è®¡å¸ˆ
  getAllDesigners: function() {
    return ApiService.get('/designers');
  },
  
  // è·å–æ‰€æœ‰è®¢å•
  getAllOrders: function() {
    return ApiService.get('/orders?all=1');
  },
  
  // æ›´æ–°è®¢å•çŠ¶æ€
  updateOrderStatus: function(orderId, status) {
    return ApiService.put(`/orders/update`, {
      id: orderId,
      status: status
    });
  },
  
  // è·å–è®¢å•è¯¦æƒ…
  getOrderById: async function(orderId) {
    console.log(`å°è¯•è·å–è®¢å•è¯¦æƒ… ID: ${orderId}`);
    
    // ä½¿ç”¨è®¢å•åˆ—è¡¨APIï¼Œä½†è·å–æ‰€æœ‰è®¢å•ï¼ˆå¯¹ç®¡ç†å‘˜æœ‰æ•ˆï¼‰
    return ApiService.get('/orders', { all: 1 }).then(response => {
      if (response.success && response.data && response.data.orders) {
        // ä»è®¢å•åˆ—è¡¨ä¸­æ‰¾åˆ°æŒ‡å®šIDçš„è®¢å•
        const foundOrder = response.data.orders.find(order => order.id == orderId);
        
        if (foundOrder) {
          // å¦‚æœæ‰¾åˆ°äº†ï¼ŒåŒ…è£…ä¸ºæˆåŠŸå“åº”æ ¼å¼
          console.log(`âœ… åœ¨è®¢å•åˆ—è¡¨ä¸­æ‰¾åˆ°äº†è®¢å• #${orderId}`);
          return {
            success: true,
            data: foundOrder
          };
        } else {
          console.warn(`âš ï¸ åœ¨APIå“åº”ä¸­æ‰¾ä¸åˆ°æŒ‡å®šè®¢å• #${orderId}`);
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è®¢å•æˆ–APIè¯·æ±‚å¤±è´¥ï¼Œè¿”å›é”™è¯¯å“åº”
      return {
        success: false,
        message: 'æœªæ‰¾åˆ°æŒ‡å®šçš„è®¢å•'
      };
    });
  },
  
  // å¤„ç†è®¢å•
  handleOrder: function(orderId, action) {
    console.log(`ğŸ“¡ å¤„ç†è®¢å• - ID: ${orderId}, åŠ¨ä½œ: ${action}`);
    
    // å°†actionè½¬æ¢ä¸ºçŠ¶æ€
    let status = '';
    switch(action) {
      case 'process': status = 'processing'; break;
      case 'ship': status = 'shipped'; break;
      case 'deliver': status = 'delivered'; break;
      case 'complete': status = 'completed'; break;
      case 'cancel': status = 'cancelled'; break;
      default: status = action;
    }
    
    // ä½¿ç”¨æ ‡å‡†RESTfulæ ¼å¼å‘é€çŠ¶æ€æ›´æ–°
    return ApiService.put('/orders/update', {
      id: orderId,
      status: status
    });
  },
  
  // åˆ é™¤è®¢å•
  deleteOrder: function(orderId) {
    // æ”¹ç”¨POSTæ–¹æ³•è€Œä¸æ˜¯DELETEï¼Œå¹¶æ·»åŠ actionå‚æ•°
    return ApiService.post('/orders/update', {
      id: orderId,
      action: 'delete',
      status: 'deleted'  // å¦‚æœAPIéœ€è¦çŠ¶æ€å‚æ•°
    });
  }
};

/**
 * æ¨¡æ‹Ÿæ•°æ®æœåŠ¡
 * åœ¨APIè°ƒç”¨å¤±è´¥æ—¶æä¾›å¤‡ç”¨æ•°æ®
 */
const MockDataService = {
  // åˆ›å»ºæ¨¡æ‹Ÿè®¢å•æ•°æ®
  createMockOrder: function(orderId) {
    console.log('ğŸ”§ åˆ›å»ºæ¨¡æ‹Ÿè®¢å•æ•°æ®:', orderId);
    return {
      id: orderId,
      status: 'pending',
      createdAt: new Date().toISOString(),
      totalAmount: 99.99,
      shippingFee: 5.99,
      items: [
        {
          productId: 'mock-product-1',
          name: 'Mock Product 1',
          price: 49.99,
          quantity: 1,
          subtotal: 49.99
        },
        {
          productId: 'mock-product-2',
          name: 'Mock Product 2',
          price: 50.00,
          quantity: 1,
          subtotal: 50.00
        }
      ],
      userId: 'mock-user-1',
      shippingInfo: {
        name: 'Mock User',
        address: '123 Mock Street',
        city: 'Mockville',
        state: 'Mockland',
        zip: '12345',
        country: 'Mockistan',
        phone: '555-MOCK'
      },
      paymentMethod: 'creditCard'
    };
  }
};
</script>

<script src="/src/client/js/data-service.js"></script>
<script src="/src/client/js/ui-helpers.js"></script>
<script src="/src/client/js/common.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    loadNavbar();
    loadFooter();
    checkAdminPermissions();
    
    // Setup for filter collapse toggle icon
    document.querySelector('.filter-toggle').addEventListener('click', function() {
      const icon = this.querySelector('.bi-chevron-up, .bi-chevron-down');
      if (icon.classList.contains('bi-chevron-up')) {
        icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
      } else {
        icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
      }
    });
  });

  async function loadOrders() {
    const tableBody = document.getElementById('order-table-body');
    const noOrdersMessage = document.getElementById('no-orders-message');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading orders...</p>
        </td>
      </tr>
    `;
    
    try {
      // é¢„å…ˆè·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®ï¼Œé¿å…æ¯ä¸ªè®¢å•éƒ½è¦å•ç‹¬è¯·æ±‚
      console.log('ğŸ“¡ å‘é€APIè¯·æ±‚: è·å–æ‰€æœ‰ç”¨æˆ· - GET /auth/profile?all=1');
      const usersResponse = await AdminApiService.getAllUsers();
      console.log('âœ… è·å–ç”¨æˆ·åˆ—è¡¨å“åº”:', usersResponse);
      
      // åˆ›å»ºç”¨æˆ·IDæ˜ å°„è¡¨
      const userMap = {};
      if (usersResponse && usersResponse.success && usersResponse.data) {
        const users = Array.isArray(usersResponse.data) ? usersResponse.data : (usersResponse.data.users || []);
        users.forEach(user => {
          if (user && user.id) {
            userMap[String(user.id)] = user;
          }
        });
      }
      console.log(`ğŸ“Š åˆ›å»ºäº†åŒ…å«${Object.keys(userMap).length}ä¸ªç”¨æˆ·çš„æ˜ å°„è¡¨`);
      
      console.log('ğŸ“¡ å‘é€APIè¯·æ±‚: è·å–æ‰€æœ‰è®¢å• - GET /orders');
      const response = await AdminApiService.getAllOrders();
      console.log('âœ… è·å–è®¢å•å“åº”:', response);
      
      if (!response || !response.success) {
        throw new Error(response?.message || 'Failed to load orders');
      }
      
      // æ­£ç¡®å¤„ç†APIè¿”å›ç»“æ„
      let orders = [];
      if (response.data) {
        if (Array.isArray(response.data)) {
          orders = response.data;
        } else if (response.data.orders && Array.isArray(response.data.orders)) {
          orders = response.data.orders;
        } else {
          console.error('APIè¿”å›çš„ordersæ ¼å¼ä¸æ­£ç¡®:', response.data);
          // å°è¯•å…¶ä»–å¯èƒ½çš„æ•°æ®æ ¼å¼
          const dataKeys = Object.keys(response.data);
          if (dataKeys.length > 0 && Array.isArray(response.data[dataKeys[0]])) {
            orders = response.data[dataKeys[0]];
            console.log('å°è¯•ä½¿ç”¨æ›¿ä»£æ•°æ®æ ¼å¼:', dataKeys[0]);
          } else {
            throw new Error('Invalid orders data format');
          }
        }
      }
      
      console.log(`ğŸ“Š è·å–åˆ°${orders.length}ä¸ªè®¢å•`);
      
      // åº”ç”¨ç­›é€‰
      if (Object.values(currentFilters).some(v => v)) {
        console.log('ğŸ” åº”ç”¨è®¢å•ç­›é€‰æ¡ä»¶:', currentFilters);
        orders = filterOrders(orders, Object.values(userMap));
        console.log(`ğŸ“Š ç­›é€‰åå‰©ä½™${orders.length}ä¸ªè®¢å•`);
      }
      
      // æ¸…ç©ºè¡¨æ ¼
      tableBody.innerHTML = '';
      
      // æ˜¾ç¤ºæ²¡æœ‰è®¢å•çš„æ¶ˆæ¯ï¼ˆå¦‚æœæ²¡æœ‰è®¢å•ï¼‰
      if (!orders || !orders.length) {
        console.log('ğŸ“Š æ²¡æœ‰æ‰¾åˆ°è®¢å•');
        noOrdersMessage.classList.remove('d-none');
        return;
      }
      
      // éšè—æ²¡æœ‰è®¢å•çš„æ¶ˆæ¯
      noOrdersMessage.classList.add('d-none');
      
      // æ¸²æŸ“è®¢å•æ•°æ®
      console.log('ğŸ–Œï¸ æ¸²æŸ“è®¢å•è¡¨æ ¼');
      renderOrdersTable(orders, tableBody, userMap);
      
    } catch (error) {
      console.error('âŒ åŠ è½½è®¢å•å‡ºé”™:', error);
      tableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-4">
            <div class="alert alert-danger" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              Error loading orders: ${error.message}
            </div>
            <button class="btn btn-outline-primary mt-3" onclick="loadOrders()">
              <i class="bi bi-arrow-clockwise me-1"></i>Try Again
            </button>
          </td>
        </tr>
      `;
    }
  }

  // æ¸²æŸ“è®¢å•è¡¨æ ¼
  function renderOrdersTable(orders, tableBody, userMap) {
    if (!orders || !orders.length) return;
    
    // æŒ‰è®¢å•IDå‡åºæ’åºï¼ˆè€Œä¸æ˜¯æŒ‰æ—¥æœŸé™åºï¼‰
    orders.sort((a, b) => {
      // æå–è®¢å•IDä¸­çš„æ•°å­—éƒ¨åˆ†ï¼ˆå¦‚æœIDæ ¼å¼ä¸º"ORD12345"ï¼Œåˆ™æå–12345éƒ¨åˆ†ï¼‰
      const getOrderNumber = (id) => {
        if (!id) return 0;
        const numericPart = id.toString().replace(/\D/g, '');
        return numericPart ? parseInt(numericPart) : 0;
      };
      
      return getOrderNumber(a.id) - getOrderNumber(b.id);
    });
    
    // åˆ›å»ºä¸€ä¸ªå·²æ¸²æŸ“è®¢å•IDçš„é›†åˆï¼Œé¿å…é‡å¤æ¸²æŸ“
    const renderedOrderIds = new Set();
    
    // æ¸²æŸ“æ¯ä¸ªè®¢å•è¡Œ
    orders.forEach(order => {
      try {
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ¸²æŸ“è¿‡è¿™ä¸ªè®¢å•
        if (renderedOrderIds.has(order.id)) {
          console.log(`âš ï¸ è·³è¿‡é‡å¤çš„è®¢å•ID: ${order.id}`);
          return;
        }
        renderedOrderIds.add(order.id);
        
        // è·å–ç”¨æˆ·åç§°
        let userName = 'Unknown User';
        if (order.user) {
          userName = order.user.name || `${order.user.firstName || ''} ${order.user.lastName || ''}`.trim() || 'Unknown User';
        } else if (order.userId && userMap[String(order.userId)]) {
          // ä»é¢„å…ˆè·å–çš„ç”¨æˆ·æ˜ å°„ä¸­æŸ¥æ‰¾ç”¨æˆ·
          const user = userMap[String(order.userId)];
          userName = user.username || `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'Unknown User';
        } else if (order.userId) {
          userName = `User #${order.userId}`;
        }
        
        // ç¡®å®šè®¢å•çŠ¶æ€çš„æ ·å¼
        let statusBadgeClass = 'bg-secondary';
        let statusIcon = '';
        switch(order.status) {
          case 'pending':
            statusBadgeClass = 'bg-warning text-dark';
            statusIcon = '<i class="bi bi-hourglass me-1"></i>';
            break;
          case 'processing':
            statusBadgeClass = 'bg-info text-dark';
            statusIcon = '<i class="bi bi-gear me-1"></i>';
            break;
          case 'shipped':
            statusBadgeClass = 'bg-primary';
            statusIcon = '<i class="bi bi-truck me-1"></i>';
            break;
          case 'delivered':
            statusBadgeClass = 'bg-success';
            statusIcon = '<i class="bi bi-check-circle me-1"></i>';
            break;
          case 'cancelled':
            statusBadgeClass = 'bg-danger';
            statusIcon = '<i class="bi bi-x-circle me-1"></i>';
            break;
        }
        
        // æ ¼å¼åŒ–é‡‘é¢å’Œæ—¥æœŸ
        const totalAmount = typeof order.totalAmount === 'number' ? 
          order.totalAmount.toFixed(2) : 
          order.totalAmount || 0;
          
        const orderDate = order.createdAt || order.date || '';
        const formattedDate = orderDate ? new Date(orderDate).toLocaleDateString() : 'Unknown date';
        
        // åˆ›å»ºè®¢å•è¡Œ
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="order-id-column">
            <span class="order-id-text" title="${order.id}" onclick="copyToClipboard('${order.id}')">${order.id}</span>
          </td>
          <td>
            <div class="d-flex align-items-center">
              <i class="bi bi-person-circle me-2 text-secondary"></i>
              ${userName}
            </div>
          </td>
          <td><span class="badge badge-status ${statusBadgeClass}">${statusIcon}${order.status || 'unknown'}</span></td>
          <td><strong>$${totalAmount}</strong></td>
          <td>
            <div class="d-flex align-items-center">
              <i class="bi bi-calendar-date me-2 text-secondary"></i>
              ${formattedDate}
            </div>
          </td>
          <td class="text-center action-buttons">
            <button class="btn btn-sm btn-primary action-button" onclick="viewOrderDetails('${order.id}')">
              <i class="bi bi-eye me-1"></i>View
            </button>
            <button class="btn btn-sm btn-danger action-button" onclick="deleteOrder('${order.id}')">
              <i class="bi bi-trash me-1"></i>Delete
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      } catch (error) {
        console.error('Error rendering order row:', error);
      }
    });
  }

  // æŸ¥çœ‹è®¢å•è¯¦æƒ…
  async function viewOrderDetails(orderId) {
    try {
      showLoading();
      console.log(`æŸ¥çœ‹è®¢å•è¯¦æƒ…: ${orderId}`);
      
      // ä½¿ç”¨æ”¹è¿›çš„APIè°ƒç”¨è·å–è®¢å•è¯¦æƒ…
      const response = await AdminApiService.getOrderById(orderId);
      
      if (!response || !response.success) {
        hideLoading();
        console.error(`Error viewing order details:`, response);
        throw new Error(`Failed to load order details: ${response?.message || 'Unknown error'}`);
      }
      
      const order = response.data;
      
      // å°è¯•è·å–ç”¨æˆ·è¯¦æƒ…
      let userData = { username: 'Unknown User' };
      
      try {
        const userResponse = await ApiService.get('/auth/profile', { id: order.userId });
        if (userResponse.success && userResponse.data) {
          userData = userResponse.data;
        } else {
          console.warn(`âŒ è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:`, userResponse);
        }
      } catch (userError) {
        console.error(`âŒ è·å–ç”¨æˆ·æ•°æ®æ—¶å‡ºé”™:`, userError);
      }
      
      // æ„å»ºæ¨¡æ€çª—å£HTML
      const modalHtml = `
        <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="orderDetailsModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order ID:</strong> ${order.id}</p>
                    <p><strong>Date:</strong> ${new Date(order.createdAt || order.date).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="badge bg-${getStatusColor(order.status)}">${order.status}</span></p>
                    <p><strong>Payment Method:</strong> ${formatPaymentMethod(order.paymentInfo?.method || order.paymentMethod)}</p>
                    <p><strong>Payment Status:</strong> ${order.isPaid ? '<span class="text-success">Paid</span>' : '<span class="text-danger">Not Paid</span>'}</p>
                  </div>
                  <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p><strong>Name:</strong> ${userData.name || `${userData.firstName || ''} ${userData.lastName || ''}`.trim() || 'Unknown'}</p>
                    <p><strong>Email:</strong> ${userData.email || 'Not available'}</p>
                    <h6 class="mt-3">Shipping Address</h6>
                    ${formatShippingAddress(order.shippingInfo || order.shippingAddress)}
                  </div>
                </div>
                
                <h6>Order Items</h6>
                <div class="table-responsive">
                  <table class="table table-bordered">
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${formatOrderItems(order.orderItems || order.items)}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="3" class="text-end"><strong>Subtotal:</strong></td>
                        <td>$${order.totalAmount?.toFixed(2) || '0.00'}</td>
                      </tr>
                      <tr>
                        <td colspan="3" class="text-end"><strong>Shipping Fee:</strong></td>
                        <td>$${order.shippingFee?.toFixed(2) || '0.00'}</td>
                      </tr>
                      <tr>
                        <td colspan="3" class="text-end"><strong>Total:</strong></td>
                        <td><strong>$${order.grandTotal?.toFixed(2) || order.totalAmount?.toFixed(2) || '0.00'}</strong></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                
                <div class="mt-4">
                  <h6>Update Order Status</h6>
                  <div class="d-flex flex-wrap gap-2">
                    <button class="btn ${order.status === 'pending' ? 'btn-warning' : 'btn-outline-warning'}" 
                            onclick="handleOrder('${order.id}', 'process')">
                      <i class="bi bi-hourglass me-1"></i>Set as Processing
                    </button>
                    <button class="btn ${order.status === 'processing' ? 'btn-info' : 'btn-outline-info'}" 
                            onclick="handleOrder('${order.id}', 'ship')">
                      <i class="bi bi-gear me-1"></i>Set as Shipped
                    </button>
                    <button class="btn ${order.status === 'shipped' ? 'btn-primary' : 'btn-outline-primary'}" 
                            onclick="handleOrder('${order.id}', 'deliver')">
                      <i class="bi bi-truck me-1"></i>Set as Delivered
                    </button>
                    <button class="btn ${order.status === 'delivered' ? 'btn-success' : 'btn-outline-success'}" 
                            onclick="handleOrder('${order.id}', 'complete')">
                      <i class="bi bi-check-circle me-1"></i>Set as Completed
                    </button>
                    <button class="btn ${order.status === 'cancelled' ? 'btn-danger' : 'btn-outline-danger'}" 
                            onclick="handleOrder('${order.id}', 'cancel')">
                      <i class="bi bi-x-circle me-1"></i>Set as Cancelled
                    </button>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // åˆ›å»ºå¹¶æ˜¾ç¤ºæ¨¡æ€çª—å£
      const modalContainer = document.createElement('div');
      modalContainer.innerHTML = modalHtml;
      document.body.appendChild(modalContainer);
      
      const modalElement = document.getElementById('orderDetailsModal');
      const modal = new bootstrap.Modal(modalElement);
      
      // æ¨¡æ€çª—å£å…³é—­æ—¶ç§»é™¤DOMå…ƒç´ 
      modalElement.addEventListener('hidden.bs.modal', function() {
        document.body.removeChild(modalContainer);
      });
      
      // åœ¨æ˜¾ç¤ºæ¨¡æ€çª—å£å‰éšè—åŠ è½½æŒ‡ç¤ºå™¨
      hideLoading();
      modal.show();
      
    } catch (error) {
      hideLoading();
      console.error('Error viewing order details:', error);
      Swal.fire({
        title: 'é”™è¯¯',
        text: `æŸ¥çœ‹è®¢å•è¯¦æƒ…æ—¶å‡ºé”™: ${error.message}`,
        icon: 'error'
      });
    }
  }
  
  // æ›´æ–°è®¢å•çŠ¶æ€
  async function updateOrderStatus(orderId, newStatus) {
    try {
      // æ˜¾ç¤ºåŠ è½½æç¤º
      showToast('Updating order status...', 'info');
      
      // é€šè¿‡APIæ›´æ–°è®¢å•çŠ¶æ€
      console.log(`ğŸ“¡ å‘é€APIè¯·æ±‚: æ›´æ–°è®¢å•çŠ¶æ€ - PUT /orders/update (id: ${orderId}, status: ${newStatus})`);
      const response = await AdminApiService.updateOrderStatus(orderId, newStatus);
      console.log('âœ… æ›´æ–°è®¢å•çŠ¶æ€å“åº”:', response);
      
      if (!response || !response.success) {
        throw new Error(response?.data || 'Failed to update order status');
      }
      
      // å…³é—­æ¨¡æ€çª—å£
      const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
      if (modal) {
        modal.hide();
      }
      
      // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
      await loadOrders();
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showToast('Order status updated successfully', 'success');
      
    } catch (error) {
      console.error('âŒ æ›´æ–°è®¢å•çŠ¶æ€æ—¶å‡ºé”™:', error);
      showToast(`Error updating order status: ${error.message}`, 'danger');
    }
  }

  // åˆ é™¤è®¢å•
  async function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
      try {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        showToast('Deleting order...', 'info');
        
        // é€šè¿‡APIåˆ é™¤è®¢å•
        console.log(`ğŸ“¡ å‘é€APIè¯·æ±‚: åˆ é™¤è®¢å• - DELETE /orders?id=${orderId}`);
        const response = await AdminApiService.deleteOrder(orderId);
        console.log('âœ… åˆ é™¤è®¢å•å“åº”:', response);
        
        if (!response || !response.success) {
          throw new Error(response?.data || 'Failed to delete order');
        }
        
        // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
        await loadOrders();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showToast('Order deleted successfully', 'success');
        
      } catch (error) {
        console.error('âŒ åˆ é™¤è®¢å•æ—¶å‡ºé”™:', error);
        showToast(`Error deleting order: ${error.message}`, 'danger');
      }
    }
  }

  function checkAdminPermissions() {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
    const token = localStorage.getItem('authToken');
    console.log('ğŸ” æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - Token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
    
    if (!token) {
      // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      console.log('âŒ æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      return;
    }
    
    // è°ƒç”¨APIéªŒè¯ç”¨æˆ·æƒé™
    console.log('ğŸ“¡ å‘é€APIè¯·æ±‚: /auth/profile');
    ApiService.get('/auth/profile')
      .then(response => {
        console.log('âœ… æ”¶åˆ°profileå“åº”:', response);
        if (!response.success || !response.data.isAdmin) {
          // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
          console.log('âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼ŒisAdmin =', response.data?.isAdmin);
          showToast('You do not have permission to access this area', 'danger');
          setTimeout(() => {
            window.location.href = '/src/client/views/index.html';
          }, 2000);
        } else {
          // åŠ è½½è®¢å•æ•°æ®
          console.log('âœ… ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½è®¢å•æ•°æ®');
          loadOrders();
        }
      })
      .catch(error => {
        console.error('âŒ æ£€æŸ¥ç®¡ç†å‘˜æƒé™å‡ºé”™:', error);
        // éªŒè¯å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        showToast('Authentication error. Please login again.', 'danger');
        setTimeout(() => {
          window.location.href = '/src/client/views/auth/login.html?redirect=admin';
        }, 2000);
      });
  }
  
  // Current filter values
  let currentFilters = {
    id: '',
    user: '',
    status: '',
    dateFrom: '',
    dateTo: ''
  };
  
  // Apply filters to orders
  function filterOrders(orders, users) {
    if (!orders || !orders.length) return [];
    
    return orders.filter(order => {
      // Get user info for filtering
      const user = users.find(u => u.id === order.userId) || {};
      const userName = user.name || `${user.firstName || ''} ${user.lastName || ''}`.trim() || '';
      
      // Filter by Order ID
      if (currentFilters.id && !order.id.toLowerCase().includes(currentFilters.id.toLowerCase())) {
        return false;
      }
      
      // Filter by User
      if (currentFilters.user && !userName.toLowerCase().includes(currentFilters.user.toLowerCase())) {
        return false;
      }
      
      // Filter by Status
      if (currentFilters.status && order.status !== currentFilters.status) {
        return false;
      }
      
      // Filter by Date Range
      const orderDate = new Date(order.createdAt || order.date);
      
      // Check date from
      if (currentFilters.dateFrom) {
        const fromDate = new Date(currentFilters.dateFrom);
        fromDate.setHours(0, 0, 0, 0);
        if (orderDate < fromDate) {
          return false;
        }
      }
      
      // Check date to
      if (currentFilters.dateTo) {
        const toDate = new Date(currentFilters.dateTo);
        toDate.setHours(23, 59, 59, 999);
        if (orderDate > toDate) {
          return false;
        }
      }
      
      return true;
    });
  }
  
  // Apply filters when button is clicked
  function applyFilters() {
    currentFilters = {
      id: document.getElementById('filter-id').value.trim(),
      user: document.getElementById('filter-user').value.trim(),
      status: document.getElementById('filter-status').value,
      dateFrom: document.getElementById('filter-date-from').value,
      dateTo: document.getElementById('filter-date-to').value
    };
    
    loadOrders();
    
    // Show which filters are applied
    const appliedFilters = Object.entries(currentFilters)
      .filter(([_, value]) => value)
      .map(([key, _]) => key)
      .join(', ');
      
    if (appliedFilters) {
      showToast(`Filters applied: ${appliedFilters}`, 'info');
    }
  }
  
  // Reset all filters
  function resetFilters() {
    document.getElementById('filter-id').value = '';
    document.getElementById('filter-user').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-date-from').value = '';
    document.getElementById('filter-date-to').value = '';
    
    currentFilters = {
      id: '',
      user: '',
      status: '',
      dateFrom: '',
      dateTo: ''
    };
    
    loadOrders();
    showToast('Filters cleared', 'info');
  }
  
  function showToast(message, type = 'success') {
    const toastContainer = document.querySelector('.toast-container');
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', function() {
      toastElement.remove();
    });
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  function showLoading() {
    // åˆ›å»ºä¸€ä¸ªè¦†ç›–å±‚
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '9999';
    
    // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
    overlay.innerHTML = `
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    `;
    
    // æ·»åŠ åˆ°body
    document.body.appendChild(overlay);
  }
  
  // éšè—åŠ è½½çŠ¶æ€
  function hideLoading() {
    // ç§»é™¤è¦†ç›–å±‚
    const overlay = document.querySelector('.loading-overlay');
    if (overlay) {
      overlay.remove();
    }
  }
  
  // Function to copy order ID to clipboard
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text)
      .then(() => {
        showToast('Order ID copied to clipboard', 'info');
      })
      .catch(err => {
        console.error('Could not copy text: ', err);
      });
  }

  // è·å–è®¢å•çŠ¶æ€çš„é¢œè‰²
  function getStatusColor(status) {
    switch(status) {
      case 'pending': return 'warning';
      case 'processing': return 'info';
      case 'shipped': return 'primary';
      case 'delivered': return 'success';
      case 'cancelled': return 'danger';
      default: return 'secondary';
    }
  }
  
  // æ ¼å¼åŒ–æ”¯ä»˜æ–¹å¼
  function formatPaymentMethod(method) {
    if (!method) return 'Unknown';
    
    const methods = {
      'creditCard': 'Credit Card',
      'alipay': 'Alipay',
      'wechatPay': 'WeChat Pay',
      'bankTransfer': 'Bank Transfer'
    };
    
    return methods[method] || method;
  }
  
  // æ ¼å¼åŒ–æ”¶è´§åœ°å€
  function formatShippingAddress(address) {
    if (!address) return '<p>No address information available</p>';
    
    // å¤„ç†ä¸åŒçš„åœ°å€æ ¼å¼
    if (typeof address === 'string') {
      try {
        address = JSON.parse(address);
      } catch (e) {
        return `<p>${address}</p>`;
      }
    }
    
    return `
      <p>${address.fullName || address.name || ''}</p>
      <p>${address.streetAddress || address.street || ''} ${address.aptSuite || address.apt || ''}</p>
      <p>${address.city || ''}, ${address.state || address.province || ''} ${address.zipCode || address.zip || ''}</p>
      <p>${address.country || ''}</p>
      <p>Phone: ${address.phone || 'Not available'}</p>
    `;
  }
  
  // æ ¼å¼åŒ–è®¢å•é¡¹ç›®
  function formatOrderItems(items) {
    if (!items || !items.length) return '<tr><td colspan="4" class="text-center">No items</td></tr>';
    
    return items.map(item => {
      const product = item.product || {};
      const productName = product.name || item.productName || 'Unknown Product';
      const image = product.image || item.image;
      const price = item.price || product.price || 0;
      const quantity = item.quantity || 0;
      const subtotal = item.subtotal || (price * quantity) || 0;
      
      return `
        <tr>
          <td>
            ${image ? `<img src="${image}" alt="${productName}" width="50" class="me-2">` : ''}
            ${productName}
          </td>
          <td>$${parseFloat(price).toFixed(2)}</td>
          <td>${quantity}</td>
          <td>$${parseFloat(subtotal).toFixed(2)}</td>
        </tr>
      `;
    }).join('');
  }

  // å¤„ç†è®¢å•çŠ¶æ€æ›´æ–°
  async function handleOrder(orderId, action) {
    try {
      // æ˜¾ç¤ºåŠ è½½æç¤º
      showToast('Processing order...', 'info');
      
      // é€šè¿‡APIæ›´æ–°è®¢å•çŠ¶æ€
      console.log(`ğŸ“¡ å‘é€APIè¯·æ±‚: æ›´æ–°è®¢å•çŠ¶æ€ - PUT /orders/update (id: ${orderId}, action: ${action})`);
      const response = await AdminApiService.handleOrder(orderId, action);
      console.log('âœ… å¤„ç†è®¢å•å“åº”:', response);
      
      if (!response || !response.success) {
        throw new Error(response?.message || 'Failed to process order');
      }
      
      // å…³é—­æ¨¡æ€çª—å£
      const modal = bootstrap.Modal.getInstance(document.getElementById('orderDetailsModal'));
      if (modal) {
        modal.hide();
      }
      
      // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
      await loadOrders();
      
      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
      showToast(`Order status updated to ${action}`, 'success');
      
    } catch (error) {
      console.error('âŒ å¤„ç†è®¢å•æ—¶å‡ºé”™:', error);
      showToast(`Error processing order: ${error.message}`, 'danger');
    }
  }
</script>

<!-- åŠ è½½å¯¼èˆªæ å’Œåº•éƒ¨æ  -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // åŠ è½½å¯¼èˆªæ 
  fetch('/src/client/assets/layout/navbar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
      // åˆå§‹åŒ–å¯¼èˆªæ çš„ä»»ä½•è„šæœ¬
      if (typeof initNavbar === 'function') {
        initNavbar();
      }
      
      // æ›´æ–°è®¤è¯æŒ‰é’®çŠ¶æ€
      setTimeout(() => {
        const currentUser = localStorage.getItem('currentUser');
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const profileButton = document.getElementById('profile-button');
        const logoutButton = document.getElementById('logout-button');
        const adminButton = document.getElementById('admin-button');
        
        if (loginButton && registerButton) {
          if (currentUser) {
            // ç”¨æˆ·å·²ç™»å½•
            loginButton.style.display = 'none';
            registerButton.style.display = 'none';
            if (profileButton) profileButton.style.display = 'block';
            if (logoutButton) logoutButton.style.display = 'block';
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
            try {
              const userData = JSON.parse(currentUser);
              if (userData.isAdmin && adminButton) {
                adminButton.style.display = 'block';
              }
            } catch (e) {
              console.error('è§£æç”¨æˆ·æ•°æ®å‡ºé”™', e);
            }
          } else {
            // ç”¨æˆ·æœªç™»å½•
            loginButton.style.display = 'block';
            registerButton.style.display = 'block';
            if (profileButton) profileButton.style.display = 'none';
            if (logoutButton) logoutButton.style.display = 'none';
            if (adminButton) adminButton.style.display = 'none';
          }
        }
      }, 300);
    })
    .catch(error => {
      console.error('Error loading navbar:', error);
    });
  
  // åŠ è½½åº•éƒ¨æ 
  fetch('/src/client/assets/layout/footer.html')
    .then(response => response.text())
    .then(data => {
      if (document.getElementById('footer-placeholder')) {
        document.getElementById('footer-placeholder').innerHTML = data;
      } else {
        // å¦‚æœåº•éƒ¨æ å ä½ç¬¦ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª
        const footerPlaceholder = document.createElement('div');
        footerPlaceholder.id = 'footer-placeholder';
        document.body.appendChild(footerPlaceholder);
        footerPlaceholder.innerHTML = data;
      }
    })
    .catch(error => {
      console.error('Error loading footer:', error);
    });
});
</script>
</body>
</html> 