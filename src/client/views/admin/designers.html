<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Designer Management - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Style for action buttons */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Admin button styles */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
    
    /* Style for category featured badge */
    .badge-success {
      background-color: #5a8c70;
      color: white;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-speedometer2 me-2"></i>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="products.html">
              <i class="bi bi-box me-2"></i>
              Products
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="categories.html">
              <i class="bi bi-tags me-2"></i>
              Categories
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="designers.html">
              <i class="bi bi-palette me-2"></i>
              Designers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="orders.html">
              <i class="bi bi-cart-check me-2"></i>
              Orders
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="users.html">
              <i class="bi bi-people me-2"></i>
              Users
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="comments.html">
              <i class="bi bi-chat-dots me-2"></i>
              Reviews
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="reports.html">
              <i class="bi bi-graph-up me-2"></i>
              Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="settings.html">
              <i class="bi bi-gear me-2"></i>
              Settings
            </a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-person-badge me-2 text-primary"></i>Designer Management</h1>
    <div>
      <a href="/src/client/views/auth/profile.html" class="btn btn-outline-secondary">
        <i class="bi bi-person me-2"></i>Back to Profile
      </a>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">
      <div class="row align-items-center">
        <div class="col">
          <h5 class="mb-0">Designer Management</h5>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#designerModal" onclick="resetDesignerForm()">
            <i class="bi bi-plus-circle me-2"></i>Add Designer
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Add filter section -->
      <div class="mb-4 p-3 border rounded bg-light">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="filter-name" class="form-label">Designer Name</label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="bi bi-person"></i></span>
              <input type="text" class="form-control" id="filter-name" placeholder="Filter by designer name">
            </div>
          </div>
          <div class="col-md-6">
            <label for="filter-specialty" class="form-label">Specialty</label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="bi bi-tools"></i></span>
              <input type="text" class="form-control" id="filter-specialty" placeholder="Filter by specialty">
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12 d-flex justify-content-end">
            <button class="btn btn-outline-secondary me-2" onclick="resetFilters()">
              <i class="bi bi-x-circle me-1"></i>Clear
            </button>
            <button class="btn btn-primary" onclick="applyFilters()">
              <i class="bi bi-search me-1"></i>Search
            </button>
          </div>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Name</th>
              <th>Specialty</th>
              <th>Products</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="designerTableBody">
            <!-- Designer data will be loaded here -->
          </tbody>
        </table>
      </div>
    </div>
      </div>
    </main>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- æ¨¡æ€çª—å£ï¼šç¼–è¾‘/æ·»åŠ è®¾è®¡å¸ˆ -->
<div class="modal fade" id="designerModal" tabindex="-1" aria-labelledby="designerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="designerModalLabel">Add New Designer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="designerForm">
          <input type="hidden" id="designerId">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="designerName" class="form-label">Designer Name</label>
                <input type="text" class="form-control" id="designerName" required>
              </div>
              <div class="mb-3">
                <label for="designerSpecialty" class="form-label">Specialty</label>
                <input type="text" class="form-control" id="designerSpecialty" required>
              </div>
              <div class="mb-3">
                <label for="designerBio" class="form-label">Biography</label>
                <textarea class="form-control" id="designerBio" rows="3" required></textarea>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Profile Images</label>
                <div id="designerImagesContainer">
                  <!-- Image previews will be added here -->
                </div>
                <div class="d-grid mt-2">
                  <button type="button" class="admin-btn admin-btn-primary" onclick="document.getElementById('designerImage').click()">
                    <i class="bi bi-upload me-1"></i> Upload Images
                  </button>
                </div>
                <input type="file" id="designerImage" accept="image/*" multiple style="display: none;" onchange="previewDesignerImages(event)">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Social Media Links</label>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-instagram"></i></span>
              <input type="url" class="form-control" id="designerInstagram" placeholder="Instagram URL">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-pinterest"></i></span>
              <input type="url" class="form-control" id="designerPinterest" placeholder="Pinterest URL">
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shop"></i></span>
              <input type="url" class="form-control" id="designerEtsy" placeholder="Etsy URL">
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="designerFeatured">
              <label class="form-check-label" for="designerFeatured">
                Set as Featured Designer
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveDesigner()">Save Designer</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- ç›´æ¥åœ¨é¡µé¢ä¸­å†…è”å®šä¹‰å…³é”®æœåŠ¡ï¼Œé¿å…åŠ è½½é—®é¢˜ -->
<script>
/**
 * API Service for Purely Handmade
 * æä¾›ç»Ÿä¸€çš„APIè®¿é—®å±‚ï¼Œå¤„ç†æ‰€æœ‰ä¸æœåŠ¡å™¨çš„é€šä¿¡
 */
const ApiService = {
  // åŸºç¡€API URL
  baseUrl: '/api',
  
  // è·å–æˆæƒä»¤ç‰Œ
  getAuthToken: function() {
    return localStorage.getItem('authToken');
  },
  
  // è·å–å¸¦æœ‰æˆæƒä¿¡æ¯çš„è¯·æ±‚å¤´
  getAuthHeaders: function() {
    const token = this.getAuthToken();
    return token ? {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    } : {
      'Content-Type': 'application/json'
    };
  },
  
  // å¤„ç†APIå“åº”
  handleResponse: async function(response) {
    const contentType = response.headers.get('content-type');
    const isJson = contentType && contentType.includes('application/json');
    
    // å¦‚æœçŠ¶æ€ç ä¸åœ¨2xxèŒƒå›´å†…ï¼ŒæŠ›å‡ºé”™è¯¯
    if (!response.ok) {
      let errorData;
      
      try {
        errorData = isJson ? await response.json() : await response.text();
      } catch (error) {
        errorData = 'Failed to parse error response';
      }
      
      const error = new Error(
        isJson && errorData.error 
          ? errorData.error 
          : 'API request failed'
      );
      
      error.status = response.status;
      error.statusText = response.statusText;
      error.data = errorData;
      
      throw error;
    }
    
    // è§£ææˆåŠŸå“åº”
    return isJson ? response.json() : response.text();
  },
  
  // å‘é€è¯·æ±‚
  request: async function(url, options = {}) {
    const fullUrl = url.startsWith('http') ? url : this.baseUrl + url;
    
    // é»˜è®¤é€‰é¡¹
    const defaultOptions = {
      headers: this.getAuthHeaders(),
      credentials: 'same-origin',
    };
    
    // åˆå¹¶é€‰é¡¹
    const fetchOptions = {
      ...defaultOptions,
      ...options,
      headers: {
        ...defaultOptions.headers,
        ...options.headers,
      },
    };
    
    // è°ƒè¯•æ—¥å¿—
    console.log(`ğŸš€ å‘é€APIè¯·æ±‚: ${options.method || 'GET'} ${fullUrl}`);
    console.log('ğŸ”‘ è¯·æ±‚å¤´:', JSON.stringify(fetchOptions.headers));
    
    try {
      const response = await fetch(fullUrl, fetchOptions);
      console.log(`ğŸ“¥ æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`);
      return await this.handleResponse(response);
    } catch (error) {
      console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  },
  
  // GETè¯·æ±‚
  get: function(url, params = {}) {
    // æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
    const queryParams = new URLSearchParams();
    Object.keys(params).forEach(key => {
      if (params[key] !== undefined && params[key] !== null) {
        queryParams.append(key, params[key]);
      }
    });
    
    const queryString = queryParams.toString();
    const fullUrl = queryString ? `${url}?${queryString}` : url;
    
    return this.request(fullUrl, { method: 'GET' });
  },
  
  // POSTè¯·æ±‚
  post: function(url, data = {}) {
    return this.request(url, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  
  // PUTè¯·æ±‚
  put: function(url, data = {}) {
    return this.request(url, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
  
  // DELETEè¯·æ±‚
  delete: function(url) {
    return this.request(url, { method: 'DELETE' });
  }
};

/**
 * Admin API Service for Purely Handmade
 * æä¾›ç®¡ç†å‘˜APIè®¿é—®å±‚ï¼Œå¤„ç†ä¸æœåŠ¡å™¨çš„ç®¡ç†åŠŸèƒ½é€šä¿¡
 */
const AdminApiService = {
  // è·å–æ‰€æœ‰è®¾è®¡å¸ˆ
  getAllDesigners: function() {
    return ApiService.get('/designers');
  },
  
  // è·å–è®¾è®¡å¸ˆè¯¦æƒ…
  getDesignerById: function(designerId) {
    return ApiService.get(`/designers/detail?id=${designerId}`);
  },
  
  // æ·»åŠ æ–°è®¾è®¡å¸ˆ
  addDesigner: function(designerData) {
    return ApiService.post('/designers/create', designerData);
  },
  
  // æ›´æ–°è®¾è®¡å¸ˆ
  updateDesigner: function(designerId, designerData) {
    return ApiService.put(`/designers/update`, { id: designerId, ...designerData });
  },
  
  // åˆ é™¤è®¾è®¡å¸ˆ
  deleteDesigner: function(designerId) {
    return ApiService.delete(`/designers?id=${designerId}`);
  },
  
  // è·å–æ‰€æœ‰äº§å“
  getAllProducts: function() {
    return ApiService.get('/products');
  }
};
</script>

<script src="/src/client/js/data-service.js"></script>
<script src="/src/client/js/ui-helpers.js"></script>
<script src="/src/client/js/common.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ç¡®ä¿æˆæƒä»¤ç‰Œå­˜åœ¨
    initApiAuth();
    
    // åŠ è½½navbarå’Œfooter
    loadNavbar();
    loadFooter();
    
    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    checkAdminPermissions();
  });
  
  // åˆå§‹åŒ–APIæˆæƒ
  function initApiAuth() {
    console.log('åˆå§‹åŒ–APIæˆæƒ');
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒä»¤ç‰Œ
    const token = localStorage.getItem('authToken');
    console.log('å½“å‰æˆæƒä»¤ç‰Œ:', token);
    
    // å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ›å»ºä¸€ä¸ª
    if (!token) {
      console.log('è®¾ç½®é»˜è®¤æˆæƒä»¤ç‰Œ');
      localStorage.setItem('authToken', 'valid-admin-token');
      
      // è®¾ç½®å½“å‰ç”¨æˆ·ä¿¡æ¯
      const currentUser = {
        id: 1,
        username: 'admin',
        isAdmin: true
      };
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      console.log('å·²è®¾ç½®é»˜è®¤ç®¡ç†å‘˜ç”¨æˆ·:', currentUser);
    }
  }
  
  function initDesignerManagement() {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoadingState();
    
    // æœç´¢åŠŸèƒ½ - ä¿®å¤äº‹ä»¶ç›‘å¬å™¨
    document.getElementById('filter-name').addEventListener('keyup', function(e) {
      if (e.key === 'Enter') {
        applyFilters();
      }
    });
    
    // ä½¿ç”¨å·²æœ‰çš„æœç´¢æŒ‰é’®
    const searchButton = document.querySelector('.btn-primary[onclick="applyFilters()"]');
    if (searchButton) {
      searchButton.addEventListener('click', applyFilters);
    }
    
    // æ·»åŠ è®¾è®¡å¸ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const addDesignerBtn = document.querySelector('.btn[data-bs-target="#designerModal"]');
    if (addDesignerBtn) {
      addDesignerBtn.addEventListener('click', function() {
        resetDesignerForm();
        // æ˜¾ç¤ºæ¨¡æ€çª—å£
        const modal = new bootstrap.Modal(document.getElementById('designerModal'));
        modal.show();
      });
    }
    
    // ä¿å­˜è®¾è®¡å¸ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const saveDesignerBtn = document.querySelector('.modal-footer .admin-btn-primary');
    if (saveDesignerBtn) {
      saveDesignerBtn.addEventListener('click', saveDesigner);
    }
  }
  
  function checkAdminPermissions() {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
    const token = localStorage.getItem('authToken');
    console.log('ğŸ” æ£€æŸ¥ç®¡ç†å‘˜æƒé™ - Token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
    
    if (!token) {
      // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
      console.log('âŒ æœªæ‰¾åˆ°è®¤è¯ä»¤ç‰Œï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢');
      window.location.href = '/src/client/views/auth/login.html?redirect=admin';
      return;
    }
    
    // è°ƒç”¨APIéªŒè¯ç”¨æˆ·æƒé™
    console.log('ğŸ“¡ å‘é€APIè¯·æ±‚: /auth/profile');
    ApiService.get('/auth/profile')
      .then(response => {
        console.log('âœ… æ”¶åˆ°profileå“åº”:', response);
        if (!response.success || !response.data.isAdmin) {
          // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œé‡å®šå‘åˆ°é¦–é¡µ
          console.log('âŒ ç”¨æˆ·ä¸æ˜¯ç®¡ç†å‘˜ï¼ŒisAdmin =', response.data?.isAdmin);
          showToast('You do not have permission to access this area', 'danger');
          setTimeout(() => {
            window.location.href = '/src/client/views/index.html';
          }, 2000);
        } else {
          // åŠ è½½è®¾è®¡å¸ˆæ•°æ®
          console.log('âœ… ç”¨æˆ·æ˜¯ç®¡ç†å‘˜ï¼ŒåŠ è½½è®¾è®¡å¸ˆæ•°æ®');
          loadDesigners();
          initDesignerManagement();
        }
      })
      .catch(error => {
        console.error('âŒ æ£€æŸ¥ç®¡ç†å‘˜æƒé™å‡ºé”™:', error);
        // éªŒè¯å¤±è´¥ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
        showToast('Authentication error. Please login again.', 'danger');
        setTimeout(() => {
          window.location.href = '/src/client/views/auth/login.html?redirect=admin';
        }, 2000);
      });
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  function showLoadingState() {
    const designerContainer = document.getElementById('designerTableBody');
    if (!designerContainer) {
      console.error('æ‰¾ä¸åˆ°è®¾è®¡å¸ˆæ•°æ®å®¹å™¨ (designerTableBody)');
      return;
    }
    
    designerContainer.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
          </div>
          <p class="mt-3">æ­£åœ¨åŠ è½½è®¾è®¡å¸ˆæ•°æ®...</p>
        </td>
      </tr>
    `;
  }
  
  // éšè—åŠ è½½çŠ¶æ€
  function hideLoadingState() {
    // åŠ è½½å®Œæˆåå†…å®¹å·²ç»è¢«æ›¿æ¢ï¼Œä¸éœ€è¦é¢å¤–æ“ä½œ
  }
  
  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
  function showError(message) {
    const designerContainer = document.getElementById('designerTableBody');
    if (!designerContainer) {
      console.error('æ‰¾ä¸åˆ°è®¾è®¡å¸ˆæ•°æ®å®¹å™¨ (designerTableBody)');
      return;
    }
    
    designerContainer.innerHTML = `
      <tr>
        <td colspan="5" class="text-center">
          <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            ${message}
          </div>
        </td>
      </tr>
    `;
  }
  
  // æ˜¾ç¤ºé€šçŸ¥æ¶ˆæ¯
  function showToast(message, type = 'success') {
    // æ£€æŸ¥UIè¾…åŠ©å‡½æ•°æ˜¯å¦å¯ç”¨
    if (typeof UIHelpers !== 'undefined' && typeof UIHelpers.showToast === 'function') {
      UIHelpers.showToast(message, type);
      return;
    }
    
    // åå¤‡å®ç°
    const toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
      return;
    }
    
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('aria-atomic', 'true');
    
    toastElement.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    
    toastContainer.appendChild(toastElement);
    
    const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
    toast.show();
  }
  
  // åŠ è½½è®¾è®¡å¸ˆæ•°æ®
  async function loadDesigners() {
    try {
      // ä»APIè·å–è®¾è®¡å¸ˆæ•°æ®
      const response = await AdminApiService.getAllDesigners()
        .catch(error => {
          console.error('APIé”™è¯¯:', error);
          throw new Error('è·å–è®¾è®¡å¸ˆæ•°æ®å¤±è´¥');
        });
      
      if (!response || !response.success) {
        throw new Error(response && response.data ? response.data : 'è·å–è®¾è®¡å¸ˆæ•°æ®å¤±è´¥');
      }
      
      const designers = response.data || [];
      
      // æ¸²æŸ“è®¾è®¡å¸ˆæ•°æ®
      renderDesigners(designers);
      
      // éšè—åŠ è½½çŠ¶æ€
      hideLoadingState();
    } catch (error) {
      console.error('åŠ è½½è®¾è®¡å¸ˆæ•°æ®å‡ºé”™:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showError('æ— æ³•åŠ è½½è®¾è®¡å¸ˆæ•°æ®ï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
      
      // éšè—åŠ è½½çŠ¶æ€
      hideLoadingState();
    }
  }
  
  // æ¸²æŸ“è®¾è®¡å¸ˆè¡Œ
  function renderDesignerRow(designer, container) {
    const row = document.createElement('tr');
    row.setAttribute('data-designer-id', designer.id);
    row.setAttribute('data-designer-name', designer.name);
    
    row.innerHTML = `
      <td>
        <div class="designer-img-small">
          <img src="${designer.image || 'https://via.placeholder.com/50x50?text=Designer'}" class="img-thumbnail" alt="${designer.name}" 
               style="width: 50px; height: 50px; object-fit: cover;">
        </div>
      </td>
      <td>
        <div class="designer-info">
          <div class="fw-bold">${designer.name}</div>
          <div class="text-muted small">${designer.slug}</div>
          ${designer.featured ? '<span class="badge bg-primary">Featured</span>' : ''}
        </div>
      </td>
      <td>${designer.bio ? designer.bio.substring(0, 50) + (designer.bio.length > 50 ? '...' : '') : 'No bio available'}</td>
      <td>0</td>
      <td class="text-center">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-secondary edit-designer-btn" data-designer-id="${designer.id}">
            <i class="bi bi-pencil-square"></i>
          </button>
          <button type="button" class="btn btn-sm btn-outline-danger delete-designer-btn" data-designer-id="${designer.id}">
            <i class="bi bi-trash"></i>
          </button>
          <div class="form-check form-switch d-inline-block ms-2">
            <input class="form-check-input featured-toggle" type="checkbox" id="featured-${designer.id}" 
                   ${designer.featured ? 'checked' : ''}>
          </div>
        </div>
      </td>
    `;
    
    // æ·»åŠ åˆ°å®¹å™¨
    container.appendChild(row);
    
    // æ·»åŠ ç¼–è¾‘æŒ‰é’®äº‹ä»¶
    row.querySelector('.edit-designer-btn').addEventListener('click', function() {
      editDesigner(designer.id);
    });
    
    // æ·»åŠ åˆ é™¤æŒ‰é’®äº‹ä»¶
    row.querySelector('.delete-designer-btn').addEventListener('click', function() {
      deleteDesigner(designer.id);
    });
    
    // æ·»åŠ Featuredåˆ‡æ¢äº‹ä»¶
    row.querySelector('.featured-toggle').addEventListener('change', function() {
      toggleDesignerFeatured(designer.id, this.checked);
    });
  }
  
  // ç­›é€‰è®¾è®¡å¸ˆ
  function filterDesigners(query) {
    const designerRows = document.querySelectorAll('#designerTableBody tr');
    
    designerRows.forEach(row => {
      const designerName = row.getAttribute('data-designer-name');
      if (designerName && (query === '' || designerName.toLowerCase().includes(query.toLowerCase()))) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  
  // åº”ç”¨ç­›é€‰æ¡ä»¶
  function applyFilters() {
    const nameFilter = document.getElementById('filter-name').value.trim().toLowerCase();
    const specialtyFilter = document.getElementById('filter-specialty').value.trim().toLowerCase();
    
    const designerRows = document.querySelectorAll('#designerTableBody tr');
    
    designerRows.forEach(row => {
      const designerName = row.getAttribute('data-designer-name');
      const designerSpecialty = row.querySelector('td:nth-child(3)').textContent;
      
      const nameMatch = !nameFilter || (designerName && designerName.toLowerCase().includes(nameFilter));
      const specialtyMatch = !specialtyFilter || (designerSpecialty && designerSpecialty.toLowerCase().includes(specialtyFilter));
      
      if (nameMatch && specialtyMatch) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }
  
  // é‡ç½®ç­›é€‰æ¡ä»¶
  function resetFilters() {
    document.getElementById('filter-name').value = '';
    document.getElementById('filter-specialty').value = '';
    
    const designerRows = document.querySelectorAll('#designerTableBody tr');
    designerRows.forEach(row => {
      row.style.display = '';
    });
  }
  
  // é‡ç½®è®¾è®¡å¸ˆè¡¨å•
  function resetDesignerForm() {
    document.getElementById('designerId').value = '';
    document.getElementById('designerName').value = '';
    document.getElementById('designerSpecialty').value = '';
    document.getElementById('designerBio').value = '';
    document.getElementById('designerFeatured').checked = false;
    document.getElementById('designerInstagram').value = '';
    document.getElementById('designerPinterest').value = '';
    document.getElementById('designerEtsy').value = '';
    
    // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
    document.getElementById('designerImagesContainer').innerHTML = '';
    
    document.getElementById('designerModalLabel').textContent = 'æ·»åŠ è®¾è®¡å¸ˆ';
  }
  
  // ç¼–è¾‘è®¾è®¡å¸ˆ
  async function editDesigner(designerId) {
    try {
      showToast('åŠ è½½è®¾è®¡å¸ˆæ•°æ®...', 'info');
      
      // ä»åç«¯APIè·å–è®¾è®¡å¸ˆæ•°æ®
      const response = await AdminApiService.getDesignerById(designerId)
        .catch(error => {
          console.error('APIé”™è¯¯:', error);
          throw new Error('è·å–è®¾è®¡å¸ˆæ•°æ®å¤±è´¥');
        });
      
      if (!response || !response.success) {
        throw new Error(response && response.data ? response.data : 'è·å–è®¾è®¡å¸ˆæ•°æ®å¤±è´¥');
      }
      
      const designer = response.data;
      
      if (!designer) {
        throw new Error('è®¾è®¡å¸ˆä¸å­˜åœ¨');
      }
      
      // å¡«å……è¡¨å•
      document.getElementById('designerId').value = designer.id;
      document.getElementById('designerName').value = designer.name;
      document.getElementById('designerSpecialty').value = designer.specialty || '';
      document.getElementById('designerBio').value = designer.bio || '';
      document.getElementById('designerFeatured').checked = designer.featured;
      document.getElementById('designerInstagram').value = designer.instagram || '';
      document.getElementById('designerPinterest').value = designer.pinterest || '';
      document.getElementById('designerEtsy').value = designer.etsy || '';
      
      // æ¸…ç©ºå›¾ç‰‡å®¹å™¨
      const imagesContainer = document.getElementById('designerImagesContainer');
      imagesContainer.innerHTML = '';
      
      // æ˜¾ç¤ºç°æœ‰å›¾ç‰‡
      if (designer.image) {
        const imgDiv = document.createElement('div');
        imgDiv.className = 'mb-2 position-relative';
        imgDiv.innerHTML = `
          <img src="${designer.image}" class="img-thumbnail" alt="${designer.name}" 
               style="width: 100%; height: 150px; object-fit: cover;">
        `;
        imagesContainer.appendChild(imgDiv);
      }
      
      document.getElementById('designerModalLabel').textContent = 'ç¼–è¾‘è®¾è®¡å¸ˆ';
      
      // æ˜¾ç¤ºæ¨¡æ€çª—å£
      new bootstrap.Modal(document.getElementById('designerModal')).show();
      
    } catch (error) {
      console.error('ç¼–è¾‘è®¾è®¡å¸ˆå‡ºé”™:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showError('æ— æ³•åŠ è½½è®¾è®¡å¸ˆæ•°æ®ï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
  }
  
  // ä¿å­˜è®¾è®¡å¸ˆ
  async function saveDesigner() {
    // è·å–è¡¨å•æ•°æ®
    const designerId = document.getElementById('designerId').value;
    const name = document.getElementById('designerName').value.trim();
    const specialty = document.getElementById('designerSpecialty').value.trim();
    const bio = document.getElementById('designerBio').value.trim();
    const featured = document.getElementById('designerFeatured').checked;
    const instagram = document.getElementById('designerInstagram').value.trim();
    const pinterest = document.getElementById('designerPinterest').value.trim();
    const etsy = document.getElementById('designerEtsy').value.trim();
    
    // éªŒè¯
    if (!name) {
      showToast('è®¾è®¡å¸ˆåç§°ä¸èƒ½ä¸ºç©º', 'danger');
      return;
    }
    
    // ç”Ÿæˆslug
    const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showToast('ä¿å­˜è®¾è®¡å¸ˆæ•°æ®...', 'info');
      
      // å‡†å¤‡æ•°æ®
      const designerData = {
        name,
        slug,
        specialty,
        bio,
        featured,
        instagram,
        pinterest,
        etsy
      };
      
      // å¤„ç†å›¾ç‰‡
      const imageContainer = document.getElementById('designerImagesContainer');
      const images = imageContainer.querySelectorAll('img');
      if (images && images.length > 0) {
        // ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ä½œä¸ºä¸»å›¾
        designerData.image = images[0].src;
      }
      
      // ä¿å­˜åˆ°API
      await saveDesignerToAPI(designerId, designerData);
      
    } catch (error) {
      console.error('ä¿å­˜è®¾è®¡å¸ˆå‡ºé”™:', error);
      showToast('ä¿å­˜è®¾è®¡å¸ˆå¤±è´¥', 'danger');
    }
  }
  
  // ä¿å­˜è®¾è®¡å¸ˆåˆ°API
  async function saveDesignerToAPI(designerId, designerData) {
    try {
      let response;
      
      if (designerId) {
        // æ›´æ–°ç°æœ‰è®¾è®¡å¸ˆ
        response = await AdminApiService.updateDesigner(designerId, designerData);
      } else {
        // åˆ›å»ºæ–°è®¾è®¡å¸ˆ
        response = await AdminApiService.addDesigner(designerData);
      }
      
      if (!response.success) {
        throw new Error(response.data || 'ä¿å­˜è®¾è®¡å¸ˆå¤±è´¥');
      }
      
      // å…³é—­æ¨¡æ€çª—å£
      const modalElement = document.getElementById('designerModal');
      const modalInstance = bootstrap.Modal.getInstance(modalElement);
      if (modalInstance) {
        modalInstance.hide();
      }
      
      // é‡æ–°åŠ è½½è®¾è®¡å¸ˆæ•°æ®
      await loadDesigners();
      
      showToast(designerId ? 'è®¾è®¡å¸ˆæ›´æ–°æˆåŠŸ' : 'è®¾è®¡å¸ˆåˆ›å»ºæˆåŠŸ', 'success');
    } catch (error) {
      console.error('ä¿å­˜è®¾è®¡å¸ˆåˆ°APIå‡ºé”™:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showError('æ— æ³•ä¿å­˜è®¾è®¡å¸ˆæ•°æ®ï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
  }
  
  // åˆ é™¤è®¾è®¡å¸ˆ
  async function deleteDesigner(designerId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤è®¾è®¡å¸ˆå—ï¼Ÿç›¸å…³äº§å“å°†ä¸å†å…³è”æ­¤è®¾è®¡å¸ˆã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
      return;
    }
    
    try {
      showToast('åˆ é™¤è®¾è®¡å¸ˆ...', 'info');
      
      // ä»åç«¯APIåˆ é™¤è®¾è®¡å¸ˆ
      const response = await AdminApiService.deleteDesigner(designerId);
      
      if (!response.success) {
        throw new Error(response.data || 'åˆ é™¤è®¾è®¡å¸ˆå¤±è´¥');
      }
      
      // é‡æ–°åŠ è½½è®¾è®¡å¸ˆæ•°æ®
      await loadDesigners();
      
      showToast('è®¾è®¡å¸ˆåˆ é™¤æˆåŠŸ', 'success');
    } catch (error) {
      console.error('åˆ é™¤è®¾è®¡å¸ˆå‡ºé”™:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showError('æ— æ³•åˆ é™¤è®¾è®¡å¸ˆï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
  }
  
  // åˆ‡æ¢è®¾è®¡å¸ˆçš„FeaturedçŠ¶æ€
  async function toggleDesignerFeatured(designerId, featured) {
    try {
      // ä»åç«¯APIè·å–è®¾è®¡å¸ˆæ•°æ®
      const response = await AdminApiService.getDesignerById(designerId);
      
      if (!response.success) {
        throw new Error(response.data || 'è·å–è®¾è®¡å¸ˆæ•°æ®å¤±è´¥');
      }
      
      const designer = response.data;
      
      if (!designer) {
        throw new Error('è®¾è®¡å¸ˆä¸å­˜åœ¨');
      }
      
      // æ›´æ–°è®¾è®¡å¸ˆ
      const updateResponse = await AdminApiService.updateDesigner(designerId, {
        ...designer,
        featured: featured
      });
      
      if (!updateResponse.success) {
        throw new Error(updateResponse.data || 'æ›´æ–°è®¾è®¡å¸ˆå¤±è´¥');
      }
      
      showToast(featured ? 'è®¾è®¡å¸ˆå·²è®¾ä¸ºæ¨è' : 'è®¾è®¡å¸ˆå·²å–æ¶ˆæ¨è', 'success');
    } catch (error) {
      console.error('åˆ‡æ¢è®¾è®¡å¸ˆFeaturedçŠ¶æ€å‡ºé”™:', error);
      
      // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
      showError('æ— æ³•æ›´æ–°è®¾è®¡å¸ˆçŠ¶æ€ï¼Œè¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
  }
  
  // é¢„è§ˆè®¾è®¡å¸ˆå›¾ç‰‡ - ä¿®å¤å‡½æ•°åå’Œå‚æ•°
  function previewDesignerImages(event) {
    const files = event.target.files;
    if (files && files.length > 0) {
      const container = document.getElementById('designerImagesContainer');
      container.innerHTML = '';
      
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imgDiv = document.createElement('div');
          imgDiv.className = 'mb-2 position-relative';
          imgDiv.innerHTML = `
            <img src="${e.target.result}" class="img-thumbnail" style="width: 100%; height: 150px; object-fit: cover;">
            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 remove-image">
              <i class="bi bi-x"></i>
            </button>
          `;
          container.appendChild(imgDiv);
          
          imgDiv.querySelector('.remove-image').addEventListener('click', function() {
            imgDiv.remove();
          });
        };
        reader.readAsDataURL(file);
      });
    }
  }
  
  // ç»‘å®šå›¾ç‰‡é¢„è§ˆäº‹ä»¶
  document.getElementById('designerImage').addEventListener('change', previewDesignerImages);
  
  // æ¸²æŸ“è®¾è®¡å¸ˆæ•°æ®
  function renderDesigners(designers) {
    const designerContainer = document.getElementById('designerTableBody');
    if (!designerContainer) {
      console.error('æ‰¾ä¸åˆ°è®¾è®¡å¸ˆæ•°æ®å®¹å™¨ (designerTableBody)');
      return;
    }
    
    if (designers.length === 0) {
      designerContainer.innerHTML = `
        <tr>
          <td colspan="5" class="text-center">
            <p>æš‚æ— è®¾è®¡å¸ˆæ•°æ®ã€‚ç‚¹å‡» "æ·»åŠ è®¾è®¡å¸ˆ" æŒ‰é’®åˆ›å»ºæ–°è®¾è®¡å¸ˆã€‚</p>
          </td>
        </tr>
      `;
      return;
    }
    
    // æ¸…ç©ºå®¹å™¨
    designerContainer.innerHTML = '';
    
    // åŠ è½½è®¾è®¡å¸ˆæ•°æ®åˆ°è¡¨æ ¼
    designers.forEach(designer => {
      renderDesignerRow(designer, designerContainer);
    });
  }
</script>
</body>
</html> 