<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purely Homemade - Category</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <link rel="stylesheet" href="../../css/global.css">

  <style>
    /* Page header styles */
    .page-header {
      background-color: #f8f9fa;
      padding: 40px 0;
      margin-bottom: 40px;
      text-align: center;
    }
    
    .page-title {
      font-size: 2.5rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }
    
    .page-subtitle {
      font-size: 1.1rem;
      color: #6c757d;
    }
    
    /* Filter sidebar styles */
    .filter-section {
      margin-bottom: 20px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 20px;
    }
    
    .filter-section:last-child {
      border-bottom: none;
    }
    
    .filter-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .price-range {
      display: flex;
      align-items: center;
    }
    
    .price-range input {
      width: 70px;
      margin: 0 10px;
    }
    
    /* Product card styles */
    .product-card {
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      transition: transform 0.3s, box-shadow 0.3s;
      height: 100%;
      position: relative;
    }
    
    .product-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
    }
    
    .product-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .product-img {
      height: 250px;
      object-fit: cover;
    }
    
    .product-price {
      font-weight: bold;
      color: #0d6efd;
      font-size: 1.1rem;
    }
    
    .product-price-discount {
      color: #6c757d;
      text-decoration: line-through;
      margin-left: 10px;
      font-size: 0.9rem;
    }
    
    .rating {
      color: #ffc107;
      margin-bottom: 10px;
    }
    
    /* Toast notification container */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    /* Loading spinner */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
    }
    
    /* Sort dropdown */
    .sort-dropdown {
      width: auto;
      min-width: 200px;
    }
    
    /* Category banner */
    .category-banner {
      position: relative;
      height: 250px;
      margin-bottom: 30px;
      overflow: hidden;
      border-radius: 10px;
    }
    
    .category-banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .category-banner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to right, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 30px;
      color: white;
    }
    
    .category-banner-title {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    .category-banner-description {
      font-size: 1.1rem;
      max-width: 600px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background-color: #f8f9fa;
      border-radius: 10px;
      margin: 20px 0;
    }
    
    .empty-state i {
      font-size: 3rem;
      color: #6c757d;
      margin-bottom: 20px;
    }
    
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    /* Responsive adjustments */
    @media (max-width: 992px) {
      .category-banner-title {
        font-size: 2rem;
      }
      
      .filter-sidebar {
        margin-bottom: 30px;
      }
    }
    
    @media (max-width: 768px) {
      .category-banner {
        height: 200px;
      }
      
      .category-banner-title {
        font-size: 1.8rem;
      }
      
      .category-banner-description {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Breadcrumb -->
<div class="container mt-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb" id="breadcrumb">
      <li class="breadcrumb-item"><a href="../../../index.html">Home</a></li>
      <li class="breadcrumb-item"><a href="category-list.html">Categories</a></li>
      <li class="breadcrumb-item active" id="breadcrumb-category">Category</li>
    </ol>
  </nav>
</div>

<!-- Category Banner -->
<div class="container">
  <div class="category-banner" id="category-banner">
    <img src="../../img/category-placeholder.jpg" alt="Category" id="category-image">
    <div class="category-banner-overlay">
      <h1 class="category-banner-title" id="category-title">Loading Category...</h1>
      <p class="category-banner-description" id="category-description">Please wait while we load the category details.</p>
    </div>
  </div>
</div>

<!-- Products Section -->
<div class="container mb-5">
  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="mb-4">Filters</h5>
          
          <!-- Price Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Price Range</h6>
            <div class="price-range">
              <span>$</span>
              <input type="number" class="form-control" id="price-min" placeholder="Min" min="0">
              <span>to</span>
              <input type="number" class="form-control" id="price-max" placeholder="Max" min="0">
            </div>
            <button class="btn btn-sm btn-outline-primary mt-2" id="apply-price-filter">Apply</button>
          </div>
          
          <!-- Rating Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Rating</h6>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="4" id="rating-4">
              <label class="form-check-label" for="rating-4">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="3" id="rating-3">
              <label class="form-check-label" for="rating-3">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="2" id="rating-2">
              <label class="form-check-label" for="rating-2">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
          </div>
          
          <!-- Availability Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Availability</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="inStock" id="in-stock">
              <label class="form-check-label" for="in-stock">
                In Stock
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="onSale" id="on-sale">
              <label class="form-check-label" for="on-sale">
                On Sale
              </label>
            </div>
          </div>
          
          <!-- Clear Filters Button -->
          <button class="btn btn-outline-secondary w-100" id="clear-filters">Clear All Filters</button>
        </div>
      </div>
    </div>
    
    <!-- Product Grid -->
    <div class="col-lg-9">
      <!-- Sorting and Results Count -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div id="results-count">Showing all products</div>
        <div class="d-flex align-items-center">
          <label for="sort-by" class="me-2">Sort by:</label>
          <select class="form-select form-select-sm sort-dropdown" id="sort-by">
            <option value="featured">Featured</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="rating-desc">Highest Rated</option>
            <option value="newest">Newest</option>
          </select>
        </div>
      </div>
      
      <!-- Loading Indicator -->
      <div class="loading-container" id="loading-indicator">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading products...</p>
      </div>
      
      <!-- Product Grid -->
      <div class="row" id="products-container">
        <!-- Products will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Initialize data script -->
<script src="../../js/init-data.js"></script>

<!-- Navbar handler script -->
<script src="../../js/navbar-handler.js"></script>

<script>
  // Load navbar
  fetch('../../assets/layout/navbar.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('navbar-placeholder').innerHTML = data;
    });
    
  // Load footer
  fetch('../../assets/layout/footer.html')
    .then(response => response.text())
    .then(data => {
      document.getElementById('footer-placeholder').innerHTML = data;
    });

  // Global variables for filter state
  let allProducts = [];
  let filteredProducts = [];
  let currentCategory = null;
  let sortMethod = 'featured';
  let filterOptions = {
    minPrice: null,
    maxPrice: null,
    rating: 0,
    inStock: false,
    onSale: false
  };

  // Initialize page when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    // Ensure data is initialized
    if (typeof window.initializeData === 'function') {
      window.initializeData();
    }
    
    // Get category ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const categoryId = urlParams.get('id');
    
    if (!categoryId) {
      showError('No category specified. Redirecting to categories page...');
      setTimeout(() => {
        window.location.href = 'category-list.html';
      }, 2000);
      return;
    }
    
    // Load category data and products
    loadCategory(parseInt(categoryId));
    
    // Setup event listeners for filters
    setupFilterListeners();
  });
  
  // Load category data
  function loadCategory(categoryId) {
    const loadingIndicator = document.getElementById('loading-indicator');
    const productsContainer = document.getElementById('products-container');
    
    // Show loading and hide products
    if (loadingIndicator) loadingIndicator.style.display = 'flex';
    if (productsContainer) productsContainer.style.display = 'none';
    
    // Get data from localStorage
    const categoriesData = localStorage.getItem('categories');
    const productsData = localStorage.getItem('products');
    
    if (!categoriesData || !productsData) {
      showError('Failed to load data. Please try again later.');
      return;
    }
    
    const categories = JSON.parse(categoriesData);
    const products = JSON.parse(productsData);
    
    // Find the selected category
    const category = categories.find(c => c.id === categoryId);
    
    if (!category) {
      showError('Category not found. Redirecting to categories page...');
      setTimeout(() => {
        window.location.href = 'category-list.html';
      }, 2000);
      return;
    }
    
    // Store current category
    currentCategory = category;
    
    // Update page with category data
    updateCategoryDisplay(category);
    
    // Filter products by category
    allProducts = products.filter(p => p.categoryId === categoryId);
    filteredProducts = [...allProducts];
    
    // Wait 500ms to simulate loading (optional)
    setTimeout(() => {
      // Hide loading and show products
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      // Using empty string for display allows the Bootstrap grid classes to work properly
      // Setting it to 'block' would override the flex layout needed for multi-column grid
      if (productsContainer) productsContainer.style.display = '';
      
      // Render products
      renderProducts(filteredProducts);
    }, 500);
  }
  
  // Update category display elements
  function updateCategoryDisplay(category) {
    // Update breadcrumb
    const breadcrumbCategory = document.getElementById('breadcrumb-category');
    if (breadcrumbCategory) {
      breadcrumbCategory.textContent = category.name;
    }
    
    // Update title and description
    const categoryTitle = document.getElementById('category-title');
    const categoryDescription = document.getElementById('category-description');
    
    if (categoryTitle) {
      categoryTitle.textContent = category.name;
    }
    
    if (categoryDescription) {
      categoryDescription.textContent = category.description || `Browse our collection of ${category.name.toLowerCase()} products`;
    }
    
    // Update document title
    document.title = `${category.name} - Purely Homemade`;
    
    // Update category image if available
    const categoryImage = document.getElementById('category-image');
    if (categoryImage && category.image) {
      categoryImage.src = category.image;
      categoryImage.alt = category.name;
    }
  }
  
  // Render products
  function renderProducts(products) {
    const container = document.getElementById('products-container');
    if (!container) return;
    
    // Update results count
    updateResultsCount(products.length);
    
    // Check if products exist
    if (products.length === 0) {
      container.innerHTML = `
        <div class="col-12">
          <div class="empty-state">
            <i class="bi bi-search"></i>
            <h3>No Products Found</h3>
            <p>We couldn't find any products matching your criteria.</p>
            <button class="btn btn-primary" id="clear-all-filters">Clear All Filters</button>
          </div>
        </div>
      `;
      
      // Add event listener to clear filters button
      const clearAllBtn = document.getElementById('clear-all-filters');
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
      }
      
      return;
    }
    
    // Create product cards
    let productsHTML = '';
    
    products.forEach(product => {
      const price = parseFloat(product.price) || 0;
      const salePrice = product.onSale ? (parseFloat(product.salePrice) || price * 0.9) : null;
      
      // Get product image
      let imageSrc = 'https://via.placeholder.com/250';
      if (Array.isArray(product.images) && product.images.length > 0) {
        imageSrc = product.images[0];
      } else if (product.image) {
        imageSrc = product.image;
      }
      
      // Format pricing display
      let priceHtml = '';
      if (salePrice) {
        priceHtml = `
          <span class="product-price">$${salePrice.toFixed(2)}</span>
          <span class="product-price-discount">$${price.toFixed(2)}</span>
        `;
      } else {
        priceHtml = `<span class="product-price">$${price.toFixed(2)}</span>`;
      }
      
      // Generate rating stars
      const rating = product.rating || 0;
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      
      let starsHtml = '<div class="rating">';
      for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="bi bi-star-fill"></i> ';
      }
      if (hasHalfStar) {
        starsHtml += '<i class="bi bi-star-half"></i> ';
      }
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="bi bi-star"></i> ';
      }
      starsHtml += `<span class="text-muted ms-1">(${product.reviewCount || 0})</span></div>`;
      
      // Stock indicator
      const stockHTML = (product.stock && product.stock <= 5) 
        ? '<span class="badge bg-warning text-dark me-2">Low Stock</span>' 
        : '';
      
      productsHTML += `
        <div class="col-md-6 col-lg-4 mb-4 fade-in">
          <div class="product-card h-100">
            ${product.onSale ? '<span class="product-badge">SALE</span>' : ''}
            <a href="./product_detail.html?id=${product.id}" class="text-decoration-none">
              <img src="${imageSrc}" class="card-img-top product-img" alt="${product.name}">
              <div class="card-body">
                <h5 class="card-title text-dark">${product.name}</h5>
                <div class="d-flex align-items-center mb-2">
                  ${priceHtml}
                </div>
                ${starsHtml}
                <p class="card-text text-truncate text-secondary">${product.description || 'No description available'}</p>
                <div class="mt-3">
                  ${stockHTML}
                </div>
              </div>
            </a>
            <div class="card-footer bg-transparent border-top-0 text-center">
              <button class="btn btn-primary btn-sm add-to-cart-btn" data-product-id="${product.id}">
                <i class="bi bi-cart-plus me-1"></i> Add to Cart
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = productsHTML;
    
    // Add event listeners to Add to Cart buttons
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const productId = parseInt(this.getAttribute('data-product-id'));
        addToCart(productId, 1);
      });
    });
  }
  
  // Update results count
  function updateResultsCount(count) {
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
      if (count === allProducts.length) {
        resultsCount.textContent = `Showing all ${count} products`;
      } else {
        resultsCount.textContent = `Showing ${count} of ${allProducts.length} products`;
      }
    }
  }
  
  // Setup filter event listeners
  function setupFilterListeners() {
    // Price filter
    const applyPriceBtn = document.getElementById('apply-price-filter');
    if (applyPriceBtn) {
      applyPriceBtn.addEventListener('click', function() {
        const minPrice = document.getElementById('price-min').value;
        const maxPrice = document.getElementById('price-max').value;
        
        filterOptions.minPrice = minPrice ? parseFloat(minPrice) : null;
        filterOptions.maxPrice = maxPrice ? parseFloat(maxPrice) : null;
        
        applyFilters();
      });
    }
    
    // Rating filters
    const ratingFilters = document.querySelectorAll('.rating-filter');
    ratingFilters.forEach(filter => {
      filter.addEventListener('change', function() {
        // Ensure only one rating filter is checked
        ratingFilters.forEach(f => {
          if (f !== this) f.checked = false;
        });
        
        filterOptions.rating = this.checked ? parseInt(this.value) : 0;
        applyFilters();
      });
    });
    
    // In Stock filter
    const inStockFilter = document.getElementById('in-stock');
    if (inStockFilter) {
      inStockFilter.addEventListener('change', function() {
        filterOptions.inStock = this.checked;
        applyFilters();
      });
    }
    
    // On Sale filter
    const onSaleFilter = document.getElementById('on-sale');
    if (onSaleFilter) {
      onSaleFilter.addEventListener('change', function() {
        filterOptions.onSale = this.checked;
        applyFilters();
      });
    }
    
    // Sort dropdown
    const sortDropdown = document.getElementById('sort-by');
    if (sortDropdown) {
      sortDropdown.addEventListener('change', function() {
        sortMethod = this.value;
        sortProducts();
      });
    }
    
    // Clear all filters button
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', clearAllFilters);
    }
  }
  
  // Clear all filters
  function clearAllFilters() {
    // Reset filter options
    filterOptions = {
      minPrice: null,
      maxPrice: null,
      rating: 0,
      inStock: false,
      onSale: false
    };
    
    // Reset form inputs
    const priceMin = document.getElementById('price-min');
    const priceMax = document.getElementById('price-max');
    const ratingFilters = document.querySelectorAll('.rating-filter');
    const inStockFilter = document.getElementById('in-stock');
    const onSaleFilter = document.getElementById('on-sale');
    const sortDropdown = document.getElementById('sort-by');
    
    if (priceMin) priceMin.value = '';
    if (priceMax) priceMax.value = '';
    
    ratingFilters.forEach(f => f.checked = false);
    
    if (inStockFilter) inStockFilter.checked = false;
    if (onSaleFilter) onSaleFilter.checked = false;
    if (sortDropdown) sortDropdown.value = 'featured';
    
    // Reset sort method
    sortMethod = 'featured';
    
    // Reset products and render
    filteredProducts = [...allProducts];
    renderProducts(filteredProducts);
  }
  
  // Apply all filters
  function applyFilters() {
    filteredProducts = allProducts.filter(product => {
      // Apply price filter
      if (filterOptions.minPrice !== null) {
        const productPrice = product.onSale && product.salePrice 
          ? parseFloat(product.salePrice) 
          : parseFloat(product.price);
        
        if (productPrice < filterOptions.minPrice) return false;
      }
      
      if (filterOptions.maxPrice !== null) {
        const productPrice = product.onSale && product.salePrice 
          ? parseFloat(product.salePrice) 
          : parseFloat(product.price);
        
        if (productPrice > filterOptions.maxPrice) return false;
      }
      
      // Apply rating filter
      if (filterOptions.rating > 0) {
        if ((product.rating || 0) < filterOptions.rating) return false;
      }
      
      // Apply in stock filter
      if (filterOptions.inStock) {
        if (!product.stock || product.stock <= 0) return false;
      }
      
      // Apply on sale filter
      if (filterOptions.onSale) {
        if (!product.onSale) return false;
      }
      
      return true;
    });
    
    // Sort filtered products
    sortProducts();
  }
  
  // Sort products based on current sort method
  function sortProducts() {
    switch (sortMethod) {
      case 'price-asc':
        filteredProducts.sort((a, b) => {
          const priceA = a.onSale && a.salePrice ? parseFloat(a.salePrice) : parseFloat(a.price);
          const priceB = b.onSale && b.salePrice ? parseFloat(b.salePrice) : parseFloat(b.price);
          return priceA - priceB;
        });
        break;
        
      case 'price-desc':
        filteredProducts.sort((a, b) => {
          const priceA = a.onSale && a.salePrice ? parseFloat(a.salePrice) : parseFloat(a.price);
          const priceB = b.onSale && b.salePrice ? parseFloat(b.salePrice) : parseFloat(b.price);
          return priceB - priceA;
        });
        break;
        
      case 'rating-desc':
        filteredProducts.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        break;
        
      case 'newest':
        filteredProducts.sort((a, b) => {
          const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
          const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
          return dateB - dateA;
        });
        break;
        
      case 'featured':
      default:
        // For featured, we'll use a combination of rating and sale status
        filteredProducts.sort((a, b) => {
          // Prioritize items on sale
          if (a.onSale && !b.onSale) return -1;
          if (!a.onSale && b.onSale) return 1;
          
          // Then by rating
          return (b.rating || 0) - (a.rating || 0);
        });
        break;
    }
    
    // Render sorted and filtered products
    renderProducts(filteredProducts);
  }
  
  // Add to cart function
  function addToCart(productId, quantity) {
    const product = allProducts.find(p => p.id === productId);
    if (!product) return;
    
    // Get existing cart
    let cart = [];
    const cartData = localStorage.getItem('cart');
    if (cartData) {
      cart = JSON.parse(cartData);
    }
    
    // Calculate final price
    const price = parseFloat(product.price) || 0;
    const finalPrice = product.onSale ? (parseFloat(product.salePrice) || price * 0.9) : price;
    
    // Handle image URL
    let imageUrl = 'https://via.placeholder.com/80';
    if (product.image) {
      imageUrl = product.image;
    } else if (Array.isArray(product.images) && product.images.length > 0) {
      imageUrl = product.images[0];
    }
    
    // Check if product is already in cart
    const existingItem = cart.find(item => item.id === productId);
    if (existingItem) {
      existingItem.quantity = (parseInt(existingItem.quantity) || 0) + quantity;
    } else {
      // Safely handle product description
      let description = 'No description available';
      if (product.description) {
        description = product.description.substring(0, 100);
        if (product.description.length > 100) {
          description += '...';
        }
      }
      
      cart.push({
        id: product.id || 0,
        name: product.name || 'Unnamed Product',
        price: finalPrice,
        image: imageUrl,
        quantity: quantity || 1,
        description: description,
        categoryId: product.categoryId || null
      });
    }
    
    // Save to localStorage
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Show success toast
    showToast(`${product.name} added to your cart!`, 'success');
    
    // Update cart count in navbar if the function exists
    if (typeof updateCartCount === 'function') {
      updateCartCount();
    } else {
      // Try to manually update cart count
      const cartCount = document.getElementById('cart-count');
      if (cartCount) {
        const count = cart.reduce((total, item) => total + parseInt(item.quantity), 0);
        cartCount.textContent = count;
        cartCount.style.display = count > 0 ? 'inline-block' : 'none';
      }
    }
  }
  
  // Show toast notification
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) return;
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.style.backgroundColor = '#fff';
    toast.style.color = '#333';
    toast.style.borderRadius = '4px';
    toast.style.padding = '10px 15px';
    toast.style.marginBottom = '10px';
    toast.style.minWidth = '250px';
    toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    toast.style.display = 'flex';
    toast.style.alignItems = 'center';
    toast.style.animation = 'slideIn 0.3s, fadeOut 0.5s 2.5s forwards';
    toast.style.position = 'relative';
    
    if (type === 'success') {
      toast.style.borderLeft = '4px solid #198754';
    } else if (type === 'error') {
      toast.style.borderLeft = '4px solid #dc3545';
    } else if (type === 'info') {
      toast.style.borderLeft = '4px solid #0dcaf0';
    }
    
    // Add content
    toast.innerHTML = `
      <div style="flex: 1; padding-right: 10px;">${message}</div>
      <div style="cursor: pointer; font-size: 16px; color: #999;">&times;</div>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Add close button event
    const closeBtn = toast.querySelector('div:last-child');
    closeBtn.addEventListener('click', function() {
      toast.remove();
    });
    
    // Auto remove after 3 seconds
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // Show error
  function showError(message) {
    showToast(message, 'error');
  }
</script>

</body>
</html> 