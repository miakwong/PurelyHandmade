<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Purely Homemade - Category</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <link rel="stylesheet" href="../../css/global.css">
  <link rel="stylesheet" href="../../css/category-page.css">

</head>
<body>

<!-- Navbar Placeholder -->
<div id="navbar-placeholder"></div>

<!-- Breadcrumb -->
<div class="container mt-3">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb" id="breadcrumb">
      <li class="breadcrumb-item"><a href="../../html/index.html">Home</a></li>
      <li class="breadcrumb-item"><a href="category-list.html">Categories</a></li>
      <li class="breadcrumb-item active" id="breadcrumb-category">Category</li>
    </ol>
  </nav>
</div>

<!-- Category Banner -->
<div class="container">
  <div class="category-banner" id="category-banner">
    <img src="../../img/category-placeholder.jpg" alt="Category" id="category-image">
    <div class="category-banner-overlay">
      <h1 class="category-banner-title" id="category-title">Loading Category...</h1>
      <p class="category-banner-description" id="category-description">Please wait while we load the category details.</p>
    </div>
  </div>
</div>

<!-- Products Section -->
<div class="container mb-5">
  <div class="row">
    <!-- Filters Sidebar -->
    <div class="col-lg-3 mb-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h5 class="mb-4">Filters</h5>
          
          <!-- Price Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Price Range</h6>
            <div class="price-range">
              <span>$</span>
              <input type="number" class="form-control" id="price-min" placeholder="Min" min="0">
              <span>to</span>
              <input type="number" class="form-control" id="price-max" placeholder="Max" min="0">
            </div>
            <button class="btn btn-sm btn-outline-primary mt-2" id="apply-price-filter">Apply</button>
          </div>
          
          <!-- Rating Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Rating</h6>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="4" id="rating-4">
              <label class="form-check-label" for="rating-4">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="3" id="rating-3">
              <label class="form-check-label" for="rating-3">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input rating-filter" type="checkbox" value="2" id="rating-2">
              <label class="form-check-label" for="rating-2">
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star-fill text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                <i class="bi bi-star text-warning"></i>
                & Up
              </label>
            </div>
          </div>
          
          <!-- Availability Filter -->
          <div class="filter-section">
            <h6 class="filter-title">Availability</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="inStock" id="in-stock">
              <label class="form-check-label" for="in-stock">
                In Stock
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="onSale" id="on-sale">
              <label class="form-check-label" for="on-sale">
                On Sale
              </label>
            </div>
          </div>
          
          <!-- Clear Filters Button -->
          <button class="btn btn-outline-secondary w-100" id="clear-filters">Clear All Filters</button>
        </div>
      </div>
    </div>
    
    <!-- Product Grid -->
    <div class="col-lg-9">
      <!-- Sorting and Results Count -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div id="results-count">Showing all products</div>
        <div class="d-flex align-items-center">
          <label for="sort-by" class="me-2">Sort by:</label>
          <select class="form-select form-select-sm sort-dropdown" id="sort-by">
            <option value="featured">Featured</option>
            <option value="price-asc">Price: Low to High</option>
            <option value="price-desc">Price: High to Low</option>
            <option value="rating-desc">Highest Rated</option>
            <option value="newest">Newest</option>
          </select>
        </div>
      </div>
      
      <!-- Loading Indicator -->
      <div class="loading-container" id="loading-indicator">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading products...</p>
      </div>
      
      <!-- Product Grid -->
      <div class="row" id="products-container">
        <!-- Products will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<!-- Toast Container for notifications -->
<div class="modern-toast-container" id="toast-container"></div>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Initialize data script -->
<script src="../../js/init-data.js"></script>

<!-- Navbar handler script -->
<script src="../../js/navbar-handler.js"></script>

<script>

  // Global variables for filter state
  let allProducts = [];
  let filteredProducts = [];
  let currentCategory = null;
  let sortMethod = 'featured';
  let filterOptions = {
    minPrice: null,
    maxPrice: null,
    rating: 0,
    inStock: false,
    onSale: false
  };

  // Initialize page when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    // Ensure data is initialized
    if (typeof window.initializeData === 'function') {
      window.initializeData();
    }
    
    // Get category ID from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const categoryId = urlParams.get('id');
    
    if (!categoryId) {
      showError('No category specified. Redirecting to categories page...');
      setTimeout(() => {
        window.location.href = 'category-list.html';
      }, 2000);
      return;
    }
    
    // Load category data and products
    loadCategory(parseInt(categoryId));
    
    // Setup event listeners for filters
    setupFilterListeners();
  });
  
  // Load category data
  function loadCategory(categoryId) {
    const loadingIndicator = document.getElementById('loading-indicator');
    const productsContainer = document.getElementById('products-container');
    
    // Show loading and hide products
    if (loadingIndicator) loadingIndicator.style.display = 'flex';
    if (productsContainer) productsContainer.style.display = 'none';
    
    // Get data from localStorage
    const categoriesData = localStorage.getItem('categories');
    const productsData = localStorage.getItem('products');
    
    if (!categoriesData || !productsData) {
      showError('Failed to load data. Please try again later.');
      return;
    }
    
    const categories = JSON.parse(categoriesData);
    const products = JSON.parse(productsData);
    
    // Find the selected category
    const category = categories.find(c => c.id === categoryId);
    
    if (!category) {
      showError('Category not found. Redirecting to categories page...');
      setTimeout(() => {
        window.location.href = 'category-list.html';
      }, 2000);
      return;
    }
    
    // Store current category
    currentCategory = category;
    
    // Update page with category data
    updateCategoryDisplay(category);
    
    // Filter products by category
    allProducts = products.filter(p => p.categoryId === categoryId);
    filteredProducts = [...allProducts];
    
    // Wait 500ms to simulate loading (optional)
    setTimeout(() => {
      // Hide loading and show products
      if (loadingIndicator) loadingIndicator.style.display = 'none';
      // Using empty string for display allows the Bootstrap grid classes to work properly
      // Setting it to 'block' would override the flex layout needed for multi-column grid
      if (productsContainer) productsContainer.style.display = '';
      
      // Render products
      renderProducts(filteredProducts);
    }, 500);
  }
  
  // Update category display elements
  function updateCategoryDisplay(category) {
    // Update breadcrumb
    const breadcrumbCategory = document.getElementById('breadcrumb-category');
    if (breadcrumbCategory) {
      breadcrumbCategory.textContent = category.name;
    }
    
    // Update title and description
    const categoryTitle = document.getElementById('category-title');
    const categoryDescription = document.getElementById('category-description');
    
    if (categoryTitle) {
      categoryTitle.textContent = category.name;
    }
    
    if (categoryDescription) {
      categoryDescription.textContent = category.description || `Browse our collection of ${category.name.toLowerCase()} products`;
    }
    
    // Update document title
    document.title = `${category.name} - Purely Homemade`;
    
    // Update category image if available
    const categoryImage = document.getElementById('category-image');
    if (categoryImage && category.image) {
      categoryImage.src = category.image;
      categoryImage.alt = category.name;
    }
  }
  
  // Render products
  function renderProducts(products) {
    const container = document.getElementById('products-container');
    if (!container) return;
    
    // Update results count
    updateResultsCount(products.length);
    
    // Check if products exist
    if (products.length === 0) {
      container.innerHTML = `
        <div class="col-12">
          <div class="empty-state">
            <i class="bi bi-search"></i>
            <h3>No Products Found</h3>
            <p>We couldn't find any products matching your criteria.</p>
            <button class="btn btn-primary" id="clear-all-filters">Clear All Filters</button>
          </div>
        </div>
      `;
      
      // Add event listener to clear filters button
      const clearAllBtn = document.getElementById('clear-all-filters');
      if (clearAllBtn) {
        clearAllBtn.addEventListener('click', clearAllFilters);
      }
      
      return;
    }
    
    // Create product cards
    let productsHTML = '';
    
    products.forEach(product => {
      // Make sure product.id is treated as a string for consistent comparison
      const productId = String(product.id);
      
      const price = parseFloat(product.price) || 0;
      const salePrice = product.onSale ? (parseFloat(product.salePrice) || price * 0.9) : null;
      
      // Get product image
      let imageSrc = 'https://via.placeholder.com/250';
      if (Array.isArray(product.images) && product.images.length > 0) {
        imageSrc = product.images[0];
      } else if (product.image) {
        imageSrc = product.image;
      }
      
      // Generate rating stars
      const rating = product.rating || 0;
      const fullStars = Math.floor(rating);
      const hasHalfStar = rating % 1 >= 0.5;
      
      let starsHtml = '<div class="product-rating">';
      for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="bi bi-star-fill"></i>';
      }
      if (hasHalfStar) {
        starsHtml += '<i class="bi bi-star-half"></i>';
      }
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="bi bi-star"></i>';
      }
      starsHtml += '</div>';
      
      // Format pricing display
      let priceHtml = '';
      if (salePrice) {
        priceHtml = `
          <div class="product-price-wrapper">
            <span class="product-price">$${salePrice.toFixed(2)}</span>
            <span class="product-price-discount">$${price.toFixed(2)}</span>
          </div>
        `;
      } else {
        priceHtml = `<div class="product-price-wrapper"><span class="product-price">$${price.toFixed(2)}</span></div>`;
      }
      
      // Stock indicator - moved to the product image section
      const lowStockBadge = (product.stock && product.stock <= 5) 
        ? '<div class="product-badge stock-badge">Low Stock</div>' 
        : '';
      
      productsHTML += `
        <div class="col-md-6 col-lg-4 mb-4 fade-in">
          <div class="product-card">
            <div class="product-img-wrapper">
              <a href="./product_detail.html?id=${product.id}">
                <img src="${imageSrc}" class="product-img" alt="${product.name}">
                ${product.onSale ? '<div class="product-badge">Sale</div>' : ''}
                ${lowStockBadge}
              </a>
            </div>
            <div class="product-card-body">
              <a href="./product_detail.html?id=${product.id}" style="text-decoration: none; color: inherit;">
                <h2 class="product-title">${product.name}</h2>
              </a>
              ${priceHtml}
              ${starsHtml}
              <p class="product-desc">${product.description || 'No description available'}</p>
              <button class="add-to-cart-btn" data-product-id="${productId}" onclick="addToCart('${productId}', 1); return false;">
                <i class="bi bi-cart-plus me-2"></i> Add to Cart
              </button>
            </div>
          </div>
        </div>
      `;
    });
    
    container.innerHTML = productsHTML;
  }
  
  // Update results count
  function updateResultsCount(count) {
    const resultsCount = document.getElementById('results-count');
    if (resultsCount) {
      if (count === allProducts.length) {
        resultsCount.textContent = `Showing all ${count} products`;
      } else {
        resultsCount.textContent = `Showing ${count} of ${allProducts.length} products`;
      }
    }
  }
  
  // Setup filter event listeners
  function setupFilterListeners() {
    // Price filter
    const applyPriceBtn = document.getElementById('apply-price-filter');
    if (applyPriceBtn) {
      applyPriceBtn.addEventListener('click', function() {
        const minPrice = document.getElementById('price-min').value;
        const maxPrice = document.getElementById('price-max').value;
        
        filterOptions.minPrice = minPrice ? parseFloat(minPrice) : null;
        filterOptions.maxPrice = maxPrice ? parseFloat(maxPrice) : null;
        
        applyFilters();
      });
    }
    
    // Rating filters
    const ratingFilters = document.querySelectorAll('.rating-filter');
    ratingFilters.forEach(filter => {
      filter.addEventListener('change', function() {
        // Ensure only one rating filter is checked
        ratingFilters.forEach(f => {
          if (f !== this) f.checked = false;
        });
        
        filterOptions.rating = this.checked ? parseInt(this.value) : 0;
        applyFilters();
      });
    });
    
    // In Stock filter
    const inStockFilter = document.getElementById('in-stock');
    if (inStockFilter) {
      inStockFilter.addEventListener('change', function() {
        filterOptions.inStock = this.checked;
        applyFilters();
      });
    }
    
    // On Sale filter
    const onSaleFilter = document.getElementById('on-sale');
    if (onSaleFilter) {
      onSaleFilter.addEventListener('change', function() {
        filterOptions.onSale = this.checked;
        applyFilters();
      });
    }
    
    // Sort dropdown
    const sortDropdown = document.getElementById('sort-by');
    if (sortDropdown) {
      sortDropdown.addEventListener('change', function() {
        sortMethod = this.value;
        sortProducts();
      });
    }
    
    // Clear all filters button
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
      clearFiltersBtn.addEventListener('click', clearAllFilters);
    }
  }
  
  // Clear all filters
  function clearAllFilters() {
    // Reset filter options
    filterOptions = {
      minPrice: null,
      maxPrice: null,
      rating: 0,
      inStock: false,
      onSale: false
    };
    
    // Reset form inputs
    const priceMin = document.getElementById('price-min');
    const priceMax = document.getElementById('price-max');
    const ratingFilters = document.querySelectorAll('.rating-filter');
    const inStockFilter = document.getElementById('in-stock');
    const onSaleFilter = document.getElementById('on-sale');
    const sortDropdown = document.getElementById('sort-by');
    
    if (priceMin) priceMin.value = '';
    if (priceMax) priceMax.value = '';
    
    ratingFilters.forEach(f => f.checked = false);
    
    if (inStockFilter) inStockFilter.checked = false;
    if (onSaleFilter) onSaleFilter.checked = false;
    if (sortDropdown) sortDropdown.value = 'featured';
    
    // Reset sort method
    sortMethod = 'featured';
    
    // Reset products and render
    filteredProducts = [...allProducts];
    renderProducts(filteredProducts);
  }
  
  // Apply all filters
  function applyFilters() {
    filteredProducts = allProducts.filter(product => {
      // Apply price filter
      if (filterOptions.minPrice !== null) {
        const productPrice = product.onSale && product.salePrice 
          ? parseFloat(product.salePrice) 
          : parseFloat(product.price);
        
        if (productPrice < filterOptions.minPrice) return false;
      }
      
      if (filterOptions.maxPrice !== null) {
        const productPrice = product.onSale && product.salePrice 
          ? parseFloat(product.salePrice) 
          : parseFloat(product.price);
        
        if (productPrice > filterOptions.maxPrice) return false;
      }
      
      // Apply rating filter
      if (filterOptions.rating > 0) {
        if ((product.rating || 0) < filterOptions.rating) return false;
      }
      
      // Apply in stock filter
      if (filterOptions.inStock) {
        if (!product.stock || product.stock <= 0) return false;
      }
      
      // Apply on sale filter
      if (filterOptions.onSale) {
        if (!product.onSale) return false;
      }
      
      return true;
    });
    
    // Sort filtered products
    sortProducts();
  }
  
  // Sort products based on current sort method
  function sortProducts() {
    switch (sortMethod) {
      case 'price-asc':
        filteredProducts.sort((a, b) => {
          const priceA = a.onSale && a.salePrice ? parseFloat(a.salePrice) : parseFloat(a.price);
          const priceB = b.onSale && b.salePrice ? parseFloat(b.salePrice) : parseFloat(b.price);
          return priceA - priceB;
        });
        break;
        
      case 'price-desc':
        filteredProducts.sort((a, b) => {
          const priceA = a.onSale && a.salePrice ? parseFloat(a.salePrice) : parseFloat(a.price);
          const priceB = b.onSale && b.salePrice ? parseFloat(b.salePrice) : parseFloat(b.price);
          return priceB - priceA;
        });
        break;
        
      case 'rating-desc':
        filteredProducts.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        break;
        
      case 'newest':
        filteredProducts.sort((a, b) => {
          const dateA = a.dateAdded ? new Date(a.dateAdded) : new Date(0);
          const dateB = b.dateAdded ? new Date(b.dateAdded) : new Date(0);
          return dateB - dateA;
        });
        break;
        
      case 'featured':
      default:
        // For featured, we'll use a combination of rating and sale status
        filteredProducts.sort((a, b) => {
          // Prioritize items on sale
          if (a.onSale && !b.onSale) return -1;
          if (!a.onSale && b.onSale) return 1;
          
          // Then by rating
          return (b.rating || 0) - (a.rating || 0);
        });
        break;
    }
    
    // Render sorted and filtered products
    renderProducts(filteredProducts);
  }
  
  // Add to cart function
  function addToCart(productId, quantity) {
    console.log('addToCart called with productId:', productId, 'type:', typeof productId);
    
    const productsData = localStorage.getItem('products');
    if (!productsData) {
      console.error('No products data found in localStorage');
      return;
    }
    
    const products = JSON.parse(productsData);
    
    // Try to match by both string and number comparisons
    let product = products.find(p => p.id === productId);
    
    // If not found, try parsing as integer
    if (!product && !isNaN(parseInt(productId))) {
      const numericId = parseInt(productId);
      console.log('Trying numeric ID:', numericId);
      product = products.find(p => p.id === numericId);
    }
    
    // If still not found, try string comparison
    if (!product) {
      const stringId = String(productId);
      console.log('Trying string ID:', stringId);
      product = products.find(p => String(p.id) === stringId);
    }
    
    if (!product) {
      console.error('Product not found with ID:', productId);
      showToast('Product not found', 'error');
      return;
    }
    
    console.log('Found product to add to cart:', product);
    
    // Get existing cart
    let cart = [];
    const cartData = localStorage.getItem('cart');
    if (cartData) {
      try {
        cart = JSON.parse(cartData);
        console.log('Existing cart:', cart);
      } catch (e) {
        console.error('Error parsing cart data:', e);
        showToast('Error loading cart data', 'error');
      }
    }
    
    // Calculate final price
    const price = parseFloat(product.price) || 0;
    const finalPrice = product.onSale ? (parseFloat(product.salePrice) || price * 0.9) : price;
    console.log('Calculated price:', finalPrice);
    
    // Handle image URL
    let imageUrl = 'https://via.placeholder.com/80';
    if (product.image) {
      imageUrl = product.image;
    } else if (Array.isArray(product.images) && product.images.length > 0) {
      imageUrl = product.images[0];
    }
    
    // Check if product is already in cart
    const existingItem = cart.find(item => {
      const itemMatch = (item.id === product.id) || 
                       (parseInt(item.id) === parseInt(product.id)) || 
                       (String(item.id) === String(product.id));
      console.log(`Cart item ID: ${item.id}, comparing with product ID: ${product.id}, matches: ${itemMatch}`);
      return itemMatch;
    });
    
    if (existingItem) {
      console.log('Product already in cart, updating quantity');
      existingItem.quantity = (parseInt(existingItem.quantity) || 0) + quantity;
    } else {
      console.log('Adding new product to cart');
      // Safely handle product description
      let description = 'No description available';
      if (product.description) {
        description = product.description.substring(0, 100);
        if (product.description.length > 100) {
          description += '...';
        }
      } else if (product.details) {
        description = product.details.substring(0, 100);
        if (product.details.length > 100) {
          description += '...';
        }
      }
      
      cart.push({
        id: product.id || 0,
        name: product.name || 'Unnamed Product',
        price: finalPrice,
        image: imageUrl,
        quantity: quantity || 1,
        description: description,
        categoryId: product.categoryId || null
      });
    }
    
    // Save to localStorage
    console.log('Saving updated cart to localStorage:', cart);
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Show success toast
    showToast(`${product.name || 'Product'} added to your cart!`, 'success');
    
    // Update cart count in navbar
    updateCartCount();
  }
  
  // Show toast notification
  function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    
    if (!toastContainer) return;
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `modern-toast ${type}`;
    
    // Add content
    toast.innerHTML = `
      <div style="flex: 1; padding-right: 10px;">
        <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'} me-2"></i>
            ${message}
      </div>
      <div style="cursor: pointer; font-size: 16px; color: #999;">&times;</div>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Add close button event
    const closeBtn = toast.querySelector('div:last-child');
    closeBtn.addEventListener('click', function() {
      toast.remove();
    });
    
    // Auto remove after 3 seconds
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }
  
  // Show error
  function showError(message) {
    showToast(message, 'error');
  }
  
  // Update cart count in navbar
  function updateCartCount() {
    const cartData = localStorage.getItem('cart');
    const cartCount = document.getElementById('cart-count');
    
    if (!cartCount) return;
    
    if (cartData) {
      const cart = JSON.parse(cartData);
      const count = cart.reduce((total, item) => total + parseInt(item.quantity || 0), 0);
      cartCount.textContent = count;
      cartCount.style.display = count > 0 ? 'inline-block' : 'none';
    } else {
      cartCount.style.display = 'none';
    }
  }
</script>

</body>
</html> 