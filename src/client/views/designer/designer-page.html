<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Designer Products - Purely Homemade</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/navbar.css">
  <link rel="stylesheet" href="../../css/global.css">
  <link rel="stylesheet" href="../../css/designer-page.css">

  <!-- Google Material Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>

  <!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

  <!-- Breadcrumb -->
  <div class="container mt-3">
    <nav>
      <ol class="breadcrumb" id="breadcrumb">
        <li class="breadcrumb-item"><a href="../../html/index.html">Home</a></li>
        <li class="breadcrumb-item"><a href="designers.html">Designers</a></li>
        <li class="breadcrumb-item active" id="designer-name">Designer</li>
      </ol>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="container mt-5">
    <div id="designer-info" class="mb-5">
      <!-- Designer details will be loaded here -->
    </div>
    <h2 class="mb-4" id="products-header">Products</h2>
    <div class="row" id="products-container">
      <!-- Product cards will be dynamically injected here -->
    </div>
  </div>

  <!-- Toast Container for notifications -->
  <div class="modern-toast-container" id="toast-container"></div>

  <!-- Footer Placeholder -->
  <div id="footer-placeholder"></div>

  <!-- Bootstrap JS and jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Data Service scripts - Must load before init-data.js -->
  <script src="../../js/data-service.js"></script>
  <script src="../../js/api-data-loader.js"></script>

  <!-- 初始化数据脚本 -->
  <script src="../../js/init-data.js"></script>

  <!-- Navbar Handler -->
  <script src="../../js/navbar-handler.js"></script>

  <script>

    // 显示Toast通知
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toast-container');
      
      if (!toastContainer) return;
      
      // 创建toast元素
      const toast = document.createElement('div');
      toast.className = `modern-toast ${type}`;
      
      // 添加内容
      toast.innerHTML = `
        <div style="flex: 1; padding-right: 10px;">
          <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle'} me-2"></i>
              ${message}
        </div>
        <div style="cursor: pointer; font-size: 16px; color: #999;">&times;</div>
      `;
      
      // 添加到容器
      toastContainer.appendChild(toast);
      
      // 添加关闭按钮事件
      const closeBtn = toast.querySelector('div:last-child');
      closeBtn.addEventListener('click', function() {
        toast.remove();
      });
      
      // 自动3秒后移除
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Parse query string to get designer id
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // 添加到购物车
    function addToCart(productId, quantity) {
      console.log('addToCart called with productId:', productId, 'type:', typeof productId);
      
      const productsData = localStorage.getItem('products');
      if (!productsData) {
        console.error('No products data found in localStorage');
        return;
      }
      
      const products = JSON.parse(productsData);
      
      // Try to match by both string and number comparisons
      let product = products.find(p => p.id === productId);
      
      // If not found, try parsing as integer
      if (!product && !isNaN(parseInt(productId))) {
        const numericId = parseInt(productId);
        console.log('Trying numeric ID:', numericId);
        product = products.find(p => p.id === numericId);
      }
      
      // If still not found, try string comparison
      if (!product) {
        const stringId = String(productId);
        console.log('Trying string ID:', stringId);
        product = products.find(p => String(p.id) === stringId);
      }
      
      if (!product) {
        console.error('Product not found with ID:', productId);
        showToast('Product not found', 'error');
        return;
      }
      
      console.log('Found product to add to cart:', product);
      
      // 获取现有购物车
      let cart = [];
      const cartData = localStorage.getItem('cart');
      if (cartData) {
        try {
          cart = JSON.parse(cartData);
          console.log('Existing cart:', cart);
        } catch (e) {
          console.error('Error parsing cart data:', e);
          showToast('Error loading cart data', 'error');
        }
      }
      
      // 计算最终价格，确保不会出现NaN
      const price = parseFloat(product.price) || 0;
      const finalPrice = product.onSale ? (parseFloat(product.salePrice) || price * 0.9) : price;
      console.log('Calculated price:', finalPrice);
      
      // 处理图片URL
      let imageUrl = 'https://via.placeholder.com/80';
      if (product.image) {
        imageUrl = product.image;
      } else if (Array.isArray(product.images) && product.images.length > 0) {
        imageUrl = product.images[0];
      }
      
      // 检查产品是否已在购物车中
      const existingItem = cart.find(item => {
        const itemMatch = (item.id === product.id) || 
                         (parseInt(item.id) === parseInt(product.id)) || 
                         (String(item.id) === String(product.id));
        console.log(`Cart item ID: ${item.id}, comparing with product ID: ${product.id}, matches: ${itemMatch}`);
        return itemMatch;
      });
      
      if (existingItem) {
        console.log('Product already in cart, updating quantity');
        existingItem.quantity = (parseInt(existingItem.quantity) || 0) + quantity;
      } else {
        console.log('Adding new product to cart');
        // 安全处理产品描述
        let description = 'No description available';
        if (product.description) {
          description = product.description.substring(0, 100);
          if (product.description.length > 100) {
            description += '...';
          }
        } else if (product.details) {
          description = product.details.substring(0, 100);
          if (product.details.length > 100) {
            description += '...';
          }
        }
        
        cart.push({
          id: product.id || 0,
          name: product.name || 'Unnamed Product',
          price: finalPrice,
          image: imageUrl,
          quantity: quantity || 1,
          description: description,
          categoryId: product.categoryId || null
        });
      }
      
      // 保存到localStorage
      console.log('Saving updated cart to localStorage:', cart);
      localStorage.setItem('cart', JSON.stringify(cart));
      
      // 显示成功消息
      showToast(`${product.name || 'Product'} added to your cart!`, 'success');
      
      // 更新导航栏购物车计数
      updateCartCount();
    }
    
    // 更新购物车计数
    function updateCartCount() {
      const cartData = localStorage.getItem('cart');
      const cartCount = document.getElementById('cart-count');
      
      if (!cartCount) return;
      
      if (cartData) {
        const cart = JSON.parse(cartData);
        const count = cart.reduce((total, item) => total + item.quantity, 0);
        cartCount.textContent = count;
        cartCount.style.display = count > 0 ? 'inline-block' : 'none';
      } else {
        cartCount.style.display = 'none';
      }
    }

    // 创建产品卡片HTML
    function createProductCard(product) {
      // Make sure product.id is treated as a string for consistent comparison
      const productId = String(product.id);
      console.log('Creating card for product ID:', productId);
      
      // 生成星级评分HTML
      const fullStars = Math.floor(product.rating || 0);
      const hasHalfStar = (product.rating || 0) % 1 >= 0.5;
      
      let starsHtml = '<div class="product-rating">';
      for (let i = 0; i < fullStars; i++) {
        starsHtml += '<i class="bi bi-star-fill"></i>';
      }
      if (hasHalfStar) {
        starsHtml += '<i class="bi bi-star-half"></i>';
      }
      const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
      for (let i = 0; i < emptyStars; i++) {
        starsHtml += '<i class="bi bi-star"></i>';
      }
      // 添加数字评分显示
      starsHtml += `<span class="rating-text">(${product.rating ? product.rating.toFixed(1) : '0.0'})</span>`;
      starsHtml += '</div>';
      
      // 价格显示
      let priceHtml = '';
      if (product.onSale && product.salePrice) {
        priceHtml = `
          <div class="product-price-wrapper">
            <span class="product-price">$${product.salePrice.toFixed(2)}</span>
            <span class="product-price-discount">$${product.price.toFixed(2)}</span>
          </div>
        `;
      } else if (product.price) {
        priceHtml = `<div class="product-price-wrapper"><span class="product-price">$${product.price.toFixed(2)}</span></div>`;
      } else {
        priceHtml = `<div class="product-price-wrapper"><span class="product-price">Price unavailable</span></div>`;
      }
      
      return `
        <div class="col-md-4">
          <div class="product-card">
            <div class="product-img-wrapper">
              <a href="../product/product_detail.html?id=${product.id}">
                <img src="${product.images && product.images.length > 0 ? product.images[0] : '/src/client/assets/placeholder.jpg'}" class="product-img" alt="${product.name || 'Product'}">
                ${product.onSale ? '<div class="product-badge">Sale</div>' : ''}
              </a>
            </div>
            <div class="product-card-body">
              <a href="../product/product_detail.html?id=${product.id}" style="text-decoration: none; color: inherit;">
                <h2 class="product-title">${product.name}</h2>
              </a>
              ${priceHtml}
              ${starsHtml}
              <p class="product-desc">${product.description ? product.description.substring(0, 80) + '...' : 'No description available'}</p>
              <button class="add-to-cart-btn" data-product-id="${productId}" onclick="addToCart('${productId}', 1); return false;">
                <i class="bi bi-cart-plus me-2"></i> Add to Cart
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // Load designer details and products
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, starting to load designer products');
      const designerId = getQueryParam('id');
      console.log('Designer ID from URL:', designerId);
      
      if (!designerId) {
        showToast('No designer ID provided in URL', 'error');
        return;
      }
      
      // Retrieve designers from localStorage
      let designers = [];
      try {
        const designersData = localStorage.getItem('designers');
        console.log('Raw designers data:', designersData);
        designers = JSON.parse(designersData || '[]');
        console.log('Parsed designers:', designers);
      } catch (e) {
        console.error('Error parsing designers data:', e);
        showToast('Error loading designers data: ' + e.message, 'error');
      }
      
      const designer = designers.find(d => d.id === designerId);
      console.log('Found designer:', designer);
      
      if (!designer) {
        document.getElementById('designer-info').innerHTML = '<div class="alert alert-warning">Designer not found.</div>';
        return;
      }
      
      // Display designer information
      document.getElementById('designer-info').innerHTML = `
        <h1>${designer.name}</h1>
        <p>${designer.bio || 'No biography available.'}</p>
      `;
      
      // Update breadcrumb with designer name
      document.getElementById('designer-name').textContent = designer.name;
      
      // Set header for products section
      document.getElementById('products-header').innerText = designer.name + "'s Products";

      // Get all products from localStorage
      const productsData = localStorage.getItem('products');
      console.log('Raw products data:', productsData);
      
      if (!productsData) {
        document.getElementById('products-container').innerHTML = '<div class="alert alert-info">No products available.</div>';
        return;
      }

      // Find products by this designer
      const products = JSON.parse(productsData);
      console.log('All products:', products);
      console.log('Looking for products with designerId:', designerId);
      
      // Check if products have designerId
      const hasDesignerIds = products.some(p => p.designerId);
      console.log('Products have designerId property:', hasDesignerIds);
      
      if (!hasDesignerIds) {
        // If products don't have designerId, we'll assign some based on categoryId for this demo
        console.log('Adding mock designerId to products for this demo');
        
        // Assign products to designers based on categories
        products.forEach(p => {
          if (p.categoryId === 1) p.designerId = 'd1';
          else if (p.categoryId === 2) p.designerId = 'd2';
          else if (p.categoryId === 3) p.designerId = 'd3';
        });
        
        // Save the updated products back to localStorage
        localStorage.setItem('products', JSON.stringify(products));
      }
      
      // Check types for comparison - string vs number issues are common
      console.log('Designer ID type:', typeof designerId);
      if (products.length > 0) {
        console.log('Sample product designerId type:', typeof products[0].designerId);
      }
      
      // Try both string and number comparison to handle potential type issues
      const designerProducts = products.filter(product => {
        const match = (product.designerId === designerId) || 
                      (product.designerId === parseInt(designerId)) || 
                      (String(product.designerId) === designerId);
        console.log(`Product ID ${product.id}, designerId: ${product.designerId}, matches: ${match}`);
        return match;
      });
      
      console.log('Filtered designer products:', designerProducts);
      
      if (designerProducts.length === 0) {
        document.getElementById('products-container').innerHTML = '<div class="alert alert-info">No products available from this designer.</div>';
        return;
      }
      
      // Render product cards
      const productsContainer = document.getElementById('products-container');
      productsContainer.innerHTML = '';
      
      designerProducts.forEach(product => {
        console.log('Creating card for product:', product);
        productsContainer.innerHTML += createProductCard(product);
      });
      
      // No need for separate event listeners since we're using onclick in the HTML
      console.log('Product cards added with inline onclick handlers');
    });
  </script>

</body>
</html> 