<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Use color variables consistent with homepage */
    :root {
      --primary-color: #eae2d6; /* Changed to match navbar color on homepage */
      --secondary-color: #e1d7c6;
      --accent-color: #867666;
      --text-color: #5e4b3e;
      --border-color: #bfb1a3;
      --shadow: 0 4px 6px rgba(94, 75, 62, 0.1);
      --border-radius: 8px;
      
      /* 保留profile页面需要的其他变量 */
      --primary-light: rgba(134, 118, 102, 0.25);
      --text-muted: #6c757d;
      --bg-light: #f8f9fa;
      --success-color: #5a8c70;
      --danger-color: #a95e5e;
      
      /* 更新按钮色彩变量，使用admin.css中定义的颜色 */
      --button-color: #867666;
      --button-hover: #6f6255;
    }
    
    /* Avatar styles - enlarged and moved further down */
    .avatar-wrapper {
      position: relative;
      width: 180px; /* Increased to 180px as requested */
      height: 180px; /* Increased to 180px as requested */
      margin: 45px auto 1.2rem; /* Increased top margin from 30px to 45px to move further down */
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 50%; /* Make wrapper perfectly circular */
      cursor: pointer;
      /* Add a subtle outline to better define the circular shape */
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 5px rgba(0,0,0,0.1);
    }
    
    .avatar-wrapper:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(255,255,255,1), 0 0 10px rgba(0,0,0,0.2);
    }
    
    .avatar-wrapper:active {
      transform: scale(0.98);
    }
    
    .profile-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid white;
    }
    
    .avatar-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: hidden;
      width: 100%;
      height: 30%;
      transition: 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .avatar-overlay i {
      color: white;
      font-size: 1.2rem;
    }
    
    /* 其他profile页面特定样式保持不变 */
    .profile-section {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    .profile-header {
      padding: 2rem;
      position: relative;
      text-align: center;
    }
    
    .profile-content {
      padding: 1.5rem 2rem;
    }
    
    .address-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .address-card.default {
      border-color: var(--button-color);
      box-shadow: 0 0 0 1px var(--button-hover);
    }
    
    .default-badge {
      position: absolute;
      top: -10px;
      right: 20px;
      background-color: var(--button-color);
      color: white;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .address-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
      margin-bottom: -1px;
      border: 1px solid transparent;
      border-top-left-radius: 0.25rem;
      border-top-right-radius: 0.25rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
      border-color: #e9ecef #e9ecef #dee2e6;
      color: var(--button-color);
    }
    
    .nav-tabs .nav-link.active {
      color: var(--button-color);
      background-color: #fff;
      border-color: #dee2e6 #dee2e6 #fff;
    }
    
    /* 更新按钮样式使用新的变量 */
    .btn-primary {
      background-color: var(--button-color);
      border-color: var(--button-color);
    }
    
    .btn-primary:hover {
      background-color: var(--button-hover);
      border-color: var(--button-hover);
    }
    
    .btn-outline-primary {
      color: var(--button-color);
      border-color: var(--button-color);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--button-color);
      border-color: var(--button-color);
      color: white;
    }
    
    /* 其他样式保持不变 */
    .profile-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .detail-item {
      margin-bottom: 1rem;
    }

    .detail-label {
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 1.1rem;
    }

    .address-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .address-card.default {
      border-color: var(--primary-color);
      background-color: var(--primary-light);
    }

    .default-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
    }

    .address-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .no-addresses {
      text-align: center;
      padding: 2rem;
      background-color: var(--bg-light);
      border-radius: 8px;
      color: var(--text-muted);
    }

    .nav-tabs {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 500;
    }

    /* Admin styles now imported from admin.css */
    
    /* 确保按钮居中显示 */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 确保category表格中的action单元格内容居中 */
    #category-table-body td.text-center {
      text-align: center !important;
    }
    
    /* 增强按钮样式 */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

<div class="container my-5">
  <h1 class="mb-4">My Profile</h1>

  <!-- Profile Overview Section -->
  <div class="profile-section">
    <div class="row">
      <div class="col-md-3 text-center">
        <!-- Avatar section -->
        <div class="avatar-wrapper" onclick="document.getElementById('avatar-upload').click(); console.log('Avatar clicked - triggering file upload dialog');">
          <img src="../../../img/profile.png" alt="Profile Photo" id="profile-img" class="profile-avatar">
          <input type="file" id="avatar-upload" class="hidden-upload" accept="image/*">
        </div>
        <h3 id="user-full-name" class="mt-3">John Doe</h3>
        <!-- Add username display with edit functionality -->
        <div class="username-container mb-2">
          <span id="username-display" class="d-inline-block">@johndoe</span>
          <button class="btn btn-sm btn-link p-0 ms-2" onclick="toggleUsernameEdit()">
            <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i>
          </button>
          <div id="username-edit-container" class="mt-2 d-none">
            <div class="input-group input-group-sm">
              <span class="input-group-text">@</span>
              <input type="text" id="username-input" class="form-control form-control-sm" maxlength="20">
              <button class="btn btn-sm btn-primary" onclick="saveUsername()">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="cancelUsernameEdit()">Cancel</button>
            </div>
            <small class="text-muted">Username must be 3-20 characters long</small>
          </div>
        </div>
        <p id="user-email" class="text-muted"></p>
        <p class="mb-0"><small class="text-muted">Member since <span id="join-date">January 2023</span></small></p>
      </div>
      <div class="col-md-9">
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal-info" type="button" role="tab" aria-controls="personal-info" aria-selected="true">Personal Info</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses" aria-selected="false">Addresses</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">Security</button>
          </li>
          <li class="nav-item" role="presentation" id="admin-tab-container" style="display: none;">
            <a class="nav-link" id="admin-tab" href="/src/client/views/admin/dashboard.html" role="tab">Admin Dashboard</a>
          </li>
        </ul>
        
        <div class="tab-content" id="profileTabsContent">
          <!-- Personal Info Tab -->
          <div class="tab-pane fade show active" id="personal-info" role="tabpanel" aria-labelledby="personal-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-person-badge me-2 text-primary"></i>Personal Information
                </h4>
                <button class="admin-btn admin-btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                  <i class="bi bi-pencil me-2"></i>Edit Profile
                </button>
              </div>
            
              <!-- Redesigned Personal Information layout with cards -->
              <div class="row g-3">
                <!-- Username -->
                <div class="col-md-4">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-person-badge me-2 text-primary"></i>Username
                      </h5>
                      <p class="card-text fs-5 mt-3" id="username-display-profile">@johndoe</p>
                    </div>
                  </div>
                </div>
                
                <!-- Name information -->
                <div class="col-md-8">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-person me-2 text-primary"></i>Full Name
                      </h5>
                      <div class="row mt-3">
                        <div class="col-md-6">
                          <p class="text-muted mb-1">First Name</p>
                          <p class="fs-5 fw-medium" id="first-name">John</p>
                        </div>
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Last Name</p>
                          <p class="fs-5 fw-medium" id="last-name">Doe</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Contact Information -->
                <div class="col-md-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-envelope me-2 text-primary"></i>Contact Information
                      </h5>
                      <div class="mt-3">
                        <p class="text-muted mb-1">Email</p>
                        <p class="fw-medium" id="email-display">johndoe@example.com</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Personal Details -->
                <div class="col-md-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-info-circle me-2 text-primary"></i>Personal Details
                      </h5>
                      <div class="row mt-3">
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Birthday</p>
                          <p class="fw-medium" id="birthday-display">January 1, 1990</p>
                        </div>
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Gender</p>
                          <p class="fw-medium" id="gender-display">Male</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Order History Tab -->
          <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
            <!-- Add order history content here -->
          </div>
          
          <!-- Addresses Tab -->
          <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-geo-alt me-2 text-primary"></i>My Addresses
                </h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                  <i class="bi bi-plus-lg me-1"></i> Add New Address
                </button>
              </div>
              
              <div id="addresses-container" class="mt-4">
                <!-- Addresses will be loaded here -->
                <div class="no-addresses text-center py-5">
                  <i class="bi bi-geo-alt display-4 text-muted"></i>
                  <p class="mt-3 text-muted">You don't have any saved addresses yet.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Security Tab -->
          <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-shield-lock me-2 text-primary"></i>Security Settings
                </h4>
              </div>
              
              <div class="card shadow-sm mt-4">
                <div class="card-body">
                  <h5 class="card-title mb-4">Change Password</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <form id="change-password-form">
                        <div class="mb-3">
                          <label for="current-password" class="form-label text-start w-100">Current Password</label>
                          <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                          <label for="new-password" class="form-label text-start w-100">New Password</label>
                          <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="mb-3">
                          <label for="confirm-password" class="form-label text-start w-100">Confirm New Password</label>
                          <input type="password" class="form-control" id="confirm-password" required>
                        </div>
                        <div id="password-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
              </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="address-form">
          <input type="hidden" id="address-id">
          <div class="mb-3">
            <label for="addressName" class="form-label">Address Name</label>
            <input type="text" class="form-control" id="addressName" placeholder="e.g. Home, Work, etc." required>
          </div>
          <div class="mb-3">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phone" required>
          </div>
          <div class="mb-3">
            <label for="addressLine1" class="form-label">Address Line 1</label>
            <input type="text" class="form-control" id="addressLine1" required>
          </div>
          <div class="mb-3">
            <label for="addressLine2" class="form-label">Address Line 2 (Optional)</label>
            <input type="text" class="form-control" id="addressLine2">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="state" class="form-label">State/Province</label>
              <input type="text" class="form-control" id="state" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="zipCode" class="form-label">ZIP/Postal Code</label>
              <input type="text" class="form-control" id="zipCode" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" required>
              <option value="" selected disabled>Select Country</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="UK">United Kingdom</option>
              <option value="AU">Australia</option>
              <option value="FR">France</option>
              <option value="DE">Germany</option>
              <option value="JP">Japan</option>
              <option value="CN">China</option>
              <option value="IN">India</option>
              <option value="BR">Brazil</option>
              <option value="MX">Mexico</option>
            </select>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="defaultAddress">
            <label class="form-check-label" for="defaultAddress">
              Set as default shipping address
            </label>
          </div>
          <div id="address-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-address">Save Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Address Modal - uses same form as Add Address but with different title -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Will use the same form as addAddressModal -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveAddress(true)">Save Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="/src/client/js/common.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Load navbar and footer components
    loadNavbar();
    loadFooter();
    
    // Set up initial user data
    initUserProfile();
    
    // Set up event listeners
    setupEventListeners();
    
    // Show admin tab if user is admin
    checkAdminStatus();
    
    // Load saved addresses
    loadAddresses();
  });
  
  function initUserProfile() {
    // Get current user data
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (currentUser) {
      // Set user profile data
      document.getElementById('user-full-name').textContent = `${currentUser.name}`;
      document.getElementById('username-display').textContent = `@${currentUser.username}`;
      document.getElementById('username-display-profile').textContent = `@${currentUser.username}`;
      document.getElementById('email-display').textContent = currentUser.email;
      
      if (currentUser.avatar) {
        document.getElementById('profile-img').src = currentUser.avatar;
      }
      
      // Set profile edit form values
      document.getElementById('edit-first-name').value = currentUser.firstName || '';
      document.getElementById('edit-last-name').value = currentUser.lastName || '';
      document.getElementById('edit-email').value = currentUser.email || '';
      document.getElementById('edit-birthday').value = currentUser.birthday || '';
      
      const genderSelect = document.getElementById('edit-gender');
      if (currentUser.gender) {
        for (let i = 0; i < genderSelect.options.length; i++) {
          if (genderSelect.options[i].value === currentUser.gender) {
            genderSelect.selectedIndex = i;
            break;
          }
        }
      }
      
      // Update display fields
      updateProfileDisplayFields();
    }
  }
  
  function updateProfileDisplayFields() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (currentUser) {
      // Format the birthday for display if it exists
      if (currentUser.birthday) {
        const birthdayDate = new Date(currentUser.birthday);
        const formattedBirthday = birthdayDate.toLocaleDateString('en-US', {
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        document.getElementById('birthday-display').textContent = formattedBirthday;
      } else {
        document.getElementById('birthday-display').textContent = 'Not set';
      }
      
      // Display gender if it exists
      if (currentUser.gender) {
        document.getElementById('gender-display').textContent = currentUser.gender;
      } else {
        document.getElementById('gender-display').textContent = 'Not set';
      }
    }
  }
  
  function setupEventListeners() {
    // Avatar upload handler
    const avatarUpload = document.getElementById('avatar-upload');
    if (avatarUpload) {
      avatarUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];
        if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const profileImg = document.getElementById('profile-img');
            profileImg.src = e.target.result;
            
            // Save the new avatar to user profile
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
              currentUser.avatar = e.target.result;
              localStorage.setItem('currentUser', JSON.stringify(currentUser));
          }
        };
        reader.readAsDataURL(file);
        }
      });
    }
    
    // Profile edit form submission
    const editProfileForm = document.getElementById('edit-profile-form');
    if (editProfileForm) {
      editProfileForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
          // Update user data
          currentUser.firstName = document.getElementById('edit-first-name').value;
          currentUser.lastName = document.getElementById('edit-last-name').value;
          currentUser.name = `${currentUser.firstName} ${currentUser.lastName}`;
          currentUser.email = document.getElementById('edit-email').value;
          currentUser.birthday = document.getElementById('edit-birthday').value;
          currentUser.gender = document.getElementById('edit-gender').value;
          
          // Save updated user
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Update users array if exists
      const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(user => user.id === currentUser.id);
      if (userIndex !== -1) {
            users[userIndex] = { ...users[userIndex], ...currentUser };
        localStorage.setItem('users', JSON.stringify(users));
      }
      
          // Refresh displayed profile data
          document.getElementById('user-full-name').textContent = `${currentUser.name}`;
          updateProfileDisplayFields();
          
          // Close modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
          modal.hide();
          
          // Show success message
          alert('Profile updated successfully!');
        }
      });
    }
    
    // Password change form
    const changePasswordForm = document.getElementById('change-password-form');
    if (changePasswordForm) {
      changePasswordForm.addEventListener('submit', function(event) {
        event.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        const errorElement = document.getElementById('password-error');
        
        // Reset error message
        errorElement.classList.add('d-none');
        
        // Check if new passwords match
        if (newPassword !== confirmPassword) {
          errorElement.textContent = 'New passwords do not match!';
          errorElement.classList.remove('d-none');
      return;
    }
    
        // Get current user
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
          // In a real app, we would validate the current password against stored hash
          // For demo, just check if it's not empty
          if (!currentPassword) {
            errorElement.textContent = 'Current password is required!';
            errorElement.classList.remove('d-none');
      return;
    }
    
          // Update password (in real app, this would be hashed)
          currentUser.password = newPassword;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Update users array if exists
        const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(user => user.id === currentUser.id);
        if (userIndex !== -1) {
          users[userIndex].password = newPassword;
          localStorage.setItem('users', JSON.stringify(users));
        }
        
        // Reset form
          changePasswordForm.reset();
          
          // Show success message
          alert('Password changed successfully!');
        }
      });
    }
  }
  
  function toggleUsernameEdit() {
    const usernameDisplay = document.getElementById('username-display');
    const currentText = usernameDisplay.textContent;
    
    // Create input for editing
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'form-control form-control-sm d-inline-block';
    input.value = currentText.substring(1); // Remove @ symbol
    input.style.width = '120px';
    
    // Create save button
    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn btn-sm btn-success ms-2';
    saveBtn.innerHTML = '<i class="bi bi-check"></i>';
    saveBtn.onclick = function() {
      const newUsername = input.value;
      if (newUsername) {
        // Update username in localStorage
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (currentUser) {
          currentUser.username = newUsername;
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // Update users array if exists
          const users = JSON.parse(localStorage.getItem('users') || '[]');
          const userIndex = users.findIndex(user => user.id === currentUser.id);
    if (userIndex !== -1) {
            users[userIndex].username = newUsername;
            localStorage.setItem('users', JSON.stringify(users));
          }
        }
        
        // Update displayed username
        usernameDisplay.textContent = `@${newUsername}`;
        document.getElementById('username-display-profile').textContent = `@${newUsername}`;
        
        // Restore original display
        toggleUsernameEdit();
      }
    };
    
    // Create cancel button
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn btn-sm btn-danger ms-1';
    cancelBtn.innerHTML = '<i class="bi bi-x"></i>';
    cancelBtn.onclick = function() {
      usernameDisplay.textContent = currentText;
      usernameDisplay.nextElementSibling.style.display = 'inline-block';
    };
    
    // Replace content
    usernameDisplay.textContent = '';
    usernameDisplay.appendChild(document.createTextNode('@'));
    usernameDisplay.appendChild(input);
    usernameDisplay.appendChild(saveBtn);
    usernameDisplay.appendChild(cancelBtn);
    
    // Hide edit button
    usernameDisplay.nextElementSibling.style.display = 'none';
    
    // Focus input
    input.focus();
  }
  
  function checkAdminStatus() {
    // Check if user is admin and show admin tab if yes
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (currentUser && currentUser.role === 'admin') {
      document.getElementById('admin-tab-container').style.display = 'block';
    }
  }
  
  // Address management functions
  function loadAddresses() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) return;
    
    const addresses = currentUser.addresses || [];
    const container = document.getElementById('addresses-container');
    
    if (addresses.length === 0) {
      container.innerHTML = `
        <div class="no-addresses text-center py-5">
          <i class="bi bi-geo-alt display-4 text-muted"></i>
          <p class="mt-3 text-muted">You don't have any saved addresses yet.</p>
            </div>
      `;
      return;
    }
    
    container.innerHTML = '<div class="row">' + 
      addresses.map((address, index) => `
        <div class="col-md-6 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h5 class="card-title">${address.name}</h5>
                <div>
                  ${address.isDefault ? '<span class="badge bg-primary">Default</span>' : ''}
                  </div>
                </div>
              <p class="card-text mb-1">${address.streetAddress}</p>
              <p class="card-text mb-1">${address.aptSuite ? address.aptSuite + ', ' : ''}${address.city}, ${address.state} ${address.zipCode}</p>
              <p class="card-text mb-3">${address.country}</p>
              <p class="card-text"><small class="text-muted">Phone: ${address.phone}</small></p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" onclick="editAddress(${index})">
                  <i class="bi bi-pencil me-1"></i>Edit
                  </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteAddress(${index})">
                  <i class="bi bi-trash me-1"></i>Delete
                  </button>
                ${!address.isDefault ? `<button class="btn btn-sm btn-outline-secondary" onclick="setDefaultAddress(${index})">Set as Default</button>` : ''}
                </div>
              </div>
            </div>
        </div>
      `).join('') + '</div>';
  }

  let currentAddressIndex = -1;
  
  function addAddress() {
    currentAddressIndex = -1;
    document.getElementById('address-form').reset();
    document.querySelector('#addAddressModal .modal-title').textContent = 'Add New Address';
    document.getElementById('default-address').checked = false;
  }
  
  function editAddress(index) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || !currentUser.addresses) return;
    
    const address = currentUser.addresses[index];
    if (!address) return;
    
    currentAddressIndex = index;
    
    // Fill form fields
    document.getElementById('address-name').value = address.name || '';
    document.getElementById('street-address').value = address.streetAddress || '';
    document.getElementById('apt-suite').value = address.aptSuite || '';
    document.getElementById('city').value = address.city || '';
    document.getElementById('state').value = address.state || '';
    document.getElementById('zip-code').value = address.zipCode || '';
    document.getElementById('country').value = address.country || '';
    document.getElementById('phone').value = address.phone || '';
    document.getElementById('default-address').checked = address.isDefault || false;
    
    document.querySelector('#editAddressModal .modal-title').textContent = 'Edit Address';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
    modal.show();
  }
  
  function saveAddress(isEdit = false) {
    const addressForm = document.getElementById('address-form');
    
    // Validate form
    if (!addressForm.checkValidity()) {
      addressForm.reportValidity();
      return;
    }
    
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) return;
    
    // Initialize addresses array if it doesn't exist
    if (!currentUser.addresses) {
      currentUser.addresses = [];
    }
    
    const newAddress = {
      name: document.getElementById('address-name').value,
      streetAddress: document.getElementById('street-address').value,
      aptSuite: document.getElementById('apt-suite').value,
      city: document.getElementById('city').value,
      state: document.getElementById('state').value,
      zipCode: document.getElementById('zip-code').value,
      country: document.getElementById('country').value,
      phone: document.getElementById('phone').value,
      isDefault: document.getElementById('default-address').checked
    };
    
    // If setting as default, remove default from other addresses
    if (newAddress.isDefault) {
      currentUser.addresses.forEach(addr => addr.isDefault = false);
    }
    
    // Add new or update existing address
    if (isEdit && currentAddressIndex >= 0) {
      currentUser.addresses[currentAddressIndex] = newAddress;
    } else {
      // If first address, set as default
      if (currentUser.addresses.length === 0) {
        newAddress.isDefault = true;
      }
      currentUser.addresses.push(newAddress);
    }
    
    // Save changes
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // Update users array if exists
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const userIndex = users.findIndex(user => user.id === currentUser.id);
    if (userIndex !== -1) {
      users[userIndex].addresses = currentUser.addresses;
      localStorage.setItem('users', JSON.stringify(users));
    }
    
    // Close modal
    const modalId = isEdit ? 'editAddressModal' : 'addAddressModal';
    const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
    modal.hide();
    
    // Reload addresses
    loadAddresses();
  }
  
  function deleteAddress(index) {
    if (!confirm('Are you sure you want to delete this address?')) return;
    
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || !currentUser.addresses) return;
    
    // Remove address
    currentUser.addresses.splice(index, 1);
    
    // If we deleted the default address and there are other addresses, set first as default
    if (currentUser.addresses.length > 0) {
      let hasDefault = currentUser.addresses.some(addr => addr.isDefault);
      if (!hasDefault) {
        currentUser.addresses[0].isDefault = true;
      }
    }
    
    // Save changes
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // Update users array if exists
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    const userIndex = users.findIndex(user => user.id === currentUser.id);
    if (userIndex !== -1) {
      users[userIndex].addresses = currentUser.addresses;
      localStorage.setItem('users', JSON.stringify(users));
    }
    
    // Reload addresses
    loadAddresses();
  }
  
  function setDefaultAddress(index) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser || !currentUser.addresses) return;
    
    // Remove default from all addresses
    currentUser.addresses.forEach(addr => addr.isDefault = false);
    
    // Set new default
    currentUser.addresses[index].isDefault = true;
    
    // Save changes
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // Update users array if exists
      const users = JSON.parse(localStorage.getItem('users') || '[]');
    const userIndex = users.findIndex(user => user.id === currentUser.id);
      if (userIndex !== -1) {
      users[userIndex].addresses = currentUser.addresses;
        localStorage.setItem('users', JSON.stringify(users));
      }
      
    // Reload addresses
    loadAddresses();
  }
</script>

</body>

<!-- Add confirmation delete modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this product? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Add toast container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;"></div>

<script>
// ... existing code ...

// Add the showToast helper function at the end of your javascript
function showToast(message, type = 'primary') {
  // Prevent duplicate toasts with the same message within a short time
  const existingToasts = document.querySelectorAll('.toast');
  for (let i = 0; i < existingToasts.length; i++) {
    const toastBody = existingToasts[i].querySelector('.toast-body');
    if (toastBody && toastBody.textContent.trim() === message.trim()) {
      console.log('Preventing duplicate toast:', message);
      return; // Don't show duplicate toast
    }
  }
  
  // 检查消息是否为空
  if (!message || message.trim() === '') {
    console.error('Empty message provided to showToast');
    message = 'Operation completed successfully';  // 提供默认消息
  }
  
  // 确保类型有效
  const validTypes = ['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'light', 'dark'];
  if (!validTypes.includes(type)) {
    console.warn(`Invalid toast type: ${type}, using 'primary' instead`);
    type = 'primary';
  }
  
  // Get or create toast container
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(toastContainer);
  }
  
  // Create toast
  const toastElement = document.createElement('div');
  toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
  toastElement.setAttribute('role', 'alert');
  toastElement.setAttribute('aria-live', 'assertive');
  toastElement.setAttribute('aria-atomic', 'true');
  
  const toastContent = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  
  toastElement.innerHTML = toastContent;
  toastContainer.appendChild(toastElement);
  
  // Initialize and show toast
  const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
  toast.show();
  
  // Remove the toast after it's hidden
  toastElement.addEventListener('hidden.bs.toast', function() {
    toastElement.remove();
  });
}
</script>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id">
          
          <div class="admin-form-group">
            <label for="category-name" class="admin-form-label">Category Name<span class="text-danger">*</span></label>
            <input type="text" class="admin-form-control" id="category-name" required placeholder="Enter category name">
            <div class="form-text">A clear, concise name for your product category</div>
          </div>
          
          <div class="admin-form-group">
            <label for="category-description" class="admin-form-label">Description</label>
            <textarea class="admin-form-control" id="category-description" rows="3" placeholder="Briefly describe what types of products belong in this category"></textarea>
            <div class="form-text">Optional: Describe the types of products that will be included</div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Category Image</label>
            <div class="d-flex align-items-start mb-2">
              <div class="product-preview me-3" style="width: 120px; height: 120px;">
                <img id="category-img-preview" src="../../../img/profile.png" alt="Category preview">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="admin-form-control mb-2" id="category-image-file" accept="image/*">
                <div class="form-text mb-2">Recommended size: 400×400px</div>
                <div class="d-grid">
                  <button type="button" class="admin-btn admin-btn-warning" onclick="resetCategoryImage()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Image
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="category-featured">
              <label class="form-check-label" for="category-featured">
                Featured Category
              </label>
              <div class="form-text">Featured categories will be highlighted on the homepage</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveCategory()">
          <i class="bi bi-check2 me-1"></i>Save Category
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .category-management-card {
    border-radius: 12px;
    overflow: hidden;
  }
  
  .category-table th {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #555;
  }
  
  .category-table tbody tr:hover {
    background-color: rgba(134, 118, 102, 0.05);
  }
  
  .empty-state-icon {
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Style for category featured badge */
  .category-featured-badge {
    background-color: var(--primary-light);
    color: var(--accent-color);
    border-radius: 4px;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* Category image thumbnail */
  .category-thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background-color: #f8f9fa;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
</style>

<script>
// ... existing code ...

  // Helper function to show loading spinner
  function showLoadingSpinner(element) {
    element.innerHTML = `
      <div class="d-flex justify-content-center my-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
            </div>
            </div>
    `;
  }
  
  // Initialize tabs if present
  document.addEventListener('DOMContentLoaded', function () {
    const tabEls = document.querySelectorAll('a[data-bs-toggle="tab"]');
    if (tabEls.length > 0) {
      tabEls.forEach(function(tabEl) {
        tabEl.addEventListener('shown.bs.tab', function (event) {
          const targetId = event.target.getAttribute('data-bs-target');
          if (targetId === '#users-panel') {
            loadUsers();
          } else if (targetId === '#products-panel') {
            if (typeof loadProducts === 'function') {
              loadProducts();
            }
          } else if (targetId === '#orders-panel') {
            if (typeof loadOrders === 'function') {
              loadOrders();
            }
          } else if (targetId === '#comments-panel') {
            if (typeof loadComments === 'function') {
              loadComments();
            }
          }
        });
      });
    }

    // Call specific functions when admin tab is shown
    const adminTab = document.getElementById('admin-tab');
    if (adminTab) {
      adminTab.addEventListener('shown.bs.tab', function (event) {
        loadUsers();
      });
    }
    
    // Initialize modals with proper options
    console.log('Initializing all modals on page...');
    // Initialize all modals with proper options after they are defined
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      try {
        var modalInstance = new bootstrap.Modal(modal, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
        console.log(`Modal initialized: #${modal.id}`);
      } catch (err) {
        console.error(`Failed to initialize modal #${modal.id}:`, err);
      }
    });
  });
</script>

<!-- Add Bootstrap JS at the end of body -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Personal Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="birthday" class="form-label">Birthday</label>
            <input type="date" class="form-control" id="birthday">
          </div>
          <div class="mb-3">
            <label class="form-label">Gender</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male">
                <label class="form-check-label" for="genderMale">Male</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
                <label class="form-check-label" for="genderFemale">Female</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderOther" value="other">
                <label class="form-check-label" for="genderOther">Other</label>
              </div>
            </div>
          </div>
          <div id="profile-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-profile" onclick="saveProfileChanges()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Add this script to ensure modals work properly -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing all modals on page...');
    // Initialize all modals with proper options after they are defined
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
        try {
        var modalInstance = new bootstrap.Modal(modal, {
            backdrop: true,
            keyboard: true,
            focus: true
          });
        console.log(`Modal initialized: #${modal.id}`);
        } catch (err) {
        console.error(`Failed to initialize modal #${modal.id}:`, err);
        }
      });
  });
</script>

<!-- Script to properly initialize all modals -->
<script>
  // Ensure modals are properly initialized after page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing modals after page load');
    setTimeout(function() {
      try {
        document.querySelectorAll('.modal').forEach(function(modal) {
          // Check if modal is already initialized
          if (!bootstrap.Modal.getInstance(modal)) {
            new bootstrap.Modal(modal);
            console.log('Modal initialized:', modal.id);
          }
        });
      } catch (error) {
        console.error('Error initializing modals:', error);
      }
    }, 500); // Small delay to ensure DOM is fully loaded
  });
</script>
</html>
