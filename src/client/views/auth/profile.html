<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Purely Homemade</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/src/client/css/global.css" rel="stylesheet">
  <link href="/src/client/css/style.css" rel="stylesheet">
  <link href="/src/client/css/navbar.css" rel="stylesheet">
  <link href="/src/client/css/admin.css" rel="stylesheet">
  
  <style>
    /* Use color variables consistent with homepage */
    :root {
      --primary-color: #eae2d6; /* Changed to match navbar color on homepage */
      --secondary-color: #e1d7c6;
      --accent-color: #867666;
      --text-color: #5e4b3e;
      --border-color: #bfb1a3;
      --shadow: 0 4px 6px rgba(94, 75, 62, 0.1);
      --border-radius: 8px;
      
      /* 保留profile页面需要的其他变量 */
      --primary-light: rgba(134, 118, 102, 0.25);
      --text-muted: #6c757d;
      --bg-light: #f8f9fa;
      --success-color: #5a8c70;
      --danger-color: #a95e5e;
      
      /* 更新按钮色彩变量，使用admin.css中定义的颜色 */
      --button-color: #867666;
      --button-hover: #6f6255;
    }
    
    /* Avatar styles - enlarged and moved further down */
    .avatar-wrapper {
      position: relative;
      width: 180px; /* Increased to 180px as requested */
      height: 180px; /* Increased to 180px as requested */
      margin: 45px auto 1.2rem; /* Increased top margin from 30px to 45px to move further down */
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 50%; /* Make wrapper perfectly circular */
      cursor: pointer;
      /* Add a subtle outline to better define the circular shape */
      box-shadow: 0 0 0 3px rgba(255,255,255,0.8), 0 0 5px rgba(0,0,0,0.1);
    }
    
    .avatar-wrapper:hover {
      transform: scale(1.05);
      box-shadow: 0 0 0 3px rgba(255,255,255,1), 0 0 10px rgba(0,0,0,0.2);
    }
    
    .avatar-wrapper:active {
      transform: scale(0.98);
    }
    
    .profile-avatar {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid white;
    }
    
    .avatar-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: hidden;
      width: 100%;
      height: 30%;
      transition: 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .avatar-overlay i {
      color: white;
      font-size: 1.2rem;
    }
    
    /* 其他profile页面特定样式保持不变 */
    .profile-section {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    .profile-header {
      padding: 2rem;
      position: relative;
      text-align: center;
    }
    
    .profile-content {
      padding: 1.5rem 2rem;
    }
    
    .address-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      position: relative;
    }
    
    .address-card.default {
      border-color: var(--button-color);
      box-shadow: 0 0 0 1px var(--button-hover);
    }
    
    .default-badge {
      position: absolute;
      top: -10px;
      right: 20px;
      background-color: var(--button-color);
      color: white;
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .address-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
      margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
      margin-bottom: -1px;
      border: 1px solid transparent;
      border-top-left-radius: 0.25rem;
      border-top-right-radius: 0.25rem;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .nav-tabs .nav-link:hover {
      border-color: #e9ecef #e9ecef #dee2e6;
      color: var(--button-color);
    }
    
    .nav-tabs .nav-link.active {
      color: var(--button-color);
      background-color: #fff;
      border-color: #dee2e6 #dee2e6 #fff;
    }
    
    /* 更新按钮样式使用新的变量 */
    .btn-primary {
      background-color: var(--button-color);
      border-color: var(--button-color);
    }
    
    .btn-primary:hover {
      background-color: var(--button-hover);
      border-color: var(--button-hover);
    }
    
    .btn-outline-primary {
      color: var(--button-color);
      border-color: var(--button-color);
    }
    
    .btn-outline-primary:hover {
      background-color: var(--button-color);
      border-color: var(--button-color);
      color: white;
    }
    
    /* 其他样式保持不变 */
    .profile-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }

    .detail-item {
      margin-bottom: 1rem;
    }

    .detail-label {
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
    }

    .detail-value {
      font-size: 1.1rem;
    }

    .address-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .address-card.default {
      border-color: var(--primary-color);
      background-color: var(--primary-light);
    }

    .default-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background-color: var(--primary-color);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 1rem;
      font-size: 0.75rem;
    }

    .address-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .no-addresses {
      text-align: center;
      padding: 2rem;
      background-color: var(--bg-light);
      border-radius: 8px;
      color: var(--text-muted);
    }

    .nav-tabs {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 500;
    }

    /* Admin styles now imported from admin.css */
    
    /* 确保按钮居中显示 */
    .action-buttons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 确保category表格中的action单元格内容居中 */
    #category-table-body td.text-center {
      text-align: center !important;
    }
    
    /* 增强按钮样式 */
    .admin-btn-sm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      padding: 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>

<!-- Navbar Placeholder -->
  <div id="navbar-placeholder"></div>

<div class="container my-5">
  <h1 class="mb-4">My Profile</h1>

  <!-- Profile Overview Section -->
  <div class="profile-section">
    <div class="row">
      <div class="col-md-3 text-center">
        <!-- Avatar section -->
        <div class="avatar-wrapper" onclick="document.getElementById('avatar-upload').click(); console.log('Avatar clicked - triggering file upload dialog');">
          <img src="../../../img/profile.png" alt="Profile Photo" id="profile-img" class="profile-avatar">
          <input type="file" id="avatar-upload" class="hidden-upload" accept="image/*">
        </div>
        <h3 id="user-full-name" class="mt-3">John Doe</h3>
        <!-- Add username display with edit functionality -->
        <div class="username-container mb-2">
          <span id="username-display" class="d-inline-block">@johndoe</span>
          <button class="btn btn-sm btn-link p-0 ms-2" onclick="toggleUsernameEdit()">
            <i class="bi bi-pencil-fill" style="font-size: 0.8rem;"></i>
          </button>
          <div id="username-edit-container" class="mt-2 d-none">
            <div class="input-group input-group-sm">
              <span class="input-group-text">@</span>
              <input type="text" id="username-input" class="form-control form-control-sm" maxlength="20">
              <button class="btn btn-sm btn-primary" onclick="saveUsername()">Save</button>
              <button class="btn btn-sm btn-secondary" onclick="cancelUsernameEdit()">Cancel</button>
            </div>
            <small class="text-muted">Username must be 3-20 characters long</small>
          </div>
        </div>
        <p id="user-email" class="text-muted"></p>
        <p class="mb-0"><small class="text-muted">Member since <span id="join-date">January 2023</span></small></p>
      </div>
      <div class="col-md-9">
        <ul class="nav nav-tabs" id="profileTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" data-bs-target="#personal-info" type="button" role="tab" aria-controls="personal-info" aria-selected="true">Personal Info</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses" aria-selected="false">Addresses</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab" aria-controls="security" aria-selected="false">Security</button>
          </li>
          <li class="nav-item" role="presentation" id="admin-tab-container" style="display: none;">
            <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">Admin Features</button>
          </li>
        </ul>
        
        <div class="tab-content" id="profileTabsContent">
          <!-- Personal Info Tab -->
          <div class="tab-pane fade show active" id="personal-info" role="tabpanel" aria-labelledby="personal-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-person-badge me-2 text-primary"></i>Personal Information
                </h4>
                <button class="admin-btn admin-btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                  <i class="bi bi-pencil me-2"></i>Edit Profile
                </button>
              </div>
            
              <!-- Redesigned Personal Information layout with cards -->
              <div class="row g-3">
                <!-- Username -->
                <div class="col-md-4">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-person-badge me-2 text-primary"></i>Username
                      </h5>
                      <p class="card-text fs-5 mt-3" id="username-display-profile">@johndoe</p>
                    </div>
                  </div>
                </div>
                
                <!-- Name information -->
                <div class="col-md-8">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-person me-2 text-primary"></i>Full Name
                      </h5>
                      <div class="row mt-3">
                        <div class="col-md-6">
                          <p class="text-muted mb-1">First Name</p>
                          <p class="fs-5 fw-medium" id="first-name">John</p>
                        </div>
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Last Name</p>
                          <p class="fs-5 fw-medium" id="last-name">Doe</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Contact Information -->
                <div class="col-md-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-envelope me-2 text-primary"></i>Contact Information
                      </h5>
                      <div class="mt-3">
                        <p class="text-muted mb-1">Email</p>
                        <p class="fw-medium" id="email-display">johndoe@example.com</p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Personal Details -->
                <div class="col-md-6">
                  <div class="card h-100 shadow-sm">
                    <div class="card-body">
                      <h5 class="card-title">
                        <i class="bi bi-info-circle me-2 text-primary"></i>Personal Details
                      </h5>
                      <div class="row mt-3">
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Birthday</p>
                          <p class="fw-medium" id="birthday-display">January 1, 1990</p>
                        </div>
                        <div class="col-md-6">
                          <p class="text-muted mb-1">Gender</p>
                          <p class="fw-medium" id="gender-display">Male</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Order History Tab -->
          <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
            <!-- Add order history content here -->
          </div>
          
          <!-- Addresses Tab -->
          <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-geo-alt me-2 text-primary"></i>My Addresses
                </h4>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                  <i class="bi bi-plus-lg me-1"></i> Add New Address
                </button>
              </div>
              
              <div id="addresses-container" class="mt-4">
                <!-- Addresses will be loaded here -->
                <div class="no-addresses text-center py-5">
                  <i class="bi bi-geo-alt display-4 text-muted"></i>
                  <p class="mt-3 text-muted">You don't have any saved addresses yet.</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Security Tab -->
          <div class="tab-pane fade" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-shield-lock me-2 text-primary"></i>Security Settings
                </h4>
              </div>
              
              <div class="card shadow-sm mt-4">
                <div class="card-body">
                  <h5 class="card-title mb-4">Change Password</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <form id="change-password-form">
                        <div class="mb-3">
                          <label for="current-password" class="form-label text-start w-100">Current Password</label>
                          <input type="password" class="form-control" id="current-password" required>
                        </div>
                        <div class="mb-3">
                          <label for="new-password" class="form-label text-start w-100">New Password</label>
                          <input type="password" class="form-control" id="new-password" required>
                        </div>
                        <div class="mb-3">
                          <label for="confirm-password" class="form-label text-start w-100">Confirm New Password</label>
                          <input type="password" class="form-control" id="confirm-password" required>
                        </div>
                        <div id="password-error" class="alert alert-danger d-none"></div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Admin Tab -->
          <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
            <div class="admin-section">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                  <i class="bi bi-gear me-2 text-primary"></i>Admin Dashboard
                </h4>
              </div>
              
              <!-- Admin Dashboard Tabs -->
              <ul class="nav nav-tabs" id="adminDashboardTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-panel" type="button" role="tab" aria-controls="users-panel" aria-selected="true">Users</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products-panel" type="button" role="tab" aria-controls="products-panel" aria-selected="false">Products</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="orders-admin-tab" data-bs-toggle="tab" data-bs-target="#orders-panel" type="button" role="tab" aria-controls="orders-panel" aria-selected="false">Orders</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments-panel" type="button" role="tab" aria-controls="comments-panel" aria-selected="false">Reviews</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="designers-tab" data-bs-toggle="tab" data-bs-target="#designers-panel" type="button" role="tab" aria-controls="designers-panel" aria-selected="false">Designers</button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-panel" type="button" role="tab" aria-controls="categories-panel" aria-selected="false">Categories</button>
                </li>
              </ul>
              
              <div class="tab-content pt-3" id="adminDashboardTabsContent">
                <!-- Users Panel -->
                <div class="tab-pane fade show active" id="users-panel" role="tabpanel" aria-labelledby="users-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="mb-0">User Management</h5>
                        </div>
                        <div class="col-auto">
                          <div class="input-group">
                            <input type="text" class="form-control" id="user-search" placeholder="Search by ID or email">
                            <button class="btn btn-primary" type="button" id="search-user">
                              <i class="bi bi-search"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Avatar</th>
                              <th>Name</th>
                              <th>Email</th>
                              <th>Role</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="userTableBody">
                            <!-- User data will be loaded here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Products Panel -->
                <div class="tab-pane fade" id="products-panel" role="tabpanel" aria-labelledby="products-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="mb-0">Product Management</h5>
                        </div>
                        <div class="col-auto">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal">
                            <i class="bi bi-plus-circle me-2"></i>Add Product
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Image</th>
                              <th>Name</th>
                              <th>Price</th>
                              <th>Category</th>
                              <th>Stock</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="productTableBody">
                            <!-- Product data will be loaded here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Designers Panel -->
                <div class="tab-pane fade" id="designers-panel" role="tabpanel" aria-labelledby="designers-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="mb-0">Designer Management</h5>
                        </div>
                        <div class="col-auto">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#designerModal">
                            <i class="bi bi-plus-circle me-2"></i>Add Designer
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Avatar</th>
                              <th>Name</th>
                              <th>Specialty</th>
                              <th>Products</th>
                              <th class="text-center">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="designerTableBody">
                            <!-- Designer data will be loaded here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Categories Panel -->
                <div class="tab-pane fade" id="categories-panel" role="tabpanel" aria-labelledby="categories-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="mb-0">Category Management</h5>
                        </div>
                        <div class="col-auto">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">
                            <i class="bi bi-plus-circle me-2"></i>Add Category
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Image</th>
                              <th>Name</th>
                              <th>Description</th>
                              <th class="text-center">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="category-table-body">
                            <!-- Category data will be loaded here -->
                          </tbody>
                        </table>
                        <div id="no-categories-message" class="d-none text-center py-5">
                          <div class="empty-state-icon mx-auto mb-3">
                            <i class="bi bi-folder-x fs-1 text-muted"></i>
                          </div>
                          <p class="text-muted mb-3">No categories found</p>
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#categoryModal">
                            Add Your First Category
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Orders Panel -->
                <div class="tab-pane fade" id="orders-panel" role="tabpanel" aria-labelledby="orders-admin-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="mb-0">Order Management</h5>
                        </div>
                        <div class="col-md-auto mb-2 mb-md-0">
                          <div class="input-group">
                            <input type="text" class="form-control" id="order-search" placeholder="Order ID">
                            <button class="btn btn-primary" type="button" id="check-order">
                              <i class="bi bi-search"></i>
                            </button>
                          </div>
                        </div>
                        <div class="col-md-auto">
                          <button class="btn btn-success" id="exportOrdersToCSV">
                            <i class="bi bi-file-earmark-spreadsheet me-2"></i>Export to CSV
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                      <!-- Order stats cards -->
                      <div class="row mb-3">
                        <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                          <div class="card text-white bg-info">
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-center">
                                <div>
                                  <h6 class="mb-0">New Orders</h6>
                                  <h2 class="mb-0" id="new-count">0</h2>
                                </div>
                                <i class="bi bi-bag fs-1"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                          <div class="card text-white bg-primary">
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-center">
                                <div>
                                  <h6 class="mb-0">Packed</h6>
                                  <h2 class="mb-0" id="packed-count">0</h2>
                                </div>
                                <i class="bi bi-box-seam fs-1"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3 mb-sm-0">
                          <div class="card text-white bg-warning">
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-center">
                                <div>
                                  <h6 class="mb-0">In Transit</h6>
                                  <h2 class="mb-0" id="transit-count">0</h2>
                                </div>
                                <i class="bi bi-truck fs-1"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                          <div class="card text-white bg-success">
                            <div class="card-body p-3">
                              <div class="d-flex justify-content-between align-items-center">
                                <div>
                                  <h6 class="mb-0">Delivered</h6>
                                  <h2 class="mb-0" id="delivered-count">0</h2>
                                </div>
                                <i class="bi bi-check-circle fs-1"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div class="table-responsive">
                        <table class="table table-hover">
                          <thead>
                            <tr>
                              <th>Order ID</th>
                              <th>Product</th>
                              <th>Amount</th>
                              <th>Status</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody id="orderTableBody">
                            <!-- Order data will be loaded here -->
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Comments Panel -->
                <div class="tab-pane fade" id="comments-panel" role="tabpanel" aria-labelledby="comments-tab">
                  <div class="card mb-4">
                    <div class="card-header">
                      <h5 class="mb-0">Customer Reviews</h5>
                    </div>
                    <div class="card-body">
                      <ul class="list-group" id="comment-list">
                        <!-- Comment data will be loaded here -->
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Address Modal -->
<div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAddressModalLabel">Add New Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="address-form">
          <input type="hidden" id="address-id">
          <div class="mb-3">
            <label for="addressName" class="form-label">Address Name</label>
            <input type="text" class="form-control" id="addressName" placeholder="e.g. Home, Work, etc." required>
          </div>
          <div class="mb-3">
            <label for="fullName" class="form-label">Full Name</label>
            <input type="text" class="form-control" id="fullName" required>
          </div>
          <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" class="form-control" id="phone" required>
          </div>
          <div class="mb-3">
            <label for="addressLine1" class="form-label">Address Line 1</label>
            <input type="text" class="form-control" id="addressLine1" required>
          </div>
          <div class="mb-3">
            <label for="addressLine2" class="form-label">Address Line 2 (Optional)</label>
            <input type="text" class="form-control" id="addressLine2">
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="city" class="form-label">City</label>
              <input type="text" class="form-control" id="city" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="state" class="form-label">State/Province</label>
              <input type="text" class="form-control" id="state" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="zipCode" class="form-label">ZIP/Postal Code</label>
              <input type="text" class="form-control" id="zipCode" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" required>
              <option value="" selected disabled>Select Country</option>
              <option value="US">United States</option>
              <option value="CA">Canada</option>
              <option value="UK">United Kingdom</option>
              <option value="AU">Australia</option>
              <option value="FR">France</option>
              <option value="DE">Germany</option>
              <option value="JP">Japan</option>
              <option value="CN">China</option>
              <option value="IN">India</option>
              <option value="BR">Brazil</option>
              <option value="MX">Mexico</option>
            </select>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="defaultAddress">
            <label class="form-check-label" for="defaultAddress">
              Set as default shipping address
            </label>
          </div>
          <div id="address-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-address">Save Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Address Modal - uses same form as Add Address but with different title -->
<div class="modal fade" id="editAddressModal" tabindex="-1" aria-labelledby="editAddressModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editAddressModalLabel">Edit Address</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Will use the same form as addAddressModal -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="update-address">Update Address</button>
      </div>
    </div>
  </div>
</div>

<!-- Designer Modal -->
<div class="modal fade" id="designerModal" tabindex="-1" aria-labelledby="designerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="designerModalLabel">Add New Designer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="designerForm">
          <input type="hidden" id="designerId">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="designerName" class="form-label">Designer Name</label>
                <input type="text" class="form-control" id="designerName" required>
              </div>
              <div class="mb-3">
                <label for="designerSpecialty" class="form-label">Specialty</label>
                <input type="text" class="form-control" id="designerSpecialty" required>
              </div>
              <div class="mb-3">
                <label for="designerBio" class="form-label">Biography</label>
                <textarea class="form-control" id="designerBio" rows="3" required></textarea>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Profile Images</label>
                <div id="designerImagesContainer">
                  <!-- Image previews will be added here -->
                </div>
                <div class="d-grid mt-2">
                  <button type="button" class="admin-btn admin-btn-primary" onclick="document.getElementById('designerImage').click()">
                    <i class="bi bi-upload me-1"></i> Upload Images
                  </button>
                </div>
                <input type="file" id="designerImage" accept="image/*" multiple style="display: none;" onchange="previewDesignerImages(event)">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Social Media Links</label>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-instagram"></i></span>
              <input type="url" class="form-control" id="designerInstagram" placeholder="Instagram URL">
            </div>
            <div class="input-group mb-2">
              <span class="input-group-text"><i class="bi bi-pinterest"></i></span>
              <input type="url" class="form-control" id="designerPinterest" placeholder="Pinterest URL">
            </div>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shop"></i></span>
              <input type="url" class="form-control" id="designerEtsy" placeholder="Etsy URL">
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="designerFeatured">
              <label class="form-check-label" for="designerFeatured">
                Set as Featured Designer
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveDesigner()">Save Designer</button>
      </div>
    </div>
  </div>
  </div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productModalLabel">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Add error message area -->
        <div id="product-form-error" class="alert alert-danger mb-3 d-none"></div>
        
        <form id="productForm">
          <input type="hidden" id="productId">
          <div class="row">
            <div class="col-md-8">
              <div class="mb-3">
                <label for="productName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productCategory" class="form-label">Category</label>
                  <select class="form-select" id="productCategory" required>
                    <option value="">Select Category</option>
                    <option value="1">Ceramics</option>
                    <option value="2">Wood Crafts</option>
                    <option value="3">Textiles</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productDesigner" class="form-label">Designer (Optional)</label>
                  <select class="form-select" id="productDesigner">
                    <option value="">No Designer</option>
                    <!-- Designers will be loaded dynamically -->
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="productPrice" class="form-label">Price ($)</label>
                  <input type="number" class="form-control" id="productPrice" min="0" step="0.01" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productStock" class="form-label">Stock</label>
                  <input type="number" class="form-control" id="productStock" min="0" required>
                </div>
              </div>
              <div class="mb-3">
                <label for="productListingDate" class="form-label">Listing Date</label>
                <input type="datetime-local" class="form-control" id="productListingDate">
              </div>
              <div class="mb-3">
                <label for="productDescription" class="form-label">Description</label>
                <textarea class="form-control" id="productDescription" rows="3" required></textarea>
              </div>
              <div class="mb-3">
                <label for="productDetails" class="form-label">Details</label>
                <textarea class="form-control" id="productDetails" rows="3"></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="productOnSale">
                    <label class="form-check-label" for="productOnSale">On Sale</label>
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="productSalePrice" class="form-label">Sale Price ($)</label>
                  <input type="number" class="form-control" id="productSalePrice" min="0" step="0.01">
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label">Product Images</label>
                <div id="productImagesContainer">
                  <!-- Image previews will be added here -->
                </div>
                <div class="d-grid mt-2">
                  <button type="button" class="admin-btn admin-btn-primary" onclick="document.getElementById('productImages').click()">
                    <i class="bi bi-upload me-1"></i> Upload Images
                  </button>
                </div>
                <input type="file" id="productImages" accept="image/*" multiple style="display: none">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" id="saveProductBtn" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>
</div>

<!-- Product Comments Modal -->
<div class="modal fade" id="productCommentsModal" tabindex="-1" aria-labelledby="productCommentsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="productCommentsModalLabel">Product Comments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="productCommentsContainer">
          <!-- Comments will be loaded here -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer Placeholder -->
<div id="footer-placeholder" class="mt-5"></div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/src/client/js/init-data.js"></script>
<script src="/src/client/js/navbar-handler.js"></script>

<script>
  // 确保localStorage中的登录状态是正确的
  document.addEventListener('DOMContentLoaded', function() {
    // 检查用户登录状态并在必要时更正
    console.log('验证登录状态...');
    // Check if user is logged in, if not redirect to login page
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (!currentUser) {
      console.log('用户未登录，重定向到登录页面');
      window.location.href = 'login.html';
      return;
    } else {
      console.log('用户已登录:', currentUser.username);
      
      // 强制更新localStorage以确保其他页面能检测到登录状态
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      // 如果是管理员，确保isAdmin标志正确设置
      if (currentUser.isAdmin) {
        localStorage.setItem('isAdmin', 'true');
      }
      
      // 触发一个storage事件以确保所有页面同步
      window.dispatchEvent(new StorageEvent('storage', {
        key: 'currentUser',
        newValue: localStorage.getItem('currentUser')
      }));
    }
  });

  // The navbar and footer are now loaded by navbar-handler.js
  // Previously custom implementation has been removed to avoid conflicts

  // Global variables
  let userProfile = null;
  let userAddresses = [];
  let productsLoaded = false; // 标记产品是否已加载

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded, initializing page...');
    
    // 增强登录检查逻辑
    function checkLoginStatus() {
      try {
        // 获取当前用户数据
        const currentUserStr = localStorage.getItem('currentUser');
        console.log('当前用户数据:', currentUserStr);
        
        // 更严格的检查
        if (!currentUserStr || currentUserStr === 'null' || currentUserStr === 'undefined') {
          console.log('用户未登录或数据无效，重定向到登录页面');
          window.location.href = 'login.html';
          return false;
        }
        
        // 验证用户数据格式
        try {
          const currentUser = JSON.parse(currentUserStr);
          if (!currentUser || typeof currentUser !== 'object' || 
              !(currentUser.id || currentUser.username || currentUser.email)) {
            console.log('用户数据格式无效，重定向到登录页面');
            window.location.href = 'login.html';
            return false;
          }
          
          console.log('用户登录验证成功:', currentUser.username);
          return true;
        } catch (parseError) {
          console.error('解析用户数据失败:', parseError);
          window.location.href = 'login.html';
          return false;
        }
      } catch (error) {
        console.error('登录检查过程中出错:', error);
        window.location.href = 'login.html';
        return false;
      }
    }
    
    // 验证登录状态
    if (!checkLoginStatus()) {
      return; // 停止初始化
    }
    
    // Test localStorage access
    try {
      console.log('Testing localStorage access...');
      const testProducts = JSON.parse(localStorage.getItem('products') || '[]');
      console.log(`Found ${testProducts.length} products in localStorage during initialization`);
      
      const testCategories = JSON.parse(localStorage.getItem('categories') || '[]');
      console.log(`Found ${testCategories.length} categories in localStorage during initialization`);

      // 检查管理员状态
      const isAdmin = localStorage.getItem('isAdmin') === 'true';
      console.log(`Admin status from localStorage: ${isAdmin}`);
    } catch (error) {
      console.error('Error accessing localStorage:', error);
    }
    
    // 初始化数据
    if (typeof window.initializeData === 'function') {
      console.log('Initializing data...');
      window.initializeData();
    } else {
      console.warn('initializeData function not found, skipping data initialization');
    }
    
    // 加载用户配置文件
    loadUserProfile();
    
    // 加载用户地址
    loadUserAddresses();
    
    // 初始化管理员功能
    initializeAdminFeatures();
    
    // 设置事件监听器
    setupEventListeners();
    
    console.log('Page initialization complete.');

    // 确保管理员面板在页面加载完成后显示
    setTimeout(function() {
      if (localStorage.getItem('isAdmin') === 'true') {
        console.log('Forcing admin panel display after page load');
        document.getElementById('admin-tab-container').style.display = 'block';
        // 如果产品尚未加载，强制加载
        if (!productsLoaded) {
          console.log('Products not loaded yet, forcing product load');
          loadProducts();
        }
      }
    }, 1000);
    
    // 确保全局函数可访问
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.viewProductComments = viewProductComments;
    window.resetProductForm = resetProductForm;
    window.saveProduct = saveProduct;
    window.editComment = editComment;
    window.deleteComment = deleteComment;
  });

  // Initialize admin features
  function initializeAdminFeatures() {
    console.log('Initializing admin features...');
    // Check if user is admin
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    console.log(`User is admin: ${isAdmin}`);
    
    if (isAdmin) {
      // Show admin tab explicitly
      document.getElementById('admin-tab-container').style.display = 'block';
      console.log('Admin tab container shown');
      
      // Load admin features data
      console.log('Loading admin data...');
      try {
        loadUsers();
        console.log('Users loaded');
        
        loadDesigners();
        console.log('Designers loaded');
        
        console.log('About to load products...');
        loadProducts();
        console.log('Products loaded');
        
        loadCategories();
        console.log('Categories loaded');
        
        // 加载订单数据
        loadAllOrders();
        console.log('Orders loaded');
        
        // Setup admin event listeners
        setupAdminEventListeners();
        console.log('Admin event listeners set up');
      } catch (error) {
        console.error('Error loading admin data:', error);
        // 尝试识别和报告具体错误
        if (error.message.includes('getElementById')) {
          console.error('DOM元素未找到。页面结构可能已更改或尚未加载。');
        } else if (error.message.includes('JSON')) {
          console.error('JSON解析错误。localStorage中的数据可能已损坏。');
        }
      }
    } else {
      console.log('User is not admin, hiding admin features');
      document.getElementById('admin-tab-container').style.display = 'none';
    }
  }

  // Load user profile from localStorage
  function loadUserProfile() {
    // Get data from currentUser instead of user
    const userData = localStorage.getItem('currentUser');
    if (userData) {
      // Parse the current user data
      userProfile = JSON.parse(userData);
      
      console.log('Loading profile for:', userProfile.username);
      
      // Get the complete user data from users array using the ID or username
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const completeUserData = users.find(u => u.id == userProfile.id || u.username === userProfile.username);
      
      if (completeUserData) {
        // Merge the data to ensure we have all profile fields
        userProfile = {...userProfile, ...completeUserData};
        console.log('Complete user profile loaded:', userProfile.username);
      } else {
        console.warn('Could not find complete profile data for user:', userProfile.username);
      }
      
      // Update profile display
      $('#profile-img').attr('src', userProfile.avatar || '../../../img/profile.png');
      $('#user-full-name').text(`${userProfile.firstName || ''} ${userProfile.lastName || ''}`);
      
      // Only show email without admin indicator
      $('#user-email, #email-display').text(userProfile.email || '');
      
      // Display username without admin indicator
      const usernameDisplay = userProfile.username ? '@' + userProfile.username : '';
      $('#username-display').text(usernameDisplay);
      $('#username-display-profile').text(usernameDisplay);
      
      // Format and display birthday
      if (userProfile.birthday) {
        const birthday = new Date(userProfile.birthday);
        const formattedBirthday = birthday.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        $('#birthday-display').text(formattedBirthday);
      } else {
        $('#birthday-display').text('Not set');
      }
      
      // Display gender
      if (userProfile.gender) {
        $('#gender-display').text(userProfile.gender.charAt(0).toUpperCase() + userProfile.gender.slice(1));
      } else {
        $('#gender-display').text('Not set');
      }
      
      // Display first and last name
      $('#first-name').text(userProfile.firstName || '');
      $('#last-name').text(userProfile.lastName || '');
      
      // Format and display join date
      if (userProfile.createdAt) {
        const joinDate = new Date(userProfile.createdAt);
        $('#join-date').text(joinDate.toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'long'
        }));
      } else {
        $('#join-date').text('Unknown');
      }
      
      // Populate edit profile form
      $('#firstName').val(userProfile.firstName || '');
      $('#lastName').val(userProfile.lastName || '');
      $('#email').val(userProfile.email || '');
      $('#birthday').val(userProfile.birthday || '');
      $('#username').val(userProfile.username || '');
      if (userProfile.gender) {
        $(`input[name="gender"][value="${userProfile.gender}"]`).prop('checked', true);
      }
    } else {
      console.error('No user data found in localStorage');
      // Redirect to login page if no user data is found
      window.location.href = 'login.html';
    }
  }

  // Load user addresses from localStorage
  function loadUserAddresses() {
    try {
      // First check if we have a current user
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));
      if (!currentUser) {
        console.error('Cannot load addresses: No current user found');
        return;
      }
      
      // Create a user-specific key for addresses
      const addressKey = `userAddresses_${currentUser.id}`;
      console.log(`Loading addresses for user ID: ${currentUser.id} using key: ${addressKey}`);
      
      const addressesData = localStorage.getItem(addressKey);
      if (addressesData) {
        userAddresses = JSON.parse(addressesData);
        console.log(`Loaded ${userAddresses.length} addresses for user`);
      } else {
        // Initialize empty addresses array for this user
        userAddresses = [];
        console.log('No addresses found for this user, initialized empty array');
      }
      
      renderAddresses();
    } catch (error) {
      console.error('Error loading user addresses:', error);
      userAddresses = [];
      renderAddresses();
    }
  }

  // Render addresses to the addresses container
  function renderAddresses() {
    const container = $('#addresses-container');
    
    if (userAddresses.length === 0) {
      container.html(`
        <div class="no-addresses">
          <i class="bi bi-geo-alt display-4"></i>
          <p class="mt-3">You don't have any saved addresses yet.</p>
        </div>
      `);
      return;
    }
    
    // Sort addresses so default is first
    userAddresses.sort((a, b) => (b.isDefault ? 1 : 0) - (a.isDefault ? 1 : 0));
    
    let addressesHTML = '';
    userAddresses.forEach((address, index) => {
      addressesHTML += `
        <div class="address-card ${address.isDefault ? 'default' : ''}">
          ${address.isDefault ? '<div class="default-badge">Default</div>' : ''}
          <h5>${address.name}</h5>
          <div>${address.fullName}</div>
          <div>${address.phone}</div>
          <div>${address.addressLine1}</div>
          ${address.addressLine2 ? `<div>${address.addressLine2}</div>` : ''}
          <div>${address.city}, ${address.state} ${address.zipCode}</div>
          <div>${getCountryName(address.country)}</div>
          
          <div class="address-actions">
            <button class="admin-btn admin-btn-outline admin-btn-sm edit-address" data-index="${index}">
              <i class="bi bi-pencil"></i> Edit
            </button>
            ${!address.isDefault ? `
              <button class="admin-btn admin-btn-outline-success admin-btn-sm set-default" data-index="${index}">
                <i class="bi bi-check-lg"></i> Set as Default
              </button>
            ` : ''}
            <button class="admin-btn admin-btn-outline-danger admin-btn-sm delete-address" data-index="${index}">
              <i class="bi bi-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
    });
    
    container.html(addressesHTML);
    
    // Add event listeners to address action buttons
    $('.edit-address').click(function() {
      const index = $(this).data('index');
      editAddress(index);
    });
    
    $('.set-default').click(function() {
      const index = $(this).data('index');
      setDefaultAddress(index);
    });
    
    $('.delete-address').click(function() {
      const index = $(this).data('index');
      deleteAddress(index);
    });
  }

  // Setup event listeners
  function setupEventListeners() {
    console.log('Setting up event listeners...');
    
    // Profile photo upload
    $('#avatar-upload').change(updateProfilePhoto);
    
    // Save profile changes
    $('#save-profile').click(saveProfileChanges);
    
    // Save new address
    $('#save-address').click(saveNewAddress);
    
    // Change password form
    $('#change-password-form').submit(function(e) {
      e.preventDefault();
      changePassword();
    });
    
    // Copy address form to edit modal
    $('#editAddressModal').on('show.bs.modal', function() {
      $(this).find('.modal-body').html($('#addAddressModal .modal-body').html());
    });
    
    // Add product event listeners
    $('#productImages').change(function(event) {
      previewProductImages(event);
    });

    // 确保产品保存按钮正确绑定事件
    $('#saveProductBtn').click(function() {
      console.log('Save product button clicked');
      saveProduct();
    });

    // 添加重置表单的按钮点击处理
    $('.btn[data-bs-toggle="modal"][data-bs-target="#productModal"]').click(function() {
      console.log('Add product button clicked, resetting form');
      resetProductForm();
    });

    $('#productModal').on('show.bs.modal', function() {
      console.log('Product modal opened, loading designers...');
      loadDesignersForProduct();
    });
    
    console.log('Event listeners setup complete.');
  }

  // Update profile photo
  function updateProfilePhoto(event) {
    try {
      const file = event.target.files[0];
      if (file && (file.type === "image/jpeg" || file.type === "image/png")) {
        if (file.size > 5 * 1024 * 1024) {
          showToast("Image size should not exceed 5MB", "warning");
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const imgData = e.target.result;
          $('#profile-img').attr('src', imgData);
          
          // Update user profile in localStorage
          if (userProfile) {
            userProfile.avatar = imgData;
            // Update in currentUser
            localStorage.setItem('currentUser', JSON.stringify(userProfile));
            
            // Also update in users array if exists
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userIndex = users.findIndex(u => u.id === userProfile.id);
            
            if (userIndex !== -1) {
              users[userIndex].avatar = imgData;
              localStorage.setItem('users', JSON.stringify(users));
            }
            
            showToast("Profile photo updated successfully", "success");
          }
        };
        reader.readAsDataURL(file);
      } else {
        showToast("Please upload a valid JPG or PNG image", "warning");
      }
    } catch (error) {
      console.error('Error updating profile photo:', error);
      showToast('Error updating profile photo: ' + error.message, 'danger');
    }
  }

  // Save profile changes
  function saveProfileChanges() {
    try {
      console.log('Saving profile changes...');
      const firstName = $('#firstName').val().trim();
      const lastName = $('#lastName').val().trim();
      const email = $('#email').val().trim();
      const birthday = $('#birthday').val();
      const gender = $('input[name="gender"]:checked').val();
      const username = $('#username').val().trim();
      
      // Validate form
      if (!firstName || !lastName || !email) {
        $('#profile-error').text('Please fill in all required fields.').removeClass('d-none');
        return;
      }
      
      // Validate username
      if (!username || username.length < 3) {
        $('#profile-error').text('Username must be at least 3 characters long.').removeClass('d-none');
        return;
      }
      
      console.log('Form validation passed, updating profile...');
      
      // Update user profile
      userProfile = {
        ...userProfile,
        firstName,
        lastName,
        email,
        birthday: birthday || userProfile.birthday,
        gender: gender || userProfile.gender,
        username
      };
      
      // Save to localStorage - ensure we update currentUser
      localStorage.setItem('currentUser', JSON.stringify(userProfile));
      
      // Also update 'user' for backwards compatibility with older code
      localStorage.setItem('user', JSON.stringify(userProfile));
      
      // Add a flag to indicate profile was just updated (will be used after page refresh)
      sessionStorage.setItem('profileJustUpdated', 'true');
      
      // Get users array if it exists
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id === userProfile.id);
      
      // Update the user in the users array if found
      if (userIndex !== -1) {
        users[userIndex] = {...users[userIndex], ...userProfile};
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      // Update display
      loadUserProfile();
      
      // Instead of trying to close the modal, refresh page with a success parameter
      showToast('Profile updated successfully!', 'success');
      console.log('Profile updated successfully, will refresh page in 1.5 seconds');
      
      
      // Give time for toast to be visible, then refresh with a parameter
      setTimeout(function() {
        window.location.href = window.location.pathname + '?status=profile_updated';
      }, 1500);
    } catch (error) {
      console.error('Error saving profile:', error);
      showToast('Error saving profile: ' + error.message, 'danger');
    }
  }

  // Save new address
  function saveNewAddress() {
    const addressId = $('#address-id').val();
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser || !currentUser.id) {
      alert('Error: User not logged in properly. Please log in again.');
      return;
    }
    
    // Create address object
    const newAddress = {
      id: addressId || Date.now().toString(),
      name: $('#addressName').val(),
      fullName: $('#fullName').val(),
      phone: $('#phone').val(),
      addressLine1: $('#addressLine1').val(),
      addressLine2: $('#addressLine2').val(),
      city: $('#city').val(),
      state: $('#state').val(),
      zipCode: $('#zipCode').val(),
      country: $('#country').val(),
      isDefault: $('#defaultAddress').is(':checked')
    };
    
    // Check if editing existing address
    if (addressId) {
      // Update existing address
      const index = userAddresses.findIndex(a => a.id === addressId);
      if (index !== -1) {
        // If this address is becoming the default, set others to false
        if (newAddress.isDefault) {
          userAddresses.forEach(addr => addr.isDefault = false);
        }
        // Preserve default status if no other is default and this is not becoming default
        else if (!userAddresses.some(a => a.id !== addressId && a.isDefault)) {
          newAddress.isDefault = true;
        }
        
        userAddresses[index] = newAddress;
      }
    } else {
      // Add new address
      
      // If this is the first address, make it default
      if (userAddresses.length === 0) {
        newAddress.isDefault = true;
      }
      // If this address is becoming the default, set others to false
      else if (newAddress.isDefault) {
        userAddresses.forEach(addr => addr.isDefault = false);
      }
      
      userAddresses.push(newAddress);
    }
    
    // Create a user-specific key for addresses
    const addressKey = `userAddresses_${currentUser.id}`;
    
    // Save to localStorage with user-specific key
    localStorage.setItem(addressKey, JSON.stringify(userAddresses));
    console.log(`Saved ${userAddresses.length} addresses for user ID: ${currentUser.id}`);
    
    // Update shipping cost in cart if this is default address
    if (newAddress.isDefault) {
      updateCartShippingCost(newAddress);
    }
    
    // Render addresses
    renderAddresses();
    
    // Reset form
    $('#address-form')[0].reset();
    $('#address-id').val('');
    
    // Instead of using jQuery modal hide, use page refresh
    showToast('Address saved successfully!', 'success');
    
    // Give time for toast to be visible, then refresh with a parameter
    setTimeout(function() {
      window.location.href = window.location.pathname + '?status=address_saved';
    }, 1500);
  }

  // Edit address
  function editAddress(index) {
    const address = userAddresses[index];
    
    // Populate form
    $('#address-id').val(address.id);
    $('#addressName').val(address.name);
    $('#fullName').val(address.fullName);
    $('#phone').val(address.phone);
    $('#addressLine1').val(address.addressLine1);
    $('#addressLine2').val(address.addressLine2);
    $('#city').val(address.city);
    $('#state').val(address.state);
    $('#zipCode').val(address.zipCode);
    $('#country').val(address.country);
    $('#defaultAddress').prop('checked', address.isDefault);
    
    // Show modal
    $('#editAddressModal').modal('show');
    
    // Set update button event handler
    $('#update-address').off('click').on('click', saveNewAddress);
  }

  // Set default address
  function setDefaultAddress(index) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser || !currentUser.id) {
      alert('Error: User not logged in properly. Please log in again.');
      return;
    }
    
    // Set all addresses to non-default
    userAddresses.forEach(addr => addr.isDefault = false);
    
    // Set selected address as default
    userAddresses[index].isDefault = true;
    
    // Update shipping cost in cart
    updateCartShippingCost(userAddresses[index]);
    
    // Create a user-specific key for addresses
    const addressKey = `userAddresses_${currentUser.id}`;
    
    // Save to localStorage with user-specific key
    localStorage.setItem(addressKey, JSON.stringify(userAddresses));
    console.log(`Updated default address for user ID: ${currentUser.id}`);
    
    // Render addresses
    renderAddresses();
    
    // Use toast and page refresh instead of alert
    showToast('Default address updated successfully!', 'success');
    
    // Give time for toast to be visible, then refresh with a parameter
    setTimeout(function() {
      window.location.href = window.location.pathname + '?status=address_updated';
    }, 1500);
  }

  // Delete address
  function deleteAddress(index) {
    if (!confirm('Are you sure you want to delete this address?')) {
      return;
    }
    
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    if (!currentUser || !currentUser.id) {
      alert('Error: User not logged in properly. Please log in again.');
      return;
    }
    
    const wasDefault = userAddresses[index].isDefault;
    
    // Remove address
    userAddresses.splice(index, 1);
    
    // If deleted address was default and there are other addresses, set first as default
    if (wasDefault && userAddresses.length > 0) {
      userAddresses[0].isDefault = true;
      updateCartShippingCost(userAddresses[0]);
    }
    
    // Create a user-specific key for addresses
    const addressKey = `userAddresses_${currentUser.id}`;
    
    // Save to localStorage with user-specific key
    localStorage.setItem(addressKey, JSON.stringify(userAddresses));
    console.log(`Deleted address for user ID: ${currentUser.id}, ${userAddresses.length} addresses remaining`);
    
    // Render addresses
    renderAddresses();
    
    // Use toast and page refresh instead of alert
    showToast('Address deleted successfully!', 'success');
    
    // Give time for toast to be visible, then refresh with a parameter
    setTimeout(function() {
      window.location.href = window.location.pathname + '?status=address_deleted';
    }, 1500);
  }

  // Update cart shipping cost based on default address
  function updateCartShippingCost(address) {
    // Simple shipping cost calculation example
    let shippingCost = 5.99; // Default shipping cost
    
    // Adjust based on country
    if (address.country === 'US') {
      shippingCost = 5.99;
    } else if (['CA', 'MX'].includes(address.country)) {
      shippingCost = 9.99;
    } else {
      shippingCost = 14.99;
    }
    
    // Save shipping cost to localStorage for cart to use
    localStorage.setItem('shippingCost', shippingCost.toString());
    
    return shippingCost;
  }

  // Change password
  function changePassword() {
    try {
      const currentPassword = $('#current-password').val();
      const newPassword = $('#new-password').val();
      const confirmPassword = $('#confirm-password').val();
      
      // Validate passwords
      if (!currentPassword || !newPassword || !confirmPassword) {
        $('#password-error').text('Please fill in all password fields.').removeClass('d-none');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        $('#password-error').text('New passwords do not match.').removeClass('d-none');
        return;
      }
      
      if (newPassword.length < 8) {
        $('#password-error').text('New password must be at least 8 characters long.').removeClass('d-none');
        return;
      }
      
      // Check if current password is correct (simplified for demo)
      // In a real app, this should be verified on the server
      if (userProfile && userProfile.password !== currentPassword) {
        $('#password-error').text('Current password is incorrect.').removeClass('d-none');
        return;
      }
      
      // Update password in all storage locations
      if (userProfile) {
        userProfile.password = newPassword;
        localStorage.setItem('currentUser', JSON.stringify(userProfile));
        localStorage.setItem('user', JSON.stringify(userProfile)); // for backwards compatibility
        
        // Also update in users array if it exists
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const userIndex = users.findIndex(u => u.id === userProfile.id);
        if (userIndex !== -1) {
          users[userIndex].password = newPassword;
          localStorage.setItem('users', JSON.stringify(users));
        }
        
        // Reset form
        $('#change-password-form')[0].reset();
        $('#password-error').addClass('d-none');
        
        // Show success message and refresh
        showToast('Password changed successfully!', 'success');
        
        // Refresh page after short delay
        setTimeout(function() {
          window.location.href = window.location.pathname + '?status=password_changed';
        }, 1500);
      }
    } catch (error) {
      console.error('Error changing password:', error);
      $('#password-error').text('Error: ' + error.message).removeClass('d-none');
    }
  }

  function getCountryName(countryCode) {
    const countries = {
      'US': 'United States',
      'CA': 'Canada',
      'UK': 'United Kingdom',
      'AU': 'Australia',
      'FR': 'France',
      'DE': 'Germany',
      'JP': 'Japan',
      'CN': 'China',
      'IN': 'India',
      'BR': 'Brazil',
      'MX': 'Mexico'
    };
    
    return countries[countryCode] || countryCode;
  }

  // Load users
  function loadUsers() {
    // First try to get from 'users' (from registration), then fall back to 'usersData' (admin created)
    let users = JSON.parse(localStorage.getItem("users")) || 
                JSON.parse(localStorage.getItem("usersData")) || [
      { id: 1, name: "Alice", email: "alice@example.com", status: "Active", role: "User" },
      { id: 2, name: "Bob", email: "bob@example.com", status: "Disabled", role: "User" }
    ];

    let userTable = document.getElementById("userTableBody");
    if (!userTable) {
      console.log('userTableBody element not found - user table will not be updated');
      return;
    }
    
    userTable.innerHTML = "";

    users.forEach(user => {
      // Get user's full name or username
      const displayName = user.firstName && user.lastName ? 
                          `${user.firstName} ${user.lastName}` : 
                          (user.name || user.username || 'Unknown');
      
      // Get user's role
      const role = user.isAdmin ? "Admin" : "User";
      
      // Get user's status or default to Active
      const status = user.status || "Active";
      
      // Get user's avatar or use default
      const avatarSrc = user.avatar || "../../../img/profile.png";
      
      userTable.innerHTML += `
        <tr>
          <td>
            <div class="user-avatar-small">
              <img src="${avatarSrc}" alt="${displayName}" class="rounded-circle" width="40" height="40">
            </div>
          </td>
          <td>${displayName}</td>
          <td>${user.email}</td>
          <td>${role}</td>
          <td>${status}</td>
          <td>
            ${status === "Active" ? 
              `<button class="admin-btn admin-btn-primary" onclick="toggleUserStatus(${user.id}, 'Disabled')">Disable</button>` :
              `<button class="admin-btn admin-btn-success" onclick="toggleUserStatus(${user.id}, 'Active')">Enable</button>`
            }
          </td>
        </tr>`;
    });

    // Store the combined data back to usersData for consistency
    localStorage.setItem("usersData", JSON.stringify(users));
  }

  // Toggle user status
  function toggleUserStatus(userId, newStatus) {
    // Try to get from both sources
    let users = JSON.parse(localStorage.getItem("users")) || [];
    let usersData = JSON.parse(localStorage.getItem("usersData")) || [];
    
    // Update in users array if found
    let userIndex = users.findIndex(user => user.id === userId);
    if (userIndex !== -1) {
      users[userIndex].status = newStatus;
      localStorage.setItem("users", JSON.stringify(users));
    }
    
    // Also update in usersData array
    userIndex = usersData.findIndex(user => user.id === userId);
    if (userIndex !== -1) {
      usersData[userIndex].status = newStatus;
      localStorage.setItem("usersData", JSON.stringify(usersData));
    }
    
    // Reload the user list
    loadUsers();
  }

  // Load orders
  function loadOrders() {
    let orders = JSON.parse(localStorage.getItem("ordersData")) || [
      { id: 101, product: "Handmade Soap", amount: "$50", orderStatus: "New" },
      { id: 102, product: "Handmade Candle", amount: "$30", orderStatus: "Packed" },
      { id: 103, product: "Handmade Basket", amount: "$45", orderStatus: "InTransit" },
      { id: 104, product: "Handmade Vase", amount: "$60", orderStatus: "Delivered" }
    ];

    // Update order counts
    document.getElementById("new-count").textContent = orders.filter(order => order.orderStatus === "New").length;
    document.getElementById("packed-count").textContent = orders.filter(order => order.orderStatus === "Packed").length;
    document.getElementById("transit-count").textContent = orders.filter(order => order.orderStatus === "InTransit").length;
    document.getElementById("delivered-count").textContent = orders.filter(order => order.orderStatus === "Delivered").length;

    // Render order list
    let orderList = document.getElementById("orderTableBody");
    if (!orderList) {
      console.error('orderTableBody element not found! DOM may not be fully loaded.');
      return;
    }
    
    orderList.innerHTML = "";

    orders.forEach(order => {
      orderList.innerHTML += `
        <tr>
          <td>${order.id}</td>
          <td>${order.product}</td>
          <td>${order.amount}</td>
          <td>${order.orderStatus}</td>
          <td>
            <div class="btn-group">
              <button class="admin-btn admin-btn-primary" onclick="updateOrderStatus(${order.id}, 'New')">New</button>
              <button class="admin-btn admin-btn-primary" onclick="updateOrderStatus(${order.id}, 'Packed')">Packed</button>
              <button class="admin-btn admin-btn-primary" onclick="updateOrderStatus(${order.id}, 'InTransit')">In Transit</button>
              <button class="admin-btn admin-btn-primary" onclick="updateOrderStatus(${order.id}, 'Delivered')">Delivered</button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteOrder(${order.id})">Delete</button>
            </div>
          </td>
        </tr>`;
    });

    localStorage.setItem("ordersData", JSON.stringify(orders));
  }

  // Update order status
  function updateOrderStatus(orderId, newStatus) {
    let orders = JSON.parse(localStorage.getItem("ordersData"));
    
    let orderIndex = orders.findIndex(order => order.id === orderId);
    if (orderIndex !== -1) {
      orders[orderIndex].orderStatus = newStatus;
      localStorage.setItem("ordersData", JSON.stringify(orders));
      loadOrders();
    }
  }

  // Delete order
  function deleteOrder(orderId) {
    if (confirm('Are you sure you want to delete this order?')) {
      let orders = JSON.parse(localStorage.getItem("ordersData"));
      orders = orders.filter(order => order.id !== orderId);
      localStorage.setItem("ordersData", JSON.stringify(orders));
      loadOrders();
    }
  }

  // Load comments
  function loadComments() {
    let comments = JSON.parse(localStorage.getItem("commentsData")) || [
      { id: 1, author: "Lisa", rating: 5, text: "Great product, excellent quality!" },
      { id: 2, author: "Mike", rating: 4, text: "Beautiful packaging, very thoughtful." },
      { id: 3, author: "Sarah", rating: 5, text: "My friend loved this gift!" }
    ];

    let commentList = document.getElementById("comment-list");
    commentList.innerHTML = "";

    comments.forEach(comment => {
      commentList.innerHTML += `
        <li class="list-group-item">
          <div class="d-flex justify-content-between">
            <div>
              <strong>${comment.author}</strong>
              <span class="text-warning">
                ${"★".repeat(comment.rating)}${"☆".repeat(5 - comment.rating)}
              </span>
            </div>
            <div>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteComment(${comment.id})">Delete</button>
            </div>
          </div>
          <p class="mb-0 mt-2">${comment.text}</p>
        </li>`;
    });

    localStorage.setItem("commentsData", JSON.stringify(comments));
  }

  // Delete comment
  function deleteComment(commentId) {
    if (confirm('Are you sure you want to delete this comment?')) {
      let comments = JSON.parse(localStorage.getItem("commentsData"));
      comments = comments.filter(comment => comment.id !== commentId);
      localStorage.setItem("commentsData", JSON.stringify(comments));
      loadComments();
    }
  }

  // Setup admin event listeners
  function setupAdminEventListeners() {
    // User search
    $('#search-user').click(function() {
      const searchTerm = $('#user-search').val().trim().toLowerCase();
      if (searchTerm) {
        const users = JSON.parse(localStorage.getItem("usersData") || "[]");
        // Filter users by ID or email
        const filteredUsers = users.filter(user => 
          user.id.toString().includes(searchTerm) || 
          user.email.toLowerCase().includes(searchTerm)
        );
        
        if (filteredUsers.length > 0) {
          renderFilteredUsers(filteredUsers);
        } else {
          alert('No users found matching your search');
        }
      } else {
        loadUsers(); // Reset to show all users if search is empty
      }
    });

    // Reset user list when clearing search box
    $('#user-search').on('input', function() {
      if ($(this).val().trim() === '') {
        loadUsers();
      }
    });

    // Order search
    $('#check-order').click(function() {
      const orderId = parseInt($('#order-search').val());
      if (!isNaN(orderId)) {
        const orders = JSON.parse(localStorage.getItem("ordersData") || "[]");
        const order = orders.find(o => o.id === orderId);
        if (order) {
          alert(`Order ID: ${order.id}\nProduct: ${order.product}\nAmount: ${order.amount}\nStatus: ${order.orderStatus}`);
        } else {
          alert('Order not found');
        }
      } else {
        alert('Please enter a valid Order ID');
      }
    });

    // Category save event
    $('#save-category').click(function() {
      saveCategory();
    });
    
    // Category form submission
    $('#category-form').on('submit', function(e) {
      e.preventDefault();
      saveCategory();
    });
    
    // 订单管理相关的事件监听器
    
    // 导出订单按钮点击事件
    document.getElementById('exportOrdersToCSV') && document.getElementById('exportOrdersToCSV').addEventListener('click', function() {
      exportOrdersToCSV();
    });
    
    // 订单状态筛选变化事件
    document.getElementById('orderFilterStatus') && document.getElementById('orderFilterStatus').addEventListener('change', function() {
      filterAdminOrders();
    });
    
    // 订单日期筛选变化事件
    document.getElementById('orderFilterDate') && document.getElementById('orderFilterDate').addEventListener('change', function() {
      filterAdminOrders();
    });
    
    // 订单搜索框输入事件
    document.getElementById('orderSearch') && document.getElementById('orderSearch').addEventListener('keyup', function() {
      filterAdminOrders();
    });
    
    // 重置订单筛选按钮点击事件
    const resetOrderFiltersBtn = document.getElementById('resetOrderFilters');
    if (resetOrderFiltersBtn) {
      resetOrderFiltersBtn.addEventListener('click', function() {
        resetOrderFilters();
      });
    }
  }

  // Render filtered users
  function renderFilteredUsers(users) {
    let userTable = document.getElementById("userTableBody");
    userTable.innerHTML = "";

    users.forEach(user => {
      userTable.innerHTML += `
        <tr>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>${user.status}</td>
          <td>
            ${user.status === "Active" ? 
              `<button class="disable-btn" onclick="toggleUserStatus(${user.id}, 'Disabled')">Disable</button>` :
              `<button class="enable-btn" onclick="toggleUserStatus(${user.id}, 'Active')">Enable</button>`
            }
          </td>
        </tr>`;
    });
  }

  // Designer management functions
  function loadDesigners() {
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const tableBody = document.getElementById('designerTableBody');
    
    if (!tableBody) {
      console.error('designerTableBody element not found! DOM may not be fully loaded.');
      return; // Exit the function early if tableBody doesn't exist
    }
    
    tableBody.innerHTML = designers.map(designer => {
      const designerProducts = products.filter(p => p.designerId === designer.id);
      return `
        <tr>
          <td>
            <img src="${designer.image}" alt="${designer.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%;">
          </td>
          <td>
            <div class="d-flex flex-column">
              <div class="fw-medium">${designer.name}</div>
              ${designer.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
            </div>
          </td>
          <td>${designer.specialty}</td>
          <td>${designerProducts.length} products</td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="admin-btn admin-btn-primary admin-btn-sm me-1" onclick="editDesigner('${designer.id}')">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm me-1" onclick="deleteDesigner('${designer.id}')">
                <i class="bi bi-trash"></i>
              </button>
              <a href="/src/client/views/designer/designer-page.html?id=${designer.id}" class="admin-btn admin-btn-info admin-btn-sm me-1" target="_blank">
                <i class="bi bi-eye"></i>
              </a>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  function previewDesignerImages(event) {
    const container = document.getElementById('designerImagesContainer');
    const files = event.target.files;
    
    if (files.length === 0) return;
    
    // Clear existing previews when adding new images
    container.innerHTML = '';
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    });
  }

  function resetDesignerForm() {
    document.getElementById('designerForm').reset();
    document.getElementById('designerId').value = '';
    document.getElementById('designerImagesContainer').innerHTML = '';
    document.getElementById('designerModalLabel').textContent = 'Add New Designer';
  }

  function editDesigner(id) {
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const designer = designers.find(d => d.id === id);
    
    if (designer) {
      document.getElementById('designerId').value = designer.id;
      document.getElementById('designerName').value = designer.name;
      document.getElementById('designerSpecialty').value = designer.specialty;
      document.getElementById('designerBio').value = designer.bio;
      document.getElementById('designerInstagram').value = designer.social?.instagram || '';
      document.getElementById('designerPinterest').value = designer.social?.pinterest || '';
      document.getElementById('designerEtsy').value = designer.social?.etsy || '';
      document.getElementById('designerFeatured').checked = designer.featured || false;
      
      const container = document.getElementById('designerImagesContainer');
      container.innerHTML = '';
      
      // Display main image and any additional images
      if (designer.image) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${designer.image}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      }
      
      // Add additional images if they exist
      if (designer.images && designer.images.length > 1) {
        designer.images.slice(1).forEach(img => {
          container.innerHTML += `
            <div class="position-relative d-inline-block me-2 mb-2">
              <img src="${img}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%;">
              <button type="button" class="btn-close position-absolute top-0 end-0" 
                style="background-color: white;" onclick="this.parentElement.remove()"></button>
            </div>
          `;
        });
      }
      
      document.getElementById('designerModalLabel').textContent = 'Edit Designer';
      new bootstrap.Modal(document.getElementById('designerModal')).show();
    }
  }

  function saveDesigner() {
    const designerId = document.getElementById('designerId').value;
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    
    // Get all images from the container
    const images = Array.from(document.getElementById('designerImagesContainer').children || [])
      .map(div => div.querySelector('img').src);
    
    const mainImage = images.length > 0 ? images[0] : '../../../img/profile.png';
    
    const designer = {
      id: designerId || `d${Date.now()}`,
      name: document.getElementById('designerName').value,
      specialty: document.getElementById('designerSpecialty').value,
      bio: document.getElementById('designerBio').value,
      image: mainImage,
      images: images,
      featured: document.getElementById('designerFeatured').checked,
      social: {
        instagram: document.getElementById('designerInstagram').value,
        pinterest: document.getElementById('designerPinterest').value,
        etsy: document.getElementById('designerEtsy').value
      }
    };
    
    if (designerId) {
      const index = designers.findIndex(d => d.id === designerId);
      if (index !== -1) {
        designers[index] = designer;
      }
    } else {
      designers.push(designer);
    }
    
    localStorage.setItem('designers', JSON.stringify(designers));
    bootstrap.Modal.getInstance(document.getElementById('designerModal')).hide();
    loadDesigners();
  }

  function deleteDesigner(id) {
    if (confirm('Are you sure you want to delete this designer? This will not delete their products.')) {
      const designers = JSON.parse(localStorage.getItem('designers') || '[]');
      const filteredDesigners = designers.filter(d => d.id !== id);
      localStorage.setItem('designers', JSON.stringify(filteredDesigners));
      loadDesigners();
    }
  }

  // Product management functions
  function loadProducts() {
    const products = JSON.parse(localStorage.getItem("productsData")) || [
      { id: 1, name: "Handmade Soap", price: 15.99, category: "Bath & Body", stock: 25, image: "../../../img/profile.png" },
      { id: 2, name: "Scented Candle", price: 24.99, category: "Home Decor", stock: 15, image: "../../../img/profile.png" }
    ];
    
    const tableBody = document.getElementById('productTableBody');
    if (!tableBody) {
      console.error('productTableBody element not found! DOM may not be fully loaded.');
      
      // Try again after a short delay
      setTimeout(() => {
        const retryTableBody = document.getElementById('productTableBody');
        if (retryTableBody) {
          console.log('Found productTableBody on retry');
          renderProductTable(products, retryTableBody);
        } else {
          console.error('productTableBody still not found after retry');
        }
      }, 500);
      
      return;
    }
    
    renderProductTable(products, tableBody);
  }
  
  function renderProductTable(products, tableBody) {
    tableBody.innerHTML = "";
    
    products.forEach(product => {
      tableBody.innerHTML += `
        <tr>
          <td>
            <img src="${product.image || '../../../img/profile.png'}" alt="${product.name}" class="rounded" width="50" height="50">
          </td>
          <td>${product.name}</td>
          <td>$${product.price.toFixed(2)}</td>
          <td>${product.category}</td>
          <td>${product.stock}</td>
          <td>
            <div class="btn-group">
              <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editProduct(${product.id})">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteProduct(${product.id})">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        </tr>`;
    });
    
    // Store in localStorage
    localStorage.setItem("productsData", JSON.stringify(products));
  }

  // 加载筛选选项
  function loadFilterOptions(categories, designers) {
    // 加载分类选项
    const categoryFilter = document.getElementById('filterCategory');
    if (categoryFilter) {
      // 清空现有选项，保留第一个"全部分类"选项
      categoryFilter.innerHTML = '<option value="">All Categories</option>';
      
      // 添加分类选项
      categories.forEach(category => {
        categoryFilter.innerHTML += `<option value="${category.id}">${category.name}</option>`;
      });
    }
    
    // 加载设计师选项
    const designerFilter = document.getElementById('filterDesigner');
    if (designerFilter) {
      // 清空现有选项，保留第一个"全部设计师"选项
      designerFilter.innerHTML = '<option value="">All Designers</option>';
      
      // 添加设计师选项
      designers.forEach(designer => {
        designerFilter.innerHTML += `<option value="${designer.id}">${designer.name}</option>`;
      });
    }
  }
  
  // 筛选产品
  function filterProducts() {
    if (!window.allProducts) {
      console.error('Products not loaded yet');
      return;
    }
    
    console.log('Filtering products...');
    
    const categoryId = document.getElementById('filterCategory').value;
    const designerId = document.getElementById('filterDesigner').value;
    const onSaleOnly = document.getElementById('filterOnSale').checked;
    
    console.log(`Filter - Category: ${categoryId}, Designer: ${designerId}, On Sale Only: ${onSaleOnly}`);
    
    let filteredProducts = [...window.allProducts]; // 复制所有产品数组
    
    // 按分类筛选
    if (categoryId) {
      filteredProducts = filteredProducts.filter(product => {
        if (product.categoryId) {
          // 使用categoryId字段
          return product.categoryId.toString() === categoryId.toString();
        } else if (product.category && window.allCategories) {
          // 使用category字段名称匹配
          const category = window.allCategories.find(c => c.id.toString() === categoryId.toString());
          return category && product.category === category.name;
        }
        return false;
      });
    }
    
    // 按设计师筛选
    if (designerId) {
      filteredProducts = filteredProducts.filter(product => {
        return product.designerId && product.designerId.toString() === designerId.toString();
      });
    }
    
    // 按销售状态筛选
    if (onSaleOnly) {
      filteredProducts = filteredProducts.filter(product => product.onSale === true);
    }
    
    console.log(`Filter results: ${filteredProducts.length} products`);
    
    // 更新表格
    const tableBody = document.getElementById('productTableBody');
    if (tableBody) {
      fillProductTable(tableBody, filteredProducts, window.allCategories, window.allDesigners);
    }
  }
  
  // 重置筛选
  function resetFilters() {
    document.getElementById('filterCategory').value = '';
    document.getElementById('filterDesigner').value = '';
    document.getElementById('filterOnSale').checked = false;
    
    // 重新显示所有产品
    const tableBody = document.getElementById('productTableBody');
    if (tableBody && window.allProducts) {
      fillProductTable(tableBody, window.allProducts, window.allCategories, window.allDesigners);
    }
  }

  // 将填充表格功能独立为函数，方便复用
  function fillProductTable(tableBody, products, categories, designers) {
    tableBody.innerHTML = '';  // 清空表格
    console.log(`Filling table with ${products.length} products`);
    
    if (products.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No products found</td></tr>';
      return;
    }
    
    products.forEach(product => {
      console.log(`Processing product: ${product.name}, format:`, product);
      
      // 兼容两种数据格式
      let categoryName = 'Unknown';
      if (product.categoryId) {
        // 第一种格式：使用categoryId关联categories数组
        const category = categories.find(c => c.id === product.categoryId);
        if (category) {
          categoryName = category.name;
        }
      } else if (product.category) {
        // 第二种格式：直接使用category字段
        categoryName = product.category;
      }
      
      const designer = product.designerId ? designers.find(d => d.id === product.designerId) : null;
      
      // 兼容两种图片格式
      let mainImage = '../../../img/profile.png';
      if (product.images && product.images.length > 0) {
        mainImage = product.images[0];
      }
      
      // 检查是否是新品（上架时间在一个月内）
      const isNew = product.listingDate && 
        (new Date().getTime() - new Date(product.listingDate).getTime()) <= 30 * 24 * 60 * 60 * 1000;
      
      // 兼容不同的价格格式
      const price = typeof product.price === 'number' ? product.price : parseFloat(product.price) || 0;
      const salePrice = product.salePrice || (product.onSale ? price * 0.9 : null);
      const stock = product.stock || 10; // 如果没有库存信息，默认为10
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>
          <img src="${mainImage}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover;">
        </td>
        <td>
          ${product.name}
          ${isNew ? '<span class="badge badge-primary ms-1">New</span>' : ''}
        </td>
        <td>${categoryName}</td>
        <td>$${price.toFixed(2)}${product.onSale ? `<br><span class="text-danger">Sale: $${salePrice.toFixed(2)}</span>` : ''}</td>
        <td>${stock}</td>
        <td>
          ${product.onSale ? '<span class="badge bg-danger">On Sale</span>' : '<span class="badge bg-success">Regular</span>'}
          <br>
          <small class="text-muted">Listed: ${product.listingDate ? new Date(product.listingDate).toLocaleDateString() : 'N/A'}</small>
        </td>
        <td>
          <div class="btn-group">
            <button class="admin-btn admin-btn-primary admin-btn-sm me-1" onclick="editProduct('${product.id}')">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="admin-btn admin-btn-danger admin-btn-sm me-1" onclick="deleteProduct('${product.id}')">
              <i class="bi bi-trash"></i>
            </button>
            <button class="admin-btn admin-btn-info admin-btn-sm" onclick="viewProductComments('${product.id}')">
              <i class="bi bi-chat-dots"></i>
            </button>
          </div>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function loadDesignersForProduct() {
    console.log('Loading designers for product dropdown');
    const designers = JSON.parse(localStorage.getItem('designers') || '[]');
    const select = document.getElementById('productDesigner');
    
    if (!select) {
      console.error('productDesigner select element not found');
      return;
    }
    
    select.innerHTML = '<option value="">Select Designer</option>' + 
      designers.map(designer => `
        <option value="${designer.id}">${designer.name} (${designer.specialty})</option>
      `).join('');
    
    console.log(`Loaded ${designers.length} designers into dropdown`);
  }

  function previewProductImages(event) {
    const container = document.getElementById('productImagesContainer');
    const files = event.target.files;
    
    if (!container) {
      console.error('productImagesContainer element not found');
      return;
    }
    
    container.innerHTML = '';
    
    if (files.length === 0) {
      console.log('No files selected for preview');
      return;
    }
    
    console.log(`Previewing ${files.length} product images`);
    
    Array.from(files).forEach(file => {
      const reader = new FileReader();
      reader.onload = function(e) {
        container.innerHTML += `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${e.target.result}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `;
      };
      reader.readAsDataURL(file);
    });
  }

  function resetProductForm() {
    console.log('Resetting product form');
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productImagesContainer').innerHTML = '';
    document.getElementById('productModalLabel').textContent = 'Add New Product';
    loadDesignersForProduct();
  }

  function editProduct(id) {
    console.log(`Editing product with ID: ${id}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(id) || p.id === id);
    
    if (product) {
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.name;
      
      // 兼容两种分类格式
      if (product.categoryId) {
        document.getElementById('productCategory').value = product.categoryId;
      } else if (product.category) {
        // 尝试根据分类名称找到分类ID
        const categories = JSON.parse(localStorage.getItem('categories') || '[]');
        const category = categories.find(c => c.name === product.category);
        if (category) {
          document.getElementById('productCategory').value = category.id;
        }
      }
      
      document.getElementById('productDesigner').value = product.designerId || '';
      document.getElementById('productPrice').value = product.price;
      document.getElementById('productStock').value = product.stock || 10;
      document.getElementById('productDescription').value = product.description;
      
      // 兼容不同的details格式
      const details = product.details || product.description || '';
      document.getElementById('productDetails').value = details.replace ? details.replace(/<br>/g, '\n') : details;
      
      document.getElementById('productOnSale').checked = product.onSale || false;
      document.getElementById('productSalePrice').value = product.salePrice || '';
      
      // 设置上架时间
      if (product.listingDate) {
        const date = new Date(product.listingDate);
        const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
          .toISOString()
          .slice(0, 16);
        document.getElementById('productListingDate').value = localDateTime;
      } else {
        document.getElementById('productListingDate').value = '';
      }
      
      const container = document.getElementById('productImagesContainer');
      container.innerHTML = '';
      
      // 兼容不同的图片格式
      if (product.images && product.images.length > 0) {
        container.innerHTML = product.images.map(image => `
          <div class="position-relative d-inline-block me-2 mb-2">
            <img src="${image}" alt="Preview" style="width: 100px; height: 100px; object-fit: cover;">
            <button type="button" class="btn-close position-absolute top-0 end-0" 
              style="background-color: white;" onclick="this.parentElement.remove()"></button>
          </div>
        `).join('');
      }
      
      document.getElementById('productModalLabel').textContent = 'Edit Product';
      loadDesignersForProduct();
      
      console.log('Opening product modal for editing');
      new bootstrap.Modal(document.getElementById('productModal')).show();
    } else {
      console.error(`Product with ID ${id} not found`);
    }
  }

  function saveProduct() {
    console.log('Saving product...');
    const productId = document.getElementById('productId').value;
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    
    try {
      // 获取表单数据
      const productName = document.getElementById('productName').value;
      const productCategory = document.getElementById('productCategory').value;
      const productPrice = document.getElementById('productPrice').value;
      
      if (!productName || !productCategory || !productPrice) {
        console.error('Missing required product fields');
        // Replace alert with form validation
        const errorMessage = document.getElementById('product-form-error');
        if (errorMessage) {
          errorMessage.textContent = 'Please fill in all required fields: Product Name, Category, and Price.';
          errorMessage.classList.remove('d-none');
        } else {
          // Fallback to toast notification
          showToast('Please fill in all required fields: Product Name, Category, and Price.', 'danger');
        }
        return;
      }
      
      console.log(`Collecting data for product: ${productName}`);
      
      const imagesContainer = document.getElementById('productImagesContainer');
      if (!imagesContainer) {
        console.error('productImagesContainer not found');
        return;
      }
      
      const images = Array.from(imagesContainer.querySelectorAll('img')).map(img => img.src);
      console.log(`Found ${images.length} images for product`);
      
      const designerId = document.getElementById('productDesigner').value;
      
      // 获取上架时间，如果没有设置则使用当前时间
      const listingDateInput = document.getElementById('productListingDate').value;
      const listingDate = listingDateInput ? new Date(listingDateInput).toISOString() 
        : productId ? (products.find(p => p.id === parseInt(productId) || p.id === productId)?.listingDate || new Date().toISOString())
        : new Date().toISOString();
      
      // 为新产品生成唯一ID
      let newId;
      if (productId) {
        newId = parseInt(productId) || productId;
      } else {
        // 生成唯一ID的更可靠方法
        const numericIds = products
          .map(p => typeof p.id === 'number' ? p.id : parseInt(p.id))
          .filter(id => !isNaN(id));
        
        newId = numericIds.length > 0 ? Math.max(...numericIds) + 1 : 1;
      }
      
      console.log(`Using product ID: ${newId}`);
      
      // 获取分类信息
      const categories = JSON.parse(localStorage.getItem('categories') || '[]');
      const selectedCategory = categories.find(c => c.id === parseInt(productCategory));
      
      const product = {
        id: newId,
        name: productName,
        categoryId: parseInt(productCategory),
        category: selectedCategory ? selectedCategory.name : null, // 同时存储分类名称，兼容两种格式
        designerId: designerId || null,
        price: parseFloat(productPrice),
        stock: parseInt(document.getElementById('productStock').value) || 0,
        description: document.getElementById('productDescription').value,
        details: document.getElementById('productDetails').value.replace(/\n/g, '<br>'),
        onSale: document.getElementById('productOnSale').checked,
        salePrice: document.getElementById('productSalePrice').value ? 
          parseFloat(document.getElementById('productSalePrice').value) : null,
        images: images.length > 0 ? images : ['../../../img/profile.png'], // 确保至少有一张默认图片
        listingDate: listingDate,
        reviews: productId ? 
          (products.find(p => p.id === parseInt(productId) || p.id === productId)?.reviews || []) : []
      };
      
      console.log(`Prepared product data:`, JSON.stringify(product, null, 2));
      
      if (productId) {
        console.log(`Updating existing product with ID: ${productId}`);
        const index = products.findIndex(p => p.id === parseInt(productId) || p.id === productId);
        if (index !== -1) {
          products[index] = product;
        } else {
          console.error(`Product with ID ${productId} not found for update`);
          products.push(product);
        }
      } else {
        console.log('Adding new product');
        products.push(product);
      }
      
      // 存储前打印最终产品列表
      console.log(`Saving products to localStorage, total: ${products.length}`);
      
      localStorage.setItem('products', JSON.stringify(products));
      console.log(`Successfully saved product. Total products: ${products.length}`);
      
      // 关闭模态窗口
      const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
      if (modal) {
        modal.hide();
      } else {
        console.error('Could not find modal instance');
        document.getElementById('productModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
      }
      
      // 重新加载产品列表
      loadProducts();
      
      // Show success message with toast instead of alert
      showToast('Product saved successfully!', 'success');
    } catch (error) {
      console.error('Error saving product:', error);
      showToast('Error saving product: ' + error.message, 'danger');
    }
  }

  function deleteProduct(id) {
    console.log(`Attempting to delete product with ID: ${id}`);
    
    // Show confirmation dialog using Bootstrap modal instead of browser confirm
    const confirmModal = document.getElementById('confirmDeleteModal');
    if (confirmModal) {
      // Set up confirm button action
      const confirmBtn = confirmModal.querySelector('.btn-danger');
      if (confirmBtn) {
        // Clear any previous event listeners
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
        
        // Add new event listener
        newConfirmBtn.addEventListener('click', function() {
          const products = JSON.parse(localStorage.getItem('products') || '[]');
          const filteredProducts = products.filter(p => p.id !== parseInt(id) && p.id !== id);
          localStorage.setItem('products', JSON.stringify(filteredProducts));
          bootstrap.Modal.getInstance(confirmModal).hide();
          loadProducts();
          showToast('Product deleted successfully', 'info');
        });
      }
      
      // Show the modal
      const bsModal = new bootstrap.Modal(confirmModal);
      bsModal.show();
    } else {
      // Fallback to confirm if modal not available
      if (confirm('Are you sure you want to delete this product?')) {
        const products = JSON.parse(localStorage.getItem('products') || '[]');
        const filteredProducts = products.filter(p => p.id !== parseInt(id) && p.id !== id);
        localStorage.setItem('products', JSON.stringify(filteredProducts));
        loadProducts();
        showToast('Product deleted successfully', 'info');
      }
    }
  }

  // 添加缺失的viewProductComments函数
  function viewProductComments(productId) {
    console.log(`Viewing comments for product with ID: ${productId}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
    
    if (product) {
      const container = document.getElementById('productCommentsContainer');
      const reviews = product.reviews || [];
      
      container.innerHTML = `
        <h6 class="mb-3">Comments for "${product.name}"</h6>
        ${reviews.length === 0 ? '<p class="text-muted">No comments yet.</p>' : ''}
        <div class="list-group">
          ${reviews.map(review => `
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">${review.name}</h6>
                  <div class="text-warning mb-1">
                    ${"★".repeat(review.rating)}${"☆".repeat(5 - review.rating)}
                  </div>
                </div>
                <div>
                  <button class="admin-btn admin-btn-primary admin-btn-sm me-1" onclick="editComment('${productId}', '${review.name}')">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteComment('${productId}', '${review.name}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <p class="mb-1">${review.comment}</p>
              <small class="text-muted">${new Date(review.date).toLocaleDateString()}</small>
            </div>
          `).join('')}
        </div>
      `;
      
      new bootstrap.Modal(document.getElementById('productCommentsModal')).show();
    }
  }

  // 添加评论编辑功能
  function editComment(productId, reviewerName) {
    console.log(`Editing comment for product ${productId} by ${reviewerName}`);
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
    
    if (product) {
      const review = product.reviews.find(r => r.name === reviewerName);
      if (review) {
        const newComment = prompt('Edit comment:', review.comment);
        if (newComment !== null) {
          review.comment = newComment;
          localStorage.setItem('products', JSON.stringify(products));
          viewProductComments(productId);
        }
      }
    }
  }

  // 添加评论删除功能
  function deleteComment(productId, reviewerName) {
    console.log(`Deleting comment for product ${productId} by ${reviewerName}`);
    if (confirm('Are you sure you want to delete this comment?')) {
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      const product = products.find(p => p.id === parseInt(productId) || p.id === productId);
      
      if (product) {
        product.reviews = product.reviews.filter(r => r.name !== reviewerName);
        localStorage.setItem('products', JSON.stringify(products));
        viewProductComments(productId);
      }
    }
  }

  // 确保全局函数可访问
  window.editProduct = editProduct;
  window.deleteProduct = deleteProduct;
  window.viewProductComments = viewProductComments;
  window.resetProductForm = resetProductForm;
  window.saveProduct = saveProduct;
  window.editComment = editComment;
  window.deleteComment = deleteComment;

  // Category management functions
  function loadCategories() {
    console.log('Loading categories data for admin panel');
    
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const tableBody = document.getElementById('category-table-body');
    const noMessage = document.getElementById('no-categories-message');
    
    if (!tableBody || !noMessage) {
      console.error('Category table elements not found');
      return;
    }
    
    console.log(`Found ${categories.length} categories`);
    
    // Show or hide "no categories" message
    if (categories.length === 0) {
      tableBody.innerHTML = '';
      noMessage.classList.remove('d-none');
    } else {
      noMessage.classList.add('d-none');
      
      // Clear the table
      tableBody.innerHTML = '';
      
      // Get products for counting products in each category
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      
      // Render each category
      categories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="product-image-small">
              <img src="${category.image || '../../../img/profile.png'}" 
                   alt="${category.name}" 
                   style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          </td>
          <td>
            <div class="d-flex flex-column">
              <div class="fw-medium">${category.name || 'Unnamed Category'}</div>
              ${category.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
            </div>
          </td>
          <td class="text-truncate" style="max-width: 250px;">
            ${category.description ? category.description : '<span class="text-muted fst-italic">No description</span>'}
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editCategory(${category.id})" data-bs-toggle="tooltip" title="Edit Category">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteCategory(${category.id})" data-bs-toggle="tooltip" title="Delete Category">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Initialize tooltips
      const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltips.map(tooltip => new bootstrap.Tooltip(tooltip));
    }
  }
  
  function resetCategoryForm() {
    // Reset form to default values
    document.getElementById('category-form').reset();
    document.getElementById('categoryModalLabel').textContent = 'Add Category';
    document.getElementById('category-id').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
  }
  
  function resetCategoryImage() {
    // Reset the image to default placeholder
    document.getElementById('category-image-file').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
  }
  
  function editCategory(categoryId) {
    // Get category data
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const category = categories.find(c => c.id === categoryId);
    
    if (category) {
      // Populate form with category data
      document.getElementById('categoryModalLabel').textContent = 'Edit Category';
      document.getElementById('category-id').value = category.id;
      document.getElementById('category-name').value = category.name || '';
      document.getElementById('category-description').value = category.description || '';
      document.getElementById('category-featured').checked = category.featured || false;
      
      // Reset file input
      document.getElementById('category-image-file').value = '';
      
      // Update image preview
      const imgPreview = document.getElementById('category-img-preview');
      if (category.image) {
        imgPreview.src = category.image;
      } else {
        imgPreview.src = '../../../img/profile.png';
      }
      
      // Show the modal
      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    } else {
      showToast('Error', `Category with ID ${categoryId} not found`, 'danger');
    }
  }
  
  function saveCategory() {
    // Get form values
    const categoryId = document.getElementById('category-id').value;
    const name = document.getElementById('category-name').value.trim();
    const description = document.getElementById('category-description').value.trim();
    const featured = document.getElementById('category-featured').checked;
    
    // Validate inputs
    if (!name) {
      showToast('Validation Error', 'Category name is required', 'warning');
      document.getElementById('category-name').focus();
      return;
    }
    
    // Get existing categories
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // Process the image (only if file upload)
    const imageFile = document.getElementById('category-image-file').files[0];
    
    // Function to save category data after image processing
    const finalizeSave = (imageData) => {
      try {
        if (categoryId) {
          // Update existing category
          const index = categories.findIndex(c => c.id === parseInt(categoryId));
          if (index !== -1) {
            categories[index].name = name;
            categories[index].description = description;
            // Only update image if a new one is provided
            if (imageData) {
              categories[index].image = imageData;
            }
            categories[index].featured = featured;
            showToast('Success', 'Category updated successfully', 'success');
          } else {
            showToast('Error', `Category with ID ${categoryId} not found for update`, 'danger');
          }
        } else {
          // Add new category
          const newId = categories.length > 0 ? Math.max(...categories.map(c => c.id)) + 1 : 1;
          categories.push({
            id: newId,
            name: name,
            description: description,
            image: imageData || '../../../img/profile.png',
            featured: featured
          });
          showToast('Success', 'New category added successfully', 'success');
        }
        
        // Save to localStorage
        localStorage.setItem('categories', JSON.stringify(categories));
        
        // Close modal and refresh category list
        bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        loadCategories();
        
        // Update filter options in product management if they exist
        if (window.updateCategoryFilters) {
          window.updateCategoryFilters(categories);
        }
      } catch (error) {
        console.error('Error saving category:', error);
        showToast('Error', `Failed to save category: ${error.message}`, 'danger');
      }
    };
    
    // Handle image file if provided
    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        finalizeSave(e.target.result); // Use the base64 string as the image data
      };
      reader.readAsDataURL(imageFile);
    } else {
      // No file uploaded, proceed with existing image or placeholder
      finalizeSave(null);
    }
  }

  function deleteCategory(categoryId) {
    // Create confirmation dialog
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmationModal') || createConfirmationModal());
    
    // Setup confirmation dialog
    document.getElementById('confirmationTitle').textContent = 'Delete Category';
    document.getElementById('confirmationMessage').innerHTML = 
      '<p>Are you sure you want to delete this category?</p>' +
      '<p class="mb-0 text-muted small">Products in this category will not be deleted but will no longer be associated with any category.</p>';
    
    // Setup confirm button
    const confirmButton = document.getElementById('confirmationButton');
    confirmButton.textContent = 'Delete Category';
    confirmButton.className = 'btn btn-danger';
    
    // Remove previous event listeners
    const newConfirmBtn = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmBtn, confirmButton);
    
    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
      // Get existing categories
      const categories = JSON.parse(localStorage.getItem('categories') || '[]');
      
      // Find category being deleted for the toast message
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : 'Unknown category';
      
      // Filter out the category to delete
      const updatedCategories = categories.filter(c => c.id !== categoryId);
      
      // Save to localStorage
      localStorage.setItem('categories', JSON.stringify(updatedCategories));
      
      // Get products and update any that reference this category
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      let productsUpdated = false;
      let affectedProducts = 0;
      
      products.forEach(product => {
        if (product.categoryId === categoryId) {
          product.categoryId = null; // Remove category association
          productsUpdated = true;
          affectedProducts++;
        }
      });
      
      // If products were updated, save them back to localStorage
      if (productsUpdated) {
        localStorage.setItem('products', JSON.stringify(products));
        showToast('Info', `${affectedProducts} product(s) were removed from the deleted category`, 'info');
      }
      
      // Refresh the category list
      loadCategories();
      
      // Update filter options in product management if they exist
      if (window.updateCategoryFilters) {
        window.updateCategoryFilters(updatedCategories);
      }
      
      // Show success message and hide modal
      showToast('Success', `Category "${categoryName}" has been deleted`, 'success');
      confirmModal.hide();
    });
    
    // Show the modal
    confirmModal.show();
  }

  // Helper function to create confirmation modal if it doesn't exist
  function createConfirmationModal() {
    const modalHtml = `
      <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="confirmationMessage">Are you sure you want to proceed?</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmationButton">Confirm</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    return document.getElementById('confirmationModal');
  }
  
  // Add event listener for image file input change to show preview
  document.addEventListener('DOMContentLoaded', function() {
    const categoryImageInput = document.getElementById('category-image-file');
    if (categoryImageInput) {
      categoryImageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('category-img-preview').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Initialize any tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Load categories when page loads
    if (typeof loadCategories === 'function') {
      loadCategories();
    }
  });

  // =====================
  // 订单管理功能相关函数
  // =====================
  
  // 初始化订单管理部分
  function initializeOrderManagement() {
    console.log('Initializing order management...');
    loadAllOrders();
    
    // 设置导出按钮的事件处理程序
    document.getElementById('exportOrdersToCSV').addEventListener('click', exportOrdersToCSV);
  }
  
  // 加载所有订单
  function loadAllOrders() {
    console.log('Loading all orders...');
    
    // 从localStorage获取所有用户
    const users = JSON.parse(localStorage.getItem('users') || '[]');
    
    // 收集所有用户的订单
    let allOrders = [];
    users.forEach(user => {
      if (user.orders && Array.isArray(user.orders)) {
        // 为每个订单添加用户信息
        const userOrders = user.orders.map(order => ({
          ...order,
          customerName: user.firstName && user.lastName ? 
                       `${user.firstName} ${user.lastName}` : 
                       (user.name || user.username || 'Unknown'),
          customerEmail: user.email
        }));
        allOrders = [...allOrders, ...userOrders];
      }
    });
    
    // 如果没有找到任何订单，尝试使用示例订单数据
    if (allOrders.length === 0) {
      allOrders = getSampleOrders();
    }
    
    // 按日期倒序排序（最新的订单在前）
    allOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    // 将订单展示在表格中
    displayOrdersInTable(allOrders);
  }
  
  // 显示订单数据到表格
  function displayOrdersInTable(orders) {
    const orderTableBody = document.getElementById('orderTableBody');
    if (!orderTableBody) {
      console.error('orderTableBody element not found! DOM may not be fully loaded.');
      return; // Exit the function early if orderTableBody doesn't exist
    }
    
    orderTableBody.innerHTML = '';
    
    if (orders.length === 0) {
      orderTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="empty-state-icon">
              <i class="bi bi-bag-x text-muted" style="font-size: 2rem;"></i>
            </div>
            <p class="text-muted mt-2">No orders found</p>
          </td>
        </tr>`;
      return;
    }
    
    orders.forEach(order => {
      // 计算订单中的总商品数量
      const totalItems = order.items ? order.items.reduce((sum, item) => sum + item.quantity, 0) : 0;
      
      // 创建订单行
      const row = document.createElement('tr');
      row.setAttribute('data-order-id', order.id);
      row.setAttribute('data-order-status', order.status || 'processing');
      row.setAttribute('data-order-date', order.date);
      row.setAttribute('data-order-total', order.total);
      
      // 设置订单状态样式
      const statusClass = getStatusClass(order.status || 'processing');
      
      row.innerHTML = `
        <td><a href="#" onclick="viewOrderDetails('${order.id}')">${order.id}</a></td>
        <td>${order.customerName}<br><small class="text-muted">${order.customerEmail}</small></td>
        <td>${formatDate(order.date)}</td>
        <td>${totalItems}</td>
        <td>$${(order.total || 0).toFixed(2)}</td>
        <td><span class="order-status ${statusClass}">${order.status || 'Processing'}</span></td>
        <td>
          <div class="btn-group">
            <button class="admin-btn admin-btn-info admin-btn-sm me-1" onclick="viewOrderDetails('${order.id}')">
              <i class="bi bi-eye"></i>
            </button>
            <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="updateOrderStatus('${order.id}')">
              <i class="bi bi-pencil"></i>
            </button>
          </div>
        </td>
      `;
      
      orderTableBody.appendChild(row);
    });
  }
  
  // 获取状态样式类
  function getStatusClass(status) {
    switch(status.toLowerCase()) {
      case 'processing': return 'status-processing';
      case 'shipped': return 'status-shipped';
      case 'delivered': return 'status-delivered';
      case 'cancelled': return 'status-cancelled';
      default: return 'status-processing';
    }
  }
  
  // 格式化日期
  function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric'
    });
  }
  
  // 查看订单详情
  function viewOrderDetails(orderId) {
    // 此功能将在模态窗口中显示订单详情
    console.log(`Viewing details for order: ${orderId}`);
    
    // TODO: 实现查看订单详情的功能
    showToast('Coming Soon', 'Order details feature is coming soon', 'info');
  }
  
  // 更新订单状态
  function updateOrderStatus(orderId) {
    // 此功能将允许管理员更新订单状态
    console.log(`Updating status for order: ${orderId}`);
    
    // TODO: 实现更新订单状态的功能
    showToast('Coming Soon', 'Order status update feature is coming soon', 'info');
  }
  
  // 筛选管理员订单列表
  function filterAdminOrders() {
    const statusFilter = document.getElementById('orderFilterStatus').value;
    const dateFilter = document.getElementById('orderFilterDate').value;
    const searchText = document.getElementById('orderSearch').value.toLowerCase();
    
    const orderRows = document.querySelectorAll('#orderTableBody tr');
    let visibleCount = 0;
    
    orderRows.forEach(row => {
      const orderId = row.getAttribute('data-order-id') || '';
      const orderStatus = row.getAttribute('data-order-status') || '';
      const orderDate = new Date(row.getAttribute('data-order-date') || '');
      const customerInfo = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
      
      // 检查状态筛选
      const matchesStatus = statusFilter === '' || orderStatus.toLowerCase() === statusFilter.toLowerCase();
      
      // 检查日期筛选
      let matchesDate = true;
      if (dateFilter) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        const lastWeek = new Date(today);
        lastWeek.setDate(lastWeek.getDate() - 7);
        
        const lastMonth = new Date(today);
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        switch(dateFilter) {
          case 'today':
            matchesDate = orderDate >= today;
            break;
          case 'yesterday':
            matchesDate = orderDate >= yesterday && orderDate < today;
            break;
          case 'week':
            matchesDate = orderDate >= lastWeek;
            break;
          case 'month':
            matchesDate = orderDate >= lastMonth;
            break;
        }
      }
      
      // 检查搜索筛选
      const matchesSearch = searchText === '' || 
                           orderId.toLowerCase().includes(searchText) || 
                           customerInfo.includes(searchText);
      
      // 显示或隐藏行
      if (matchesStatus && matchesDate && matchesSearch) {
        row.style.display = '';
        visibleCount++;
      } else {
        row.style.display = 'none';
      }
    });
    
    // 如果没有可见的订单，显示空状态
    if (visibleCount === 0 && orderRows.length > 0) {
      const noResultsRow = document.createElement('tr');
      noResultsRow.id = 'no-filter-results';
      noResultsRow.innerHTML = `
        <td colspan="7" class="text-center py-4">
          <div class="empty-state-icon">
            <i class="bi bi-funnel-fill text-muted" style="font-size: 1.5rem;"></i>
          </div>
          <p class="text-muted mt-2">No orders match your filter criteria</p>
          <button class="admin-btn admin-btn-primary admin-btn-sm mt-2" onclick="resetOrderFilters()">
            Clear Filters
          </button>
        </td>
      `;
      
      // 移除之前的"无结果"行
      const oldNoResults = document.getElementById('no-filter-results');
      if (oldNoResults) {
        oldNoResults.remove();
      }
      
      document.getElementById('orderTableBody').appendChild(noResultsRow);
    } else {
      // 移除"无结果"行
      const noResultsRow = document.getElementById('no-filter-results');
      if (noResultsRow) {
        noResultsRow.remove();
      }
    }
  }
  
  // 重置订单筛选条件
  function resetOrderFilters() {
    document.getElementById('orderFilterStatus').value = '';
    document.getElementById('orderFilterDate').value = '';
    document.getElementById('orderSearch').value = '';
    filterAdminOrders();
  }
  
  // 导出订单到CSV
  function exportOrdersToCSV() {
    // 获取表格中可见的订单
    const orderRows = Array.from(document.querySelectorAll('#orderTableBody tr')).filter(
      row => row.style.display !== 'none' && !row.id.includes('no-filter-results')
    );
    
    if (orderRows.length === 0) {
      showToast('No Orders', 'There are no orders to export', 'warning');
      return;
    }
    
    // 创建CSV头部
    let csv = 'Order ID,Customer,Email,Date,Items,Total,Status\n';
    
    // 为每个订单创建CSV行
    orderRows.forEach(row => {
      const orderId = row.getAttribute('data-order-id');
      const customerName = row.querySelector('td:nth-child(2)').textContent.split('\n')[0];
      const customerEmail = row.querySelector('td:nth-child(2) small').textContent;
      const date = row.querySelector('td:nth-child(3)').textContent;
      const items = row.querySelector('td:nth-child(4)').textContent;
      const total = row.querySelector('td:nth-child(5)').textContent;
      const status = row.querySelector('td:nth-child(6) span').textContent;
      
      // 添加到CSV
      csv += `"${orderId}","${customerName}","${customerEmail}","${date}","${items}","${total}","${status}"\n`;
    });
    
    // 创建下载链接
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `orders-export-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    // 释放URL对象
    setTimeout(() => URL.revokeObjectURL(url), 100);
    
    showToast('Success', `Exported ${orderRows.length} orders to CSV`, 'success');
  }
  
  // 获取示例订单数据（当没有真实数据时使用）
  function getSampleOrders() {
    return [
      {
        id: 'PH20230001',
        date: '2023-03-05',
        status: 'delivered',
        total: 54.03,
        customerName: 'John Smith',
        customerEmail: 'john@example.com',
        items: [
          { name: 'Lavender Handmade Soap', quantity: 2, price: 12.99 },
          { name: 'Vanilla Soy Candle', quantity: 1, price: 22.99 }
        ]
      },
      {
        id: 'PH20230002',
        date: '2023-03-06',
        status: 'shipped',
        total: 22.99,
        customerName: 'Emma Johnson',
        customerEmail: 'emma@example.com',
        items: [
          { name: 'Vanilla Soy Candle', quantity: 1, price: 22.99 }
        ]
      },
      {
        id: 'PH20230003',
        date: '2023-03-08',
        status: 'processing',
        total: 48.95,
        customerName: 'Michael Davis',
        customerEmail: 'michael@example.com',
        items: [
          { name: 'Lavender Essential Oil', quantity: 1, price: 18.99 },
          { name: 'Rose Bath Bomb Set', quantity: 2, price: 14.98 }
        ]
      }
    ];
  }

  // Add functions for username editing
  function toggleUsernameEdit() {
    const displayElem = document.getElementById('username-display');
    const editContainer = document.getElementById('username-edit-container');
    const usernameInput = document.getElementById('username-input');
    
    // Get current username without the @ symbol
    const currentUsername = displayElem.textContent.replace('@', '');
    
    // Set the input value
    usernameInput.value = currentUsername;
    
    // Show edit container
    editContainer.classList.remove('d-none');
    
    // Focus on input
    usernameInput.focus();
  }

  // Function to save username
  function saveUsername() {
    const displayElem = document.getElementById('username-display');
    const editContainer = document.getElementById('username-edit-container');
    const usernameInput = document.getElementById('username-input');
    
    const newUsername = usernameInput.value.trim();
    
    // Validate username
    if (newUsername.length < 3) {
      alert('Username must be at least 3 characters long');
      return;
    }
    
    // Update display
    displayElem.textContent = '@' + newUsername;
    
    // Hide edit container
    editContainer.classList.add('d-none');
    
    // Update user data
    if (userProfile && userProfile.username !== newUsername) {
      userProfile.username = newUsername;
      
      // Save user data
      localStorage.setItem('user', JSON.stringify(userProfile));
      localStorage.setItem('currentUser', JSON.stringify(userProfile));
      
      // Update any users array entry if it exists
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u.id == userProfile.id);
      if (userIndex !== -1) {
        users[userIndex].username = newUsername;
        localStorage.setItem('users', JSON.stringify(users));
      }
      
      // Show success message
      showToast('Username updated successfully!', 'success');
    }
  }

  // Function to cancel username edit
  function cancelUsernameEdit() {
    const editContainer = document.getElementById('username-edit-container');
    editContainer.classList.add('d-none');
  }

  // Define isAdmin as a function
  function isAdmin() {
    return localStorage.getItem('isAdmin') === 'true';
  }

  // Initialize everything when DOM content is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Check URL parameters to see if we just updated the profile
    const urlParams = new URLSearchParams(window.location.search);
    const status = urlParams.get('status');
    
    if (status === 'profile_updated') {
      // Clean up the URL by removing the parameter without triggering a page reload
      const newUrl = window.location.pathname;
      window.history.replaceState({}, document.title, newUrl);
      
      // We've already shown the success message before page refresh, no need to show anything
      console.log('Page loaded after profile update, not showing duplicate message');
      
      // Just load the profile data
      loadUserProfile();
    } else {
      // Normal page load
      console.log('Normal page load, loading user profile');
      loadUserProfile();
    }
    
    // Initialize admin features if the user is an admin
    if (isAdmin()) {
      console.log('User is admin, initializing admin features');
      document.getElementById('admin-tab-container').style.display = 'block';
      
      // Setup all the admin data tables
      loadUsers();
      loadProducts();
      loadOrders();
      loadComments();
      
      // Setup admin event listeners
      setupAdminEventListeners();
    } else {
      console.log('User is not admin, hiding admin features');
      document.getElementById('admin-tab-container').style.display = 'none';
    }
  });
</script>

</body>

<!-- Add confirmation delete modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this product? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Add toast container for notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;"></div>

<script>
// ... existing code ...

// Add the showToast helper function at the end of your javascript
function showToast(message, type = 'primary') {
  // Prevent duplicate toasts with the same message within a short time
  const existingToasts = document.querySelectorAll('.toast');
  for (let i = 0; i < existingToasts.length; i++) {
    const toastBody = existingToasts[i].querySelector('.toast-body');
    if (toastBody && toastBody.textContent.trim() === message.trim()) {
      console.log('Preventing duplicate toast:', message);
      return; // Don't show duplicate toast
    }
  }
  
  // 检查消息是否为空
  if (!message || message.trim() === '') {
    console.error('Empty message provided to showToast');
    message = 'Operation completed successfully';  // 提供默认消息
  }
  
  // 确保类型有效
  const validTypes = ['primary', 'secondary', 'success', 'danger', 'warning', 'info', 'light', 'dark'];
  if (!validTypes.includes(type)) {
    console.warn(`Invalid toast type: ${type}, using 'primary' instead`);
    type = 'primary';
  }
  
  // Get or create toast container
  let toastContainer = document.querySelector('.toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    document.body.appendChild(toastContainer);
  }
  
  // Create toast
  const toastElement = document.createElement('div');
  toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
  toastElement.setAttribute('role', 'alert');
  toastElement.setAttribute('aria-live', 'assertive');
  toastElement.setAttribute('aria-atomic', 'true');
  
  const toastContent = `
    <div class="d-flex">
      <div class="toast-body">
        ${message}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  `;
  
  toastElement.innerHTML = toastContent;
  toastContainer.appendChild(toastElement);
  
  // Initialize and show toast
  const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
  toast.show();
  
  // Remove the toast after it's hidden
  toastElement.addEventListener('hidden.bs.toast', function() {
    toastElement.remove();
  });
}
</script>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow admin-modal">
      <div class="modal-header">
        <h5 class="modal-title" id="categoryModalLabel">Add Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <input type="hidden" id="category-id">
          
          <div class="admin-form-group">
            <label for="category-name" class="admin-form-label">Category Name<span class="text-danger">*</span></label>
            <input type="text" class="admin-form-control" id="category-name" required placeholder="Enter category name">
            <div class="form-text">A clear, concise name for your product category</div>
          </div>
          
          <div class="admin-form-group">
            <label for="category-description" class="admin-form-label">Description</label>
            <textarea class="admin-form-control" id="category-description" rows="3" placeholder="Briefly describe what types of products belong in this category"></textarea>
            <div class="form-text">Optional: Describe the types of products that will be included</div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label">Category Image</label>
            <div class="d-flex align-items-start mb-2">
              <div class="product-preview me-3" style="width: 120px; height: 120px;">
                <img id="category-img-preview" src="../../../img/profile.png" alt="Category preview">
              </div>
              <div class="flex-grow-1">
                <input type="file" class="admin-form-control mb-2" id="category-image-file" accept="image/*">
                <div class="form-text mb-2">Recommended size: 400×400px</div>
                <div class="d-grid">
                  <button type="button" class="admin-btn admin-btn-warning" onclick="resetCategoryImage()">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Image
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="category-featured">
              <label class="form-check-label" for="category-featured">
                Featured Category
              </label>
              <div class="form-text">Featured categories will be highlighted on the homepage</div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="admin-btn admin-btn-danger" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="admin-btn admin-btn-primary" onclick="saveCategory()">
          <i class="bi bi-check2 me-1"></i>Save Category
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  .category-management-card {
    border-radius: 12px;
    overflow: hidden;
  }
  
  .category-table th {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #555;
  }
  
  .category-table tbody tr:hover {
    background-color: rgba(134, 118, 102, 0.05);
  }
  
  .empty-state-icon {
    width: 70px;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Style for category featured badge */
  .category-featured-badge {
    background-color: var(--primary-light);
    color: var(--accent-color);
    border-radius: 4px;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
  
  /* Category image thumbnail */
  .category-thumbnail {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    background-color: #f8f9fa;
    border: 1px solid #f0f0f0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
</style>

<script>
// ... existing code ...

  // Category management functions
  function loadCategories() {
    // Get categories from localStorage
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const tableBody = document.getElementById('category-table-body');
    const noCategories = document.getElementById('no-categories-message');
    
    if (!tableBody) {
      console.error('category-table-body element not found! DOM may not be fully loaded.');
      return; // Exit the function early if tableBody doesn't exist
    }
    
    // Clear existing rows
    tableBody.innerHTML = '';
    
    // Get products to count items in each category
    const products = JSON.parse(localStorage.getItem('products') || '[]');
    
    if (categories.length === 0) {
      // No categories found, show empty state message
      tableBody.parentElement.classList.add('d-none');
      noCategories.classList.remove('d-none');
    } else {
      // Show table and hide empty state
      tableBody.parentElement.classList.remove('d-none');
      noCategories.classList.add('d-none');
      
      // Add category rows
      categories.forEach(category => {
        const productCount = products.filter(product => product.categoryId === category.id).length;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <div class="product-image-small">
              <img src="${category.image || '../../../img/profile.png'}" 
                   alt="${category.name}" 
                   style="width: 100%; height: 100%; object-fit: cover;">
            </div>
          </td>
          <td>
            <div class="d-flex flex-column">
              <div class="fw-medium">${category.name || 'Unnamed Category'}</div>
              ${category.featured ? '<span class="badge badge-success mt-1"><i class="bi bi-star-fill me-1"></i>Featured</span>' : ''}
            </div>
          </td>
          <td class="text-truncate" style="max-width: 250px;">
            ${category.description ? category.description : '<span class="text-muted fst-italic">No description</span>'}
          </td>
          <td class="text-center">
            <div class="action-buttons">
              <button class="admin-btn admin-btn-primary admin-btn-sm" onclick="editCategory(${category.id})" data-bs-toggle="tooltip" title="Edit Category">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="admin-btn admin-btn-danger admin-btn-sm" onclick="deleteCategory(${category.id})" data-bs-toggle="tooltip" title="Delete Category">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Initialize tooltips
      const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltips.map(tooltip => new bootstrap.Tooltip(tooltip));
    }
  }

  function resetCategoryForm() {
    // Reset form to default values
    document.getElementById('category-form').reset();
    document.getElementById('categoryModalLabel').textContent = 'Add Category';
    document.getElementById('category-id').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('categoryModal')).show();
  }
  
  function resetCategoryImage() {
    // Reset the image to default placeholder
    document.getElementById('category-image-file').value = '';
    document.getElementById('category-img-preview').src = '../../../img/profile.png';
  }

  function editCategory(categoryId) {
    // Get category data
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    const category = categories.find(c => c.id === categoryId);
    
    if (category) {
      // Populate form with category data
      document.getElementById('categoryModalLabel').textContent = 'Edit Category';
      document.getElementById('category-id').value = category.id;
      document.getElementById('category-name').value = category.name || '';
      document.getElementById('category-description').value = category.description || '';
      document.getElementById('category-featured').checked = category.featured || false;
      
      // Reset file input
      document.getElementById('category-image-file').value = '';
      
      // Update image preview
      const imgPreview = document.getElementById('category-img-preview');
      if (category.image) {
        imgPreview.src = category.image;
      } else {
        imgPreview.src = '../../../img/profile.png';
      }
      
      // Show the modal
      new bootstrap.Modal(document.getElementById('categoryModal')).show();
    } else {
      showToast('Error', `Category with ID ${categoryId} not found`, 'danger');
    }
  }

  function saveCategory() {
    // Get form values
    const categoryId = document.getElementById('category-id').value;
    const name = document.getElementById('category-name').value.trim();
    const description = document.getElementById('category-description').value.trim();
    const featured = document.getElementById('category-featured').checked;
    
    // Validate inputs
    if (!name) {
      showToast('Validation Error', 'Category name is required', 'warning');
      document.getElementById('category-name').focus();
      return;
    }
    
    // Get existing categories
    const categories = JSON.parse(localStorage.getItem('categories') || '[]');
    
    // Process the image (only if file upload)
    const imageFile = document.getElementById('category-image-file').files[0];
    
    // Function to save category data after image processing
    const finalizeSave = (imageData) => {
      try {
        if (categoryId) {
          // Update existing category
          const index = categories.findIndex(c => c.id === parseInt(categoryId));
          if (index !== -1) {
            categories[index].name = name;
            categories[index].description = description;
            // Only update image if a new one is provided
            if (imageData) {
              categories[index].image = imageData;
            }
            categories[index].featured = featured;
            showToast('Success', 'Category updated successfully', 'success');
          } else {
            showToast('Error', `Category with ID ${categoryId} not found for update`, 'danger');
          }
        } else {
          // Add new category
          const newId = categories.length > 0 ? Math.max(...categories.map(c => c.id)) + 1 : 1;
          categories.push({
            id: newId,
            name: name,
            description: description,
            image: imageData || '../../../img/profile.png',
            featured: featured
          });
          showToast('Success', 'New category added successfully', 'success');
        }
        
        // Save to localStorage
        localStorage.setItem('categories', JSON.stringify(categories));
        
        // Close modal and refresh category list
        bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
        loadCategories();
        
        // Update filter options in product management if they exist
        if (window.updateCategoryFilters) {
          window.updateCategoryFilters(categories);
        }
      } catch (error) {
        console.error('Error saving category:', error);
        showToast('Error', `Failed to save category: ${error.message}`, 'danger');
      }
    };
    
    // Handle image file if provided
    if (imageFile) {
      const reader = new FileReader();
      reader.onload = function(e) {
        finalizeSave(e.target.result); // Use the base64 string as the image data
      };
      reader.readAsDataURL(imageFile);
    } else {
      // No file uploaded, proceed with existing image or placeholder
      finalizeSave(null);
    }
  }

  function deleteCategory(categoryId) {
    // Create confirmation dialog
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmationModal') || createConfirmationModal());
    
    // Setup confirmation dialog
    document.getElementById('confirmationTitle').textContent = 'Delete Category';
    document.getElementById('confirmationMessage').innerHTML = 
      '<p>Are you sure you want to delete this category?</p>' +
      '<p class="mb-0 text-muted small">Products in this category will not be deleted but will no longer be associated with any category.</p>';
    
    // Setup confirm button
    const confirmButton = document.getElementById('confirmationButton');
    confirmButton.textContent = 'Delete Category';
    confirmButton.className = 'btn btn-danger';
    
    // Remove previous event listeners
    const newConfirmBtn = confirmButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirmBtn, confirmButton);
    
    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
      // Get existing categories
      const categories = JSON.parse(localStorage.getItem('categories') || '[]');
      
      // Find category being deleted for the toast message
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : 'Unknown category';
      
      // Filter out the category to delete
      const updatedCategories = categories.filter(c => c.id !== categoryId);
      
      // Save to localStorage
      localStorage.setItem('categories', JSON.stringify(updatedCategories));
      
      // Get products and update any that reference this category
      const products = JSON.parse(localStorage.getItem('products') || '[]');
      let productsUpdated = false;
      let affectedProducts = 0;
      
      products.forEach(product => {
        if (product.categoryId === categoryId) {
          product.categoryId = null; // Remove category association
          productsUpdated = true;
          affectedProducts++;
        }
      });
      
      // If products were updated, save them back to localStorage
      if (productsUpdated) {
        localStorage.setItem('products', JSON.stringify(products));
        showToast('Info', `${affectedProducts} product(s) were removed from the deleted category`, 'info');
      }
      
      // Refresh the category list
      loadCategories();
      
      // Update filter options in product management if they exist
      if (window.updateCategoryFilters) {
        window.updateCategoryFilters(updatedCategories);
      }
      
      // Show success message and hide modal
      showToast('Success', `Category "${categoryName}" has been deleted`, 'success');
      confirmModal.hide();
    });
    
    // Show the modal
    confirmModal.show();
  }

  // Helper function to create confirmation modal if it doesn't exist
  function createConfirmationModal() {
    const modalHtml = `
      <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content border-0 shadow">
            <div class="modal-header">
              <h5 class="modal-title" id="confirmationTitle">Confirm Action</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="confirmationMessage">Are you sure you want to proceed?</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmationButton">Confirm</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    return document.getElementById('confirmationModal');
  }

// ... existing code ...

  // Add event listener for image file input change to show preview
  document.addEventListener('DOMContentLoaded', function() {
    const categoryImageInput = document.getElementById('category-image-file');
    if (categoryImageInput) {
      categoryImageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('category-img-preview').src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Initialize any tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Load categories when page loads
    if (typeof loadCategories === 'function') {
      loadCategories();
    }
  });
</script>

// ... existing code ...

  // Fix Bootstrap modal initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals with proper options
    var modals = document.querySelectorAll('.modal');
    modals.forEach(function(modal) {
      new bootstrap.Modal(modal, {
        backdrop: true,
        keyboard: true,
        focus: true
      });
    });
  });
</script>

<!-- Add Bootstrap JS at the end of body -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Edit Profile Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editProfileModalLabel">Edit Personal Information</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="profile-form">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="firstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="firstName" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="lastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="lastName" required>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="email" required>
          </div>
          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" required>
          </div>
          <div class="mb-3">
            <label for="birthday" class="form-label">Birthday</label>
            <input type="date" class="form-control" id="birthday">
          </div>
          <div class="mb-3">
            <label class="form-label">Gender</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male">
                <label class="form-check-label" for="genderMale">Male</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
                <label class="form-check-label" for="genderFemale">Female</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="gender" id="genderOther" value="other">
                <label class="form-check-label" for="genderOther">Other</label>
              </div>
            </div>
          </div>
          <div id="profile-error" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-profile" onclick="saveProfileChanges()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Add this script to ensure modals work properly -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing all modals on page...');
    // Initialize all modals with proper options after they are defined
    var modalElements = document.querySelectorAll('.modal');
    if (modalElements.length > 0) {
      modalElements.forEach(function(modalElement) {
        try {
          var modalInstance = new bootstrap.Modal(modalElement, {
            backdrop: true,
            keyboard: true,
            focus: true
          });
          console.log(`Modal initialized: #${modalElement.id}`);
        } catch (err) {
          console.error(`Failed to initialize modal #${modalElement.id}:`, err);
        }
      });
    } else {
      console.warn('No modal elements found on page');
    }
  });
</script>

<!-- Script to properly initialize all modals -->
<script>
  // Ensure modals are properly initialized after page load
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing modals after page load');
    setTimeout(function() {
      try {
        document.querySelectorAll('.modal').forEach(function(modal) {
          // Check if modal is already initialized
          if (!bootstrap.Modal.getInstance(modal)) {
            new bootstrap.Modal(modal);
            console.log('Modal initialized:', modal.id);
          }
        });
      } catch (error) {
        console.error('Error initializing modals:', error);
      }
    }, 500); // Small delay to ensure DOM is fully loaded
  });
</script>
</html>
