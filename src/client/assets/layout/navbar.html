<!-- Double-layer navigation bar -->
<!-- Top navigation bar - contains logo and user functions -->
<div class="navbar navbar-expand-md navbar-light bg-light py-2 border-bottom top-navbar">
  <div class="container">
    <div class="d-flex align-items-center navbar-top-wrapper">
      <!-- Logo -->
      <a class="navbar-brand" href="/~xzy2020c/PurelyHandmade/src/client/html/index.html">
        <img src="/~xzy2020c/PurelyHandmade/src/client/assets/placeholder.jpg" alt="Purely Homemade Logo" height="40"
          class="d-inline-block align-text-top me-2">
        Purely Homemade
      </a>

      <!-- Mobile toggle for top navbar functionality -->
      <button class="navbar-toggler d-md-none ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#topNavFunctions"
        aria-controls="topNavFunctions" aria-expanded="false" aria-label="Toggle navigation">
        <i class="bi bi-three-dots"></i>
      </button>
    </div>

    <!-- Search bar - Always visible and centered -->
    <div class="search-bar-wrapper my-2 d-flex justify-content-center">
      <form class="d-flex navbar-search w-100"
        action="/~xzy2020c/PurelyHandmade/src/client/views/products/product-list.html" method="GET">
        <input class="form-control me-2" type="search" name="q" placeholder="Search products..." aria-label="Search">
        <button class="btn btn-outline-primary" type="submit">
          <i class="bi bi-search"></i>
        </button>
      </form>
    </div>

    <!-- Right-side functionality area -->
    <div class="collapse navbar-collapse mt-2 mt-md-0" id="topNavFunctions">
      <!-- Mobile menu navigation items - only in collapsed menu -->
      <div class="d-md-none mb-3">
        <!-- Login and Register buttons - only visible when not logged in -->
        <div class="mobile-menu-buttons" id="mobile-auth-buttons" style="display: block !important;">
          <a href="/~xzy2020c/PurelyHandmade/src/client/views/auth/login.html" class="btn btn-outline-primary mobile-menu-btn" id="mobile-login-button">
            <i class="bi bi-box-arrow-in-right"></i>Login
          </a>
          <a href="/~xzy2020c/PurelyHandmade/src/client/views/auth/register.html" class="btn btn-outline-primary mobile-menu-btn" id="mobile-register-button">
            <i class="bi bi-person-plus"></i>Register
          </a>
        </div>
        
        <!-- Profile and Order History - only visible when logged in -->
        <div class="mobile-menu-buttons" id="mobile-profile-buttons" style="display: none !important;">
          <a href="/~xzy2020c/PurelyHandmade/src/client/views/auth/profile.html" class="btn btn-outline-primary mobile-menu-btn" id="mobile-profile-button">
            <i class="bi bi-person"></i>Profile
          </a>
          <a href="/~xzy2020c/PurelyHandmade/src/client/views/orders/order-history.html" class="btn btn-outline-primary mobile-menu-btn" id="mobile-order-history-button">
            <i class="bi bi-clock-history"></i>Order History
          </a>
          <a href="javascript:void(0);" class="btn btn-outline-primary mobile-menu-btn" id="mobile-logout-button" onclick="handleLogout(event)">
            <i class="bi bi-box-arrow-right"></i>Logout
          </a>
        </div>
        
        <!-- Mobile shopping cart button -->
        <a href="/~xzy2020c/PurelyHandmade/src/client/views/checkout/cart.html" class="btn btn-outline-primary mobile-menu-btn">
          <i class="bi bi-cart3"></i>Shopping Cart
          <span class="badge rounded-pill bg-danger ms-2" id="mobile-cart-count" style="display: none;">0</span>
        </a>
      </div>

      <!-- Desktop user menu - keep original logic -->
      <div class="d-none d-md-flex mt-2 mt-md-0 ms-auto">
        <!-- Desktop dropdown menu - original dropdown logic -->
        <div class="dropdown me-2 d-none d-md-block">
          <button class="btn btn-outline-primary" type="button" id="userDropdown" data-bs-toggle="dropdown"
            aria-expanded="false">
            <i class="bi bi-person-circle"></i>
          </button>
          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
            <li>
              <a class="dropdown-item" href="/~xzy2020c/PurelyHandmade/src/client/views/auth/login.html" id="login-button">
                <i class="bi bi-box-arrow-in-right me-2"></i>Login
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/~xzy2020c/PurelyHandmade/src/client/views/auth/register.html" id="register-button">
                <i class="bi bi-person-plus me-2"></i>Register
              </a>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item" href="/~xzy2020c/PurelyHandmade/src/client/views/auth/profile.html" id="profile-button"
                style="display: none;">
                <i class="bi bi-person me-2"></i>Profile
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="/~xzy2020c/PurelyHandmade/src/client/views/orders/order-history.html"
                id="order-history-button" style="display: none;">
                <i class="bi bi-clock-history me-2"></i>Order History
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="javascript:void(0);" id="logout-button" style="display: none;" onclick="handleLogout(event)">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>

        <!-- Shopping cart - with border -->
        <a href="/~xzy2020c/PurelyHandmade/src/client/views/checkout/cart.html" class="btn btn-outline-primary position-relative">
          <i class="bi bi-cart3"></i>
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cart-count"
            style="display: none;">
            0
            <span class="visually-hidden">items in cart</span>
          </span>
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Bottom navigation bar - main navigation menu -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm py-1 navbar-dark">
  <div class="container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/html/index.html">Home</a>
        </li>
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/views/new-arrivals.html">New Arrivals</a>
        </li>
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/views/products/product-list.html">Products</a>
        </li>
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/views/designer/designers.html">Designers</a>
        </li>
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/views/on-sale.html">Sale</a>
        </li>
        <li class="nav-item mx-lg-2">
          <a class="nav-link" href="/~xzy2020c/PurelyHandmade/src/client/views/about.html">About Us</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<script>
  // Use centralized logout handler
  function handleLogout(event) {
    event.preventDefault();
    console.log('Navbar: logout button clicked');
    
    if (window.handleLogout) {
      // Use the centralized handler
      window.handleLogout(event);
    } else {
      // Fallback if common.js not loaded
      localStorage.removeItem('currentUser');
      localStorage.removeItem('authToken');
      document.body.classList.remove('user-logged-in');
      window.location.href = '/~xzy2020c/PurelyHandmade/src/client/html/index.html';
    }
  }

  // Use centralized updateAuthButton function
  window.updateAuthButton = function() {
    console.log('Navbar: updateAuthButton called');
    
    // Check if centralized system exists and use it
    if (window.checkAuthState) {
      window.checkAuthState();
    } else {
      // Fallback implementation if common.js not loaded
      try {
        const currentUser = localStorage.getItem('currentUser');
        console.log('Auth status:', currentUser ? 'logged in' : 'not logged in');
        
        if (currentUser) {
          document.body.classList.add('user-logged-in');
        } else {
          document.body.classList.remove('user-logged-in');
        }
        
        // Desktop elements
        const loginButton = document.getElementById('login-button');
        const registerButton = document.getElementById('register-button');
        const profileButton = document.getElementById('profile-button');
        const orderHistoryButton = document.getElementById('order-history-button');
        const logoutButton = document.getElementById('logout-button');
        
        // Mobile elements
        const mobileAuthButtons = document.getElementById('mobile-auth-buttons');
        const mobileProfileButtons = document.getElementById('mobile-profile-buttons');

        if (currentUser) {
          // Desktop elements when logged in
          if (loginButton) loginButton.style.cssText = 'display: none !important';
          if (registerButton) registerButton.style.cssText = 'display: none !important';
          if (profileButton) profileButton.style.cssText = 'display: block !important';
          if (orderHistoryButton) orderHistoryButton.style.cssText = 'display: block !important';
          if (logoutButton) logoutButton.style.cssText = 'display: block !important';
          
          // Mobile elements when logged in
          if (mobileAuthButtons) mobileAuthButtons.style.cssText = 'display: none !important; visibility: hidden !important;';
          if (mobileProfileButtons) mobileProfileButtons.style.cssText = 'display: block !important; visibility: visible !important;';
        } else {
          // Desktop elements when logged out
          if (loginButton) loginButton.style.cssText = 'display: block !important';
          if (registerButton) registerButton.style.cssText = 'display: block !important';
          if (profileButton) profileButton.style.cssText = 'display: none !important';
          if (orderHistoryButton) orderHistoryButton.style.cssText = 'display: none !important';
          if (logoutButton) logoutButton.style.cssText = 'display: none !important';
          
          // Mobile elements when logged out
          if (mobileAuthButtons) mobileAuthButtons.style.cssText = 'display: block !important; visibility: visible !important;';
          if (mobileProfileButtons) mobileProfileButtons.style.cssText = 'display: none !important; visibility: hidden !important;';
        }

        // Ensure parent elements are visible
        if (mobileAuthButtons && mobileAuthButtons.parentElement) {
          mobileAuthButtons.parentElement.style.display = 'block';
        }
        if (mobileProfileButtons && mobileProfileButtons.parentElement) {
          mobileProfileButtons.parentElement.style.display = 'block';
        }
      } catch (err) {
        console.error('Error updating navbar auth state:', err);
      }
    }
  };

  // Cart count update function
  window.updateCartCount = async function() {
    const cartCountElement = document.getElementById('cart-count');
    const mobileCartCountElement = document.getElementById('mobile-cart-count');
    
    if (!cartCountElement && !mobileCartCountElement) return;

    try {
      if (typeof DataService === 'undefined') {
        console.warn('DataService未定义，无法更新购物车数量');
        if (cartCountElement) cartCountElement.style.display = 'none';
        if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
        return;
      }
      
      const currentUser = DataService.getCurrentUser();
      if (!currentUser) {
        if (cartCountElement) cartCountElement.style.display = 'none';
        if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
        return;
      }

      const response = await fetch(`${CONFIG?.getApiPath ? CONFIG.getApiPath('cart') : '/~xzy2020c/PurelyHandmade/api/cart'}?userId=${currentUser.id}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${DataService.getAuthToken()}`
        }
      });

      const result = await response.json();

      if (result.success && Array.isArray(result.data)) {
        const count = result.data.reduce((total, item) => total + (item.quantity || 1), 0);
        if (count > 0) {
          if (cartCountElement) {
            cartCountElement.textContent = count;
            cartCountElement.style.display = 'inline-block';
          }
          
          if (mobileCartCountElement) {
            mobileCartCountElement.textContent = count;
            mobileCartCountElement.style.display = 'inline-block';
          }
        } else {
          if (cartCountElement) cartCountElement.style.display = 'none';
          if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
        }
      } else {
        if (cartCountElement) cartCountElement.style.display = 'none';
        if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
      }
    } catch (e) {
      console.error('Error updating cart count', e);
      if (cartCountElement) cartCountElement.style.display = 'none';
      if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
    }
  };

  // Register with event system if available
  function registerWithEventSystem() {
    if (window.PurelyHandmadeEvents) {
      console.log('Navbar: Registering with PurelyHandmadeEvents');
      
      // Register to receive auth events
      window.PurelyHandmadeEvents.on('auth:login', function() {
        console.log('Navbar: Received auth:login event');
        updateCartCount().catch(err => console.error('Cart update failed:', err));
      });
      
      window.PurelyHandmadeEvents.on('auth:logout', function() {
        console.log('Navbar: Received auth:logout event'); 
        // Clear cart display
        const cartCountElement = document.getElementById('cart-count');
        const mobileCartCountElement = document.getElementById('mobile-cart-count');
        if (cartCountElement) cartCountElement.style.display = 'none';
        if (mobileCartCountElement) mobileCartCountElement.style.display = 'none';
      });
    }
  }

  // Initialize navbar
  function initNavbar() {
    console.log('Initializing navbar');
    
    // Register with event system
    registerWithEventSystem();
    
    // Check if we should use centralized system
    if (window.checkAuthState) {
      window.checkAuthState();
    } else {
      // Fall back to local implementation
      updateAuthButton();
    }
    
    updateCartCount().catch(err => console.error('Cart update failed:', err));
  }
  
  // Initialize on load or immediately if ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNavbar);
  } else {
    initNavbar();
  }
  
  // Additional safety check
  setTimeout(initNavbar, 500);
</script>